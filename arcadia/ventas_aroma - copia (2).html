<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Reporte de caja ARCADIA</title>
  <meta name="description" content="Aplicaci√≥n de caja: captura diaria con totales y guardado en la nube. El reporte se consulta en la hoja de c√°lculo." />
  <style>
    :root{
      --primary:#0056b3; --success:#28a745; --danger:#dc3545;
      --warning:#ffc107; --info:#007bff; --muted:#6c757d; --purple:#6f42c1;
      --bg:#f4f7f9; --card:#fff; --radius:8px; --shadow:0 6px 18px rgba(9,30,66,0.08);
      --border:#e6eaee; --touch:44px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      background:var(--bg);color:#222;line-height:1.45;
      padding:8px;
    }
    .container{
      width:100vw; max-width:100vw; min-height:96vh;
      margin:0 auto;background:var(--card);
      border-radius:var(--radius);box-shadow:var(--shadow);padding:16px; position: relative;
    }
    header h1{margin:0 0 8px 0;color:var(--primary);font-size:1.6rem}
    header p{margin:0 0 14px 0;color:var(--muted);font-size:0.95rem}
    .btn{
      padding:10px 14px;border-radius:6px;border:0;cursor:pointer;color:#fff;font-weight:600;
      display:inline-flex;align-items:center;gap:8px;transition:transform .12s, box-shadow .12s, opacity .12s;
      justify-content:center; min-height:var(--touch); min-width:var(--touch);
    }
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:var(--primary)}
    .btn-success{background:var(--success)}
    .btn-info{background:var(--info)}
    .btn-warning{background:var(--warning); color:#222}
    .btn-danger{background:var(--danger)}
    .btn-purple{background:var(--purple)}
    .btn-ghost{background:#eef3fb;color:var(--primary)}
    .btn-small{padding: 8px 10px; font-size: 0.95rem; min-height:var(--touch)}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;}
    .card{border:1px solid var(--border);border-radius:10px;padding:16px;background:#fff}
    .card h3{margin:0 0 8px 0}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    hr{border:0;border-top:1px solid #eef2f5;margin:16px 0}
    label{font-weight:600;font-size:0.88rem;margin-bottom:4px;display:block}
    input, select{
      width:100%;padding:12px;border:1px solid var(--border);border-radius:6px;
      font-size:1rem;background:#fff; min-height:var(--touch);
    }
    .tag{
      display:inline-block;padding:6px 10px;border-radius:999px;background:#eef3fb;color:#1353d8;
      font-weight:600;font-size:.9rem
    }
    @media (max-width: 600px){
      body{padding:0}
      .container{border-radius:0; padding:12px}
      header h1{font-size:1.35rem}
      .cards{grid-template-columns:1fr}
      .btn{width:100%}
    }
    @media print{
      .no-print{display:none !important}
      body{ background:#fff; color:#000 }
      .container{ box-shadow:none; border:1px solid #ccc }
    }

    #session-info{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:8px 10px;border-radius:6px;background:#eef3fb;margin-bottom:14px;font-size:0.95rem;
    }
    .actions-bar {display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-bottom:12px;}
    .records-container{overflow:auto;border-radius:6px;border:1px solid var(--border)}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th, td{
      padding:10px;border-top:1px solid #f4f7fb;font-size:1rem;
      text-align: left; vertical-align: middle;
    }
    thead th{
      background:#f1f6fb;font-weight:700;position:sticky;top:0;z-index:2;border-bottom:1px solid var(--border)
    }
    tbody tr:nth-child(odd){background:#fbfdff}
    tbody tr:hover { background-color: #e7f1ff !important; }
    .row-style-efectivo { background-color: #e9f7ec; }
    .row-style-electronica { background-color: #f8f9fa; }
    .row-style-credito-nomina { background-color: #e6eef9; }
    .row-style-credito-formulas { background-color: #e0f2ff; }
    .row-style-gasto { background-color: #fff8e7; }
    .row-style-interco { background-color: #f3e5f5; }
    .row-style-autoconsumo { background-color: #fff1e6; }
    tbody tr.row-style-efectivo:nth-child(odd) { background-color: #dff2e3; }
    tbody tr.row-style-electronica:nth-child(odd) { background-color: #f0f1f2; }
    tbody tr.row-style-credito-nomina:nth-child(odd) { background-color: #dce5f0; }
    tbody tr.row-style-credito-formulas:nth-child(odd) { background-color: #d5e9f5; }
    tbody tr.row-style-gasto:nth-child(odd) { background-color: #fcf3d7; }
    tbody tr.row-style-interco:nth-child(odd) { background-color: #e1bee7; }
    tbody tr.row-style-autoconsumo:nth-child(odd) { background-color: #ffe6d6; }

    tfoot td { padding: 12px; background: #fafcfe; font-weight: 700; border-top: 1px solid #eef2f5; }
    tfoot tr.grand-total td { background-color: #e7f1ff; font-weight: bold; }
    tfoot tr.sub-grand-total td { background-color: #e9ecef; font-weight: bold; }
    .col-number, .col-total {text-align:right}
    .col-action{text-align:center;white-space:nowrap}
    .table-input {
      border:1px solid #dde2e7;background:#fdfdfd;width:100%;padding:10px;border-radius:6px;
      font-size:1rem;box-shadow:inset 0 1px 2px rgba(0,0,0,0.05); min-height:var(--touch);
    }
    .table-input:focus {
      background:#fff;border-color:var(--primary);outline:none;
      box-shadow:0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    .truncate{white-space: normal; word-break: break-word;}
    .status-pill{
      padding:6px 10px;border-radius:999px;font-weight:700;font-size:.85rem;
      border:1px solid var(--border);
    }
    .status-online{ background:#e6f8ee; color:#117a3a; border-color:#bfe8cf; }
    .status-offline{ background:#fff3f3; color:#b02a37; border-color:#f1c2c6; }
    @media (max-width: 600px){
      .actions-bar{flex-direction:column}
      table{min-width:720px}
      #action-buttons-container{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <main class="container" id="app">
    <header>
      <h1>Reporte de caja ARCADIA</h1>
      <p class="muted">
        Captura diaria con totales y guardado en la nube.
        El reporte lo consultas directamente en la hoja de c√°lculo.
      </p>
    </header>

    <section id="home">
      <div class="cards">
        <article class="card">
          <h3>Captura diaria</h3>
          <p class="muted">Registra el cierre del d√≠a, calcula totales y guarda en la nube.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="go-capture" class="btn btn-success">Abrir captura</button>
            <button id="resume-last" class="btn btn-ghost">Reanudar √∫ltima sesi√≥n</button>
          </div>
        </article>
      </div>
    </section>

    <hr/>

    <section id="capture" class="hidden">
      <div class="no-print" style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px">
        <button class="btn btn-ghost" id="back-home-1">‚¨Ö Volver al inicio</button>
        <span class="tag" id="resume-hint" title="Se cargar√°/guardar√° autom√°ticamente" style="display:none">
          Captura actual
        </span>
      </div>

      <section id="session-info-container">
        <div id="session-setup-fields" class="form-grid">
          <div>
            <label for="fecha">Fecha del reporte</label>
            <input id="fecha" type="date" required />
          </div>
          <div>
            <label for="puntoVenta">Punto de venta</label>
            <select id="puntoVenta" required></select>
          </div>
          <div style="align-self:end;">
            <button id="start-session-btn" class="btn btn-success" style="width:100%">
              Iniciar / Cambiar Sesi√≥n
            </button>
          </div>
        </div>

        <div id="session-info" class="hidden">
          <div>
            <strong>Fecha:</strong> <span id="session-date-display"></span> ‚Äî
            <strong>Punto:</strong> <span id="session-pos-display"></span>
          </div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div id="network-status" class="status-pill status-offline">Offline</div>
            <button id="toggle-formulas-btn" class="btn btn-ghost btn-small" type="button">
              üëÅÔ∏è Mostrar f√≥rmulas
            </button>
          </div>
        </div>
      </section>

      <div class="actions-bar no-print">
        <button id="add-nomina-btn" class="btn btn-primary">A√±adir Venta a Cr√©dito (Descuentos por n√≥mina)</button>
        <button id="add-formulas-btn" class="btn btn-info">A√±adir Venta a Cr√©dito (F√≥rmulas)</button>
        <button id="add-kardex-btn" class="btn btn-info">A√±adir Venta a Cr√©dito (Faltantes en kardex por n√≥mina)</button>
        <button id="add-interco-btn" class="btn btn-purple">A√±adir Venta a Cr√©dito (A empresas del grupo)</button>
        <button id="add-autoconsumo-btn" class="btn btn-info">A√±adir Venta a Cr√©dito (Autoconsumo)</button>
        <button id="add-gasto-btn" class="btn btn-warning">A√±adir Gasto en Efectivo</button>
      </div>

      <div class="records-container">
        <table id="recordsTable">
          <thead>
            <tr>
              <th style="width:32%;">Tipo de Operaci√≥n</th>
              <th class="col-number" style="width:12%;">Valor</th>
              <th class="col-number" style="width:12%;">Devoluciones</th>
              <th class="col-number" style="width:13%;">Total</th>
              <th style="width:15%;">Tercero / Destino</th>
              <th style="width:11%;">Detalle</th>
              <th class="col-action" style="width:5%;">Acci√≥n</th>
            </tr>
          </thead>
          <tbody id="recordsListBody"></tbody>
          <tfoot id="recordsTableFooter">
            <tr data-summary-id="total_ventas_efectivo">
              <td>Ventas de contado en efectivo</td>
              <td colspan="2"></td><td class="col-total"></td>
              <td colspan="3"></td>
            </tr>
            <tr data-summary-id="total_ventas_electronicas">
              <td>Total ventas por medios electronicos</td>
              <td colspan="2"></td><td class="col-total"></td>
              <td colspan="3"></td>
            </tr>
            <tr data-summary-id="total_ventas_credito">
              <td>Total ventas a credito</td>
              <td colspan="2"></td><td class="col-total"></td>
              <td colspan="3"></td>
            </tr>
            <tr class="sub-grand-total" data-summary-id="total_ventas_global">
              <td>Total ventas</td>
              <td colspan="2"></td><td class="col-total"></td>
              <td colspan="3"></td>
            </tr>
            <tr data-summary-id="total_gastos_efectivo">
              <td>Total gastos en efectivo</td>
              <td colspan="2"></td><td class="col-total"></td>
              <td colspan="3"></td>
            </tr>
            <tr class="grand-total" data-summary-id="total_esperado_tesoreria">
              <td>Total dinero a recibir por tesoreria</td>
              <td colspan="2"></td><td class="col-total"></td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div id="action-buttons-container"
           class="no-print"
           style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:12px">
        <button id="sendAllBtn" class="btn btn-primary">üì§ Guardar Todo en la Nube</button>
        <button id="clearAllBtn" class="btn btn-danger">üóëÔ∏è Limpiar y Finalizar Reporte</button>
      </div>
    </section>
  </main>

  <script>
    window.Arcadia = window.Arcadia || {};
    (function (A) {
      'use strict';

      A.CONFIG = {
        REPORT_TITLE: 'Reporte de caja ARCADIA',
        LS_RECORDS_KEY: 'salesGridRecords_v2',
        LS_SESSION_KEY: 'sessionGrid_v2',

        // Apps Script (Google Sheets)
        SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxeYCVLDzsiM97EOdWgov5pT8Mt8Spf1KXUye5eN70g16irwY6k3bTRPfCfPf9Ta3ZR/exec',
        API_KEY: '',

        // ‚úÖ √öNICO punto de venta requerido: Aroma
        PUNTOS_VENTA: ['Aroma'],

        EMPRESAS_GRUPO: ['Unidad Hemato O.','Sembrando Esperanza','Inversiones ARCADIA','Doctor Ahorro','Heritage','Distribuidora'],

        TIPOS_SIN_TERCERO: [],

        // Tipos donde Tercero/Destino es obligatorio (incluye Autoconsumo)
        TIPOS_REQUIEREN_EMPRESA: [
          'Ventas a cr√©dito (Descuentos por n√≥mina)',
          'Ventas a cr√©dito (F√≥rmulas)',
          'Ventas a cr√©dito (Faltantes en kardex que se descuentan por n√≥mina)',
          'Ventas a cr√©dito (A empresas del grupo)',
          'Ventas a cr√©dito (Autoconsumo)'
        ],

        TIPOS_EFECTIVO: ['Ventas de contado en efectivo'],
        TIPOS_ELECTRONICOS: ['Ventas de contado con QR','Ventas de contado con tarjeta debito','Ventas de contado con tarjeta de credito'],
        TIPOS_GASTO: ['Gasto en efectivo']
      };

      A.Utils = {
        safeNumber(val){
          if (typeof val === 'number') return isFinite(val) ? val : 0;
          let cleanStr = String(val ?? '0').trim();
          if (!cleanStr) return 0;
          cleanStr = cleanStr.replace(/[^0-9,.\-]/g, '');
          cleanStr = cleanStr.replace(/\./g, '').replace(/,/g, '.');
          const n = parseFloat(cleanStr);
          return isFinite(n) ? n : 0;
        },
        formatCurrency(num){
          return new Intl.NumberFormat('es-CO',{
            style:'currency', currency:'COP',
            minimumFractionDigits:0, maximumFractionDigits:0
          }).format(Math.round(num));
        },
        escapeHtml(s){
          return String(s == null ? '' : s)
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;');
        },
        nowDateISO(){ return new Date().toISOString().slice(0,10); },
        dateAddDays(iso, days){
          const d = new Date(iso);
          d.setDate(d.getDate()+days);
          return d.toISOString().slice(0,10);
        },
        yesterdayISO(){ return A.Utils.dateAddDays(A.Utils.nowDateISO(), -1); },
        uuidv4(){
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random()*16|0, v = c==='x' ? r : (r&0x3|0x8);
            return v.toString(16);
          });
        }
      };

      A.UI = {
        home: document.getElementById('home'),
        capture: document.getElementById('capture'),
        goCaptureBtn: document.getElementById('go-capture'),
        backHome1: document.getElementById('back-home-1'),
        resumeLastBtn: document.getElementById('resume-last'),
        resumeHint: document.getElementById('resume-hint'),

        sessionInfo: document.getElementById('session-info'),
        sessionDate: document.getElementById('session-date-display'),
        sessionPos: document.getElementById('session-pos-display'),
        networkStatus: document.getElementById('network-status'),

        recordsBody: document.getElementById('recordsListBody'),
        recordsFooter: document.getElementById('recordsTableFooter'),

        fechaInput: document.getElementById('fecha'),
        puntoVentaInput: document.getElementById('puntoVenta')
      };

      A.state = { session: { date: null, pos: null } };
      A.App = A.App || {};
    })(window.Arcadia);
  </script>

  <script>
    window.Arcadia = window.Arcadia || {};
    (function (A) {
      'use strict';
      const { CONFIG, UI } = A;
      const state = A.state;
      const App = A.App;

      function normalizeText(s){
        return String(s || '')
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      }

      Object.assign(App, {
        normalizeText,

        requiresEmpresaForTipo(tipo){
          return (CONFIG.TIPOS_REQUIEREN_EMPRESA || []).includes(tipo);
        },
        disableTerceroForTipo(tipo){
          return (CONFIG.TIPOS_SIN_TERCERO || []).includes(tipo);
        },
        isGastoTipo(tipo){
          const t = String(tipo || '');
          if ((CONFIG.TIPOS_GASTO || []).includes(t)) return true;
          const nt = this.normalizeText(t);
          return nt.startsWith('gasto en efectivo');
        },
        requiresTerceroObligatorioForTipo(tipo){
          return this.requiresEmpresaForTipo(tipo) || this.isGastoTipo(tipo);
        },
        validateEmpresaGrupo(records){
          const faltantes = (records || []).filter(r =>
            this.requiresTerceroObligatorioForTipo(r.tipo) &&
            !String(r.tercero || '').trim()
          );
          if (faltantes.length) {
            const tipos = Array.from(new Set(faltantes.map(f => f.tipo)));
            alert(
              'Debes seleccionar el Tercero / Destino para estos conceptos antes de enviar:\n\n' +
              tipos.map(t => `- ${t}`).join('\n')
            );
            return false;
          }
          return true;
        },

        updateNetworkStatus(){
          const online = navigator.onLine;
          UI.networkStatus?.classList.toggle('status-online', online);
          UI.networkStatus?.classList.toggle('status-offline', !online);
          if (UI.networkStatus) UI.networkStatus.textContent = online ? 'Online' : 'Offline';
        },

        getStorageKey(){
          if (!state.session.date || !state.session.pos) return null;
          return `${CONFIG.LS_RECORDS_KEY}_${state.session.date}_${state.session.pos}`;
        },
        saveSession(){
          localStorage.setItem(CONFIG.LS_SESSION_KEY, JSON.stringify(state.session));
        },
        loadSession(){
          state.session = JSON.parse(localStorage.getItem(CONFIG.LS_SESSION_KEY)) || { date: null, pos: null };

          // ‚úÖ Si exist√≠a una sesi√≥n antigua con otro punto de venta, se invalida (solo queda "Aroma")
          const allowed = new Set(CONFIG.PUNTOS_VENTA || []);
          if (state.session.pos && !allowed.has(state.session.pos)) {
            state.session.pos = null;
            this.saveSession();
          }
        }
      });
    })(window.Arcadia);
  </script>

  <script>
    window.Arcadia = window.Arcadia || {};
    (function (A) {
      'use strict';
      const { CONFIG, Utils, UI } = A;
      const state = A.state;
      const App = A.App;

      const LS_SHOW_FORMULAS = 'captureFooterShowFormulas_v1';
      let footerMetaBuilt = false;
      let showFooterFormulas = false;
      const footerMeta = {};

      const TERCERO_OTROS  = 'Otros';
      const TERCERO_VARIAS = 'Varias';

      function escapeAttr(s){ return Utils.escapeHtml(String(s ?? '')); }

      function buildTerceroSelectHtml(selectedValue, { required = false } = {}){
        const selected = String(selectedValue || '');
        const empresas = CONFIG.EMPRESAS_GRUPO || [];

        const placeholder = required
          ? '<option value="">Seleccione...</option>'
          : '<option value="">(Opcional) Seleccione...</option>';

        const empresasOptions = empresas.map(e => {
          const isSel = selected === e ? 'selected' : '';
          return `<option value="${escapeAttr(e)}" ${isSel}>${escapeAttr(e)}</option>`;
        }).join('');

        const otrosSel  = selected === TERCERO_OTROS  ? 'selected' : '';
        const variasSel = selected === TERCERO_VARIAS ? 'selected' : '';

        return `
          <select class="table-input" data-field="tercero" ${required ? 'required' : ''}>
            ${placeholder}
            ${empresasOptions}
            <option value="${TERCERO_OTROS}" ${otrosSel}>${TERCERO_OTROS}</option>
            <option value="${TERCERO_VARIAS}" ${variasSel}>${TERCERO_VARIAS}</option>
          </select>
        `;
      }

      Object.assign(App, {
        populatePuntoVentaSelect(){
          const select = UI.puntoVentaInput;

          select.innerHTML = '<option value="">Seleccione...</option>';
          (CONFIG.PUNTOS_VENTA || []).forEach(pv => {
            select.innerHTML += `<option value="${Utils.escapeHtml(pv)}">${Utils.escapeHtml(pv)}</option>`;
          });

          // ‚úÖ Si solo hay un punto de venta, se selecciona y se bloquea el selector
          const puntos = (CONFIG.PUNTOS_VENTA || []);
          if (puntos.length === 1) {
            select.value = puntos[0];
            select.disabled = true;
          } else {
            select.disabled = false;
          }
        },

        buildFooterFormulaMeta(){
          const joinPlus = (arr) => (arr || []).filter(Boolean).join(' + ');
          const joinMinus = (...parts) => parts.filter(p => String(p || '').trim()).join(' - ');

          const efectivoTxt    = joinPlus(CONFIG.TIPOS_EFECTIVO || []);
          const electronicaTxt = joinPlus(CONFIG.TIPOS_ELECTRONICOS || []);
          const gastoTxt       = joinPlus(CONFIG.TIPOS_GASTO || []);

          const creditoOrder = [
            'Ventas a cr√©dito (A empresas del grupo)',
            'Ventas a cr√©dito (Descuentos por n√≥mina)',
            'Ventas a cr√©dito (F√≥rmulas)',
            'Ventas a cr√©dito (Faltantes en kardex que se descuentan por n√≥mina)',
            'Ventas a cr√©dito (Autoconsumo)'
          ];
          const creditoSet = new Set(CONFIG.TIPOS_REQUIEREN_EMPRESA || []);
          const creditoOrdered = creditoOrder.filter(t => creditoSet.has(t));
          const creditoExtras = (CONFIG.TIPOS_REQUIEREN_EMPRESA || []).filter(t => !creditoOrder.includes(t));
          const creditoTiposFinal = [...creditoOrdered, ...creditoExtras];

          const creditoConceptsTxt = joinPlus(creditoTiposFinal);

          // Seg√∫n tu cuadro:
          // - "Ventas de contado en efectivo" es el efectivo de ventas (no se resta cr√©dito)
          // - "Total dinero a recibir por tesorer√≠a" = Ventas de contado en efectivo - Total gastos en efectivo
          const ventasContadoEfectivoTxt = efectivoTxt;

          const tesoreriaTxt = joinMinus(
            efectivoTxt,
            gastoTxt ? `(${gastoTxt})` : ''
          );

          const totalVentasTxt = 'Ventas de contado en efectivo + Total ventas por medios electronicos + Total ventas a credito';

          footerMeta['total_ventas_efectivo'] = { base: 'Ventas de contado en efectivo', formula: ventasContadoEfectivoTxt };
          footerMeta['total_ventas_electronicas'] = { base: 'Total ventas por medios electronicos', formula: electronicaTxt };
          footerMeta['total_ventas_credito'] = { base: 'Total ventas a credito', formula: creditoConceptsTxt };
          footerMeta['total_ventas_global'] = { base: 'Total ventas', formula: totalVentasTxt };
          footerMeta['total_gastos_efectivo'] = { base: 'Total gastos en efectivo', formula: gastoTxt };
          footerMeta['total_esperado_tesoreria'] = { base: 'Total dinero a recibir por tesoreria', formula: tesoreriaTxt };

          footerMetaBuilt = true;
        },

        applyFooterLabels(){
          if (!UI.recordsFooter) return;
          if (!footerMetaBuilt) this.buildFooterFormulaMeta();

          Object.keys(footerMeta).forEach(summaryId => {
            const tr = UI.recordsFooter.querySelector(`[data-summary-id="${summaryId}"]`);
            if (!tr) return;
            const firstTd = tr.querySelector('td');
            if (!firstTd) return;

            const meta = footerMeta[summaryId] || {};
            const base = String(meta.base || '').trim();
            const formula = String(meta.formula || '').trim();
            if (!base) return;

            firstTd.textContent = (showFooterFormulas && formula) ? `${base} (${formula})` : base;
          });
        },

        initFooterFormulaToggle(){
          showFooterFormulas = (localStorage.getItem(LS_SHOW_FORMULAS) === '1');
          this.applyFooterLabels();

          const btn = document.getElementById('toggle-formulas-btn');
          if (!btn) return;

          const paintBtn = () => {
            btn.textContent = showFooterFormulas ? 'üôà Ocultar f√≥rmulas' : 'üëÅÔ∏è Mostrar f√≥rmulas';
          };
          paintBtn();

          btn.addEventListener('click', () => {
            showFooterFormulas = !showFooterFormulas;
            localStorage.setItem(LS_SHOW_FORMULAS, showFooterFormulas ? '1' : '0');
            this.applyFooterLabels();
            paintBtn();
          });
        },

        bindCaptureEvents(){
          document.getElementById('start-session-btn').addEventListener('click', () => {
            const fecha = UI.fechaInput.value;
            const puntoVenta = UI.puntoVentaInput.value;
            if (!fecha || !puntoVenta) {
              alert('Por favor, seleccione fecha y punto de venta.');
              return;
            }
            const ayer = Utils.yesterdayISO();
            if (fecha !== ayer && !confirm(`Vas a abrir la sesi√≥n para ${fecha} (no es el d√≠a anterior: ${ayer}). ¬øContinuar?`)) {
              return;
            }

            const prevKey = this.getStorageKey();
            if (prevKey && localStorage.getItem(prevKey)) {
              if (!confirm('Hay datos locales de la sesi√≥n anterior. Si cambias de sesi√≥n podr√≠an perderse. ¬øContinuar?')) {
                return;
              }
            }
            this.startSession(fecha, puntoVenta);
          });

          document.getElementById('add-nomina-btn').addEventListener('click', () =>
            this.addRow({ tipo: 'Ventas a cr√©dito (Descuentos por n√≥mina)', category: 'credito', isRemovable: true, styleHint: 'credito-nomina' })
          );

          document.getElementById('add-formulas-btn').addEventListener('click', () =>
            this.addRow({ tipo: 'Ventas a cr√©dito (F√≥rmulas)', category: 'credito', isRemovable: true, styleHint: 'credito-formulas' })
          );

          document.getElementById('add-kardex-btn').addEventListener('click', () =>
            this.addRow({ tipo: 'Ventas a cr√©dito (Faltantes en kardex que se descuentan por n√≥mina)', category: 'credito', isRemovable: true, styleHint: 'credito-nomina' })
          );

          document.getElementById('add-interco-btn').addEventListener('click', () =>
            this.addRow({ tipo: 'Ventas a cr√©dito (A empresas del grupo)', category: 'credito', isRemovable: true, styleHint: 'interco' })
          );

          document.getElementById('add-autoconsumo-btn').addEventListener('click', () =>
            this.addRow({ tipo: 'Ventas a cr√©dito (Autoconsumo)', category: 'credito', isRemovable: true, styleHint: 'autoconsumo' })
          );

          document.getElementById('add-gasto-btn').addEventListener('click', () =>
            this.addRow({ tipo: 'Gasto en efectivo', category: 'gasto', isRemovable: true, styleHint: 'gasto' })
          );

          UI.recordsBody.addEventListener('input', (e) => this.handleTableInput(e));
          UI.recordsBody.addEventListener('change', (e) => this.handleTableInput(e));
          UI.recordsBody.addEventListener('click', (e) => this.handleTableClick(e));

          document.getElementById('sendAllBtn').addEventListener('click', () => this.handleSendAll());
          document.getElementById('clearAllBtn').addEventListener('click', () => this.handleClearAll());

          this.initFooterFormulaToggle();
        },

        handleTableInput(e){
          const target = e.target;
          if (!target.classList.contains('table-input')) return;

          const field = target.dataset.field;
          if (field !== 'valor' && field !== 'devoluciones' && field !== 'tercero' && field !== 'detalle') return;

          const tr = target.closest('tr');
          if (!tr) return;

          if (field === 'valor' || field === 'devoluciones') {
            const val = Utils.safeNumber(tr.querySelector('[data-field="valor"]').value);
            const dev = Utils.safeNumber(tr.querySelector('[data-field="devoluciones"]').value);
            const total = val - dev;
            const totalCell = tr.querySelector('.col-total');
            if (totalCell) totalCell.textContent = Utils.formatCurrency(total);
            this.updateTotalsDisplay();
          }
          this.saveRecords();
        },

        handleTableClick(e){
          const btn = e.target.closest('button');
          if (!btn) return;

          if (btn.dataset.action === 'delete') {
            const tr = btn.closest('tr');
            if (tr && confirm('¬øEliminar fila?')) {
              tr.remove();
              this.updateTotalsDisplay();
              this.saveRecords();
            }
          }
        },

        startSession(date, pos, fromStorage = false){
          state.session.date = date;
          state.session.pos = pos;
          this.saveSession();

          UI.sessionDate.textContent = date;
          UI.sessionPos.textContent = pos;

          document.getElementById('session-setup-fields').classList.add('hidden');
          UI.sessionInfo.classList.remove('hidden');

          const key = this.getStorageKey();
          if (fromStorage) {
            this.loadRecords();
          } else {
            if (key && localStorage.getItem(key)) {
              const reanudar = confirm(
                'Ya existen datos guardados localmente para esta fecha y punto.\n' +
                '¬øDeseas reanudarlos en lugar de iniciar desde cero?'
              );
              if (reanudar) this.loadRecords();
              else {
                localStorage.removeItem(key);
                this.createInitialRows();
                this.saveRecords();
              }
            } else {
              this.createInitialRows();
              this.saveRecords();
            }
          }

          this.applyFooterLabels();
          this.updateTotalsDisplay();
        },

        createInitialRows(){
          UI.recordsBody.innerHTML = '';
          const initialData = [
            { tipo: 'Ventas de contado en efectivo', category: 'efectivo', styleHint: 'efectivo' },
            { tipo: 'Ventas de contado con QR', category: 'electronica', styleHint: 'electronica' },
            { tipo: 'Ventas de contado con tarjeta debito', category: 'electronica', styleHint: 'electronica' },
            { tipo: 'Ventas de contado con tarjeta de credito', category: 'electronica', styleHint: 'electronica' },
          ];
          initialData.forEach(data => this.addRow(data, true));
          this.saveRecords();
        },

        addRow(data = {}, skipSave = false){
          const defaults = {
            id: Utils.uuidv4(),
            tipo: '',
            valor: 0,
            devoluciones: 0,
            tercero: '',
            detalle: '',
            isRemovable: false,
            category: 'default',
            styleHint: 'electronica'
          };
          const record = { ...defaults, ...data };

          const tr = document.createElement('tr');
          tr.dataset.id = record.id;
          tr.dataset.category = record.category;
          tr.dataset.styleHint = record.styleHint;
          tr.classList.add(`row-style-${record.styleHint}`);

          const total = Utils.safeNumber(record.valor) - Utils.safeNumber(record.devoluciones);

          const terceroDisabled = this.disableTerceroForTipo(record.tipo);
          const terceroRequired = this.requiresTerceroObligatorioForTipo(record.tipo);

          let terceroCellHtml = '';
          if (terceroDisabled) {
            terceroCellHtml = `
              <input type="text" class="table-input" data-field="tercero" value="" placeholder="No aplica" disabled>
            `;
          } else {
            terceroCellHtml = buildTerceroSelectHtml(record.tercero, { required: terceroRequired });
          }

          tr.innerHTML = `
            <td class="truncate" title="${Utils.escapeHtml(record.tipo)}">${Utils.escapeHtml(record.tipo)}</td>
            <td class="col-number"><input type="text" inputmode="decimal" class="table-input" data-field="valor" value="${record.valor || ''}" placeholder="0"></td>
            <td class="col-number"><input type="text" inputmode="decimal" class="table-input" data-field="devoluciones" value="${record.devoluciones || ''}" placeholder="0"></td>
            <td class="col-total" data-field="total">${Utils.formatCurrency(total)}</td>
            <td>${terceroCellHtml}</td>
            <td><input type="text" class="table-input" data-field="detalle" value="${Utils.escapeHtml(record.detalle || '')}"></td>
            <td class="col-action">${record.isRemovable ? '<button class="btn btn-danger btn-small" data-action="delete">Borrar</button>' : ''}</td>
          `;

          UI.recordsBody.appendChild(tr);

          const firstInput = tr.querySelector('[data-field="valor"]');
          if (firstInput) firstInput.focus();

          if (!skipSave) {
            this.saveRecords();
            this.updateTotalsDisplay();
          }
          return tr;
        },

        getCalculatedState(){
          let efectivo = 0, electronica = 0, credito = 0, gasto = 0;

          UI.recordsBody.querySelectorAll('tr[data-id]').forEach(tr => {
            const valor = Utils.safeNumber(tr.querySelector('[data-field="valor"]').value);
            const devoluciones = Utils.safeNumber(tr.querySelector('[data-field="devoluciones"]').value);
            const currentTotal = valor - devoluciones;

            tr.querySelector('[data-field="total"]').textContent = Utils.formatCurrency(currentTotal);

            const category = tr.dataset.category;
            switch (category) {
              case 'efectivo': efectivo += currentTotal; break;
              case 'electronica': electronica += currentTotal; break;
              case 'credito': credito += currentTotal; break;
              case 'gasto': gasto += currentTotal; break;
            }
          });

          // Refleja tu cuadro:
          // - Ventas de contado en efectivo = total de la categor√≠a "efectivo"
          // - Total ventas = efectivo + electr√≥nicas + cr√©dito
          // - Total dinero a recibir por tesorer√≠a = efectivo - gastos en efectivo
          const ventasContadoEfectivo = efectivo;
          const ventasElectronicas = electronica;
          const ventasCredito = credito;
          const ventasGlobal = ventasContadoEfectivo + ventasElectronicas + ventasCredito;
          const gastosEfectivo = gasto;
          const esperadoTesoreria = ventasContadoEfectivo - gastosEfectivo;

          return { summary: { ventasContadoEfectivo, ventasElectronicas, ventasCredito, gastosEfectivo, ventasGlobal, esperadoTesoreria } };
        },

        updateTotalsDisplay(){
          this.applyFooterLabels();
          const s = this.getCalculatedState().summary;

          UI.recordsFooter.querySelector('[data-summary-id="total_ventas_efectivo"] .col-total').textContent = Utils.formatCurrency(s.ventasContadoEfectivo);
          UI.recordsFooter.querySelector('[data-summary-id="total_ventas_electronicas"] .col-total').textContent = Utils.formatCurrency(s.ventasElectronicas);
          UI.recordsFooter.querySelector('[data-summary-id="total_ventas_credito"] .col-total').textContent = Utils.formatCurrency(s.ventasCredito);
          UI.recordsFooter.querySelector('[data-summary-id="total_gastos_efectivo"] .col-total').textContent = Utils.formatCurrency(s.gastosEfectivo);
          UI.recordsFooter.querySelector('[data-summary-id="total_ventas_global"] .col-total').textContent = Utils.formatCurrency(s.ventasGlobal);
          UI.recordsFooter.querySelector('[data-summary-id="total_esperado_tesoreria"] .col-total').textContent = Utils.formatCurrency(s.esperadoTesoreria);
        },

        getRecordsFromTable(){
          const records = [];
          UI.recordsBody.querySelectorAll('tr[data-id]').forEach(tr => {
            const valor = Utils.safeNumber(tr.querySelector('[data-field="valor"]').value);
            const devoluciones = Utils.safeNumber(tr.querySelector('[data-field="devoluciones"]').value);
            if (valor !== 0 || devoluciones !== 0) {
              records.push({
                id: tr.dataset.id,
                tipo: tr.cells[0].textContent,
                valor,
                devoluciones,
                total: valor - devoluciones,
                tercero: tr.querySelector('[data-field="tercero"]').value,
                detalle: tr.querySelector('[data-field="detalle"]').value,
                category: tr.dataset.category,
              });
            }
          });
          return records;
        },

        async handleSendAll(){
          const records = this.getRecordsFromTable();
          if (records.length === 0) { alert('No hay registros con valores para guardar.'); return; }
          if (!this.validateEmpresaGrupo(records)) return;

          const btn = document.getElementById('sendAllBtn');
          btn.disabled = true;
          btn.textContent = 'Guardando...';

          const detailData = records.map(r => ({
            fecha: state.session.date,
            puntoVenta: state.session.pos,
            tipo: r.tipo,
            tercero: r.tercero || '',
            detalle: r.detalle || '',
            valor: Number(r.total || 0)
          }));

          const s = this.getCalculatedState().summary;
          const totalData = [
            { tipo: 'Ventas de contado en efectivo',          valor: s.ventasContadoEfectivo },
            { tipo: 'Total ventas por medios electronicos',   valor: s.ventasElectronicas },
            { tipo: 'Total ventas a credito',                 valor: s.ventasCredito },
            { tipo: 'Total ventas',                           valor: s.ventasGlobal },
            { tipo: 'Total gastos en efectivo',               valor: s.gastosEfectivo },
            { tipo: 'Total dinero a recibir por tesoreria',   valor: s.esperadoTesoreria }
          ].map(t => ({
            fecha: state.session.date,
            puntoVenta: state.session.pos,
            tipo: t.tipo,
            tercero: '',
            detalle: '',
            valor: Number(t.valor || 0)
          }));

          const dataToSend = [...detailData, ...totalData];

          try{
            const url = A.CONFIG.SCRIPT_URL + (A.CONFIG.API_KEY ? ('?key='+encodeURIComponent(A.CONFIG.API_KEY)) : '');
            const response = await fetch(url, {
              method:'POST',
              body: JSON.stringify(dataToSend),
              headers:{'Content-Type':'text/plain;charset=utf-8'}
            });

            const text = await response.text();
            let result;
            try { result = JSON.parse(text); }
            catch { throw new Error('Respuesta no v√°lida del servidor.'); }

            if (!response.ok || result.result !== 'success') {
              throw new Error(result.error || `Error del servidor (HTTP ${response.status}).`);
            }

            alert('¬°Registros (detalles + totales) guardados con √©xito!');
            btn.textContent = '‚úîÔ∏è Guardado';
          }catch(error){
            console.error("Error al enviar datos:", error);
            alert('Error: No se pudieron guardar los registros.');
            btn.disabled = false;
            btn.textContent = 'üì§ Guardar Todo en la Nube';
          }
        },

        handleClearAll(){
          if(confirm('¬øFinalizar el reporte? Se limpiar√°n todos los registros y la sesi√≥n.')) {
            localStorage.removeItem(this.getStorageKey());
            localStorage.removeItem(CONFIG.LS_SESSION_KEY);
            location.reload();
          }
        },

        saveRecords(){
          const key = this.getStorageKey();
          if (!key) return;

          const records = [];
          UI.recordsBody.querySelectorAll('tr[data-id]').forEach(tr => {
            records.push({
              id: tr.dataset.id,
              tipo: tr.cells[0].textContent,
              valor: tr.querySelector('[data-field="valor"]').value,
              devoluciones: tr.querySelector('[data-field="devoluciones"]').value,
              tercero: tr.querySelector('[data-field="tercero"]').value,
              detalle: tr.querySelector('[data-field="detalle"]').value,
              category: tr.dataset.category,
              styleHint: tr.dataset.styleHint,
              isRemovable: !!tr.querySelector('[data-action="delete"]'),
            });
          });
          localStorage.setItem(key, JSON.stringify(records));
        },

        loadRecords(){
          const key = this.getStorageKey();
          if (!key) return;

          const savedRecords = JSON.parse(localStorage.getItem(key)) || [];
          UI.recordsBody.innerHTML = '';

          if (savedRecords.length > 0) savedRecords.forEach(rec => this.addRow(rec, true));
          else this.createInitialRows();
        }
      });
    })(window.Arcadia);
  </script>
    <script>
    window.Arcadia = window.Arcadia || {};
    (function (A) {
      'use strict';
      const { Utils, UI } = A;
      const state = A.state;
      const App = A.App;

      Object.assign(App, {
        init(){
          this.populatePuntoVentaSelect();
          this.loadSession();
          this.bindNav();
          this.bindCaptureEvents();
          this.updateNetworkStatus();

          window.addEventListener('online', () => this.updateNetworkStatus());
          window.addEventListener('offline', () => this.updateNetworkStatus());

          if (UI.fechaInput && !UI.fechaInput.value) UI.fechaInput.value = Utils.yesterdayISO();

          // Con un solo punto de venta, el bot√≥n sigue funcionando (reanuda la √∫ltima sesi√≥n si existe)
          UI.resumeLastBtn.disabled = !(state.session.date && state.session.pos);
        },

        bindNav(){
          UI.goCaptureBtn.addEventListener('click', () => this.showSection('capture'));
          UI.backHome1.addEventListener('click', () => this.showSection('home'));

          UI.resumeLastBtn.addEventListener('click', () => {
            if(state.session.date && state.session.pos){
              this.showSection('capture');
              this.startSession(state.session.date, state.session.pos, true);
              UI.resumeHint.style.display = '';
            }
          });
        },

        showSection(name){
          UI.home.classList.toggle('hidden', name!=='home');
          UI.capture.classList.toggle('hidden', name!=='capture');

          if(name==='capture' && !(state.session.date && state.session.pos)){
            UI.fechaInput.value = Utils.yesterdayISO();
          }
        }
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => App.init());
      } else {
        App.init();
      }
    })(window.Arcadia);
  </script>
</body>
</html>

  
