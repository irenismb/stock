<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat√°logo de Productos - Irenis Mendoza</title>
    
    <!-- LIBRER√çA DE GOOGLE SIGN-IN -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GYVVFP8XCK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-GYVVFP8XCK');
    </script>
    
    <style>
        /* ... (CSS para el dise√±o responsive y est√©tica) ... */
        :root{--primary-color:#007bff;--secondary-color:#25D366;--background-color:#f4f4f9;--text-color:#333;--card-bg-color:#fff;--border-color:#ddd}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;margin:0;padding:10px;background-color:var(--background-color);color:var(--text-color)}
        h1{text-align:center;margin-bottom:15px;margin-top:0;font-size:24px}
        h2{font-size:20px;color:#555;border-bottom:2px solid var(--primary-color);padding-bottom:5px;margin-bottom:8px}
        h3{font-size:18px;color:#0056b3}
        .container{display:flex;gap:15px;align-items:flex-start}
        .left-panel{flex:3 1 700px;display:flex;flex-direction:column}
        .controls-panel{flex-shrink:0}
        .right-panel{flex:1 1 280px;position:sticky;top:10px;display:flex;flex-direction:column;gap:15px;max-height:calc(100vh - 20px);overflow-y:auto}
        .cart-container{background-color:#e9f5ff;padding:15px;border-radius:8px;border:1px solid #bde0fe}
        .contact-info{padding:15px;background-color:var(--card-bg-color);border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.05)}
        .contact-info h3{margin-top:0;margin-bottom:10px;font-size:16px;text-align:center}
        .contact-info p{margin:6px 0;font-size:14px;line-height:1.5;text-align:center}
        .contact-info a{color:var(--primary-color);text-decoration:none}
        .contact-info a:hover{text-decoration:underline}
        .category-container{background-color:var(--card-bg-color);padding:10px 15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.1);margin-bottom:10px}
        .products-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px}
        .left-controls{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
        .search-filters{display:flex;align-items:center;gap:8px;flex:1;min-width:0}
        #searchInput{flex:1;min-width:0;padding:10px 12px;border:1px solid #ccc;border-radius:5px;background-color:var(--card-bg-color);font-size:16px;box-sizing:border-box}
        .dropdown-toggle-btn{padding:10px 12px;border:1px solid #ccc;border-radius:5px;background:var(--card-bg-color);cursor:pointer;white-space:nowrap;font-size:14px;color:var(--text-color)}
        .custom-dropdown{position:relative}
        .custom-menu{position:absolute;top:calc(100% + 6px);right:0;left:auto;background:var(--card-bg-color);border:1px solid var(--border-color);padding:8px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.08);display:none;z-index:50;max-height:220px;overflow:auto;min-width:200px}
        #categoryMenu{right:auto;left:0}
        .custom-dropdown.open .custom-menu{display:block}
        .custom-menu label{display:block;margin-bottom:6px;cursor:pointer;font-size:14px}
        .custom-menu input[type="checkbox"],.custom-menu input[type="radio"]{margin-right:8px}
        #sortPriceBtn{padding:8px 12px;font-size:14px;border:1px solid #ccc;background-color:#f8f9fa;border-radius:5px;cursor:pointer;transition:background-color .2s,border-color .2s;white-space:nowrap}
        #sortPriceBtn:hover{background-color:#e9ecef}
        #sortPriceBtn.active{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
        #adminModeBtn{padding:8px 12px;font-size:14px;border:none;border-radius:5px;cursor:pointer;transition:background-color .2s;background-color:#6c757d;color:white}
        #adminModeBtn.active{background-color:#dc3545}
        /* Contenedor para el bot√≥n de Google */
        #googleSignInContainer{display:none; margin-left: 8px;}

        .table-wrapper{border-radius:8px;overflow:hidden}
        .product-table{width:100%;border-collapse:collapse;background-color:var(--card-bg-color)}
        .product-table td,.product-table th{border:1px solid var(--border-color);padding:10px;text-align:left;vertical-align:middle}
        .product-table th{background-color:var(--primary-color);color:#fff;font-size:14px;text-align:center}
        .product-table td{font-size:15px}
        .product-table tr:nth-child(even){background-color:#f8f9fa}
        .quantity-control{display:flex;align-items:center;justify-content:center}
        .quantity-btn{background-color:#e9ecef;border:1px solid #ced4da;color:#495057;cursor:pointer;font-size:1.2rem;font-weight:700;width:30px;height:30px;line-height:28px;text-align:center;-webkit-user-select:none;user-select:none}
        .quantity-btn:hover{background-color:#dee2e6}
        .decrease-btn{border-radius:4px 0 0 4px}
        .increase-btn{border-radius:0 4px 4px 0}
        .quantity-input{width:45px;height:28px;padding:5px;text-align:center;border:1px solid #ced4da;border-left:none;border-right:none;border-radius:0;-moz-appearance:textfield;background-color:#fff}
        .quantity-input:read-only{background-color:#f8f9fa}
        .quantity-input[disabled]{background-color:#fefde8}
        .quantity-input::-webkit-inner-spin-button,.quantity-input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        .price-cell{font-weight:700;color:#2a9d8f}
        #whatsappBtn{background-color:var(--secondary-color);color:#fff;width:100%;border:none;padding:12px 20px;font-size:16px;border-radius:5px;cursor:pointer;margin-top:10px}
        #whatsappBtn:hover{background-color:#1da851}
        #cartList{list-style-type:none;padding-left:0;max-height:250px;overflow-y:auto}
        #cartList li{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;border-bottom:1px solid #ccc;padding-bottom:5px;font-size:14px}
        #totalPrice{margin-top:15px;font-size:18px;font-weight:700;text-align:right}
        .remove-item-btn{background:0 0;border:none;color:#dc3545;cursor:pointer;font-weight:700;font-size:16px;padding:5px}
        .remove-item-btn:hover{color:#a71d2a}
        #clearCartBtn{background-color:#6c757d;color:#fff;width:100%;border:none;padding:8px 15px;font-size:14px;border-radius:5px;cursor:pointer;margin-top:10px}
        #clearCartBtn:hover{background-color:#5a6268}
        footer{display:none}
        .product-name-clickable{color:var(--primary-color);cursor:pointer;font-weight:500}
        .product-name-clickable:hover{text-decoration:underline}
        .product-image-display{background-color:var(--card-bg-color);padding:15px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,.05);display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:150px;text-align:center;gap:10px}
        #displayedProductImage{max-width:100%;max-height:200px;height:auto;border-radius:5px;object-fit:contain}
        .image-caption{font-size:1.1em;font-weight:700;color:var(--text-color);margin:0}
        @media (max-width:768px){body{overflow:auto;padding:10px}h1{font-size:20px}.container{flex-direction:column-reverse;height:auto;gap:15px}.left-panel,.right-panel{flex:1 1 100%;width:100%;height:auto}.right-panel{flex-direction:column-reverse;position:static;max-height:none;overflow-y:visible}.table-wrapper{overflow-y:visible}.product-table thead{display:none}.product-table tr{display:block;margin-bottom:15px;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.05);padding:10px}.product-table tr:nth-child(even){background-color:var(--card-bg-color)}.product-table td{display:flex;justify-content:space-between;align-items:center;text-align:right;font-size:15px;border:none;border-bottom:1px dotted #ccc;padding:8px 8px 8px 0;position:relative}.product-table td:last-child{border-bottom:0}.product-table td::before{content:attr(data-label);text-align:left;font-weight:700;position:static;width:auto}.quantity-control{justify-content:flex-end}#cartList{max-height:none}.product-image-display{order:-1;margin-bottom:15px}#displayedProductImage{max-height:150px}.left-controls{flex-direction:column;align-items:stretch;gap:8px}.search-filters{flex-direction:column;align-items:stretch}.custom-dropdown .custom-menu{left:0;right:auto}}
    </style>
</head>
<body>
    <h1>Cat√°logo Interactivo de Productos</h1>
    <div class="container">
        <div class="left-panel">
            <div class="controls-panel">
                <div class="products-header">
                    <div class="left-controls">
                        <div class="search-filters">
                            <input type="text" id="searchInput" placeholder="üîç Buscar por nombre, marca, categor√≠a...">
                            <!-- Dropdowns de filtro (sin cambios) -->
                            <div class="custom-dropdown" id="categoryDropdown">
                                <button type="button" id="categoryToggleBtn" class="dropdown-toggle-btn">Categor√≠as ‚ñæ</button>
                                <div id="categoryMenu" class="custom-menu" aria-hidden="true"></div>
                            </div>
                            <div class="custom-dropdown" id="brandDropdown">
                                <button type="button" id="brandToggleBtn" class="dropdown-toggle-btn">Marcas ‚ñæ</button>
                                <div id="brandMenu" class="custom-menu" aria-hidden="true"></div>
                            </div>
                        </div>
                    </div>
                    <button id="sortPriceBtn">Ordenar por precio</button>
                    
                    <!-- --- INICIO CAMBIO HTML --- -->
                    <!-- Bot√≥n de admin (Ahora es para Salir / Mostrar login) -->
                    <button id="adminModeBtn">üîë Admin</button>
                    <!-- Contenedor para el bot√≥n oficial de Google -->
                    <div id="googleSignInContainer"></div>
                    <!-- --- FIN CAMBIO HTML --- -->

                </div>
            </div>
            <div class="table-wrapper">
                <table class="product-table">
                    <thead>
                        <tr>
                            <th>Nombre producto</th>
                            <th>Categor√≠a</th>
                            <th>Marca</th>
                            <th>Valor unitario</th>
                            <th>Cantidad</th>
                            <th>Total a pagar</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr id="loading-row"><td colspan="6" style="text-align:center;">Cargando productos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="right-panel">
            <!-- Panel derecho (sin cambios) -->
            <div id="productImageDisplay" class="product-image-display">
                <img id="displayedProductImage" src="" alt="Imagen del producto" style="display:none;">
                <p id="displayedProductCaption" class="image-caption">Haz clic en un producto para ver su imagen</p>
            </div>
            <div class="cart-container">
                <h3>üõí Carrito de Compras</h3>
                <ul id="cartList"><li>El carrito est√° vac√≠o.</li></ul>
                <div id="totalPrice">Total: 0</div>
                <button id="clearCartBtn">Vaciar Carrito</button>
                <button id="whatsappBtn">Comprar por WhatsApp</button>
            </div>
            <div class="contact-info">
                <h3>‚ú® Contacto y Ubicaci√≥n ‚ú®</h3>
                <p>üì± WhatsApp y llamadas: <a href="#" id="contactWhatsappLink">3042088961</a></p>
                <p>üìç Ubicaci√≥n: Estamos en Santa Marta. ¬°Hacemos env√≠os a toda Colombia y pagos contra entrega en Santa Marta!</p>
                <p>üó∫Ô∏è Vis√≠tanos (GPS): <a href="https://www.google.com/maps" target="_blank" rel="noopener noreferrer">Ver en Google Maps</a></p>
                <hr>
                <h3>üåê ¬°S√≠guenos en Nuestras Redes! üåê</h3>
                <p>üëç <a href="https://www.facebook.com/marketplace/profile/100084865295132" target="_blank" rel="noopener noreferrer">Facebook</a></p>
                <p>üì∏ <a href="https://www.instagram.com/irenismb_stocknaturasm" target="_blank" rel="noopener noreferrer">Instagram</a></p>
                <p>üéµ <a href="https://www.tiktok.com/@irenismbstocknatura" target="_blank" rel="noopener noreferrer">TikTok</a></p>
            </div>
        </div>
    </div>
    <footer></footer>

<script>
    // --- URL DE DATOS (lectura) ---
    // URL de la hoja publicada como TSV.
    const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBTeqbaoB-5-b_h98cslcSic_6QcA1lCkCQagpF8q-yxcr1okC9TEuIYAZDgTL1DSCvdPtwBrApGj6/pub?gid=732037573&single=true&output=tsv';

    // --- CONFIGURACI√ìN DE IMAGEN ---
    const imageBaseUrl = "https://irenismb.github.io/stock/imagenes/"; 
    const imageExtension = ".jpg"; 
    // ---------------------------------

    // --- ¬°¬°¬°CONFIGURACI√ìN DE ADMIN!!! ---
    
    // 1. URL de la App Script que modifica el stock (la que obtuviste de la implementaci√≥n)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzfK4aeNJAJxfLg4Pav0A6J3nOExJssVieG-dPD6OV-mNL55fY7imS61RRrn0v-9V1I/exec"; 
    
    // 2. Client ID de Google Cloud Console
    const GOOGLE_CLIENT_ID = "575624026373-nm1ienpvaaa4its9070pv182quqf544m.apps.googleusercontent.com"; 
    // ---------------------------------

    let products = [];
    let isAdminMode = false;
    let googleUserToken = null; // Almacenar√° el token de ID de Google
    
    // --- (Selectores de DOM) ---
    const categoryDropdown = document.getElementById('categoryDropdown');
    const categoryToggleBtn = document.getElementById('categoryToggleBtn');
    const categoryMenuContainer = document.getElementById('categoryMenu');
    const brandMenuContainer = document.getElementById('brandMenu'); 
    const brandDropdown = document.getElementById('brandDropdown');
    const brandToggleBtn = document.getElementById('brandToggleBtn');
    const searchInput = document.getElementById('searchInput');
    const productTableBody = document.getElementById('productTableBody');
    const cartList = document.getElementById('cartList');
    const totalPriceElement = document.getElementById('totalPrice');
    const whatsappBtn = document.getElementById('whatsappBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const contactWhatsappLink = document.getElementById('contactWhatsappLink');
    const sortPriceBtn = document.getElementById('sortPriceBtn');
    const adminModeBtn = document.getElementById('adminModeBtn');
    const productImageDisplay = document.getElementById("productImageDisplay");
    const displayedProductImage = document.getElementById("displayedProductImage");
    const displayedProductCaption = document.getElementById("displayedProductCaption");
    const googleSignInContainer = document.getElementById('googleSignInContainer');

    let cart = {};
    let currentSortOrder = 'default';
    const currencyFormatter = new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", minimumFractionDigits: 0 });

    // --- L√ìGICA DE CARGA DE DATOS ---
    fetch(googleSheetURL)
        .then(response => response.ok ? response.text() : Promise.reject('Error en la red'))
        .then(csvText => {
            const rows = csvText.trim().split('\n').slice(2); 
            products = rows.map(row => {
                const columns = row.split('\t'); 
                const columnIndices = { name: 0, category: 1, marca: 2, valor_unitario: 3, stock: 4 };
                if (columns.length < 4) return null; 
                let priceString = columns[columnIndices.valor_unitario] || '0';
                priceString = priceString.replace(/[^\d.]/g, '').replace(/\./g, ''); 
                const parsedPrice = parseInt(priceString, 10) || 0;
                const parsedStock = (columns[columnIndices.stock]) 
                    ? parseInt(columns[columnIndices.stock].replace(/[^\d]/g, ''), 10) || 0 
                    : 0;
                return {
                    name: columns[columnIndices.name] ? columns[columnIndices.name].trim() : '',
                    category: columns[columnIndices.category] ? columns[columnIndices.category].trim() : '',
                    marca: columns[columnIndices.marca] ? toTitleCase(columns[columnIndices.marca].trim()) : '',
                    valor_unitario: parsedPrice, 
                    stock: parsedStock
                };
            }).filter(p => p && p.name && p.name.trim() !== '');
            
            initializeApp();
        })
        .catch(error => {
            console.error('Error al cargar productos:', error);
            productTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error al cargar productos. Verifica la URL de la hoja de c√°lculo y que est√© publicada.</td></tr>`;
        });
    
    /**
     * --- INICIALIZACI√ìN DE GOOGLE SIGN-IN ---
     */
    window.onload = function() {
        if (typeof google === 'undefined') {
            console.error("No se pudo cargar la librer√≠a de Google Sign-In.");
            return;
        }

        try {
            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleGoogleSignIn // Funci√≥n que se llama tras el login exitoso
            });

            // Renderiza el bot√≥n oficial de Google en el contenedor oculto
            google.accounts.id.renderButton(
                googleSignInContainer,
                { theme: "outline", size: "medium", text: "signin_with", shape: "rectangular" } 
            );

        } catch (error) {
            console.error("Error inicializando Google Sign-In:", error);
            // Uso de console.warn en lugar de alert para evitar el uso de alert()
            console.warn("Advertencia: No se pudo conectar con el servicio de Google. Verifica tu Client ID.");
        }
    };

    function handleGoogleSignIn(response) {
        if (!response.credential) {
            console.error("Respuesta de Google inv√°lida.", response);
            return;
        }
        
        googleUserToken = response.credential;
        
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        const userName = payload.given_name || payload.name || 'Admin';

        enterAdminMode(userName);
    }
    
    function enterAdminMode(userName) {
        isAdminMode = true;
        
        // Muestra el bot√≥n "Salir", oculta el de Google
        adminModeBtn.textContent = `üîí Salir (Hola, ${userName})`;
        adminModeBtn.classList.add('active');
        adminModeBtn.style.display = "block"; // Muestra el bot√≥n Salir
        googleSignInContainer.style.display = "none"; // Oculta el bot√≥n de Google

        document.querySelector('.right-panel').style.display = 'none'; // Ocultar carrito
        filterAndDisplayProducts(); // Redibuja la tabla en modo admin
    }

    function exitAdminMode() {
        isAdminMode = false;
        
        if (typeof google !== 'undefined') {
            google.accounts.id.disableAutoSelect();
            if (googleUserToken) {
                try {
                    const payload = JSON.parse(atob(googleUserToken.split('.')[1]));
                    if (payload.sub) { 
                         google.accounts.id.revoke(payload.sub, done => {
                            console.log('Intento de revocaci√≥n de sesi√≥n de Google:', done.successful);
                         });
                    }
                } catch (e) {
                    console.error("Error al decodificar o revocar el token:", e);
                }
            }
        }
        
        googleUserToken = null; // Borra el token
        
        // Muestra el bot√≥n "Admin", oculta el de Google
        adminModeBtn.textContent = 'üîë Admin';
        adminModeBtn.classList.remove('active');
        adminModeBtn.style.display = "block"; // Muestra el bot√≥n Admin
        googleSignInContainer.style.display = "none"; // Mantiene oculto el de Google

        document.querySelector('.right-panel').style.display = 'flex'; // Mostrar carrito
        filterAndDisplayProducts(); // Redibuja la tabla en modo cliente
    }

    adminModeBtn.addEventListener('click', () => {
        if (isAdminMode) {
            exitAdminMode();
        } else {
            adminModeBtn.style.display = "none";
            googleSignInContainer.style.display = "block";
        }
    });

    /**
     * --- FUNCI√ìN PRINCIPAL DE ESCRITURA ---
     * Llama al Apps Script para actualizar el stock en Google Sheets.
     */
    async function updateStockInGoogleSheet(productName, newStock, inputElement) {
        if (APPS_SCRIPT_URL === "") {
            console.error("Error: APPS_SCRIPT_URL no configurada.");
            alert("Error: La URL de APPS_SCRIPT_URL no est√° configurada en el HTML.");
            return;
        }
        if (!googleUserToken) {
            alert("Error: No est√°s autenticado. Vuelve a iniciar sesi√≥n.");
            exitAdminMode();
            return;
        }

        const product = products.find(p => p.name === productName);
        const originalStock = product ? product.stock : 0;

        inputElement.disabled = true; // Deshabilita mientras guarda

        const payload = {
            token: googleUserToken, 
            productName: productName,
            newStock: newStock
        };

        try {
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload),
                redirect: 'follow' // Permite la redirecci√≥n de Apps Script
            });

            if (!response.ok) {
                throw new Error(`Error de red: ${response.status} ${response.statusText}`);
            }
            const result = await response.json();

            if (result.status === "success") {
                if (product) {
                    product.stock = newStock;
                }
                console.log(result.message);
            } else {
                throw new Error(result.message);
            }

        } catch (error) {
            // Error mejorado y m√°s descriptivo
            console.error("Error al actualizar stock:", error); 
            let errorMessage = error.message;
            if (error instanceof TypeError && error.message.includes("Failed to fetch")) {
                errorMessage = "Failed to fetch. \n\nCausa probable: \n1. Problema de CORS.\n2. El script no fue (re)implementado.";
            }
            alert(`Error al guardar: ${errorMessage}\nEl valor se revertir√°.`);
            inputElement.value = originalStock; // Revierte el cambio visual
        } finally {
            inputElement.disabled = false; // Vuelve a habilitar
        }
    }

    // --- (Funciones de UI y L√≥gica) ---

    function toTitleCase(str) {
        if (!str) return "";
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }
    
    function generateImageUrl(productName) {
        const normalizedName = productName
            .toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
            .replace(/[^a-z0-9\s-]/g, '')
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-');
            
        return `${imageBaseUrl}${normalizedName}${imageExtension}`;
    }

    function initializeApp() {
        const brandOrder = { 'Natura': 1, 'Avon': 2, 'Esika': 3 };
        const categoryOrder = { 'Perfumes femeninos': 1, 'Perfumes masculinos': 2, 'Perfumes unisex': 3, 'Colonias': 4, 'Combos perfumes': 5, 'Regalos': 6, 'Combos regalos': 7, 'Combos cuidado corporal': 8, 'Cremas hidratantes corporales': 9, 'Combos cuidado capilar': 10, 'Jabones': 11, 'Cremas hidratantes para manos': 12, 'Cuidado capilar': 13, 'Bloqueadores': 14, 'Cuidado facial': 15, 'Combos cuidado facial': 16, 'Desodorantes y antitranspirantes': 17, 'Exfoliantes': 18, 'Maquillaje': 19, 'Aceites': 20, 'Cremas y b√°lsamos para afeitar': 21, 'Cuidado del bebe': 22, 'Cuidado intimo': 23 };
        products.sort((a, b) => {
            const brandAOrder = brandOrder[a.marca] || 99;
            const brandBOrder = brandOrder[b.marca] || 99;
            if (brandAOrder !== brandBOrder) return brandAOrder - brandBOrder;
            const categoryAOrder = categoryOrder[a.category] || 999;
            const categoryBOrder = categoryOrder[b.category] || 999;
            if (categoryAOrder !== categoryBOrder) return categoryAOrder - categoryBOrder;
            return a.name.localeCompare(b.name);
        });
        const savedCart = localStorage.getItem("shoppingCart");
        if (savedCart) { try { cart = JSON.parse(savedCart) || {}; } catch (a) { cart = {}; } }
        const uniqueCategories = [...new Set(products.map(p => p.category))].sort();
        const categories = ["Todas", ...uniqueCategories];
        const brands = ["Todas", ...new Set(products.map(p => p.marca))].sort();
        populateRadioMenu(categoryMenuContainer, categories, 'category');
        populateCheckboxes(brandMenuContainer, brands);
        setupRadioMenuListener(categoryMenuContainer);
        setupCheckboxListener(brandMenuContainer);
        filterAndDisplayProducts();
        updateCart();
    }
    function normalizeText(text) { return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
    function filterAndDisplayProducts() {
        let filteredProducts = [...products];
        const categoryRadio = document.querySelector("#categoryMenu input:checked");
        const selectedCategory = categoryRadio ? categoryRadio.value : "Todas";
        if (selectedCategory && selectedCategory !== "Todas") { filteredProducts = filteredProducts.filter(p => p.category === selectedCategory); }
        const selectedBrands = Array.from(document.querySelectorAll("#brandMenu input:checked")).map(cb => cb.value);
        if (selectedBrands.length > 0 && !selectedBrands.includes("Todas")) { filteredProducts = filteredProducts.filter(p => selectedBrands.includes(p.marca)); }
        const searchTerms = normalizeText(searchInput.value).split(/\s+/).filter(term => term);
        if (searchTerms.length > 0) { filteredProducts = filteredProducts.filter(product => { const searchableText = normalizeText(`${product.name} ${product.category} ${product.marca}`); return searchTerms.every(term => searchableText.includes(term)); }); }
        if (currentSortOrder === "asc") { filteredProducts.sort((a, b) => a.valor_unitario - b.valor_unitario); } else if (currentSortOrder === "desc") { filteredProducts.sort((a, b) => b.valor_unitario - b.valor_unitario); }
        displayProducts(filteredProducts);
        updateBrandToggleLabel(); 
        updateCategoryToggleLabel();
    }
    function displayProducts(productsToDisplay) {
        if (productsToDisplay.length === 0) { productTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding-left: 10px;">No se encontraron productos.</td></tr>'; return; }
        const rowsHtml = productsToDisplay.map(product => {
            const quantityInCart = cart[product.name] ? cart[product.name].quantity : 0;
            const valueToShow = isAdminMode ? product.stock : quantityInCart;
            const dataLabel = isAdminMode ? "Stock" : "Cantidad";
            const subtotal = isAdminMode ? 0 : (quantityInCart * product.valor_unitario);
            const subtotalText = isAdminMode ? "---" : currencyFormatter.format(subtotal);
            const totalLabel = isAdminMode ? "---" : "Total a Pagar";
            const imageUrl = generateImageUrl(product.name);
            const readOnlyAttr = !isAdminMode ? 'readonly' : '';

            return `
                <tr>
                    <td data-label="Producto"><span class="product-name-clickable" data-image-url="${imageUrl}" data-caption="${product.name}">${product.name}</span></td>
                    <td data-label="Categor√≠a">${product.category}</td>
                    <td data-label="Marca">${product.marca}</td>
                    <td data-label="Valor Unit." class="price-cell">${currencyFormatter.format(product.valor_unitario)}</td>
                    <td data-label="${dataLabel}">
                        <div class="quantity-control">
                            <button type="button" class="quantity-btn decrease-btn">-</button>
                            <input type="number" class="quantity-input" min="0" value="${valueToShow}" data-price="${product.valor_unitario}" data-name="${product.name}" ${readOnlyAttr}>
                            <button type="button" class="quantity-btn increase-btn">+</button>
                        </div>
                    </td>
                    <td data-label="${totalLabel}" class="price-cell total-pay">${subtotalText}</td>
                </tr>`;
        }).join("");
        productTableBody.innerHTML = rowsHtml;
    }
    function updateCart() {
        let grandTotal = 0;
        const cartItems = Object.values(cart);
        if (cartItems.length === 0) { cartList.innerHTML = "<li>El carrito est√° vac√≠o.</li>"; } else {
            cartList.innerHTML = cartItems.map(item => { const subtotal = item.quantity * item.price; grandTotal += subtotal; return `<li><span>${item.quantity} x ${item.name} (${currencyFormatter.format(subtotal)})</span><button class="remove-item-btn" data-name="${item.name}">X</button></li>`; }).join("");
        }
        totalPriceElement.textContent = `Total: ${currencyFormatter.format(grandTotal)}`;
        localStorage.setItem("shoppingCart", JSON.stringify(cart));
    }
    productTableBody.addEventListener("input", (event) => {
        if (isAdminMode) return; 
        if (event.target.classList.contains("quantity-input")) { 
            const input = event.target;
            let quantity = parseInt(input.value, 10) || 0;
            const name = input.dataset.name;
            const price = parseFloat(input.dataset.price);
            if (quantity < 0) { quantity = 0; input.value = 0; }
            input.closest("tr").querySelector(".total-pay").textContent = currencyFormatter.format(quantity * price);
            if (quantity > 0) { cart[name] = { name, quantity, price }; } else { delete cart[name]; }
            updateCart();
        }
    });
    productTableBody.addEventListener("click", (event) => {
        const target = event.target;
        if (target.classList.contains("quantity-btn")) {
            const controlDiv = target.closest(".quantity-control");
            const input = controlDiv.querySelector(".quantity-input");
            let currentValue = parseInt(input.value, 10) || 0;
            if (target.classList.contains("increase-btn")) { currentValue++; } else if (target.classList.contains("decrease-btn")) { currentValue--; }
            if (currentValue < 0) { currentValue = 0; }
            input.value = currentValue;
            if (isAdminMode) {
                const name = input.dataset.name;
                updateStockInGoogleSheet(name, currentValue, input);
            } else {
                input.dispatchEvent(new Event("input", { bubbles: true }));
            }
        }
        if (target.classList.contains("product-name-clickable")) {
            const imgUrl = target.dataset.imageUrl;
            const captionText = target.dataset.caption;
            if (imgUrl) { displayedProductImage.src = imgUrl; displayedProductImage.alt = captionText; displayedProductImage.style.display = 'block'; displayedProductCaption.textContent = captionText; } else { displayedProductImage.style.display = 'none'; displayedProductImage.src = ''; displayedProductImage.alt = ''; displayedProductCaption.textContent = 'Haz clic en un producto para ver su imagen'; }
        }
    });
    function populateRadioMenu(container, items, groupName) { container.innerHTML = items.map(item => { const safeVal = item.replace(/"/g, '"'); const checkedAttr = (item === "Todas") ? "checked" : ""; return `<label><input type="radio" name="${groupName}" value="${safeVal}" ${checkedAttr}> ${item}</label>`; }).join(""); }
    function setupRadioMenuListener(container) { container.addEventListener("change", (event) => { if (event.target.type === "radio") { filterAndDisplayProducts(); const dropdown = container.closest('.custom-dropdown'); if (dropdown) { dropdown.classList.remove('open'); container.setAttribute('aria-hidden', 'true'); } } }); }
    function updateCategoryToggleLabel() { const checkedRadio = document.querySelector("#categoryMenu input:checked"); const btn = categoryToggleBtn; if (checkedRadio && checkedRadio.value !== "Todas") { btn.textContent = `Categor√≠a: ${checkedRadio.value} ‚ñæ`; } else { btn.textContent = "Categor√≠as: Todas ‚ñæ"; } }
    function populateCheckboxes(container, items) { container.innerHTML = items.map(item => { const safeVal = item.replace(/"/g, '"'); const checkedAttr = ("Todas" === item) ? "checked" : ""; return `<label><input type="checkbox" name="brand" value="${safeVal}" ${checkedAttr}> ${item}</label>`; }).join(""); }
    function setupCheckboxListener(container) { container.addEventListener("change", (event) => { const targetCheckbox = event.target; if ("checkbox" !== targetCheckbox.type) return; const allCheckbox = container.querySelector('input[value="Todas"]'); if ("Todas" === targetCheckbox.value && targetCheckbox.checked) { container.querySelectorAll('input:not([value="Todas"])').forEach(cb => cb.checked = false); } else if ("Todas" !== targetCheckbox.value && targetCheckbox.checked && allCheckbox) { allCheckbox.checked = false; } if (!container.querySelector("input:checked") && allCheckbox && allCheckbox.checked === false) { allCheckbox.checked = true; } filterAndDisplayProducts(); }); }
    function updateBrandToggleLabel(){ const checked = Array.from(document.querySelectorAll("#brandMenu input:checked")).map(i => i.value); const btn = brandToggleBtn; if (!checked || checked.length === 0) { btn.textContent = "Marcas ‚ñæ"; } else if (checked.includes("Todas")) { btn.textContent = "Marcas: Todas ‚ñæ"; } else if (checked.length === 1) { btn.textContent = `Marca: ${checked[0]} ‚ñæ`; } else { btn.textContent = `Marcas: ${checked.length} ‚ñæ`; } }
    document.addEventListener('click', (e) => { const target = e.target; if (target.classList.contains('dropdown-toggle-btn')) { e.stopPropagation(); const dropdown = target.closest('.custom-dropdown'); const menu = dropdown.querySelector('.custom-menu'); const wasOpen = dropdown.classList.contains('open'); document.querySelectorAll('.custom-dropdown.open').forEach(d => { if (d !== dropdown) { d.classList.remove('open'); d.querySelector('.custom-menu').setAttribute('aria-hidden', 'true'); } }); dropdown.classList.toggle('open', !wasOpen); menu.setAttribute('aria-hidden', 'true'); } else if (!target.closest('.custom-dropdown')) { document.querySelectorAll('.custom-dropdown.open').forEach(dropdown => { dropdown.classList.remove('open'); dropdown.querySelector('.custom-menu').setAttribute('aria-hidden', 'true'); }); } else if (target.closest('#brandMenu')) { e.stopPropagation(); } });
    function openWhatsApp(message) { const phoneNumber = "573042088961"; const encodedMessage = encodeURIComponent(message); const whatsappURL = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}` : `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`; window.open(whatsappURL, "_blank"); }
    searchInput.addEventListener("input", filterAndDisplayProducts);
    sortPriceBtn.addEventListener("click", () => { if ("default" === currentSortOrder || "desc" === currentSortOrder) { currentSortOrder = "asc"; sortPriceBtn.textContent = "Precio $‚Üì"; sortPriceBtn.classList.add("active"); } else if ("asc" === currentSortOrder) { currentSortOrder = "desc"; sortPriceBtn.textContent = "Precio $‚Üë"; sortPriceBtn.classList.remove("active"); } filterAndDisplayProducts(); });
    whatsappBtn.addEventListener("click", () => { const cartItems = Object.values(cart); if (cartItems.length === 0) { console.warn("El carrito est√° vac√≠o."); return; } let message = "Hola, deseo comprar los siguientes productos:\n\n"; let total = 0; cartItems.forEach(item => { const subtotal = item.quantity * item.price; message += `- ${item.quantity} x *${item.name}* (${currencyFormatter.format(item.price)} c/u) - Subtotal: ${currencyFormatter.format(subtotal)}\n`; total += subtotal; }); message += `\n*Total del pedido: ${currencyFormatter.format(total)}*`; openWhatsApp(message); });
    contactWhatsappLink.addEventListener("click", (e) => { e.preventDefault(); openWhatsApp("Hola, me interesan tus productos."); });
    cartList.addEventListener("click", (event) => { if (event.target.classList.contains("remove-item-btn")) { const productName = event.target.dataset.name; delete cart[productName]; const inputInTable = productTableBody.querySelector(`.quantity-input[data-name="${productName}"]`); if (inputInTable) { inputInTable.value = 0; inputInTable.dispatchEvent(new Event("input", { bubbles: true })); } else { updateCart(); } } });
    clearCartBtn.addEventListener("click", () => { cart = {}; localStorage.removeItem("shoppingCart"); productTableBody.querySelectorAll(".quantity-input").forEach(input => { if (parseInt(input.value) > 0) { input.value = 0; input.dispatchEvent(new Event("input", { bubbles: true })); } }); updateCart(); });
</script>

</body>
</html>
