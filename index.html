<!DOCTYPE html>  
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Irenismb Natura Stock - Cat√°logo con Busqueda Inteligente</title>

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://irenismb.github.io/stock/index.html">
  <meta property="og:title" content="Irenismb Natura Stock - Cat√°logo con B√∫squeda Inteligente">
  <meta property="og:description" content="Explora el cat√°logo Natura con b√∫squeda inteligente, filtros por marca y categor√≠as, y compra f√°cil por WhatsApp.">
  <meta property="og:image" content="https://irenismb.github.io/stock/logo.png">
  <meta property="og:site_name" content="Irenismb Natura Stock">
  <meta property="og:locale" content="es_CO">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    :root{
      --primary:#007bff;
      --secondary:#25D366;
      --bg:#f4f4f9;
      --text:#333;
      --card:#fff;
      --border:#ddd;
      --danger:#dc3545;
      --radius:8px;
      --gap:8px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ max-width:100%; overflow-x:hidden; }
    body{
      margin:0; padding:10px; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    }
    .container{ display:flex; gap:15px; align-items:flex-start; width:100%; }
    .left-panel{ flex:3 1 700px; display:flex; flex-direction:column; min-width:0; }
    .right-panel{
      flex:1 1 280px; position:sticky; top:10px; display:flex; flex-direction:column;
      gap:15px; max-height:calc(100vh - 20px); overflow-y:auto;
    }
    .controls-panel{ position:sticky; top:0; z-index:40; background:var(--bg); padding:4px 0 6px; }
    .products-header{ display:flex; flex-direction:column; gap:6px; border-bottom:1px solid rgba(0,0,0,.05); padding-bottom:6px; }
    .controls-top{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; }
    #searchInput{
      flex:1 1 220px; min-width:180px; padding:10px 12px; border:1px solid #ccc; border-radius:5px;
      background:var(--card); font-size:16px;
    }
    .controls-bottom{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .custom-dropdown{ position:relative }
    .dropdown-toggle-btn{
      padding:8px 10px; border:1px solid #ccc; border-radius:5px; background:var(--card);
      cursor:pointer; white-space:nowrap; font-size:14px; min-height:38px; display:flex; align-items:center; gap:4px;
    }
    .custom-menu{
      position:absolute; top:calc(100% + 6px); right:0; background:var(--card); border:1px solid var(--border);
      padding:8px; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,.08); display:none; z-index:50; max-height:220px; overflow:auto; min-width:200px;
    }
    .custom-dropdown.open .custom-menu{ display:block }
    #categoryMenu{ right:auto; left:0 }

    #sortPriceBtn{
      padding:8px 12px; font-size:14px; border:1px solid #ccc; background:#f8f9fa;
      border-radius:5px; cursor:pointer; min-height:38px;
    }

    /* Logo + nombre de empresa en la barra de filtros */
    .brand-logo{
      display:flex;
      align-items:center;
      gap:6px;
      margin-left:auto;
      font-weight:600;
      color:#444;
      font-size:14px;
    }
    .brand-logo-img{
      width:40px;
      height:40px;
      border-radius:50%;
      object-fit:cover;
    }
    .brand-logo-text{
      white-space:nowrap;
      font-weight:700;
    }

    .table-wrapper{ border-radius:8px; overflow:hidden; background:#fff; max-height:calc(100vh - 140px); overflow-y:auto; }
    .product-table{ width:100%; border-collapse:collapse; background:var(--card); }
    .product-table th,.product-table td{ border:1px solid var(--border); padding:10px; text-align:left; vertical-align:middle; }
    .product-table thead th{
      background:var(--primary); color:#fff; font-size:14px; text-align:center; position:sticky; top:0; z-index:30;
    }
    .product-table tr:nth-child(even){ background:#f8f9fa }
    .quantity-control{ display:flex; align-items:center; justify-content:center; gap:4px; }
    .quantity-btn{
      background:#e9ecef; border:1px solid #ced4da; color:#495057; cursor:pointer;
      font-size:1.2rem; font-weight:700; width:34px; height:34px; line-height:32px; text-align:center; border-radius:6px; touch-action:manipulation;
    }
    .quantity-input{
      width:55px; height:34px; padding:5px; text-align:center; border:1px solid #ced4da; background:#fff; font-size:15px; border-radius:6px;
    }
    .price-cell{ font-weight:700; color:#2a9d8f }

    .cart-container{
      background:#e9f5ff; padding:15px; border-radius:10px; border:1px solid #bde0fe;
      box-shadow:0 6px 16px rgba(13,110,253,0.08);
    }
    .cart-container h3{
      margin-top:0; display:flex; align-items:center; gap:6px; font-size:16px; border-bottom:1px solid rgba(0,0,0,.05); padding-bottom:6px;
    }
    #cartList{
      list-style:none; padding:0; margin:10px 0; display:flex; flex-direction:column; gap:6px; max-height:220px; overflow-y:auto;
    }
    .cart-item{
      display:flex; justify-content:space-between; gap:8px; background:#fff; border:1px solid rgba(0,0,0,.03);
      border-radius:6px; padding:6px 8px 6px 10px; font-size:13px;
    }
    .remove-item-btn{
      border:none; background:#f8d7da; color:#842029; border-radius:4px; padding:1px 6px; cursor:pointer; font-weight:600; font-size:12px; touch-action:manipulation;
    }
    #totalPrice{ font-weight:700; font-size:15px; text-align:right; margin-top:4px; background:#fff; border-radius:6px; padding:5px 8px; }
    #whatsappBtn{
      background:var(--secondary); color:#fff; width:100%; border:none; padding:11px 14px; font-size:15px; border-radius:8px; cursor:pointer; margin-top:8px; touch-action:manipulation;
    }

    .contact-info{
      padding:15px;
      background:var(--card);
      border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
      font-size:14px;
      text-align:center;
    }
    .contact-info h3{
      margin:0 0 6px;
    }
    .contact-info p{
      margin:2px 0;
    }
    .contact-info hr{
      margin:8px 0;
    }

    /* ==== Previsualizaci√≥n / Galer√≠a ==== */
    .preview{
      background:#fff; border:1px solid #bde0fe; border-radius:10px; padding:10px;
      box-shadow:0 6px 16px rgba(13,110,253,0.08); display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    .preview .stage{
      position:relative; width:100%; aspect-ratio:1/1; background:#f8f9fa; border-radius:8px; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .preview .stage img{
      width:100%; height:100%; object-fit:contain; display:none;
    }
    /* Overlay para el estado de la imagen (cargando / sin imagen) */
    .preview .stage .image-status{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px;
      text-align:center;
      font-size:14px;
      color:#2563eb;
      background:rgba(255,255,255,0.8);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s ease;
    }
    .preview .stage .image-status.visible{
      opacity:1;
    }
    .preview .nav{
      position:absolute; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:50%;
      background:rgba(0,0,0,.45); color:#fff; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .preview .nav[disabled]{ opacity:.35; cursor:not-allowed; }
    .preview .nav.prev{ left:8px; } .preview .nav.next{ right:8px; }
    .thumbs{
      width:100%; display:flex; gap:8px; overflow:auto; padding:4px 2px;
    }
    .thumbs img{
      width:64px; height:64px; object-fit:cover; border:2px solid transparent; border-radius:6px; cursor:pointer; background:#f1f3f5;
      flex:0 0 auto;
    }
    .thumbs img.active{ border-color:var(--primary); }

    /* Nombre del producto entre miniaturas y descripci√≥n */
    .preview .product-name{
      width:100%;
      text-align:left;
      font-weight:700;
      font-size:14px;
      letter-spacing:0.06em;
      color:#222;
    }

    .preview .caption{
      font-size:13px; color:#444; text-align:left; width:100%; min-height:2.5em;
    }
    /* Estado de "Cargando imagen..." */
    .preview .caption.loading{
      color:#2563eb;
      font-style:italic;
    }

    /* ======== M√ìVIL ======== */
    @media (max-width:768px){
      body{ padding:6px; }
      .container{ flex-direction:column-reverse; gap:10px; }
      .controls-panel{ position:static; }
      .right-panel{ position:static; max-height:none; width:100%; overflow:visible; }
      .cart-container,.contact-info{ width:100%; }
      .table-wrapper{ max-height:none; overflow:visible; width:100%; }
      .controls-top{ flex-direction:column; align-items:stretch; }
      #searchInput{ width:100%; padding:6px 10px; min-height:40px; line-height:1.2; }
      .controls-bottom{ flex-direction:column; align-items:stretch; }
      #sortPriceBtn,.dropdown-toggle-btn{ width:100%; text-align:left; }
      .custom-menu{ width:min(310px,96vw); left:0; right:auto; }

      .brand-logo{
        margin-left:0;
        justify-content:flex-start;
      }

      .product-table{ border:0; }
      .product-table thead{ display:none; }
      .product-table tr{ display:block; background:#fff; margin-bottom:12px; border:1px solid #eee; border-radius:8px; overflow:hidden; }
      .product-table td{
        display:flex; justify-content:space-between; gap:12px; border:none; border-bottom:1px solid #f1f1f1;
        padding:8px 10px; font-size:14px; width:100% !important; max-width:100% !important;
      }
      .product-table td:last-child{ border-bottom:none; }
      .product-table td::before{ content:attr(data-label); font-weight:600; color:#555; margin-right:8px; flex:1; }
      .quantity-control{ justify-content:flex-end; }
      .preview .stage{ max-height:44vh; }
    }
  </style>

  <!-- Estilos extra para interfaz moderna + correcci√≥n del scroll -->
  <style>
    :root{
      --primary:#2563eb;
      --secondary:#22c55e;
      --bg:#e5e7eb;
      --text:#0f172a;
      --card:#ffffff;
      --border:#e2e8f0;
      --danger:#dc2626;
      --radius:10px;
      --gap:10px;
    }

    /* ===== Lienzo general / contenedor principal ===== */
    body{
      padding:16px;
      margin:0;
      background:
        radial-gradient(circle at top,#eff6ff 0,#e5e7eb 45%,#e5e7eb 100%);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:18px 18px 20px;
      background:var(--card);
      border-radius:18px;
      box-shadow:0 18px 40px rgba(15,23,42,0.12);
      gap:24px;
    }

    .left-panel{
      flex:3 1 700px;
    }

    .right-panel{
      flex:1 1 300px;
      gap:16px;
    }

    /* ===== Barra superior de b√∫squeda / filtros ===== */
    .controls-panel{
      background:linear-gradient(to bottom,#ffffff,#f9fafb);
      border-radius:14px;
      padding:10px 12px 14px;
      box-shadow:0 8px 18px rgba(15,23,42,0.05);
      margin-bottom:12px;
      top:0;
      z-index:40;
    }

    .products-header{
      border-bottom:none;
      gap:10px;
    }

    .controls-top{
      gap:10px;
    }

    #searchInput{
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#f9fafb;
      font-size:15px;
      padding:10px 16px;
      box-shadow:0 0 0 1px rgba(148,163,184,0.12) inset;
      transition:border-color .15s ease,box-shadow .15s ease,background .15s ease,transform .05s ease;
    }

    #searchInput::placeholder{
      color:#9ca3af;
    }

    #searchInput:focus{
      outline:none;
      border-color:#2563eb;
      background:#ffffff;
      box-shadow:
        0 0 0 1px rgba(37,99,235,0.3),
        0 10px 24px rgba(15,23,42,0.08);
      transform:translateY(-1px);
    }

    .controls-bottom{
      gap:10px;
    }

    #sortPriceBtn,
    .dropdown-toggle-btn{
      border-radius:999px;
      border:1px solid #e2e8f0;
      background:#ffffff;
      font-size:13px;
      padding:8px 14px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      min-height:38px;
      transition:background .15s ease,box-shadow .15s ease,transform .05s ease,color .15s ease,border-color .15s ease;
    }

    #sortPriceBtn:hover,
    .dropdown-toggle-btn:hover{
      background:#eff6ff;
      border-color:#bfdbfe;
      box-shadow:0 8px 18px rgba(37,99,235,0.15);
      transform:translateY(-1px);
    }

    #sortPriceBtn:active,
    .dropdown-toggle-btn:active{
      transform:translateY(0);
      box-shadow:0 4px 10px rgba(15,23,42,0.12);
    }

    .custom-menu{
      border-radius:10px;
      border:1px solid #e5e7eb;
      box-shadow:0 16px 36px rgba(15,23,42,0.18);
    }

    /* Logo de la marca en formato ‚Äúpill‚Äù */
    .brand-logo{
      margin-left:auto;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      color:#1e293b;
      font-size:13px;
      align-items:center;
    }

    .brand-logo-img{
      width:32px;
      height:32px;
      border-radius:999px;
      object-fit:cover;
    }

    .brand-logo-text{
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:11px;
    }

    /* ===== Tabla de productos / listado ===== */
    .table-wrapper{
      border-radius:14px;
      border:1px solid #e2e8f0;
      box-shadow:0 12px 30px rgba(15,23,42,0.06);
      background:var(--card);

      /* panel desplazable con scrollbar vertical */
      max-height:calc(100vh - 160px);
      overflow-y:auto;
      overflow-x:hidden;
      scrollbar-gutter:stable;
    }

    .product-table{
      background:var(--card);
    }

    .product-table th,
    .product-table td{
      border-color:#e5e7eb;
    }

    .product-table thead th{
      background:linear-gradient(90deg,#2563eb,#1d4ed8);
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:600;
    }

    .product-table tbody tr{
      transition:background .12s ease;
    }

    .product-table tbody tr:nth-child(even){
      background:#f9fafb;
    }

    .product-table tbody tr:hover{
      background:#eef2ff;
    }

    .price-cell{
      color:#059669;
      font-weight:700;
    }

    /* ===== Controles de cantidad ===== */
    .quantity-control{
      background:#f9fafb;
      border-radius:999px;
      padding:2px 4px;
    }

    .quantity-btn{
      background:#e0e7ff;
      border:none;
      color:#1d4ed8;
      width:30px;
      height:30px;
      font-size:1rem;
      font-weight:700;
      border-radius:999px;
    }

    .quantity-btn:hover{
      background:#c7d2fe;
    }

    .quantity-input{
      width:52px;
      height:30px;
      border:none;
      background:transparent;
      text-align:center;
      font-size:15px;
      font-weight:600;
    }

    .quantity-input:focus{
      outline:none;
    }

    /* ===== Vista previa de producto ===== */
    .preview{
      background:#f9fafb;
      border-radius:14px;
      border:1px solid #e2e8f0;
      box-shadow:0 12px 30px rgba(15,23,42,0.06);
      padding:12px 10px 12px;
    }

    .preview .stage{
      background:radial-gradient(circle at top,#eff6ff,#e5e7eb);
      border-radius:10px;
    }

    .preview .nav{
      background:rgba(15,23,42,0.55);
    }

    .preview .nav[disabled]{
      background:rgba(148,163,184,0.6);
    }

    .preview .product-name{
      font-size:13px;
      letter-spacing:.08em;
      color:#111827;
    }

    #previewCaption{
      color:#4b5563;
    }

    .thumbs img{
      border-radius:8px;
      background:#e5e7eb;
    }

    .thumbs img.active{
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,0.5);
    }

    /* ===== Carrito ===== */
    .cart-container{
      background:#f0f9ff;
      border-radius:14px;
      border:1px solid #bae6fd;
      box-shadow:0 12px 30px rgba(59,130,246,0.16);
    }

    .cart-container h3{
      font-size:15px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:#0f172a;
    }

    #cartList{
      max-height:230px;
    }

    .cart-item{
      font-size:13px;
      border-radius:8px;
    }

    .remove-item-btn{
      background:#fee2e2;
      color:#b91c1c;
      border-radius:999px;
    }

    .remove-item-btn:hover{
      background:#fecaca;
    }

    #totalPrice{
      border-radius:999px;
      background:#ffffff;
      border:1px dashed #bfdbfe;
      font-size:14px;
    }

    #whatsappBtn{
      background:linear-gradient(90deg,#22c55e,#16a34a);
      box-shadow:0 10px 25px rgba(22,163,74,0.35);
      font-weight:600;
    }

    #whatsappBtn:hover{
      filter:brightness(1.05);
    }

    /* ===== Tarjeta de contacto / redes ===== */
    .contact-info{
      border-radius:14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
      background:#ffffff;
    }

    .contact-info h3{
      font-size:15px;
    }

    .contact-info a{
      color:#2563eb;
      text-decoration:none;
    }

    .contact-info a:hover{
      text-decoration:underline;
    }

    /* ===== Ajustes para m√≥vil ===== */
    @media (max-width:768px){
      body{
        padding:10px;
        background:#f3f4f6;
      }

      .container{
        box-shadow:none;
        padding:0;
        background:transparent;
        gap:10px;
      }

      .controls-panel{
        margin-bottom:10px;
        border-radius:12px;
      }

      .right-panel{
        position:static;
        max-height:none;
      }

      .table-wrapper{
        border:none;
        box-shadow:none;
        border-radius:0;
        max-height:none;
        overflow:visible;   /* en m√≥vil que crezca normal */
      }

      .product-table tr{
        box-shadow:0 8px 20px rgba(15,23,42,0.08);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <div class="controls-panel">
        <div class="products-header">
          <div class="controls-top">
            <input id="searchInput" type="text" autocomplete="off" inputmode="search" placeholder="üîç Buscar por nombre, marca, categor√≠a...">
            <button id="sortPriceBtn">Ordenar por precio</button>
          </div>
          <div class="controls-bottom">
            <div class="custom-dropdown" id="categoryDropdown">
              <button type="button" id="categoryToggleBtn" class="dropdown-toggle-btn" aria-haspopup="listbox" aria-expanded="false">Categor√≠as ‚ñæ</button>
              <div id="categoryMenu" class="custom-menu" aria-hidden="true"></div>
            </div>
            <div class="custom-dropdown" id="brandDropdown">
              <button type="button" id="brandToggleBtn" class="dropdown-toggle-btn" aria-haspopup="listbox" aria-expanded="false">Marcas ‚ñæ</button>
              <div id="brandMenu" class="custom-menu" aria-hidden="true"></div>
            </div>

            <!-- Logo + nombre de la empresa -->
            <div class="brand-logo">
              <img src="logo.png" alt="Logo Irenismb Stock" class="brand-logo-img">
              <span class="brand-logo-text">Irenismb Stock</span>
            </div>
          </div>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="product-table" aria-label="Listado de productos">
          <thead>
            <tr>
              <th>Nombre producto</th>
              <th>Categor√≠a</th>
              <th>Marca</th>
              <th>Valor unitario</th>
              <th>Cantidad</th>
              <th>Total a pagar</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr><td colspan="6" style="text-align:center;">Cargando productos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="right-panel">
      <!-- Vista previa del producto (galer√≠a) -->
      <div id="productPreview" class="preview" aria-live="polite">
        <div class="stage" role="region" aria-label="Galer√≠a del producto">
          <button class="nav prev" id="galleryPrevBtn" aria-label="Imagen anterior">‚Äπ</button>
          <img id="previewImg" alt="Vista previa del producto" />
          <!-- Overlay de estado de imagen -->
          <div id="imageStatus" class="image-status" aria-live="polite"></div>
          <button class="nav next" id="galleryNextBtn" aria-label="Imagen siguiente">‚Ä∫</button>
        </div>
        <div id="thumbs" class="thumbs" aria-label="Miniaturas de producto" role="list"></div>
        <div id="previewName" class="product-name"></div>
        <div id="previewCaption" class="caption">Haz clic en un producto para ver su descripci√≥n</div>
      </div>

      <div class="cart-container" id="cartContainer">
        <h3>üõí Carrito de Compras</h3>
        <ul id="cartList">
          <li class="cart-item"><span class="cart-item-title">El carrito est√° vac√≠o.</span></li>
        </ul>
        <div id="totalPrice">Total: 0</div>
        <button id="whatsappBtn">Comprar por WhatsApp</button>
      </div>

      <div class="contact-info">
        <h3>‚ú® Contacto y Ubicaci√≥n ‚ú®</h3>
        <p class="small-gap">üì± <strong>WhatsApp y llamadas:</strong> <a href="https://wa.me/573042088961" target="_blank" rel="noopener" id="contactWhatsappLink">3042088961</a></p>
        <p class="small-gap">üìç <strong>Ubicaci√≥n:</strong> Estamos en Santa Marta. ¬°Hacemos env√≠os a toda Colombia y pagos contra entrega en Santa Marta!</p>
        <p class="small-gap">üó∫Ô∏è <strong>Vis√≠tanos (GPS):</strong> <a href="https://maps.google.com/?q=11.244833370782679,-74.19066001689564" target="_blank" rel="noopener noreferrer">Ver en Google Maps</a></p>
        <hr>
        <h3>üåê ¬°S√≠guenos en Nuestras Redes! üåê</h3>
        <p class="small-gap">üëç <a href="https://www.facebook.com/marketplace/profile/100084865295132" target="_blank" rel="noopener">Facebook</a></p>
        <p class="small-gap">üì∏ <a href="https://www.instagram.com/irenismb_stocknaturasm" target="_blank" rel="noopener">Instagram</a></p>
        <p class="small-gap">üéµ <a href="https://www.tiktok.com/@irenismbstocknatura" target="_blank" rel="noopener">TikTok</a></p>
      </div>
    </div>
  </div>

<script>
  // ================== CONFIG ==================
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgRlyQfToDd8O7JOyRP0XXdryqpksSTu04zuhaZHYnun59S0ALXR_vnHZGfY5ch7SP/exec";
  const DEFAULT_WHATSAPP = "573042088961";
  const AUTO_REFRESH_MS = 20000;
  const LS_FILTERS_KEY = "naturaFilters";
  const LS_CART_KEY = "shoppingCart";

  const currencyFormatter = new Intl.NumberFormat("es-CO", {
    style: "currency",
    currency: "COP",
    minimumFractionDigits: 0
  });

  // ================== IM√ÅGENES (GitHub) ==================
  const IMG_BASE_PATH = "https://irenismb.github.io/stock/imagenes/productos/";
  // Todas las im√°genes se asumen .webp para acelerar la b√∫squeda
  const IMG_EXTS = ["webp","WEBP"];
  const imageCache = new Map();

  // ================== ESTADO ==================
  let products = [];
  let allCategories = [];
  let allBrands = [];   // [{key,label}]
  let currentSortOrder = "default"; // default ‚Üí Orden, asc ‚Üí precio menor, desc ‚Üí precio mayor
  let cart = {};        // id -> { id, name, price, quantity }
  let currentGallery = { productId: null, images: [], index: 0 };
  let lastPreviewRequestId = 0;
  let filterListenersAttached = false;
  let lastSearchLogged = "";
  let autoRefreshTimer = null;

  // ================== DOM ==================
  const searchInput = document.getElementById("searchInput");
  const productTableBody = document.getElementById("productTableBody");
  const cartList = document.getElementById("cartList");
  const totalPriceElement = document.getElementById("totalPrice");
  const whatsappBtn = document.getElementById("whatsappBtn");
  const contactWhatsappLink = document.getElementById("contactWhatsappLink");
  const sortPriceBtn = document.getElementById("sortPriceBtn");

  const categoryMenu = document.getElementById("categoryMenu");
  const brandMenu = document.getElementById("brandMenu");
  const categoryToggleBtn = document.getElementById("categoryToggleBtn");
  const brandToggleBtn = document.getElementById("brandToggleBtn");

  const productPreview = document.getElementById("productPreview");
  const previewImg = document.getElementById("previewImg");
  const previewCaption = document.getElementById("previewCaption");
  const galleryPrevBtn = document.getElementById("galleryPrevBtn");
  const galleryNextBtn = document.getElementById("galleryNextBtn");
  const thumbs = document.getElementById("thumbs");
  const previewName = document.getElementById("previewName");
  const imageStatus = document.getElementById("imageStatus");

  // ================== UTIL ==================
  function debounce(fn, ms = 300) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  function normalizeText(t) {
    return (t || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function normalizeBrand(str) {
    return normalizeText((str || "").trim());
  }

  function escapeHtml(t) {
    if (t == null) return "";
    return String(t).replace(/[&<>"']/g, s => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    })[s]);
  }

  function escapeAttr(t) {
    return escapeHtml(t).replace(/"/g, "&quot;");
  }

  // ================== REGISTRO DE VISITAS ==================
  function logVisit(clickText, searchText) {
    try {
      const params = new URLSearchParams({
        action: "logVisit",
        clickText: String(clickText || ""),
        searchText: String(searchText || ""),
        ts: Date.now().toString()
      });
      const img = new Image();
      img.src = APPS_SCRIPT_URL + "?" + params.toString();
    } catch (e) {
      console.error("Error en logVisit:", e);
    }
  }

  // ================== IM√ÅGENES / GALER√çA ==================
  // Ligero ajuste al timeout para no esperar demasiado en URLs que no responden.
  function testImageOnce(url, timeout = 1200) {
    return new Promise(resolve => {
      const img = new Image();
      let done = false;

      const timer = setTimeout(() => {
        if (!done) {
          done = true;
          img.src = "";
          resolve(false);
        }
      }, timeout);

      img.onload = () => {
        if (!done) {
          done = true;
          clearTimeout(timer);
          resolve(true);
        }
      };
      img.onerror = () => {
        if (!done) {
          done = true;
          clearTimeout(timer);
          resolve(false);
        }
      };

      img.decoding = "async";
      img.loading = "eager";
      img.src = url;
    });
  }

  async function resolveImageForCode(code, name) {
    if (!code) return null;

    const safeName = (name || "").trim();
    const baseVariants = [];

    // 1) C√≥digo solo: 123.webp
    baseVariants.push(String(code));

    if (safeName) {
      const safeNameSlug = safeName
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");

      if (safeNameSlug) {
        baseVariants.push(`${code}-${safeNameSlug}`);
      }
      // C√≥digo + nombre original
      baseVariants.push(`${code}-${safeName}`);
      // Patr√≥n antiguo: 123@Nombre
      baseVariants.push(`${code}@${safeName}`);
    }

    for (const base of baseVariants) {
      for (const ext of IMG_EXTS) {
        const key = `${base}.${ext}`;
        const cached = imageCache.get(key);
        if (cached) {
          if (cached.ok) return cached.url;
          continue;
        }
        const url = IMG_BASE_PATH + encodeURIComponent(base) + "." + ext;
        const ok = await testImageOnce(url);
        imageCache.set(key, { ok, url });
        if (ok) return url;
      }
    }

    return null;
  }

  async function findAllImagesForProduct(prod, maxChildren = 12) {
    if (!prod || !prod.id) return [];
    const id = String(prod.id).trim();
    const name = String(prod.name || "").trim();
    const images = [];

    const main = await resolveImageForCode(id, name);
    if (main) images.push(main);

    for (let i = 1; i <= maxChildren; i++) {
      const childCode = `${id}-${i}`;
      const url = await resolveImageForCode(childCode, name);
      if (url) images.push(url);
    }

    return images;
  }

  function renderThumbs(imgs, activeIndex) {
    thumbs.innerHTML = "";
    imgs.forEach((url, idx) => {
      const im = document.createElement("img");
      im.src = url;
      im.alt = `Miniatura ${idx + 1}`;
      if (idx === activeIndex) im.classList.add("active");
      im.addEventListener("click", () => setGalleryIndex(idx, true));
      thumbs.appendChild(im);
    });
  }

  function updateNavButtons() {
    const len = currentGallery.images.length;
    const disabled = len <= 1;
    galleryPrevBtn.disabled = disabled;
    galleryNextBtn.disabled = disabled;
  }

  function setGalleryIndex(newIndex, userAction) {
    const imgs = currentGallery.images;
    const len = imgs.length;
    if (!len) return;

    if (newIndex < 0) newIndex = len - 1;
    if (newIndex >= len) newIndex = 0;

    currentGallery.index = newIndex;
    const url = imgs[newIndex];

    previewImg.style.display = "block";
    previewImg.src = url;

    thumbs.querySelectorAll("img").forEach((im, idx) => {
      im.classList.toggle("active", idx === newIndex);
    });

    updateNavButtons();
  }

  // >>> CAMBIO PRINCIPAL: mostrar "Cargando imagen..." en el panel de imagen
  async function showPreviewForProduct(prod) {
    if (!prod) return;

    const requestId = ++lastPreviewRequestId;

    const name = (prod.name || "").trim();
    const descriptionText = prod.description || "Sin descripci√≥n para este producto.";
    previewName.textContent = name ? name.toUpperCase() : "";

    // La descripci√≥n se muestra siempre, incluso mientras carga la imagen
    previewCaption.textContent = descriptionText;
    previewCaption.classList.remove("loading");

    previewImg.style.display = "none";
    previewImg.src = "";
    thumbs.innerHTML = "";
    currentGallery = { productId: prod.id, images: [], index: 0 };
    updateNavButtons();

    // Overlay de estado en el panel de imagen
    if (imageStatus) {
      imageStatus.textContent = "Cargando imagen...";
      imageStatus.classList.add("visible");
    }

    const imgs = await findAllImagesForProduct(prod);

    // Si mientras tanto el usuario hizo clic en otro producto, descartamos este resultado.
    if (requestId !== lastPreviewRequestId) {
      return;
    }

    currentGallery.images = imgs;
    currentGallery.index = 0;

    if (!imgs.length) {
      // No se encontr√≥ ninguna imagen: mensaje amigable en el panel de imagen
      if (imageStatus) {
        imageStatus.textContent = "Pr√≥ximamente tendr√°s la imagen de tu producto aqu√≠";
        imageStatus.classList.add("visible");
      }
      updateNavButtons();
      return;
    }

    // Hay im√°genes: ocultamos el overlay de estado
    if (imageStatus) {
      imageStatus.textContent = "";
      imageStatus.classList.remove("visible");
    }

    renderThumbs(imgs, 0);
    setGalleryIndex(0);
  }

  galleryPrevBtn.addEventListener("click", () => {
    setGalleryIndex(currentGallery.index - 1, true);
  });
  galleryNextBtn.addEventListener("click", () => {
    setGalleryIndex(currentGallery.index + 1, true);
  });

  (function addSwipe(el) {
    if (!el) return;
    let startX = null;
    el.addEventListener("touchstart", e => {
      startX = e.changedTouches[0].clientX;
    }, { passive: true });
    el.addEventListener("touchend", e => {
      if (startX == null) return;
      const dx = e.changedTouches[0].clientX - startX;
      if (Math.abs(dx) > 40) {
        if (dx > 0) setGalleryIndex(currentGallery.index - 1, true);
        else setGalleryIndex(currentGallery.index + 1, true);
      }
      startX = null;
    }, { passive: true });
  })(document.querySelector(".stage"));

  productPreview.tabIndex = 0;
  productPreview.addEventListener("keydown", e => {
    if (e.key === "ArrowLeft") {
      e.preventDefault();
      setGalleryIndex(currentGallery.index - 1, true);
    } else if (e.key === "ArrowRight") {
      e.preventDefault();
      setGalleryIndex(currentGallery.index + 1, true);
    }
  });

  // ================== FILTROS ==================
  function getSavedFilters() {
    try {
      return JSON.parse(localStorage.getItem(LS_FILTERS_KEY) || "{}");
    } catch (e) {
      return {};
    }
  }

  function saveFiltersToStorage() {
    const cat = categoryMenu.querySelector('input[name="category"]:checked')?.value || "Todas";
    const brand = brandMenu.querySelector('input[name="brand"]:checked')?.value || "Todas";
    localStorage.setItem(LS_FILTERS_KEY, JSON.stringify({ category: cat, brand }));
  }

  function updateCategoryButtonLabel() {
    const sel = categoryMenu.querySelector('input[name="category"]:checked');
    if (sel && sel.value !== "Todas") {
      categoryToggleBtn.textContent = sel.value + " ‚ñæ";
    } else {
      categoryToggleBtn.textContent = "Categor√≠as ‚ñæ";
    }
  }

  function updateBrandButtonLabel() {
    const sel = brandMenu.querySelector('input[name="brand"]:checked');
    if (sel && sel.value !== "Todas") {
      const label = sel.dataset.label || sel.value;
      brandToggleBtn.textContent = label + " ‚ñæ";
    } else {
      brandToggleBtn.textContent = "Marcas ‚ñæ";
    }
  }

  function closeDropdowns() {
    document.querySelectorAll(".custom-dropdown.open").forEach(dd => {
      dd.classList.remove("open");
      const menu = dd.querySelector(".custom-menu");
      if (menu) menu.setAttribute("aria-hidden", "true");
      const btn = dd.querySelector(".dropdown-toggle-btn");
      if (btn) btn.setAttribute("aria-expanded", "false");
    });
  }

  function refreshFilters() {
    allCategories = [...new Set(products.map(p => p.category).filter(Boolean))]
      .sort((a, b) => a.localeCompare(b, "es", { sensitivity: "base" }));

    const brandMap = new Map();
    products.forEach(p => {
      const raw = (p.marca || "").trim();
      if (!raw) return;
      const key = normalizeBrand(raw);
      if (!key) return;
      if (!brandMap.has(key)) {
        brandMap.set(key, raw);
      }
    });

    allBrands = Array.from(brandMap.entries())
      .map(([key, label]) => ({ key, label }))
      .sort((a, b) => a.label.localeCompare(b.label, "es", { sensitivity: "base" }));

    const saved = getSavedFilters();
    const catSaved = saved.category || "Todas";
    let brandSaved = saved.brand || "Todas";

    categoryMenu.innerHTML = ["Todas", ...allCategories].map(c => `
      <label style="display:block;margin-bottom:4px;">
        <input type="radio" name="category" value="${escapeAttr(c)}" ${c === catSaved ? "checked" : ""}>
        ${escapeHtml(c || "Todas")}
      </label>
    `).join("");

    const brandHtml = [
      `<label style="display:block;margin-bottom:4px;">
        <input type="radio" name="brand" value="Todas" ${brandSaved === "Todas" ? "checked" : ""}> Todas
      </label>`,
      ...allBrands.map(b => `
        <label style="display:block;margin-bottom:4px;">
          <input type="radio" name="brand" value="${escapeAttr(b.key)}" data-label="${escapeAttr(b.label)}" ${b.key === brandSaved ? "checked" : ""}>
          ${escapeHtml(b.label)}
        </label>
      `)
    ];
    brandMenu.innerHTML = brandHtml.join("");

    updateCategoryButtonLabel();
    updateBrandButtonLabel();
  }

  function setupFilterListenersOnce() {
    if (filterListenersAttached) return;
    filterListenersAttached = true;

    categoryMenu.addEventListener("change", () => {
      saveFiltersToStorage();
      filterAndDisplayProducts();
      updateCategoryButtonLabel();
      closeDropdowns();
    });

    brandMenu.addEventListener("change", () => {
      saveFiltersToStorage();
      filterAndDisplayProducts();
      updateBrandButtonLabel();
      closeDropdowns();
    });

    document.addEventListener("click", e => {
      const t = e.target;
      if (t.classList.contains("dropdown-toggle-btn")) {
        e.stopPropagation();
        const dd = t.closest(".custom-dropdown");
        if (!dd) return;
        const wasOpen = dd.classList.contains("open");
        closeDropdowns();
        dd.classList.toggle("open", !wasOpen);
        const menu = dd.querySelector(".custom-menu");
        if (menu) menu.setAttribute("aria-hidden", wasOpen ? "true" : "false");
        t.setAttribute("aria-expanded", (!wasOpen).toString());
      } else if (!t.closest(".custom-dropdown")) {
        closeDropdowns();
      }
    });

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        closeDropdowns();
      }
    });

    [categoryToggleBtn, brandToggleBtn].forEach(btn => {
      btn.addEventListener("keydown", e => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          btn.click();
        }
      });
    });

    // B√∫squeda con debounce
    searchInput.addEventListener("input", debounce(() => {
      const raw = searchInput.value || "";
      const term = raw.trim();

      if (!term) {
        currentSortOrder = "default";
        sortPriceBtn.textContent = "Ordenar por precio";
      }

      filterAndDisplayProducts();

      if (term && term !== lastSearchLogged) {
        lastSearchLogged = term;
        logVisit("busqueda", term);
      }
    }, 500));
  }

  // ================== CARGA DE PRODUCTOS ==================
  async function fetchProductsFromBackend() {
    try {
      const resp = await fetch(APPS_SCRIPT_URL + "?action=getAll&ts=" + Date.now());
      if (!resp.ok) throw new Error("Error de red al cargar productos");
      const data = await resp.json();
      if (data.status !== "success" || !Array.isArray(data.products)) {
        throw new Error(data.message || "Respuesta inv√°lida del servidor");
      }

      products = data.products.map(p => {
        const valor = Number(p.valor_unitario);
        const orden = Number(p.orden);
        return {
          ...p,
          valor_unitario: Number.isFinite(valor) ? valor : 0,
          orden: Number.isFinite(orden) ? orden : 999999
        };
      });

      refreshFilters();
      setupFilterListenersOnce();
      filterAndDisplayProducts();
    } catch (err) {
      console.error("Error al cargar productos:", err);
      productTableBody.innerHTML =
        '<tr><td colspan="6" style="text-align:center;">Error al cargar productos.</td></tr>';
    }
  }

  function sortByOrdenThenId(list) {
    list.sort((a, b) => {
      const aVal = typeof a.orden === "number" && !isNaN(a.orden) ? a.orden : 999999;
      const bVal = typeof b.orden === "number" && !isNaN(b.orden) ? b.orden : 999999;
      if (aVal !== bVal) return aVal - bVal;
      return String(a.id).localeCompare(String(b.id));
    });
  }

  // ================== LISTADO / FILTRADO ==================
  function filterAndDisplayProducts() {
    let list = [...products];

    const catSel = categoryMenu.querySelector('input[name="category"]:checked');
    const catVal = catSel ? catSel.value : "Todas";
    if (catVal !== "Todas") {
      list = list.filter(p => p.category === catVal);
    }

    const brandSel = brandMenu.querySelector('input[name="brand"]:checked');
    const brandVal = brandSel ? brandSel.value : "Todas";
    if (brandVal !== "Todas") {
      list = list.filter(p => normalizeBrand(p.marca || "") === brandVal);
    }

    const terms = normalizeText(searchInput.value)
      .split(/\s+/)
      .filter(Boolean);
    if (terms.length > 0) {
      list = list.filter(p => {
        const s = normalizeText(`${p.id} ${p.name} ${p.category} ${p.marca} ${p.description || ""}`);
        return terms.every(t => s.includes(t));
      });
    }

    if (currentSortOrder === "asc") {
      list.sort((a, b) => (a.valor_unitario || 0) - (b.valor_unitario || 0));
    } else if (currentSortOrder === "desc") {
      list.sort((a, b) => (b.valor_unitario || 0) - (a.valor_unitario || 0));
    } else {
      sortByOrdenThenId(list);
    }

    displayProducts(list);
  }

  function displayProducts(list) {
    if (!Array.isArray(list) || list.length === 0) {
      productTableBody.innerHTML =
        '<tr><td colspan="6" style="text-align:center;">No hay productos.</td></tr>';
      return;
    }

    const frag = document.createDocumentFragment();

    list.forEach(p => {
      const item = cart[p.id];
      const qty = item ? item.quantity : 0;
      const unitPrice = p.valor_unitario || 0;
      const subtotal = qty * unitPrice;

      const tr = document.createElement("tr");
      tr.setAttribute("data-product-id", p.id);

      tr.innerHTML = `
        <td data-label="Nombre"><span>${escapeHtml(p.name)}</span></td>
        <td data-label="Categor√≠a">${escapeHtml(p.category)}</td>
        <td data-label="Marca">${escapeHtml(p.marca)}</td>
        <td data-label="Valor unitario" class="price-cell">${currencyFormatter.format(unitPrice)}</td>
        <td data-label="Cantidad">
          <div class="quantity-control">
            <button type="button" class="quantity-btn decrease-btn" aria-label="Disminuir">-</button>
            <input type="number" class="quantity-input" min="0" value="${qty}"
              data-price="${unitPrice}" data-id="${escapeAttr(p.id)}" data-name="${escapeAttr(p.name)}">
            <button type="button" class="quantity-btn increase-btn" aria-label="Aumentar">+</button>
          </div>
        </td>
        <td data-label="Total" class="price-cell total-pay">${currencyFormatter.format(subtotal)}</td>
      `;

      frag.appendChild(tr);
    });

    productTableBody.innerHTML = "";
    productTableBody.appendChild(frag);
  }

  // ================== CARRITO ==================
  function loadCartFromStorage() {
    const saved = localStorage.getItem(LS_CART_KEY);
    if (!saved) {
      cart = {};
      return;
    }
    try {
      const parsed = JSON.parse(saved);
      if (parsed && typeof parsed === "object") {
        cart = parsed;
      } else {
        cart = {};
      }
    } catch (e) {
      cart = {};
    }
  }

  function updateCart() {
    const items = Object.values(cart);
    let total = 0;

    if (items.length === 0) {
      cartList.innerHTML =
        '<li class="cart-item"><span class="cart-item-title">El carrito est√° vac√≠o.</span></li>';
    } else {
      cartList.innerHTML = items.map(it => {
        const sub = it.quantity * it.price;
        total += sub;
        return `
          <li class="cart-item">
            <span class="cart-item-title">${it.quantity} x ${escapeHtml(it.name)} <strong>(${currencyFormatter.format(sub)})</strong></span>
            <button class="remove-item-btn" data-id="${escapeAttr(it.id)}">X</button>
          </li>
        `;
      }).join("");
    }

    totalPriceElement.textContent = "Total: " + currencyFormatter.format(total);
    localStorage.setItem(LS_CART_KEY, JSON.stringify(cart));
  }

  function buildClientWhatsAppMsg(items, header = "Hola, deseo comprar estos productos en Irenismb Natura Stock:") {
    let msg = header + "\n\n";
    let total = 0;
    items.forEach(it => {
      const sub = it.quantity * it.price;
      total += sub;
      msg += `‚Ä¢ ${it.quantity} x ${it.name} = ${currencyFormatter.format(sub)}\n`;
    });
    msg += `\nTotal: ${currencyFormatter.format(total)}\n`;
    msg += `\nUbicaci√≥n (GPS): https://maps.google.com/?q=11.244833370782679,-74.19066001689564`;
    msg += `\nInstagram: https://www.instagram.com/irenismb_stocknaturasm`;
    msg += `\nFacebook: https://www.facebook.com/marketplace/profile/100084865295132`;
    return msg;
  }

  function openWhatsApp(msg) {
    const encoded = encodeURIComponent(msg);
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const url = isMobile
      ? `https://api.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`
      : `https://web.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`;
    window.open(url, "_blank");
  }

  // ================== EVENTOS ==================
  productTableBody.addEventListener("input", e => {
    if (!e.target.classList.contains("quantity-input")) return;
    const input = e.target;
    let qty = parseInt(input.value, 10);
    if (isNaN(qty) || qty < 0) qty = 0;
    input.value = qty;

    const id = input.dataset.id;
    const name = input.dataset.name;
    const price = parseInt(input.dataset.price, 10) || 0;
    const tr = input.closest("tr");

    if (tr) {
      const totalCell = tr.querySelector(".total-pay");
      if (totalCell) {
        totalCell.textContent = currencyFormatter.format(qty * price);
      }
    }

    if (qty > 0) {
      cart[id] = { id, name, quantity: qty, price };
    } else {
      delete cart[id];
    }
    updateCart();
  });

  productTableBody.addEventListener("click", e => {
    const tr = e.target.closest("tr[data-product-id]");
    if (!tr) return;

    if (e.target.classList.contains("quantity-btn")) {
      const input = tr.querySelector(".quantity-input");
      let qty = parseInt(input.value, 10) || 0;
      if (e.target.classList.contains("increase-btn")) qty++;
      else if (e.target.classList.contains("decrease-btn")) qty--;
      if (qty < 0) qty = 0;
      input.value = qty;
      input.dispatchEvent(new Event("input", { bubbles: true }));
      return;
    }

    if (e.target.classList.contains("quantity-input")) return;

    const id = tr.getAttribute("data-product-id");
    const prod = products.find(p => String(p.id) === String(id));
    if (prod) {
      showPreviewForProduct(prod);
      logVisit("producto: " + prod.name, (searchInput.value || "").trim());
    }
  });

  sortPriceBtn.addEventListener("click", () => {
    if (currentSortOrder === "default" || currentSortOrder === "desc") {
      currentSortOrder = "asc";
      sortPriceBtn.textContent = "Precio $‚Üì";
    } else {
      currentSortOrder = "desc";
      sortPriceBtn.textContent = "Precio $‚Üë";
    }
    filterAndDisplayProducts();
  });

  whatsappBtn.addEventListener("click", () => {
    const items = Object.values(cart);
    if (!items.length) return;
    const msg = buildClientWhatsAppMsg(items);
    openWhatsApp(msg);
  });

  contactWhatsappLink.addEventListener("click", e => {
    e.preventDefault();
    openWhatsApp("Hola, me interesan los productos de Irenismb Natura Stock.");
  });

  cartList.addEventListener("click", e => {
    if (!e.target.classList.contains("remove-item-btn")) return;
    const id = e.target.dataset.id;
    delete cart[id];
    try {
      const selector = `.quantity-input[data-id="${CSS.escape(id)}"]`;
      const input = productTableBody.querySelector(selector);
      if (input) {
        input.value = 0;
        input.dispatchEvent(new Event("input", { bubbles: true }));
      } else {
        updateCart();
      }
    } catch (err) {
      updateCart();
    }
  });

  function startAutoRefresh() {
    stopAutoRefresh();
    autoRefreshTimer = setInterval(() => {
      if (document.hidden) return;
      fetchProductsFromBackend();
    }, AUTO_REFRESH_MS);
  }

  function stopAutoRefresh() {
    if (autoRefreshTimer) {
      clearInterval(autoRefreshTimer);
      autoRefreshTimer = null;
    }
  }

  document.addEventListener("visibilitychange", () => {
    if (document.hidden) stopAutoRefresh();
    else startAutoRefresh();
  });

  document.addEventListener("DOMContentLoaded", () => {
    // Mejora peque√±a: decodificaci√≥n as√≠ncrona para la imagen principal de preview
    if (previewImg) {
      previewImg.decoding = "async";
      previewImg.loading = "eager";
    }

    loadCartFromStorage();
    updateCart();
    fetchProductsFromBackend();
    startAutoRefresh();
    logVisit("entrada_catalogo", "");
  });

  window.addEventListener("beforeunload", () => {
    localStorage.setItem(LS_CART_KEY, JSON.stringify(cart));
    localStorage.setItem(LS_FILTERS_KEY, JSON.stringify(getSavedFilters()));
  });
</script>
</body>
</html>



