<script>
    const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS4Nfc_zvMMpHmVPCrDB0lFJ1yIQkOCWFtfEuBzxJEgN3HmPVkP77rSDyOKzN6Vc1xmT76cAcYkdQEl/pub?gid=0&single=true&output=csv';

    // Se definen las variables globales.
    let products = [];
    const categoryCheckboxesContainer = document.getElementById('categoryCheckboxes');
    const brandCheckboxesContainer = document.getElementById('brandCheckboxes');
    const searchInput = document.getElementById('searchInput');
    const productTableBody = document.getElementById('productTableBody');
    const cartList = document.getElementById('cartList');
    const totalPriceElement = document.getElementById('totalPrice');
    const whatsappBtn = document.getElementById('whatsappBtn');
    const clearCartBtn = document.getElementById('clearCartBtn');
    const contactWhatsappLink = document.getElementById('contactWhatsappLink');
    const sortPriceBtn = document.getElementById('sortPriceBtn');
    let cart = {};
    let currentSortOrder = 'default';

    // Usamos fetch para traer los datos de la URL.
    fetch(googleSheetURL)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la red al cargar los datos.');
            }
            return response.text();
        })
        .then(csvText => {
            const rows = csvText.trim().split('\n').slice(2); // <-- AQUÍ ESTÁ EL CAMBIO
            products = rows.map(row => {
                const columns = row.split(',');
                return {
                    name: columns[0] ? columns[0].trim() : '',
                    category: columns[1] ? columns[1].trim() : '',
                    marca: columns[2] ? columns[2].trim() : '',
                    valor_unitario: parseInt(columns[3], 10) || 0
                };
            }).filter(p => p.name && p.name.trim() !== ''); // Filtra filas vacías
            
            initializeApp(); // Inicia la aplicación una vez que los productos están cargados.
        })
        .catch(error => {
            console.error('Error al cargar productos:', error);
            productTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error al cargar productos. Verifica que la hoja de cálculo esté "Publicada en la web" como CSV.</td></tr>`;
        });

    function initializeApp() {
        const brandOrder = { 'Natura': 1, 'Avon': 2, 'Esika': 3 };
        const categoryOrder = { 'Perfumes femeninos': 1, 'Perfumes masculinos': 2, 'Perfumes unisex': 3, 'Colonias': 4, 'Combos perfumes': 5, 'Regalos': 6, 'Combos regalos': 7, 'Combos cuidado corporal': 8, 'Cremas hidratantes corporales': 9, 'Combos cuidado capilar': 10, 'Jabones': 11, 'Cremas hidratantes para manos': 12, 'Cuidado capilar': 13, 'Bloqueadores': 14, 'Cuidado facial': 15, 'Combos cuidado facial': 16, 'Desodorantes y antitranspirantes': 17, 'Exfoliantes': 18, 'Maquillaje': 19, 'Aceites': 20, 'Cremas y bálsamos para afeitar': 21, 'Cuidado del bebe': 22, 'Cuidado intimo': 23 };
        
        products.sort((a, b) => {
            const brandAOrder = brandOrder[a.marca] || 99;
            const brandBOrder = brandOrder[b.marca] || 99;
            if (brandAOrder !== brandBOrder) return brandAOrder - brandBOrder;
            const categoryAOrder = categoryOrder[a.category] || 999;
            const categoryBOrder = categoryOrder[b.category] || 999;
            if (categoryAOrder !== categoryBOrder) return categoryAOrder - categoryBOrder;
            return a.name.localeCompare(b.name);
        });

        const savedCart = localStorage.getItem("shoppingCart");
        if (savedCart) {
            try {
                cart = JSON.parse(savedCart) || {};
            } catch (a) {
                console.error("Error al leer el carrito:", a);
                cart = {};
            }
        }

        const categories = ["Todas", ...new Set(products.map(p => p.category))].sort();
        const brands = ["Todas", ...new Set(products.map(p => p.marca))].sort();
        const currencyFormatter = new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", minimumFractionDigits: 0 });

        function normalizeText(text) {
            return text.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function filterAndDisplayProducts() {
            let filteredProducts = [...products];
            const selectedCategories = Array.from(document.querySelectorAll("#categoryCheckboxes input:checked")).map(cb => cb.value);
            if (selectedCategories.length > 0 && !selectedCategories.includes("Todas")) {
                filteredProducts = filteredProducts.filter(p => selectedCategories.includes(p.category));
            }
            const selectedBrands = Array.from(document.querySelectorAll("#brandCheckboxes input:checked")).map(cb => cb.value);
            if (selectedBrands.length > 0 && !selectedBrands.includes("Todas")) {
                filteredProducts = filteredProducts.filter(p => selectedBrands.includes(p.marca));
            }
            const searchTerms = normalizeText(searchInput.value).split(/\s+/).filter(term => term);
            if (searchTerms.length > 0) {
                filteredProducts = filteredProducts.filter(product => {
                    const searchableText = normalizeText(`${product.name} ${product.category} ${product.marca}`);
                    return searchTerms.every(term => searchableText.includes(term));
                });
            }
            if (currentSortOrder === "asc") {
                filteredProducts.sort((a, b) => a.valor_unitario - b.valor_unitario);
            } else if (currentSortOrder === "desc") {
                filteredProducts.sort((a, b) => b.valor_unitario - a.valor_unitario);
            }
            displayProducts(filteredProducts);
        }

        function displayProducts(productsToDisplay) {
            productTableBody.innerHTML = "";
            if (productsToDisplay.length === 0) {
                productTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding-left: 10px;">No se encontraron productos.</td></tr>';
                return;
            }
            productsToDisplay.forEach(product => {
                const row = document.createElement("tr");
                const quantityInCart = cart[product.name] ? cart[product.name].quantity : 0;
                const subtotal = quantityInCart * product.valor_unitario;
                row.innerHTML = `
                        <td data-label="Producto">${product.name}</td>
                        <td data-label="Categoría">${product.category}</td>
                        <td data-label="Marca">${product.marca}</td>
                        <td data-label="Valor Unit." class="price-cell">${currencyFormatter.format(product.valor_unitario)}</td>
                        <td data-label="Cantidad">
                            <div class="quantity-control">
                                <button type="button" class="quantity-btn decrease-btn">-</button>
                                <input type="number" class="quantity-input" min="0" value="${quantityInCart}" data-price="${product.valor_unitario}" data-name="${product.name}">
                                <button type="button" class="quantity-btn increase-btn">+</button>
                            </div>
                        </td>
                        <td data-label="Total a Pagar" class="price-cell total-pay">${currencyFormatter.format(subtotal)}</td>`;
                productTableBody.appendChild(row);
            });
        }

        function updateCart() {
            let grandTotal = 0;
            const cartItems = Object.values(cart);
            if (cartItems.length === 0) {
                cartList.innerHTML = "<li>El carrito está vacío.</li>";
            } else {
                cartList.innerHTML = cartItems.map(item => {
                    const subtotal = item.quantity * item.price;
                    grandTotal += subtotal;
                    return `<li><span>${item.quantity} x ${item.name} (${currencyFormatter.format(subtotal)})</span><button class="remove-item-btn" data-name="${item.name}">X</button></li>`;
                }).join("");
            }
            totalPriceElement.textContent = `Total: ${currencyFormatter.format(grandTotal)}`;
            localStorage.setItem("shoppingCart", JSON.stringify(cart));
        }

        productTableBody.addEventListener("input", (event) => {
            if (event.target.classList.contains("quantity-input")) {
                const input = event.target;
                let quantity = parseInt(input.value, 10) || 0;
                const name = input.dataset.name;
                const price = parseFloat(input.dataset.price);
                if (quantity < 0) { quantity = 0; input.value = 0; }
                input.closest("tr").querySelector(".total-pay").textContent = currencyFormatter.format(quantity * price);
                if (quantity > 0) {
                    cart[name] = { name, quantity, price };
                } else {
                    delete cart[name];
                }
                updateCart();
            }
        });

        productTableBody.addEventListener("click", (event) => {
            const target = event.target;
            if (target.classList.contains("quantity-btn")) {
                const controlDiv = target.closest(".quantity-control");
                const input = controlDiv.querySelector(".quantity-input");
                let currentValue = parseInt(input.value, 10) || 0;
                if (target.classList.contains("increase-btn")) {
                    currentValue++;
                } else if (target.classList.contains("decrease-btn")) {
                    currentValue--;
                }
                if (currentValue < 0) { currentValue = 0; }
                input.value = currentValue;
                input.dispatchEvent(new Event("input", { bubbles: true }));
            }
        });

        function populateCheckboxes(container, items) {
            container.innerHTML = items.map(item => `<label class="category-checkbox-item"><input type="checkbox" name="category" value="${item}" ${"Todas" === item ? "checked" : ""}><span>${item}</span></label>`).join("");
        }

        function setupCheckboxListener(container) {
            container.addEventListener("change", (event) => {
                const targetCheckbox = event.target;
                if ("checkbox" !== targetCheckbox.type) return;
                const allCheckbox = container.querySelector('input[value="Todas"]');
                if ("Todas" === targetCheckbox.value && targetCheckbox.checked) {
                    container.querySelectorAll('input:not([value="Todas"])').forEach(cb => cb.checked = false);
                } else if ("Todas" !== targetCheckbox.value && targetCheckbox.checked && allCheckbox) {
                    allCheckbox.checked = false;
                }
                if (!container.querySelector("input:checked") && allCheckbox) {
                    allCheckbox.checked = true;
                }
                filterAndDisplayProducts();
            });
        }

        function openWhatsApp(message) {
            const phoneNumber = "573042088961";
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) ? `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}` : `https://web.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
            window.open(whatsappURL, "_blank");
        }

        searchInput.addEventListener("input", filterAndDisplayProducts);

        sortPriceBtn.addEventListener("click", () => {
            if ("default" === currentSortOrder || "desc" === currentSortOrder) {
                currentSortOrder = "asc";
                sortPriceBtn.textContent = "Precio $↓";
                sortPriceBtn.classList.add("active");
            } else if ("asc" === currentSortOrder) {
                currentSortOrder = "desc";
                sortPriceBtn.textContent = "Precio $↑";
            }
            filterAndDisplayProducts();
        });

        whatsappBtn.addEventListener("click", () => {
            const cartItems = Object.values(cart);
            if (cartItems.length === 0) {
                return void alert("El carrito está vacío. Por favor, añade una cantidad a los productos que deseas comprar.");
            }
            let message = "Hola, deseo comprar los siguientes productos:\n\n";
            let total = 0;
            cartItems.forEach(item => {
                const subtotal = item.quantity * item.price;
                message += `- ${item.quantity} x *${item.name}* (${currencyFormatter.format(item.price)} c/u) - Subtotal: ${currencyFormatter.format(subtotal)}\n`;
                total += subtotal;
            });
            message += `\n*Total del pedido: ${currencyFormatter.format(total)}*`;
            openWhatsApp(message);
        });

        contactWhatsappLink.addEventListener("click", (e) => {
            e.preventDefault();
            openWhatsApp("Hola, me interesan tus productos.");
        });

        cartList.addEventListener("click", (event) => {
            if (event.target.classList.contains("remove-item-btn")) {
                const productName = event.target.dataset.name;
                delete cart[productName];
                const inputInTable = productTableBody.querySelector(`.quantity-input[data-name="${productName}"]`);
                if (inputInTable) {
                    inputInTable.value = 0;
                    inputInTable.dispatchEvent(new Event("input", { bubbles: true }));
                } else {
                    updateCart();
                }
            }
        });

        clearCartBtn.addEventListener("click", () => {
            cart = {};
            localStorage.removeItem("shoppingCart");
            productTableBody.querySelectorAll(".quantity-input").forEach(input => {
                if (parseInt(input.value) > 0) {
                    input.value = 0;
                    input.dispatchEvent(new Event("input", { bubbles: true }));
                }
            });
            updateCart();
        });

        // Llamadas iniciales para configurar la página
        populateCheckboxes(categoryCheckboxesContainer, categories);
        populateCheckboxes(brandCheckboxesContainer, brands);
        setupCheckboxListener(categoryCheckboxesContainer);
        setupCheckboxListener(brandCheckboxesContainer);
        filterAndDisplayProducts();
        updateCart();
    }
</script>
