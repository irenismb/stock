<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Irenismb Natura Stock - Cat√°logo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --primary:#007bff;
      --secondary:#25D366;
      --bg:#f4f4f9;
      --text:#333;
      --card:#fff;
      --border:#ddd;
      --danger:#dc3545;
      --radius:8px;
      --gap:8px;
    }
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      max-width:100%;
      overflow-x:hidden;
    }
    body{
      margin:0;
      padding:10px;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    }
    .container{
      display:flex;
      gap:15px;
      align-items:flex-start;
      width:100%;
    }
    .left-panel{
      flex:3 1 700px;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .right-panel{
      flex:1 1 280px;
      position:sticky;
      top:10px;
      display:flex;
      flex-direction:column;
      gap:15px;
      max-height:calc(100vh - 20px);
      overflow-y:auto;
    }
    .controls-panel{
      position:sticky;
      top:0;
      z-index:40;
      background:var(--bg);
      padding-bottom:6px;
      padding-top:4px;
    }
    .products-header{
      display:flex;
      flex-direction:column;
      gap:6px;
      border-bottom:1px solid rgba(0,0,0,.05);
      padding-bottom:6px;
    }
    .controls-top{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:nowrap;
    }
    #searchInput{
      flex:1 1 220px;
      min-width:180px;
      padding:10px 12px;
      border:1px solid #ccc;
      border-radius:5px;
      background:var(--card);
      font-size:16px;
    }
    #modeSelector,
    #inventoryTotal,
    #saveEditsBtn,
    #logoutBtn,
    #googleSignInContainer{
      flex:0 0 auto;
    }
    .controls-bottom{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    #modeSelector{
      padding:6px 10px;
      border:1px solid #ccc;
      border-radius:5px;
      background:var(--card);
      font-size:14px;
      min-height:36px;
    }
    #inventoryTotal{
      font-weight:bold;
      color:var(--danger);
      white-space:nowrap;
      display:none;
    }
    #saveEditsBtn,
    #logoutBtn{
      border:none;
      border-radius:6px;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
    }
    #saveEditsBtn{
      background:#198754;
      color:#fff;
      display:none;
    }
    #saveEditsBtn[disabled]{
      opacity:.55;
      cursor:not-allowed;
    }
    #logoutBtn{
      background:var(--danger);
      color:#fff;
      display:none;
    }
    #googleSignInContainer{
      display:block;
    }
    .custom-dropdown{position:relative}
    .dropdown-toggle-btn{
      padding:8px 10px;
      border:1px solid #ccc;
      border-radius:5px;
      background:var(--card);
      cursor:pointer;
      white-space:nowrap;
      font-size:14px;
      min-height:38px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .custom-menu{
      position:absolute;
      top:calc(100% + 6px);
      right:0;
      background:var(--card);
      border:1px solid var(--border);
      padding:8px;
      border-radius:6px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      display:none;
      z-index:50;
      max-height:220px;
      overflow:auto;
      min-width:200px;
    }
    .custom-dropdown.open .custom-menu{display:block}
    #categoryMenu{right:auto;left:0}
    #sortPriceBtn{
      padding:8px 12px;
      font-size:14px;
      border:1px solid #ccc;
      background:#f8f9fa;
      border-radius:5px;
      cursor:pointer;
      min-height:38px;
    }
    .table-wrapper{
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      max-height:calc(100vh - 140px);
      overflow-y:auto;
    }
    .product-table{
      width:100%;
      border-collapse:collapse;
      background:var(--card);
    }
    .product-table th,
    .product-table td{
      border:1px solid var(--border);
      padding:10px;
      text-align:left;
      vertical-align:middle;
    }
    .product-table thead th{
      background:var(--primary);
      color:#fff;
      font-size:14px;
      text-align:center;
      position:sticky;
      top:0;
      z-index:30;
    }
    .product-table tr:nth-child(even){background:#f8f9fa}
    .quantity-control{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:4px;
    }
    .quantity-btn{
      background:#e9ecef;
      border:1px solid #ced4da;
      color:#495057;
      cursor:pointer;
      font-size:1.2rem;
      font-weight:700;
      width:34px;
      height:34px;
      line-height:32px;
      text-align:center;
      border-radius:6px;
      touch-action:manipulation;
    }
    .quantity-input{
      width:55px;
      height:34px;
      padding:5px;
      text-align:center;
      border:1px solid #ced4da;
      background:#fff;
      font-size:15px;
      border-radius:6px;
    }
    .price-cell{font-weight:700;color:#2a9d8f}
    .cart-container{
      background:#e9f5ff;
      padding:15px;
      border-radius:10px;
      border:1px solid #bde0fe;
      box-shadow:0 6px 16px rgba(13,110,253,0.08);
    }
    .cart-container h3{
      margin-top:0;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:16px;
      border-bottom:1px solid rgba(0,0,0,.05);
      padding-bottom:6px;
    }
    #cartList{
      list-style:none;
      padding:0;
      margin:10px 0;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:220px;
      overflow-y:auto;
    }
    .cart-item{
      display:flex;
      justify-content:space-between;
      gap:8px;
      background:#fff;
      border:1px solid rgba(0,0,0,.03);
      border-radius:6px;
      padding:6px 8px 6px 10px;
      font-size:13px;
    }
    .remove-item-btn{
      border:none;
      background:#f8d7da;
      color:#842029;
      border-radius:4px;
      padding:1px 6px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      touch-action:manipulation;
    }
    #totalPrice{
      font-weight:700;
      font-size:15px;
      text-align:right;
      margin-top:4px;
      background:#fff;
      border-radius:6px;
      padding:5px 8px;
    }
    #whatsappBtn,#invoiceBtn{
      background:var(--secondary);
      color:#fff;
      width:100%;
      border:none;
      padding:11px 14px;
      font-size:15px;
      border-radius:8px;
      cursor:pointer;
      margin-top:8px;
      touch-action:manipulation;
    }
    #invoiceBtn{background:#0d6efd}
    .contact-info{
      padding:15px;
      background:var(--card);
      border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
      font-size:14px;
      text-align:center;
    }
    .only-client{display:block;}
    .only-admin{display:none;}
    .only-admin-edit{display:none;}
    .only-admin-sale{display:none;}
    .row-pending-edit{
      outline:2px dashed rgba(25,135,84,.5);
      background:rgba(25,135,84,.04);
    }

    /* ======== M√ìVIL ======== */
    @media (max-width:768px){
      body{padding:6px;}
      .container{
        flex-direction:column-reverse;
        gap:10px;
      }
      .controls-panel{position:static;}
      .right-panel{
        position:static;
        max-height:none;
        width:100%;
        overflow:visible;
      }
      .cart-container,
      .contact-info{
        width:100%;
      }
      .table-wrapper{
        max-height:none;
        overflow:visible;
        width:100%;
      }
      .controls-top{
        flex-direction:column;
        align-items:stretch;
      }
      #searchInput,
      #modeSelector{
        width:100%;
        padding:6px 10px;
        min-height:40px;
        line-height:1.2;
      }
      .controls-bottom{
        flex-direction:column;
        align-items:stretch;
      }
      #modeSelector,
      #inventoryTotal,
      #saveEditsBtn,
      #logoutBtn,
      #googleSignInContainer,
      #sortPriceBtn,
      .dropdown-toggle-btn{
        width:100%;
        text-align:left;
      }
      .custom-menu{
        width:min(310px,96vw);
        left:0;
        right:auto;
      }
      .product-table{border:0;}
      .product-table thead{display:none;}
      .product-table tr{
        display:block;
        background:#fff;
        margin-bottom:12px;
        border:1px solid #eee;
        border-radius:8px;
        overflow:hidden;
      }
      .product-table td{
        display:flex;
        justify-content:space-between;
        gap:12px;
        border:none;
        border-bottom:1px solid #f1f1f1;
        padding:8px 10px;
        font-size:14px;
        width:100% !important;
        max-width:100% !important;
      }
      .product-table td:last-child{border-bottom:none;}
      .product-table td::before{
        content:attr(data-label);
        font-weight:600;
        color:#555;
        margin-right:8px;
        flex:1;
      }
      .quantity-control{justify-content:flex-end;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <div class="controls-panel">
        <div class="products-header">
          <div class="controls-top">
            <input id="searchInput" type="text" autocomplete="off" inputmode="search" placeholder="üîç Buscar por nombre, marca, categor√≠a...">
            <select id="modeSelector" title="Seleccionar modo">
              <option value="client" selected>Cliente</option>
              <option value="admin_edit">Edici√≥n</option>
              <option value="admin_sale">Vendedor</option>
            </select>
            <span id="inventoryTotal">Total: $0</span>
            <button id="saveEditsBtn" class="only-admin-edit" disabled>üíæ Guardar cambios (0)</button>
            <button id="logoutBtn" class="only-admin">üö™ Cerrar sesi√≥n</button>
            <div id="googleSignInContainer"></div>
          </div>
          <div class="controls-bottom">
            <button id="sortPriceBtn" class="only-client">Ordenar por precio</button>
            <div class="custom-dropdown" id="categoryDropdown">
              <button type="button" id="categoryToggleBtn" class="dropdown-toggle-btn">Categor√≠as ‚ñæ</button>
              <div id="categoryMenu" class="custom-menu" aria-hidden="true"></div>
            </div>
            <div class="custom-dropdown" id="brandDropdown">
              <button type="button" id="brandToggleBtn" class="dropdown-toggle-btn">Marcas ‚ñæ</button>
              <div id="brandMenu" class="custom-menu" aria-hidden="true"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="product-table" aria-label="Listado de productos">
          <thead>
            <tr>
              <th>Nombre producto</th>
              <th>Categor√≠a</th>
              <th>Marca</th>
              <th>Valor unitario</th>
              <th id="qtyHeader">Cantidad</th>
              <th>Total a pagar</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr><td colspan="6" style="text-align:center;">Cargando productos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="right-panel">
      <div class="cart-container" id="cartContainer">
        <h3>üõí Carrito de Compras</h3>
        <ul id="cartList">
          <li class="cart-item"><span class="cart-item-title">El carrito est√° vac√≠o.</span></li>
        </ul>
        <div id="totalPrice">Total: 0</div>
        <button id="whatsappBtn" class="only-client">Comprar por WhatsApp (cliente)</button>
        <button id="invoiceBtn" class="only-admin-sale" style="display:none;" disabled>Vender</button>
      </div>

      <div class="contact-info">
        <h3>‚ú® Contacto y Ubicaci√≥n ‚ú®</h3>
        <p class="small-gap">üì± <strong>WhatsApp y llamadas:</strong> <a href="https://wa.me/573042088961" target="_blank" rel="noopener" id="contactWhatsappLink">3042088961</a></p>
        <p class="small-gap">üìç <strong>Ubicaci√≥n:</strong> Estamos en Santa Marta. ¬°Hacemos env√≠os a toda Colombia y pagos contra entrega en Santa Marta!</p>
        <p class="small-gap">üó∫Ô∏è <strong>Vis√≠tanos (GPS):</strong> <a href="https://www.google.com/maps" target="_blank" rel="noopener">Ver en Google Maps</a></p>
        <hr>
        <h3>üåê ¬°S√≠guenos en Nuestras Redes! üåê</h3>
        <p class="small-gap">üëç <a href="#" target="_blank" rel="noopener">Facebook</a></p>
        <p class="small-gap">üì∏ <a href="#" target="_blank" rel="noopener">Instagram</a></p>
        <p class="small-gap">üéµ <a href="#" target="_blank" rel="noopener">TikTok</a></p>
      </div>
    </div>
  </div>

  <script>
    const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBTeqbaoB-5-b_h98cslcSic_6QcA1lCkCQagpF8q-yxcr1okC9TEuIYAZDgTL1DSCvdPtwBrApGj6/pub?gid=732037573&single=true&output=tsv';
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgRlyQfToDd8O7JOyRP0XXdryqpksSTu04zuhaZHYnun59S0ALXR_vnHZGfY5ch7SP/exec";
    const GOOGLE_CLIENT_ID = "575624026373-nm1ienpvaaa4its9070pv182quqf544m.apps.googleusercontent.com";
    const DEFAULT_WHATSAPP = "573042088961";
    const SELLER_NAME = "Irenis Stock Natura";
    const SELLER_PHONE = "3042088961";
    const AUTO_REFRESH_MS = 20000; // refresca cat√°logo cada 20 s

    const ALLOWED_ADMIN_EMAILS = [
      "irenismendoza@gmail.com",
      "marllerpar@gmail.com"
    ];

    const MODE_CLIENT = "client";
    const MODE_ADMIN_EDIT = "admin_edit";
    const MODE_ADMIN_SALE = "admin_sale";
    const SESSION_KEY = "naturaAdminGoogleSession";

    let currentMode = MODE_CLIENT;
    let products = [];
    let cart = {};
    let allCategories = [];
    let allBrands = [];
    let currentSortOrder = "default";
    let googleUserToken = null;
    let currentAdminName = null;
    let currentAdminEmail = null;
    let pendingEdits = [];

    const searchInput = document.getElementById('searchInput');
    const productTableBody = document.getElementById('productTableBody');
    const cartList = document.getElementById('cartList');
    const totalPriceElement = document.getElementById('totalPrice');
    const whatsappBtn = document.getElementById('whatsappBtn');
    const contactWhatsappLink = document.getElementById('contactWhatsappLink');
    const sortPriceBtn = document.getElementById('sortPriceBtn');
    const googleSignInContainer = document.getElementById('googleSignInContainer');
    const inventoryTotalElement = document.getElementById('inventoryTotal');
    const invoiceBtn = document.getElementById('invoiceBtn');
    const qtyHeader = document.getElementById('qtyHeader');
    const modeSelector = document.getElementById('modeSelector');
    const categoryMenuContainer = document.getElementById('categoryMenu');
    const brandMenuContainer = document.getElementById('brandMenu');
    const categoryToggleBtn = document.getElementById('categoryToggleBtn');
    const brandToggleBtn = document.getElementById('brandToggleBtn');
    const saveEditsBtn = document.getElementById('saveEditsBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const currencyFormatter = new Intl.NumberFormat("es-CO", {
      style: "currency",
      currency: "COP",
      minimumFractionDigits: 0
    });

    async function fetchProductsFromSheet() {
      try {
        const resp = await fetch(googleSheetURL + "&_=" + Date.now());
        if (!resp.ok) throw new Error("Error de red");
        const csvText = await resp.text();
        const rows = csvText.trim().split('\n').slice(2);
        const newProducts = rows.map(row => {
          const cols = row.split('\t');
          if (cols.length < 6) return null;
          const priceStr = (cols[3] || '0').replace(/[^\d]/g, '');
          const stockStr = (cols[4] || '0').replace(/[^\d]/g, '');
          const id = cols[5] ? cols[5].trim() : null;
          const name = cols[0] ? cols[0].trim() : null;
          if (!id || !name) return null;
          return {
            id,
            name,
            category: cols[1] ? cols[1].trim() : '',
            marca: cols[2] ? toTitleCase(cols[2].trim()) : '',
            valor_unitario: parseInt(priceStr, 10) || 0,
            stock: parseInt(stockStr, 10) || 0
          };
        }).filter(Boolean);
        if (newProducts.length > 0) {
          products = newProducts.sort((a, b) => a.name.localeCompare(b.name));
          refreshFilters();
          filterAndDisplayProducts();
          updateInventoryTotalDisplay();
        }
      } catch (err) {
        console.error(err);
        productTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error al cargar productos.</td></tr>`;
      }
    }

    fetchProductsFromSheet().then(() => {
      restoreAdminSession();
      loadCartFromStorage();
      applyUIMode();
      filterAndDisplayProducts();
      updateCart();
      updateInventoryTotalDisplay();
    });

    setInterval(() => {
      if (pendingEdits.length === 0) {
        fetchProductsFromSheet();
      }
    }, AUTO_REFRESH_MS);

    document.addEventListener("DOMContentLoaded", () => {
      let tries = 0;
      const maxTries = 20;
      const timer = setInterval(() => {
        tries++;
        if (typeof google !== "undefined" && google.accounts && google.accounts.id) {
          clearInterval(timer);
          try {
            google.accounts.id.initialize({
              client_id: GOOGLE_CLIENT_ID,
              callback: handleGoogleSignIn
            });
            google.accounts.id.renderButton(
              googleSignInContainer,
              { theme: "outline", size: "medium", text: "signin_with", shape: "rectangular" }
            );
          } catch (e) { console.warn(e); }
        }
        if (tries >= maxTries) clearInterval(timer);
      }, 300);
    });

    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) { return null; }
    }

    function handleGoogleSignIn(resp) {
      if (!resp.credential) {
        alert("Error de login");
        return;
      }
      const payload = parseJwt(resp.credential);
      const email = payload && payload.email ? payload.email : null;
      const name = payload && (payload.given_name || payload.name) ? (payload.given_name || payload.name) : "Admin";

      if (email && !ALLOWED_ADMIN_EMAILS.includes(email)) {
        alert("Este correo no est√° autorizado como administrador.\nCorreo: " + email);
        currentMode = MODE_CLIENT;
        modeSelector.value = MODE_CLIENT;
        applyUIMode();
        filterAndDisplayProducts();
        return;
      }

      googleUserToken = resp.credential;
      currentAdminName = name;
      currentAdminEmail = email;

      localStorage.setItem(SESSION_KEY, JSON.stringify({
        token: googleUserToken,
        name: currentAdminName,
        email: currentAdminEmail,
        mode: MODE_ADMIN_EDIT
      }));

      enterAdminMode(name, email, MODE_ADMIN_EDIT);
    }

    function restoreAdminSession() {
      try {
        const raw = localStorage.getItem(SESSION_KEY);
        if (!raw) return;
        const saved = JSON.parse(raw);
        if (!saved || !saved.token || !saved.email) return;
        googleUserToken = saved.token;
        currentAdminName = saved.name || "Admin";
        currentAdminEmail = saved.email;
        currentMode = saved.mode || MODE_ADMIN_EDIT;
      } catch (e) {
        console.warn("No se pudo restaurar la sesi√≥n:", e);
      }
    }

    function refreshFilters() {
      allCategories = [...new Set(products.map(p => p.category))].sort();
      allBrands = [...new Set(products.map(p => p.marca))].sort();

      categoryMenuContainer.innerHTML = ["Todas", ...allCategories].map(c => `
        <label style="display:block;margin-bottom:4px;">
          <input type="radio" name="category" value="${c}" ${c==="Todas"?"checked":""}>
          ${c}
        </label>
      `).join("");

      brandMenuContainer.innerHTML = ["Todas", ...allBrands].map(b => `
        <label style="display:block;margin-bottom:4px;">
          <input type="radio" name="brand" value="${b}" ${b==="Todas"?"checked":""}>
          ${b}
        </label>
      `).join("");

      categoryMenuContainer.addEventListener("change", () => {
        filterAndDisplayProducts();
        updateCategoryButtonLabel();
        closeDropdowns();
      });
      brandMenuContainer.addEventListener("change", () => {
        filterAndDisplayProducts();
        updateBrandButtonLabel();
        closeDropdowns();
      });

      updateCategoryButtonLabel();
      updateBrandButtonLabel();
    }

    function updateCategoryButtonLabel(){
      const sel = categoryMenuContainer.querySelector('input[name="category"]:checked');
      categoryToggleBtn.textContent = sel && sel.value !== "Todas"
        ? sel.value + " ‚ñæ"
        : "Categor√≠as ‚ñæ";
    }
    function updateBrandButtonLabel(){
      const sel = brandMenuContainer.querySelector('input[name="brand"]:checked');
      brandToggleBtn.textContent = sel && sel.value !== "Todas"
        ? sel.value + " ‚ñæ"
        : "Marcas ‚ñæ";
    }

    function closeDropdowns(){
      document.querySelectorAll('.custom-dropdown.open').forEach(d => {
        d.classList.remove('open');
        d.querySelector('.custom-menu').setAttribute('aria-hidden','true');
      });
    }
    document.addEventListener("click", e => {
      const t = e.target;
      if (t.classList.contains("dropdown-toggle-btn")) {
        e.stopPropagation();
        const dd = t.closest(".custom-dropdown");
        const was = dd.classList.contains("open");
        closeDropdowns();
        dd.classList.toggle("open", !was);
        dd.querySelector(".custom-menu").setAttribute("aria-hidden", was ? "true" : "false");
      } else if (!t.closest(".custom-dropdown")) {
        closeDropdowns();
      }
    });

    function enterAdminMode(name, email, modeWanted){
      currentMode = modeWanted || MODE_ADMIN_EDIT;
      modeSelector.value = currentMode;
      applyUIMode();
      filterAndDisplayProducts();
      updateInventoryTotalDisplay();
      const saved = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      if (saved){
        saved.mode = currentMode;
        localStorage.setItem(SESSION_KEY, JSON.stringify(saved));
      }
    }

    function exitAdminMode(){
      currentMode = MODE_CLIENT;
      googleUserToken = null;
      currentAdminName = null;
      currentAdminEmail = null;
      pendingEdits = [];
      updateSaveBtnState();
      localStorage.removeItem(SESSION_KEY);
      modeSelector.value = MODE_CLIENT;
      applyUIMode();
      filterAndDisplayProducts();
      updateInventoryTotalDisplay();
    }

    logoutBtn.addEventListener("click", () => {
      exitAdminMode();
      alert("Sesi√≥n cerrada.");
    });

    modeSelector.addEventListener("change", () => {
      const selected = modeSelector.value;

      if (!googleUserToken && (selected === MODE_ADMIN_EDIT || selected === MODE_ADMIN_SALE)) {
        alert("Inicia sesi√≥n con un correo autorizado para usar ese modo.");
        modeSelector.value = MODE_CLIENT;
        currentMode = MODE_CLIENT;
        applyUIMode();
        filterAndDisplayProducts();
        return;
      }

      if (selected === MODE_CLIENT) {
        exitAdminMode();
        return;
      }

      currentMode = selected;
      applyUIMode();
      filterAndDisplayProducts();

      const saved = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      if (saved){
        saved.mode = currentMode;
        localStorage.setItem(SESSION_KEY, JSON.stringify(saved));
      }
    });

    function applyUIMode(){
      document.querySelectorAll('.only-client').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.only-admin-edit').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.only-admin-sale').forEach(el => el.style.display = 'none');

      if (currentMode === MODE_CLIENT){
        document.querySelectorAll('.only-client').forEach(el => el.style.display = 'block');
        sortPriceBtn.style.display = "inline-block";
        inventoryTotalElement.style.display = "none";
        invoiceBtn.disabled = true;
        saveEditsBtn.style.display = "none";
        logoutBtn.style.display = "none";
      } else if (currentMode === MODE_ADMIN_EDIT){
        document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'inline-block');
        document.querySelectorAll('.only-admin-edit').forEach(el => el.style.display = 'inline-block');
        sortPriceBtn.style.display = "none";
        inventoryTotalElement.style.display = "inline-block";
        invoiceBtn.disabled = true;
        saveEditsBtn.style.display = "block";
        logoutBtn.style.display = "block";
      } else if (currentMode === MODE_ADMIN_SALE){
        document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'inline-block');
        document.querySelectorAll('.only-admin-sale').forEach(el => el.style.display = 'inline-block');
        sortPriceBtn.style.display = "none";
        inventoryTotalElement.style.display = "inline-block";
        invoiceBtn.disabled = false;
        saveEditsBtn.style.display = "none";
        logoutBtn.style.display = "block";
      }
      setQtyHeader();
    }

    function setQtyHeader(){
      if (!qtyHeader) return;
      qtyHeader.textContent = currentMode === MODE_ADMIN_EDIT ? "Stock" : "Cantidad";
    }

    function calculateInventoryTotal(){
      return products.reduce((acc,p)=> acc + ((p.valor_unitario||0) * (p.stock||0)), 0);
    }

    function updateInventoryTotalDisplay(){
      if (currentMode === MODE_ADMIN_EDIT || currentMode === MODE_ADMIN_SALE){
        inventoryTotalElement.style.display = "inline-block";
        inventoryTotalElement.textContent = "Total: " + currencyFormatter.format(calculateInventoryTotal());
      } else {
        inventoryTotalElement.style.display = "none";
      }
    }

    function normalizeText(t){
      return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
    }

    function filterAndDisplayProducts(){
      let list = [...products];

      const catSel = document.querySelector("#categoryMenu input[name='category']:checked");
      const catVal = catSel ? catSel.value : "Todas";
      if (catVal !== "Todas"){
        list = list.filter(p => p.category === catVal);
      }

      const brandSel = document.querySelector("#brandMenu input[name='brand']:checked");
      const brandVal = brandSel ? brandSel.value : "Todas";
      if (brandVal !== "Todas"){
        list = list.filter(p => p.marca === brandVal);
      }

      const searchTerms = normalizeText(searchInput.value).split(/\s+/).filter(Boolean);
      if (searchTerms.length > 0){
        list = list.filter(p => {
          const s = normalizeText(`${p.id} ${p.name} ${p.category} ${p.marca}`);
          return searchTerms.every(t => s.includes(t));
        });
      }

      if (currentSortOrder === "asc") list.sort((a,b)=>a.valor_unitario-b.valor_unitario);
      else if (currentSortOrder === "desc") list.sort((a,b)=>b.valor_unitario-a.valor_unitario);

      displayProducts(list);
      updateInventoryTotalDisplay();
    }

    function displayProducts(list){
      if (list.length === 0){
        productTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay productos.</td></tr>';
        return;
      }

      const rows = list.map(p => {
        const isEditing = (currentMode === MODE_ADMIN_EDIT && googleUserToken);
        const valueToShow = isEditing ? (p.stock || 0) : (cart[p.id]?.quantity || 0);
        const dataLabel = isEditing ? "Stock" : "Cantidad";
        const unitPrice = (p.valor_unitario || 0);
        const subtotal = valueToShow * unitPrice;
        const readOnlyAttr = isEditing ? "" : "readonly";

        let nameCell, catCell, brandCell, priceCell;
        if (isEditing){
          nameCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="name" value="${escapeHtml(p.name)}">`;
          catCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="category" value="${escapeHtml(p.category)}">`;
          brandCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="marca" value="${escapeHtml(p.marca)}">`;
          priceCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="valor_unitario" value="${unitPrice}" placeholder="0">`;
        } else {
          nameCell = `<span>${escapeHtml(p.name)}</span>`;
          catCell = escapeHtml(p.category);
          brandCell = escapeHtml(p.marca);
          priceCell = currencyFormatter.format(unitPrice);
        }

        return `
          <tr data-product-id="${p.id}">
            <td data-label="Nombre">${nameCell}</td>
            <td data-label="Categor√≠a">${catCell}</td>
            <td data-label="Marca">${brandCell}</td>
            <td data-label="Valor unitario" class="price-cell">${priceCell}</td>
            <td data-label="${dataLabel}">
              <div class="quantity-control">
                <button type="button" class="quantity-btn decrease-btn">-</button>
                <input type="number" class="quantity-input" min="0" value="${valueToShow}"
                  data-price="${unitPrice}"
                  data-id="${p.id}"
                  data-name="${escapeHtml(p.name)}"
                  ${readOnlyAttr}>
                <button type="button" class="quantity-btn increase-btn">+</button>
              </div>
            </td>
            <td data-label="Total" class="price-cell total-pay">${currencyFormatter.format(subtotal)}</td>
          </tr>
        `;
      }).join("");

      productTableBody.innerHTML = rows;
    }

    function loadCartFromStorage(){
      const savedCart = localStorage.getItem("shoppingCart");
      try{
        const parsed = JSON.parse(savedCart);
        if (parsed && Object.values(parsed)[0]?.id){
          cart = parsed;
        }
      }catch{ cart = {}; }
    }

    function updateCart(){
      let total = 0;
      const items = Object.values(cart);
      if (items.length === 0){
        cartList.innerHTML = '<li class="cart-item"><span class="cart-item-title">El carrito est√° vac√≠o.</span></li>';
      } else {
        cartList.innerHTML = items.map(it => {
          const sub = it.quantity * it.price;
          total += sub;
          return `<li class="cart-item">
              <span class="cart-item-title">${it.quantity} x ${escapeHtml(it.name)} <strong>(${currencyFormatter.format(sub)})</strong></span>
              <button class="remove-item-btn" data-id="${it.id}">X</button>
            </li>`;
        }).join("");
      }
      totalPriceElement.textContent = "Total: " + currencyFormatter.format(total);
      localStorage.setItem("shoppingCart", JSON.stringify(cart));
    }

    function escapeHtml(t){
      if (t == null) return '';
      return String(t).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    function addPendingEdit(id,field,value,inputEl){
      const idx = pendingEdits.findIndex(e => e.id===id && e.field===field);
      if (idx>=0){
        pendingEdits[idx].value = value;
        pendingEdits[idx].input = inputEl;
      } else {
        pendingEdits.push({id,field,value,input:inputEl});
      }
      updateSaveBtnState();
    }

    function updateSaveBtnState(){
      if (pendingEdits.length>0){
        saveEditsBtn.disabled = false;
        saveEditsBtn.textContent = `üíæ Guardar cambios (${pendingEdits.length})`;
      } else {
        saveEditsBtn.disabled = true;
        saveEditsBtn.textContent = "üíæ Guardar cambios (0)";
      }
    }

    saveEditsBtn.addEventListener("click", async () => {
      if (pendingEdits.length===0) return;
      saveEditsBtn.disabled = true;
      for (const edit of pendingEdits){
        await updateProductFieldInGoogleSheet(edit.id, edit.field, edit.value, edit.input, true);
      }
      alert("Cambios enviados.");
      pendingEdits = [];
      updateSaveBtnState();
      fetchProductsFromSheet();
    });

    productTableBody.addEventListener("input", async e => {
      const isQty = e.target.classList.contains("quantity-input");
      const isAdminInput = e.target.classList.contains("admin-input");

      if (isAdminInput && currentMode===MODE_ADMIN_EDIT && googleUserToken){
        const input = e.target;
        const field = input.dataset.field;
        const id = input.dataset.id;
        const val = input.value;
        addPendingEdit(id, field, val, input);
        return;
      }

      if (!isQty) return;
      const input = e.target;
      let qty = parseInt(input.value,10) || 0;
      if (qty<0) qty=0;
      input.value = qty;
      const id = input.dataset.id;
      const name = input.dataset.name;
      const price = parseInt(input.dataset.price,10)||0;
      const tr = input.closest("tr");
      if (tr) tr.querySelector(".total-pay").textContent = currencyFormatter.format(qty*price);

      if (currentMode===MODE_ADMIN_EDIT && googleUserToken){
        const p = products.find(p=>p.id===id);
        if (p) p.stock = qty;
        updateInventoryTotalDisplay();
        await updateProductFieldInGoogleSheet(id, "stock", qty, input, false);
        return;
      }

      if (qty>0){
        cart[id] = {id,name,quantity:qty,price};
      } else {
        delete cart[id];
      }
      updateCart();
    });

    productTableBody.addEventListener("click", async e => {
      if (!e.target.classList.contains("quantity-btn")) return;
      const ctrl = e.target.closest(".quantity-control");
      const input = ctrl.querySelector(".quantity-input");
      let val = parseInt(input.value,10) || 0;
      if (e.target.classList.contains("increase-btn")) val++;
      else val--;
      if (val<0) val=0;
      input.value = val;

      const id = input.dataset.id;
      const name = input.dataset.name;
      const price = parseInt(input.dataset.price,10)||0;
      const tr = input.closest("tr");
      if (tr) tr.querySelector(".total-pay").textContent = currencyFormatter.format(val*price);

      if (currentMode===MODE_ADMIN_EDIT && googleUserToken){
        const p = products.find(p=>p.id===id);
        if (p) p.stock = val;
        updateInventoryTotalDisplay();
        await updateProductFieldInGoogleSheet(id, "stock", val, input, false);
        return;
      }

      if (val>0){
        cart[id] = {id,name,quantity:val,price};
      } else {
        delete cart[id];
      }
      updateCart();
    });

    async function updateProductFieldInGoogleSheet(id,field,value,input,silent){
      if (!googleUserToken){
        alert("No est√°s autenticado.");
        return;
      }
      const p = products.find(p=>p.id===id);
      const original = p ? p[field] : "";
      let newValue = value;
      if (field==="valor_unitario"){
        newValue = (value||"").replace(/[^\d]/g,"");
        newValue = parseInt(newValue,10)||0;
      }
      if (input) input.disabled = true;
      try{
        const resp = await fetch(APPS_SCRIPT_URL, {
          method:"POST",
          headers:{"Content-Type":"text/plain;charset=utf-8"},
          body:JSON.stringify({
            action: field === "stock" ? "updateStock" : "updateField",
            token:googleUserToken,
            productId:id,
            fieldToUpdate:field,
            newValue,
            adminEmail:currentAdminEmail
          })
        });
        const json = await resp.json();
        if (json.status==="success"){
          if (p) p[field] = newValue;
          if (field === "stock") {
            const rowInput = document.querySelector(`.quantity-input[data-id="${id}"]`);
            if (rowInput) rowInput.value = newValue;
          }
          if (!silent){
            updateInventoryTotalDisplay();
          }
        } else {
          throw new Error(json.message || "Error guardando");
        }
      } catch(err){
        alert("Error al guardar: " + err.message);
        if (input) input.value = original;
      } finally {
        if (input) input.disabled = false;
      }
    }

    searchInput.addEventListener("input", filterAndDisplayProducts);
    sortPriceBtn.addEventListener("click", () => {
      if (currentSortOrder==="default" || currentSortOrder==="desc"){
        currentSortOrder="asc";
        sortPriceBtn.textContent="Precio $‚Üì";
      } else {
        currentSortOrder="desc";
        sortPriceBtn.textContent="Precio $‚Üë";
      }
      filterAndDisplayProducts();
    });

    function openWhatsApp(msg){
      const encoded = encodeURIComponent(msg);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const url = isMobile
        ? `https://api.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`
        : `https://web.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`;
      window.open(url, "_blank");
    }

    whatsappBtn.addEventListener("click", () => {
      if (currentMode !== MODE_CLIENT) return;
      const items = Object.values(cart);
      if (items.length===0) return;
      const msg = buildWhatsAppMsg(items);
      openWhatsApp(msg);
    });

    function buildWhatsAppMsg(items, header="Hola, deseo comprar estos productos en Irenismb Natura Stock:"){
      let msg = header + "\n\n";
      let total=0;
      items.forEach(it=>{
        const sub = it.quantity * it.price;
        msg += `‚Ä¢ ${it.quantity} x ${it.name} = ${currencyFormatter.format(sub)}\n`;
        total += sub;
      });
      msg += `\nTotal: ${currencyFormatter.format(total)}\n`;
      msg += `\nVendedor: ${SELLER_NAME}\nWhatsApp: ${SELLER_PHONE}\n`;
      return msg;
    }

    contactWhatsappLink.addEventListener("click", e => {
      e.preventDefault();
      openWhatsApp("Hola, me interesan los productos de Irenismb Natura Stock.");
    });

    cartList.addEventListener("click", e => {
      if (!e.target.classList.contains("remove-item-btn")) return;
      const id = e.target.dataset.id;
      delete cart[id];
      const input = productTableBody.querySelector(`.quantity-input[data-id="${id}"]`);
      if (input){
        input.value = 0;
        input.dispatchEvent(new Event("input", {bubbles:true}));
      } else {
        updateCart();
      }
    });

    invoiceBtn.addEventListener("click", () => {
      if (currentMode !== MODE_ADMIN_SALE) return;
      if (!googleUserToken){
        alert("Inicia sesi√≥n con Google primero.");
        googleSignInContainer.style.display = "block";
        return;
      }
      startSellFlow();
    });

    function openInvoiceWindow(html){
      const w = window.open("", "_blank");
      w.document.write(html);
      w.document.close();
    }

    async function startSellFlow(){
      const items = Object.values(cart);
      if (items.length===0){
        alert("No hay productos en el carrito.");
        return;
      }

      const action = prompt("Seleccione la acci√≥n:\n1. Generar factura (predeterminado)\n2. Enviar por WhatsApp", "1");
      const actionNum = (action || "1").trim();

      const cliente = prompt("Nombre del cliente:", "Cliente contado");
      if (cliente===null) return;

      const fechaDef = formatDateDDMMYYYY(new Date());
      let fecha = prompt("Fecha de venta (dd/mm/aaaa):", fechaDef) || fechaDef;
      let abonadoStr = prompt("Valor abonado / pagado:", "0") || "0";
      let plazoStr = prompt("Plazo en d√≠as (30 por defecto):", "30") || "30";

      const abonado = parseInt(abonadoStr.replace(/[^\d]/g,""),10) || 0;
      let plazo = parseInt(plazoStr,10);
      if (isNaN(plazo) || plazo<0) plazo=30;

      let total = 0;
      items.forEach(it => total += it.quantity * it.price);
      let saldo = total - abonado;
      if (saldo<0) saldo=0;

      let vence = "";
      if (saldo>0){
        const p = fecha.split("/");
        let d = new Date();
        if (p.length===3){
          d = new Date(parseInt(p[2],10), parseInt(p[1],10)-1, parseInt(p[0],10));
        }
        d.setDate(d.getDate() + plazo);
        vence = formatDateDDMMYYYY(d);
      }

      if (actionNum==="1" || actionNum===""){
        const html = `
          <html><head><title>Factura - Irenismb Natura Stock</title></head><body>
          <h2>Irenismb Natura Stock</h2>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Fecha:</strong> ${fecha}</p>
          <p><strong>Vendedor:</strong> ${SELLER_NAME} - ${SELLER_PHONE}</p>
          <table border="1" cellspacing="0" cellpadding="5">
            <tr><th>Producto</th><th>Cant</th><th>V.Unit</th><th>Subtotal</th></tr>
            ${items.map(it => `<tr><td>${it.name}</td><td>${it.quantity}</td><td>${currencyFormatter.format(it.price)}</td><td>${currencyFormatter.format(it.quantity*it.price)}</td></tr>`).join("")}
            <tr><td colspan="3"><strong>Total</strong></td><td>${currencyFormatter.format(total)}</td></tr>
            <tr><td colspan="3"><strong>Abonado/Pagado</strong></td><td>${currencyFormatter.format(abonado)}</td></tr>
            <tr><td colspan="3"><strong>Saldo</strong></td><td>${currencyFormatter.format(saldo)}</td></tr>
            ${saldo>0 ? `<tr><td colspan="3"><strong>Vence</strong></td><td>${vence}</td></tr>` : ""}
          </table>
          <p>Gracias por su compra.</p>
          </body></html>
        `;
        openInvoiceWindow(html);
      } else if (actionNum==="2"){
        let msg = `Venta para ${cliente}\nFecha: ${fecha}\n\n`;
        items.forEach(it => {
          const sub = it.quantity * it.price;
          msg += `‚Ä¢ ${it.quantity} x ${it.name} = ${currencyFormatter.format(sub)}\n`;
        });
        msg += `\nTotal: ${currencyFormatter.format(total)}\n`;
        msg += `Abonado/Pagado: ${currencyFormatter.format(abonado)}\n`;
        msg += `Saldo: ${currencyFormatter.format(saldo)}\n`;
        if (saldo>0) msg += `Vence: ${vence}\n`;
        msg += `\nVendedor: ${SELLER_NAME} - ${SELLER_PHONE}`;
        openWhatsApp(msg);
      } else {
        const html = `
          <html><head><title>Factura - Irenismb Natura Stock</title></head><body>
          <h2>Irenismb Natura Stock</h2>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Fecha:</strong> ${fecha}</p>
          <p><strong>Vendedor:</strong> ${SELLER_NAME} - ${SELLER_PHONE}</p>
          <table border="1" cellspacing="0" cellpadding="5">
            <tr><th>Producto</th><th>Cant</th><th>V.Unit</th><th>Subtotal</th></tr>
            ${items.map(it => `<tr><td>${it.name}</td><td>${it.quantity}</td><td>${currencyFormatter.format(it.price)}</td><td>${currencyFormatter.format(it.quantity*it.price)}</td></tr>`).join("")}
            <tr><td colspan="3"><strong>Total</strong></td><td>${currencyFormatter.format(total)}</td></tr>
            <tr><td colspan="3"><strong>Abonado/Pagado</strong></td><td>${currencyFormatter.format(abonado)}</td></tr>
            <tr><td colspan="3"><strong>Saldo</strong></td><td>${currencyFormatter.format(saldo)}</td></tr>
            ${saldo>0 ? `<tr><td colspan="3"><strong>Vence</strong></td><td>${vence}</td></tr>` : ""}
          </table>
          <p>Gracias por su compra.</p>
          </body></html>
        `;
        openInvoiceWindow(html);
      }

      for (const it of items) {
        const prod = products.find(p => p.id === it.id);
        if (prod){
          const newStock = Math.max((prod.stock||0) - it.quantity, 0);
          prod.stock = newStock;
          await updateProductFieldInGoogleSheet(prod.id, "stock", newStock, null, true);
        }
      }

      cart = {};
      localStorage.removeItem("shoppingCart");
      productTableBody.querySelectorAll(".quantity-input").forEach(input=>{
        if (currentMode !== MODE_ADMIN_EDIT) input.value = 0;
      });
      updateCart();
      filterAndDisplayProducts();
      updateInventoryTotalDisplay();
    }

    function toTitleCase(str){return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : "";}
    function formatDateDDMMYYYY(d){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).toString().padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}/${mm}/${yy}`;
    }
  </script>
</body>
</html>
