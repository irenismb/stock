<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Irenismb Natura Stock - Cat√°logo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <style>
    :root{
      --primary:#007bff;
      --secondary:#25D366;
      --bg:#f4f4f9;
      --text:#333;
      --card:#fff;
      --border:#ddd;
      --danger:#dc3545;
      --radius:8px;
      --gap:8px;
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    html,body{ max-width:100%; overflow-x:hidden; }
    body{
      margin:0; padding:10px; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    }
    .container{ display:flex; gap:15px; align-items:flex-start; width:100%; }
    .left-panel{ flex:3 1 700px; display:flex; flex-direction:column; min-width:0; }
    .right-panel{
      flex:1 1 280px; position:sticky; top:10px; display:flex; flex-direction:column;
      gap:15px; max-height:calc(100vh - 20px); overflow-y:auto;
    }
    .controls-panel{ position:sticky; top:0; z-index:40; background:var(--bg); padding:4px 0 6px; }
    .products-header{ display:flex; flex-direction:column; gap:6px; border-bottom:1px solid rgba(0,0,0,.05); padding-bottom:6px; }
    .controls-top{ display:flex; align-items:center; gap:8px; flex-wrap:nowrap; }
    #searchInput{
      flex:1 1 220px; min-width:180px; padding:10px 12px; border:1px solid #ccc; border-radius:5px;
      background:var(--card); font-size:16px;
    }
    .controls-bottom{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    .custom-dropdown{ position:relative }
    .dropdown-toggle-btn{
      padding:8px 10px; border:1px solid #ccc; border-radius:5px; background:var(--card);
      cursor:pointer; white-space:nowrap; font-size:14px; min-height:38px; display:flex; align-items:center; gap:4px;
    }
    .custom-menu{
      position:absolute; top:calc(100% + 6px); right:0; background:var(--card); border:1px solid var(--border);
      padding:8px; border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,.08); display:none; z-index:50; max-height:220px; overflow:auto; min-width:200px;
    }
    .custom-dropdown.open .custom-menu{ display:block }
    #categoryMenu{ right:auto; left:0 }

    #sortPriceBtn{
      padding:8px 12px; font-size:14px; border:1px solid #ccc; background:#f8f9fa;
      border-radius:5px; cursor:pointer; min-height:38px;
    }

    /* Logo + nombre de empresa en la barra de filtros */
    .brand-logo{
      display:flex;
      align-items:center;
      gap:6px;
      margin-left:auto;
      font-weight:600;
      color:#444;
      font-size:14px;
    }
    .brand-logo-img{
      width:40px;
      height:40px;
      border-radius:50%;
      object-fit:cover;
    }
    .brand-logo-text{
      white-space:nowrap;
      font-weight:700;   /* negrita */
    }

    .table-wrapper{ border-radius:8px; overflow:hidden; background:#fff; max-height:calc(100vh - 140px); overflow-y:auto; }
    .product-table{ width:100%; border-collapse:collapse; background:var(--card); }
    .product-table th,.product-table td{ border:1px solid var(--border); padding:10px; text-align:left; vertical-align:middle; }
    .product-table thead th{
      background:var(--primary); color:#fff; font-size:14px; text-align:center; position:sticky; top:0; z-index:30;
    }
    .product-table tr:nth-child(even){ background:#f8f9fa }
    .quantity-control{ display:flex; align-items:center; justify-content:center; gap:4px; }
    .quantity-btn{
      background:#e9ecef; border:1px solid #ced4da; color:#495057; cursor:pointer;
      font-size:1.2rem; font-weight:700; width:34px; height:34px; line-height:32px; text-align:center; border-radius:6px; touch-action:manipulation;
    }
    .quantity-input{
      width:55px; height:34px; padding:5px; text-align:center; border:1px solid #ced4da; background:#fff; font-size:15px; border-radius:6px;
    }
    .price-cell{ font-weight:700; color:#2a9d8f }

    .cart-container{
      background:#e9f5ff; padding:15px; border-radius:10px; border:1px solid #bde0fe;
      box-shadow:0 6px 16px rgba(13,110,253,0.08);
    }
    .cart-container h3{
      margin-top:0; display:flex; align-items:center; gap:6px; font-size:16px; border-bottom:1px solid rgba(0,0,0,.05); padding-bottom:6px;
    }
    #cartList{
      list-style:none; padding:0; margin:10px 0; display:flex; flex-direction:column; gap:6px; max-height:220px; overflow-y:auto;
    }
    .cart-item{
      display:flex; justify-content:space-between; gap:8px; background:#fff; border:1px solid rgba(0,0,0,.03);
      border-radius:6px; padding:6px 8px 6px 10px; font-size:13px;
    }
    .remove-item-btn{
      border:none; background:#f8d7da; color:#842029; border-radius:4px; padding:1px 6px; cursor:pointer; font-weight:600; font-size:12px; touch-action:manipulation;
    }
    #totalPrice{ font-weight:700; font-size:15px; text-align:right; margin-top:4px; background:#fff; border-radius:6px; padding:5px 8px; }
    #whatsappBtn{
      background:var(--secondary); color:#fff; width:100%; border:none; padding:11px 14px; font-size:15px; border-radius:8px; cursor:pointer; margin-top:8px; touch-action:manipulation;
    }

    .contact-info{
      padding:15px;
      background:var(--card);
      border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
      font-size:14px;
      text-align:center;
    }
    .contact-info h3{
      margin:0 0 6px;
    }
    .contact-info p{
      margin:2px 0;
    }
    .contact-info hr{
      margin:8px 0;
    }

    /* ==== Previsualizaci√≥n / Galer√≠a ==== */
    .preview{
      background:#fff; border:1px solid #bde0fe; border-radius:10px; padding:10px;
      box-shadow:0 6px 16px rgba(13,110,253,0.08); display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    .preview .stage{
      position:relative; width:100%; aspect-ratio:1/1; background:#f8f9fa; border-radius:8px; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
    }
    .preview .stage img{
      width:100%; height:100%; object-fit:contain; display:none;
    }
    .preview .nav{
      position:absolute; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:50%;
      background:rgba(0,0,0,.45); color:#fff; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .preview .nav[disabled]{ opacity:.35; cursor:not-allowed; }
    .preview .nav.prev{ left:8px; } .preview .nav.next{ right:8px; }
    .thumbs{
      width:100%; display:flex; gap:8px; overflow:auto; padding:4px 2px;
    }
    .thumbs img{
      width:64px; height:64px; object-fit:cover; border:2px solid transparent; border-radius:6px; cursor:pointer; background:#f1f3f5;
      flex:0 0 auto;
    }
    .thumbs img.active{ border-color:var(--primary); }

    /* Nombre del producto entre miniaturas y descripci√≥n */
    .preview .product-name{
      width:100%;
      text-align:left;
      font-weight:700;
      font-size:14px;
      letter-spacing:0.06em;
      color:#222;
    }

    .preview .caption{
      font-size:13px; color:#444; text-align:left; width:100%; min-height:2.5em;
    }

    /* ======== M√ìVIL ======== */
    @media (max-width:768px){
      body{ padding:6px; }
      .container{ flex-direction:column-reverse; gap:10px; }
      .controls-panel{ position:static; }
      .right-panel{ position:static; max-height:none; width:100%; overflow:visible; }
      .cart-container,.contact-info{ width:100%; }
      .table-wrapper{ max-height:none; overflow:visible; width:100%; }
      .controls-top{ flex-direction:column; align-items:stretch; }
      #searchInput{ width:100%; padding:6px 10px; min-height:40px; line-height:1.2; }
      .controls-bottom{ flex-direction:column; align-items:stretch; }
      #sortPriceBtn,.dropdown-toggle-btn{ width:100%; text-align:left; }
      .custom-menu{ width:min(310px,96vw); left:0; right:auto; }

      .brand-logo{
        margin-left:0;
        justify-content:flex-start;
      }

      .product-table{ border:0; }
      .product-table thead{ display:none; }
      .product-table tr{ display:block; background:#fff; margin-bottom:12px; border:1px solid #eee; border-radius:8px; overflow:hidden; }
      .product-table td{
        display:flex; justify-content:space-between; gap:12px; border:none; border-bottom:1px solid #f1f1f1;
        padding:8px 10px; font-size:14px; width:100% !important; max-width:100% !important;
      }
      .product-table td:last-child{ border-bottom:none; }
      .product-table td::before{ content:attr(data-label); font-weight:600; color:#555; margin-right:8px; flex:1; }
      .quantity-control{ justify-content:flex-end; }
      .preview .stage{ max-height:44vh; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <div class="controls-panel">
        <div class="products-header">
          <div class="controls-top">
            <input id="searchInput" type="text" autocomplete="off" inputmode="search" placeholder="üîç Buscar por nombre, marca, categor√≠a...">
            <button id="sortPriceBtn">Ordenar por precio</button>
          </div>
          <div class="controls-bottom">
            <div class="custom-dropdown" id="categoryDropdown">
              <button type="button" id="categoryToggleBtn" class="dropdown-toggle-btn" aria-haspopup="listbox" aria-expanded="false">Categor√≠as ‚ñæ</button>
              <div id="categoryMenu" class="custom-menu" aria-hidden="true"></div>
            </div>
            <div class="custom-dropdown" id="brandDropdown">
              <button type="button" id="brandToggleBtn" class="dropdown-toggle-btn" aria-haspopup="listbox" aria-expanded="false">Marcas ‚ñæ</button>
              <div id="brandMenu" class="custom-menu" aria-hidden="true"></div>
            </div>

            <!-- Logo + nombre de la empresa -->
            <div class="brand-logo">
              <img src="logo.png" alt="Logo Irenismb Stock" class="brand-logo-img">
              <span class="brand-logo-text">Irenismb Stock</span>
            </div>
          </div>
        </div>
      </div>
      <div class="table-wrapper">
        <table class="product-table" aria-label="Listado de productos">
          <thead>
            <tr>
              <th>Nombre producto</th>
              <th>Categor√≠a</th>
              <th>Marca</th>
              <th>Valor unitario</th>
              <th>Cantidad</th>
              <th>Total a pagar</th>
            </tr>
          </thead>
          <tbody id="productTableBody">
            <tr><td colspan="6" style="text-align:center;">Cargando productos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="right-panel">
      <!-- Vista previa del producto (galer√≠a) -->
      <div id="productPreview" class="preview" aria-live="polite">
        <div class="stage" role="region" aria-label="Galer√≠a del producto">
          <button class="nav prev" id="galleryPrevBtn" aria-label="Imagen anterior">‚Äπ</button>
          <img id="previewImg" alt="Vista previa del producto" />
          <button class="nav next" id="galleryNextBtn" aria-label="Imagen siguiente">‚Ä∫</button>
        </div>
        <div id="thumbs" class="thumbs" aria-label="Miniaturas de producto" role="list"></div>
        <div id="previewName" class="product-name"></div>
        <div id="previewCaption" class="caption">Haz clic en un producto para ver su descripci√≥n</div>
      </div>

      <div class="cart-container" id="cartContainer">
        <h3>üõí Carrito de Compras</h3>
        <ul id="cartList">
          <li class="cart-item"><span class="cart-item-title">El carrito est√° vac√≠o.</span></li>
        </ul>
        <div id="totalPrice">Total: 0</div>
        <button id="whatsappBtn">Comprar por WhatsApp</button>
      </div>

      <div class="contact-info">
        <h3>‚ú® Contacto y Ubicaci√≥n ‚ú®</h3>
        <p class="small-gap">üì± <strong>WhatsApp y llamadas:</strong> <a href="https://wa.me/573042088961" target="_blank" rel="noopener" id="contactWhatsappLink">3042088961</a></p>
        <p class="small-gap">üìç <strong>Ubicaci√≥n:</strong> Estamos en Santa Marta. ¬°Hacemos env√≠os a toda Colombia y pagos contra entrega en Santa Marta!</p>
        <p class="small-gap">üó∫Ô∏è <strong>Vis√≠tanos (GPS):</strong> <a href="https://maps.google.com/?q=11.244833370782679,-74.19066001689564" target="_blank" rel="noopener noreferrer">Ver en Google Maps</a></p>
        <hr>
        <h3>üåê ¬°S√≠guenos en Nuestras Redes! üåê</h3>
        <p class="small-gap">üëç <a href="#" target="_blank" rel="noopener">Facebook</a></p>
        <p class="small-gap">üì∏ <a href="#" target="_blank" rel="noopener">Instagram</a></p>
        <p class="small-gap">üéµ <a href="#" target="_blank" rel="noopener">TikTok</a></p>
      </div>
    </div>
  </div>

<script>
  /* ================== CONFIG ================== */
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgRlyQfToDd8O7JOyRP0XXdryqpksSTu04zuhaZHYnun59S0ALXR_vnHZGfY5ch7SP/exec";
  const DEFAULT_WHATSAPP = "573042088961";
  const AUTO_REFRESH_MS = 20000;
  const LS_FILTERS_KEY = "naturaFilters";
  const LS_CART_KEY = "shoppingCart";

  const currencyFormatter = new Intl.NumberFormat("es-CO",{
    style:"currency",
    currency:"COP",
    minimumFractionDigits:0
  });

  /* ================== IM√ÅGENES (GitHub) ================== */
  const IMG_BASE_PATH = "https://irenismb.github.io/stock/imagenes/productos/";
  const IMG_EXTS = ["webp","jpg","jpeg","png","gif","JPG","JPEG","PNG","WEBP","GIF"];
  const imageCache = new Map(); // clave: base.ext  ‚Üí {ok,url}

  /* ================== ESTADO ================== */
  let products = [];
  let cart = {};
  let allCategories = [];
  let allBrands = [];   // [{key,label}]
  let currentSortOrder = "default"; // default ‚Üí Orden, asc/desc ‚Üí precio
  let currentGallery = { productId:null, images:[], index:0 };
  let filterListenersAttached = false;
  let lastSearchLogged = "";   // √∫ltima b√∫squeda registrada en "visitas"
  let lastPreviewRequestId = 0; // controla el √∫ltimo clic de vista previa

  /* ================== DOM ================== */
  const searchInput = document.getElementById("searchInput");
  const productTableBody = document.getElementById("productTableBody");
  const cartList = document.getElementById("cartList");
  const totalPriceElement = document.getElementById("totalPrice");
  const whatsappBtn = document.getElementById("whatsappBtn");
  const contactWhatsappLink = document.getElementById("contactWhatsappLink");
  const sortPriceBtn = document.getElementById("sortPriceBtn");

  const categoryMenuContainer = document.getElementById("categoryMenu");
  const brandMenuContainer = document.getElementById("brandMenu");
  const categoryToggleBtn = document.getElementById("categoryToggleBtn");
  const brandToggleBtn = document.getElementById("brandToggleBtn");

  const productPreview = document.getElementById("productPreview");
  const previewImg = document.getElementById("previewImg");
  const previewCaption = document.getElementById("previewCaption");
  const galleryPrevBtn = document.getElementById("galleryPrevBtn");
  const galleryNextBtn = document.getElementById("galleryNextBtn");
  const thumbs = document.getElementById("thumbs");
  const previewName = document.getElementById("previewName");

  /* ================== UTIL ================== */
  function debounce(fn, ms=180){
    let t=null;
    return (...args)=>{
      clearTimeout(t);
      t=setTimeout(()=>fn(...args),ms);
    };
  }
  function normalizeText(t){
    return (t||"").toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g,"");
  }
  // Normaliza marcas para que no discriminen may√∫sculas/min√∫sculas ni tildes
  function normalizeBrand(str){
    return normalizeText((str||"").trim());
  }
  function escapeHtml(t){
    if(t==null) return "";
    return String(t).replace(/[&<>"']/g, s=>({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#39;"
    })[s]);
  }
  function escapeAttr(t){
    return escapeHtml(t).replace(/"/g,"&quot;");
  }
  function formatDateISO(d){
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  /* ================== REGISTRO DE VISITAS ================== */
  function logVisit(clickText, searchText){
    try {
      console.log("logVisit ‚Üí", clickText, "| buscar:", searchText);

      const params = new URLSearchParams({
        action: "logVisit",
        clickText: String(clickText || ""),
        searchText: String(searchText || ""),
        ts: Date.now().toString()
      });

      const img = new Image();
      img.src = APPS_SCRIPT_URL + "?" + params.toString();
    } catch (e) {
      console.error("Error en logVisit:", e);
    }
  }

  /* ================== IM√ÅGENES / GALER√çA ================== */
  function preloadImage(url){
    const img=new Image();
    img.decoding="async";
    img.loading="eager";
    img.src=url;
    return img;
  }
  function testImageOnce(url, timeout=6000){
    return new Promise(resolve=>{
      const img=new Image();
      let done=false;
      const timer=setTimeout(()=>{
        if(!done){
          done=true;
          img.src="";
          resolve(false);
        }
      },timeout);
      img.onload=()=>{
        if(!done){
          done=true;
          clearTimeout(timer);
          resolve(true);
        }
      };
      img.onerror=()=>{
        if(!done){
          done=true;
          clearTimeout(timer);
          resolve(false);
        }
      };
      img.src=url;
    });
  }

  // Busca archivos: ID@Nombre, ID-Nombre, ID-nombre-normalizado, ID
  async function resolveImageForCode(code,name){
    if(!code) return null;
    const safeName=(name||"").trim();
    const baseVariants=[];
    if(safeName){
      const safeNameSlug = safeName
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-zA-Z0-9]+/g,"-")
        .replace(/-+/g,"-")
        .replace(/^-|-$/g,"");
      baseVariants.push(`${code}@${safeName}`);      // patr√≥n antiguo
      baseVariants.push(`${code}-${safeName}`);      // patr√≥n con guion y nombre original
      if(safeNameSlug){
        baseVariants.push(`${code}-${safeNameSlug}`); // patr√≥n con guion y nombre ‚Äúlimpio‚Äù
      }
    }
    baseVariants.push(`${code}`); // solo c√≥digo

    for(const base of baseVariants){
      for(const ext of IMG_EXTS){
        const key=`${base}.${ext}`;
        const cached=imageCache.get(key);
        if(cached){
          if(cached.ok) return cached.url;
          continue;
        }
        const url=IMG_BASE_PATH + encodeURIComponent(base) + "." + ext;
        const ok=await testImageOnce(url);
        imageCache.set(key,{ok,url});
        if(ok) return url;
      }
    }
    return null;
  }

  async function findAllImagesForProduct(prod,maxChildren=12){
    if(!prod||!prod.id) return [];
    const id=String(prod.id).trim();
    const name=String(prod.name||"").trim();
    const images=[];

    const main=await resolveImageForCode(id,name);
    if(main) images.push(main);

    for(let i=1;i<=maxChildren;i++){
      const childCode=`${id}-${i}`;
      const url=await resolveImageForCode(childCode,name);
      if(url) images.push(url);
    }
    return images;
  }

  function renderThumbs(imgs,activeIndex){
    thumbs.innerHTML="";
    imgs.forEach((u,idx)=>{
      const im=document.createElement("img");
      im.src=u;
      im.alt=`Miniatura ${idx+1}`;
      im.setAttribute("role","listitem");
      if(idx===activeIndex) im.classList.add("active");
      im.addEventListener("click",()=>setGalleryIndex(idx,true));
      thumbs.appendChild(im);
    });
  }
  function updateNavButtons(){
    const len=currentGallery.images.length;
    const disabled=len<=1;
    galleryPrevBtn.disabled=disabled;
    galleryNextBtn.disabled=disabled;
  }
  function setGalleryIndex(idx,focusImg=false){
    const len=currentGallery.images.length;
    if(len===0) return;
    if(idx<0) idx=len-1;
    if(idx>=len) idx=0;
    currentGallery.index=idx;

    previewImg.style.display="none";
    previewImg.src=currentGallery.images[idx];
    previewImg.onload=()=>{
      previewImg.style.display="block";
      if(focusImg && typeof previewImg.focus==="function") previewImg.focus();
    };

    [...thumbs.querySelectorAll("img")].forEach((im,i)=>{
      if(i===idx) im.classList.add("active");
      else im.classList.remove("active");
    });

    const nextIdx=(idx+1)%len;
    preloadImage(currentGallery.images[nextIdx]);

    updateNavButtons();
  }

  // Versi√≥n protegida: solo el √∫ltimo clic puede actualizar la vista previa
  async function showPreviewForProduct(prod){
    if (!prod) return;

    const requestId = ++lastPreviewRequestId;

    // Nombre del producto en MAY√öSCULA SOSTENIDA
    if (previewName) {
      const name = (prod.name || "").trim();
      previewName.textContent = name ? name.toUpperCase() : "";
    }

    // Mostrar de inmediato la descripci√≥n
    previewCaption.textContent = prod.description ? prod.description : "";
    previewImg.style.display = "none";
    previewImg.src = "";
    thumbs.innerHTML = "";

    currentGallery = { productId: prod.id, images: [], index: 0 };
    updateNavButtons();

    const imgs = await findAllImagesForProduct(prod);

    if (requestId !== lastPreviewRequestId) {
      return;
    }

    currentGallery = { productId: prod.id, images: imgs, index: 0 };

    if (imgs.length === 0) {
      thumbs.innerHTML = "";
      previewCaption.textContent = prod.description || "Sin imagen para este producto.";
      updateNavButtons();
      return;
    }

    renderThumbs(imgs, 0);
    setGalleryIndex(0);
  }

  galleryPrevBtn.addEventListener("click",()=>setGalleryIndex(currentGallery.index-1,true));
  galleryNextBtn.addEventListener("click",()=>setGalleryIndex(currentGallery.index+1,true));

  productPreview.addEventListener("keydown",e=>{
    if(e.key==="ArrowLeft"){
      e.preventDefault();
      setGalleryIndex(currentGallery.index-1,true);
    }else if(e.key==="ArrowRight"){
      e.preventDefault();
      setGalleryIndex(currentGallery.index+1,true);
    }
  });
  productPreview.tabIndex=0;

  (function addSwipe(el){
    if(!el) return;
    let startX=null;
    el.addEventListener("touchstart",e=>{
      startX=e.changedTouches[0].clientX;
    },{passive:true});
    el.addEventListener("touchend",e=>{
      if(startX==null) return;
      const dx=e.changedTouches[0].clientX-startX;
      if(Math.abs(dx)>40){
        if(dx>0) setGalleryIndex(currentGallery.index-1);
        else setGalleryIndex(currentGallery.index+1);
      }
      startX=null;
    },{passive:true});
  })(document.querySelector(".stage"));

  /* ================== FILTROS ================== */
  function getSavedFilters(){
    try{
      return JSON.parse(localStorage.getItem(LS_FILTERS_KEY)||"{}");
    }catch{
      return {};
    }
  }
  function saveFiltersToStorage(){
    const cat=categoryMenuContainer.querySelector('input[name="category"]:checked')?.value || "Todas";
    const brand=brandMenuContainer.querySelector('input[name="brand"]:checked')?.value || "Todas";
    localStorage.setItem(LS_FILTERS_KEY,JSON.stringify({category:cat,brand}));
  }
  function updateCategoryButtonLabel(){
    const sel=categoryMenuContainer.querySelector('input[name="category"]:checked');
    categoryToggleBtn.textContent = sel && sel.value!=="Todas" ? sel.value+" ‚ñæ" : "Categor√≠as ‚ñæ";
  }
  function updateBrandButtonLabel(){
    const sel=brandMenuContainer.querySelector('input[name="brand"]:checked');
    if(sel && sel.value!=="Todas"){
      const label = sel.dataset.label || sel.value;
      brandToggleBtn.textContent = label + " ‚ñæ";
    }else{
      brandToggleBtn.textContent = "Marcas ‚ñæ";
    }
  }
  function closeDropdowns(){
    document.querySelectorAll(".custom-dropdown.open").forEach(d=>{
      d.classList.remove("open");
      const menu = d.querySelector(".custom-menu");
      if(menu){
        menu.setAttribute("aria-hidden","true");
      }
      d.querySelector(".dropdown-toggle-btn")?.setAttribute("aria-expanded","false");
    });
  }

  // Aqu√≠ se unifican categor√≠as y marcas (marcas sin distinguir may√∫sculas/min√∫sculas)
  function refreshFilters(){
    allCategories=[...new Set(products.map(p=>p.category).filter(Boolean))].sort();

    // Mapa de marcas normalizadas ‚Üí etiqueta original
    const brandMap = new Map();
    products.forEach(p=>{
      const raw=(p.marca||"").trim();
      if(!raw) return;
      const key=normalizeBrand(raw);
      if(!key) return;
      if(!brandMap.has(key)){
        brandMap.set(key, raw);
      }
    });

    allBrands = Array.from(brandMap.entries())
      .map(([key,label])=>({key,label}))
      .sort((a,b)=>a.label.localeCompare(b.label,'es',{sensitivity:'base'}));

    const saved=getSavedFilters();
    const catSaved=saved.category||"Todas";
    let brandSaved=saved.brand||"Todas";

    // Compatibilidad con valores antiguos guardados como texto exacto
    if(brandSaved!=="Todas" && brandSaved && !brandMap.has(brandSaved)){
      const normalized = normalizeBrand(brandSaved);
      if(brandMap.has(normalized)){
        brandSaved = normalized;
      }else{
        brandSaved = "Todas";
      }
    }

    categoryMenuContainer.innerHTML=["Todas",...allCategories].map(c=>`
      <label style="display:block;margin-bottom:4px;">
        <input type="radio" name="category" value="${escapeAttr(c)}" ${c===catSaved?"checked":""}> ${escapeHtml(c||"Todas")}
      </label>
    `).join("");

    const brandOptionsHtml = [
      `<label style="display:block;margin-bottom:4px;">
        <input type="radio" name="brand" value="Todas" ${brandSaved==="Todas"?"checked":""}> Todas
      </label>`,
      ...allBrands.map(b=>`
        <label style="display:block;margin-bottom:4px;">
          <input type="radio" name="brand" value="${escapeAttr(b.key)}" data-label="${escapeAttr(b.label)}" ${b.key===brandSaved?"checked":""}> ${escapeHtml(b.label)}
        </label>
      `)
    ];
    brandMenuContainer.innerHTML = brandOptionsHtml.join("");

    updateCategoryButtonLabel();
    updateBrandButtonLabel();
  }

  function setupFilterListenersOnce(){
    if(filterListenersAttached) return;
    filterListenersAttached=true;

    categoryMenuContainer.addEventListener("change",()=>{
      saveFiltersToStorage();
      filterAndDisplayProducts();
      updateCategoryButtonLabel();
      closeDropdowns();
    });
    brandMenuContainer.addEventListener("change",()=>{
      saveFiltersToStorage();
      filterAndDisplayProducts();
      updateBrandButtonLabel();
      closeDropdowns();
    });

    document.addEventListener("click",e=>{
      const t=e.target;
      if(t.classList.contains("dropdown-toggle-btn")){
        e.stopPropagation();
        const dd=t.closest(".custom-dropdown");
        if(!dd) return;
        const was=dd.classList.contains("open");
        closeDropdowns();
        dd.classList.toggle("open",!was);
        const menu = dd.querySelector(".custom-menu");
        if(menu){
          menu.setAttribute("aria-hidden",was?"true":"false");
        }
        t.setAttribute("aria-expanded",(!was).toString());
      }else if(!t.closest(".custom-dropdown")){
        closeDropdowns();
      }
    });

    document.addEventListener("keydown",e=>{
      if(e.key==="Escape") closeDropdowns();
    });

    [categoryToggleBtn,brandToggleBtn].forEach(btn=>{
      btn.addEventListener("keydown",e=>{
        if(e.key==="Enter"||e.key===" "){
          e.preventDefault();
          btn.click();
        }
      });
    });

    // B√∫squeda con debounce
    searchInput.addEventListener("input", debounce(() => {
      const raw = searchInput.value || "";
      const term = raw.trim();

      if (term === "") {
        currentSortOrder = "default";
        sortPriceBtn.textContent = "Ordenar por precio";
      }

      filterAndDisplayProducts();

      if (term && term !== lastSearchLogged) {
        lastSearchLogged = term;
        logVisit("busqueda", term);
      }
    }, 600));
  }

  /* ================== CARGA DE PRODUCTOS ================== */
  async function fetchProductsFromBackend(){
    try{
      const resp=await fetch(APPS_SCRIPT_URL+"?action=getAll&ts="+Date.now());
      if(!resp.ok) throw new Error("Error de red");
      const data=await resp.json();
      if(data.status!=="success" || !Array.isArray(data.products)){
        throw new Error(data.message||"Respuesta inv√°lida");
      }

      products = data.products.map(p=>{
        const valor = Number(p.valor_unitario);
        const orden = Number(p.orden);
        return {
          ...p,
          valor_unitario: Number.isFinite(valor) ? valor : 0,
          orden: Number.isFinite(orden) ? orden : 999999
        };
      });

      refreshFilters();
      setupFilterListenersOnce();
      filterAndDisplayProducts();
    }catch(err){
      console.error(err);
      productTableBody.innerHTML='<tr><td colspan="6" style="text-align:center;">Error al cargar productos.</td></tr>';
    }
  }

  // Orden base: columna "orden" + c√≥digo
  function sortByOrdenThenName(list){
    list.sort((a,b)=>{
      const aVal = typeof a.orden === "number" && !isNaN(a.orden) ? a.orden : 999999;
      const bVal = typeof b.orden === "number" && !isNaN(b.orden) ? b.orden : 999999;
      if(aVal!==bVal) return aVal-bVal;
      return String(a.id).localeCompare(String(b.id));
    });
  }

  /* ================== LISTADO / FILTRADO ================== */
  function filterAndDisplayProducts(){
    let list=[...products];

    const catSel=categoryMenuContainer.querySelector('input[name="category"]:checked');
    const catVal=catSel ? catSel.value : "Todas";
    if(catVal!=="Todas") list=list.filter(p=>p.category===catVal);

    const brandSel=brandMenuContainer.querySelector('input[name="brand"]:checked');
    const brandVal=brandSel ? brandSel.value : "Todas";
    if(brandVal!=="Todas") list=list.filter(p=>normalizeBrand(p.marca||"")===brandVal);

    const terms=normalizeText(searchInput.value).split(/\s+/).filter(Boolean);
    if(terms.length>0){
      list=list.filter(p=>{
        const s=normalizeText(`${p.id} ${p.name} ${p.category} ${p.marca} ${p.description||""}`);
        return terms.every(t=>s.includes(t));
      });
    }

    if(currentSortOrder==="asc"){
      list.sort((a,b)=>(a.valor_unitario||0)-(b.valor_unitario||0));
    }else if(currentSortOrder==="desc"){
      list.sort((a,b)=>(b.valor_unitario||0)-(a.valor_unitario||0));
    }else{
      sortByOrdenThenName(list);
    }

    displayProducts(list);
  }

  function displayProducts(list){
    if(!Array.isArray(list) || list.length===0){
      productTableBody.innerHTML='<tr><td colspan="6" style="text-align:center;">No hay productos.</td></tr>';
      return;
    }
    const frag=document.createDocumentFragment();
    list.forEach(p=>{
      const qty=cart[p.id]?.quantity || 0;
      const unitPrice=p.valor_unitario||0;
      const subtotal=qty*unitPrice;

      const tr=document.createElement("tr");
      tr.setAttribute("data-product-id",p.id);
      tr.innerHTML=`
        <td data-label="Nombre"><span>${escapeHtml(p.name)}</span></td>
        <td data-label="Categor√≠a">${escapeHtml(p.category)}</td>
        <td data-label="Marca">${escapeHtml(p.marca)}</td>
        <td data-label="Valor unitario" class="price-cell">${currencyFormatter.format(unitPrice)}</td>
        <td data-label="Cantidad">
          <div class="quantity-control">
            <button type="button" class="quantity-btn decrease-btn" aria-label="Disminuir">-</button>
            <input type="number" class="quantity-input" min="0" value="${qty}"
              data-price="${unitPrice}" data-id="${escapeAttr(p.id)}" data-name="${escapeAttr(p.name)}">
            <button type="button" class="quantity-btn increase-btn" aria-label="Aumentar">+</button>
          </div>
        </td>
        <td data-label="Total" class="price-cell total-pay">${currencyFormatter.format(subtotal)}</td>
      `;
      frag.appendChild(tr);
    });
    productTableBody.innerHTML="";
    productTableBody.appendChild(frag);
  }

  /* ================== CARRITO ================== */
  function loadCartFromStorage(){
    const saved=localStorage.getItem(LS_CART_KEY);
    if(!saved) return;
    try{
      const parsed=JSON.parse(saved);
      if(parsed && typeof parsed==="object"){
        cart=parsed;
      }
    }catch{
      cart={};
    }
  }
  function updateCart(){
    let total=0;
    const items=Object.values(cart);
    if(items.length===0){
      cartList.innerHTML='<li class="cart-item"><span class="cart-item-title">El carrito est√° vac√≠o.</span></li>';
    }else{
      cartList.innerHTML=items.map(it=>{
        const sub=it.quantity*it.price;
        total+=sub;
        return `<li class="cart-item">
          <span class="cart-item-title">${it.quantity} x ${escapeHtml(it.name)} <strong>(${currencyFormatter.format(sub)})</strong></span>
          <button class="remove-item-btn" data-id="${escapeAttr(it.id)}">X</button>
        </li>`;
      }).join("");
    }
    totalPriceElement.textContent="Total: " + currencyFormatter.format(total);
    localStorage.setItem(LS_CART_KEY,JSON.stringify(cart));
  }

  function buildClientWhatsAppMsg(items,header="Hola, deseo comprar estos productos en Irenismb Natura Stock:"){
    let msg=header + "\n\n";
    let total=0;
    items.forEach(it=>{
      const sub=it.quantity*it.price;
      total+=sub;
      msg+=`‚Ä¢ ${it.quantity} x ${it.name} = ${currencyFormatter.format(sub)}\n`;
    });
    msg+=`\nTotal: ${currencyFormatter.format(total)}\n`;
    msg+=`\nUbicaci√≥n (GPS): https://maps.google.com/?q=11.244833370782679,-74.19066001689564`;
    msg+=`\nInstagram: https://www.instagram.com/irenismb_stocknaturasm`;
    msg+=`\nFacebook: https://www.facebook.com/marketplace/profile/100084865295132`;
    return msg;
  }
  function openWhatsApp(msg){
    const encoded=encodeURIComponent(msg);
    const isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const url=isMobile
      ? `https://api.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`
      : `https://web.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`;
    window.open(url,"_blank");
  }

  /* ================== EVENTOS ================== */
  productTableBody.addEventListener("input",e=>{
    if(!e.target.classList.contains("quantity-input")) return;
    const input=e.target;
    let qty=parseInt(input.value,10);
    if(isNaN(qty) || qty<0) qty=0;
    input.value=qty;

    const id=input.dataset.id;
    const name=input.dataset.name;
    const price=parseInt(input.dataset.price,10)||0;
    const tr=input.closest("tr");
    if(tr){
      const totalCell=tr.querySelector(".total-pay");
      if(totalCell) totalCell.textContent=currencyFormatter.format(qty*price);
    }

    if(qty>0){
      cart[id]={id,name,quantity:qty,price};
    }else{
      delete cart[id];
    }
    updateCart();
  });

  productTableBody.addEventListener("click",e=>{
    const tr=e.target.closest("tr[data-product-id]");
    if(!tr) return;

    if(e.target.classList.contains("quantity-btn")){
      const input=tr.querySelector(".quantity-input");
      let qty=parseInt(input.value,10)||0;
      if(e.target.classList.contains("increase-btn")) qty++;
      else if(e.target.classList.contains("decrease-btn")) qty--;
      if(qty<0) qty=0;
      input.value=qty;
      input.dispatchEvent(new Event("input",{bubbles:true}));
      return;
    }

    if(e.target.classList.contains("quantity-input")) return;

    const id=tr.getAttribute("data-product-id");
    const prod=products.find(p=>String(p.id)===String(id));
    if(prod){
      showPreviewForProduct(prod);
      logVisit("producto: "+prod.name, searchInput.value.trim());
    }
  });

  sortPriceBtn.addEventListener("click",()=>{
    if(currentSortOrder==="default"||currentSortOrder==="desc"){
      currentSortOrder="asc";
      sortPriceBtn.textContent="Precio $‚Üì";
    }else{
      currentSortOrder="desc";
      sortPriceBtn.textContent="Precio $‚Üë";
    }
    filterAndDisplayProducts();
  });

  whatsappBtn.addEventListener("click",()=>{
    const items=Object.values(cart);
    if(items.length===0) return;
    const msg=buildClientWhatsAppMsg(items);
    openWhatsApp(msg);
  });

  contactWhatsappLink.addEventListener("click",e=>{
    e.preventDefault();
    openWhatsApp("Hola, me interesan los productos de Irenismb Natura Stock.");
  });

  cartList.addEventListener("click",e=>{
    if(!e.target.classList.contains("remove-item-btn")) return;
    const id=e.target.dataset.id;
    delete cart[id];
    try{
      const selector = `.quantity-input[data-id="${CSS.escape(id)}"]`;
      const input=productTableBody.querySelector(selector);
      if(input){
        input.value=0;
        input.dispatchEvent(new Event("input",{bubbles:true}));
      }else{
        updateCart();
      }
    }catch{
      updateCart();
    }
  });

  let autoRefreshTimer=null;
  function startAutoRefresh(){
    stopAutoRefresh();
    autoRefreshTimer=setInterval(()=>{
      if(document.hidden) return;
      fetchProductsFromBackend();
    },AUTO_REFRESH_MS);
  }
  function stopAutoRefresh(){
    if(autoRefreshTimer){
      clearInterval(autoRefreshTimer);
      autoRefreshTimer=null;
    }
  }
  document.addEventListener("visibilitychange",()=>{
    if(document.hidden) stopAutoRefresh();
    else startAutoRefresh();
  });

  document.addEventListener("DOMContentLoaded",()=>{
    loadCartFromStorage();
    updateCart();
    fetchProductsFromBackend();
    startAutoRefresh();
    logVisit("entrada_catalogo","");

    // Actualizar enlaces de redes
    try{
      const links=document.querySelectorAll(".contact-info a");
      links.forEach(a=>{
        const txt=(a.textContent||"").toLowerCase();
        if(txt.includes("facebook")){
          a.href="https://www.facebook.com/marketplace/profile/100084865295132";
          a.target="_blank";
          a.rel="noopener noreferrer";
        }else if(txt.includes("instagram")){
          a.href="https://www.instagram.com/irenismb_stocknaturasm";
          a.target="_blank";
          a.rel="noopener noreferrer";
        }else if(txt.includes("tiktok")){
          a.href="https://www.tiktok.com/@irenismbstocknatura";
          a.target="_blank";
          a.rel="noopener noreferrer";
        }
      });
    }catch(e){
      console.error("Error actualizando redes:", e);
    }
  });

  window.addEventListener("beforeunload",()=>{
    localStorage.setItem(LS_CART_KEY,JSON.stringify(cart));
    localStorage.setItem(LS_FILTERS_KEY,JSON.stringify(getSavedFilters()));
  });
</script>
</body>
</html>

