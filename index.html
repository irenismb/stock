<script>
  // ===== CONFIG =====
  const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBTeqbaoB-5-b_h98cslcSic_6QcA1lCkCQagpF8q-yxcr1okC9TEuIYAZDgTL1DSCvdPtwBrApGj6/pub?gid=732037573&single=true&output=tsv';
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgRlyQfToDd8O7JOyRP0XXdryqpksSTu04zuhaZHYnun59S0ALXR_vnHZGfY5ch7SP/exec";
  const GOOGLE_CLIENT_ID = "575624026373-nm1ienpvaaa4its9070pv182quqf544m.apps.googleusercontent.com";
  const DEFAULT_WHATSAPP = "573042088961";
  const SELLER_NAME = "Irenis Stock Natura";
  const SELLER_PHONE = "3042088961";

  // detectar m√≥vil
  const IS_MOBILE = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || window.innerWidth <= 768;

  // admins
  const ALLOWED_ADMIN_EMAILS = [
    "irenismendoza@gmail.com",
    "marllerpar@gmail.com",
    "TU_CORREO_ADMIN_ACTUAL@GMAIL.COM"
  ];

  const MODE_CLIENT = "client";
  const MODE_ADMIN_EDIT = "admin_edit";
  const MODE_ADMIN_SALE = "admin_sale";

  const SESSION_KEY = "naturaAdminGoogleSession";
  const MOBILE_ADMIN_FLAG = "naturaMobileAdminAllowed";

  let currentMode = MODE_CLIENT;
  let products = [];
  let allCategories = [];
  let allBrands = [];
  let googleUserToken = null;
  let currentAdminName = null;
  let currentAdminEmail = null;

  // DOM
  const categoryMenuContainer = document.getElementById('categoryMenu');
  const brandMenuContainer = document.getElementById('brandMenu');
  const searchInput = document.getElementById('searchInput');
  const productTableBody = document.getElementById('productTableBody');
  const cartList = document.getElementById('cartList');
  const totalPriceElement = document.getElementById('totalPrice');
  const whatsappBtn = document.getElementById('whatsappBtn');
  const contactWhatsappLink = document.getElementById('contactWhatsappLink');
  const sortPriceBtn = document.getElementById('sortPriceBtn');
  const googleSignInContainer = document.getElementById('googleSignInContainer');
  const inventoryTotalElement = document.getElementById('inventoryTotal');
  const invoiceBtn = document.getElementById('invoiceBtn');
  const qtyHeader = document.getElementById('qtyHeader');
  const modeSelector = document.getElementById('modeSelector');
  const cartContainer = document.getElementById('cartContainer');
  const categoryToggleBtn = document.getElementById('categoryToggleBtn');
  const brandToggleBtn = document.getElementById('brandToggleBtn');

  // bot√≥n flotante para entrar a admin en m√≥vil
  const mobileAdminBtn = document.createElement("button");
  mobileAdminBtn.textContent = "üîê Admin m√≥vil";
  mobileAdminBtn.style.position = "fixed";
  mobileAdminBtn.style.bottom = "16px";
  mobileAdminBtn.style.right = "16px";
  mobileAdminBtn.style.zIndex = "999";
  mobileAdminBtn.style.background = "#0d6efd";
  mobileAdminBtn.style.color = "#fff";
  mobileAdminBtn.style.border = "none";
  mobileAdminBtn.style.borderRadius = "999px";
  mobileAdminBtn.style.padding = "8px 14px";
  mobileAdminBtn.style.fontSize = "13px";
  mobileAdminBtn.style.boxShadow = "0 4px 12px rgba(0,0,0,.25)";
  mobileAdminBtn.style.display = "none";

  // barrita cuando ya eres admin en m√≥vil
  const mobileAdminBar = document.createElement("div");
  mobileAdminBar.style.position = "fixed";
  mobileAdminBar.style.left = "0";
  mobileAdminBar.style.right = "0";
  mobileAdminBar.style.bottom = "0";
  mobileAdminBar.style.background = "rgba(255,255,255,.95)";
  mobileAdminBar.style.borderTop = "1px solid rgba(0,0,0,.08)";
  mobileAdminBar.style.display = "none";
  mobileAdminBar.style.zIndex = "998";
  mobileAdminBar.style.padding = "6px 10px";
  mobileAdminBar.style.display = "none";
  mobileAdminBar.style.gap = "8px";
  mobileAdminBar.style.justifyContent = "center";
  mobileAdminBar.style.alignItems = "center";
  mobileAdminBar.style.flexWrap = "wrap";
  mobileAdminBar.style.boxShadow = "0 -4px 12px rgba(0,0,0,.08)";
  mobileAdminBar.style.display = "none";
  mobileAdminBar.style.display = "none";
  mobileAdminBar.style.display = "none";
  mobileAdminBar.style.flexDirection = "row";
  mobileAdminBar.style.display = "none";

  const mobileEditBtn = document.createElement("button");
  mobileEditBtn.textContent = "‚úèÔ∏è Editar";
  mobileEditBtn.style.background = "#198754";
  mobileEditBtn.style.color = "#fff";
  mobileEditBtn.style.border = "none";
  mobileEditBtn.style.borderRadius = "6px";
  mobileEditBtn.style.padding = "6px 10px";
  mobileEditBtn.style.fontSize = "13px";

  const mobileSellBtn = document.createElement("button");
  mobileSellBtn.textContent = "üßæ Vender";
  mobileSellBtn.style.background = "#0d6efd";
  mobileSellBtn.style.color = "#fff";
  mobileSellBtn.style.border = "none";
  mobileSellBtn.style.borderRadius = "6px";
  mobileSellBtn.style.padding = "6px 10px";
  mobileSellBtn.style.fontSize = "13px";

  mobileAdminBar.appendChild(mobileEditBtn);
  mobileAdminBar.appendChild(mobileSellBtn);

  document.body.appendChild(mobileAdminBtn);
  document.body.appendChild(mobileAdminBar);

  let cart = {};
  let currentSortOrder = 'default';
  const currencyFormatter = new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", minimumFractionDigits: 0 });

  const canMobileAdmin = () => IS_MOBILE && localStorage.getItem(MOBILE_ADMIN_FLAG) === "1" && !!googleUserToken;

  // ===== CARGA DE PRODUCTOS =====
  fetch(googleSheetURL)
    .then(r => r.ok ? r.text() : Promise.reject("Error de red"))
    .then(csvText => {
      const rows = csvText.trim().split('\n').slice(2);
      products = rows.map((row, idx) => {
        const cols = row.split('\t');
        if (cols.length < 6) return null;
        const priceStr = (cols[3] || '0').replace(/[^\d]/g, '');
        const stockStr = (cols[4] || '0').replace(/[^\d]/g, '');
        const id = cols[5] ? cols[5].trim() : null;
        const name = cols[0] ? cols[0].trim() : null;
        if (!id || !name) return null;
        return {
          id: id,
          name: name,
          category: cols[1] ? cols[1].trim() : '',
          marca: cols[2] ? toTitleCase(cols[2].trim()) : '',
          valor_unitario: parseInt(priceStr, 10) || 0,
          stock: parseInt(stockStr, 10) || 0
        };
      }).filter(Boolean);
      initializeApp();
    })
    .catch(err => {
      console.error(err);
      productTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error al cargar productos.</td></tr>`;
    });

  // ===== Google Sign-In =====
  window.onload = function () {
    if (typeof google === 'undefined') return;
    try {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleSignIn
      });
      // en desktop s√≠ lo pinto de una
      if (!IS_MOBILE) {
        google.accounts.id.renderButton(
          googleSignInContainer,
          { theme: "outline", size: "medium", text: "signin_with", shape: "rectangular" }
        );
      }
    } catch (e) { console.warn(e); }
  };

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  function restoreAdminSession() {
    try {
      const raw = localStorage.getItem(SESSION_KEY);
      const mobileOverride = localStorage.getItem(MOBILE_ADMIN_FLAG) === "1";
      if (!raw) {
        currentMode = MODE_CLIENT;
        return;
      }
      const saved = JSON.parse(raw);
      if (!saved || !saved.token || !saved.email) return;
      googleUserToken = saved.token;
      currentAdminName = saved.name || "Admin";
      currentAdminEmail = saved.email;
      if (IS_MOBILE && !mobileOverride) {
        currentMode = MODE_CLIENT;
      } else {
        currentMode = saved.mode || MODE_ADMIN_EDIT;
      }
    } catch (e) {
      console.warn("No se pudo restaurar la sesi√≥n:", e);
    }
  }

  function handleGoogleSignIn(resp) {
    if (!resp.credential) {
      alert("Error de login");
      return;
    }
    const payload = parseJwt(resp.credential);
    const email = payload && payload.email ? payload.email : null;
    const name = payload && (payload.given_name || payload.name) ? (payload.given_name || payload.name) : "Admin";

    if (email && !ALLOWED_ADMIN_EMAILS.includes(email)) {
      alert("Este correo no est√° autorizado como administrador.\nCorreo: " + email);
      currentMode = MODE_CLIENT;
      modeSelector.value = MODE_CLIENT;
      applyUIMode();
      filterAndDisplayProducts();
      return;
    }

    googleUserToken = resp.credential;
    currentAdminName = name;
    currentAdminEmail = email;

    localStorage.setItem(SESSION_KEY, JSON.stringify({
      token: googleUserToken,
      name: currentAdminName,
      email: currentAdminEmail,
      mode: MODE_ADMIN_EDIT
    }));

    if (IS_MOBILE) {
      localStorage.setItem(MOBILE_ADMIN_FLAG, "1");
      enterAdminMode(name, email, MODE_ADMIN_EDIT);
      showMobileAdminBar();
    } else {
      enterAdminMode(name, email, MODE_ADMIN_EDIT);
    }
  }

  function enterAdminMode(name, email, modeWanted) {
    currentMode = modeWanted || MODE_ADMIN_EDIT;
    if (!IS_MOBILE) {
      googleSignInContainer.style.display = "none";
    }
    applyUIMode();
    filterAndDisplayProducts();
    updateInventoryTotalDisplay();
    try {
      const saved = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      if (saved) {
        saved.mode = currentMode;
        localStorage.setItem(SESSION_KEY, JSON.stringify(saved));
      }
    } catch (e) {}
  }

  function exitAdminMode() {
    currentMode = MODE_CLIENT;
    applyUIMode();
    filterAndDisplayProducts();
    updateInventoryTotalDisplay();
    hideMobileAdminBar();
  }

  // selector de modo (desktop)
  modeSelector.addEventListener("change", () => {
    if (IS_MOBILE) {
      modeSelector.value = currentMode;
      return;
    }
    const selected = modeSelector.value;
    if (selected === MODE_CLIENT) {
      exitAdminMode();
      return;
    }
    if (!googleUserToken) {
      alert("Inicia sesi√≥n con un correo autorizado.");
      googleSignInContainer.style.display = "block";
      modeSelector.value = MODE_CLIENT;
      return;
    }
    currentMode = selected;
    applyUIMode();
    filterAndDisplayProducts();
  });

  // bot√≥n flotante m√≥vil
  mobileAdminBtn.addEventListener("click", () => {
    if (canMobileAdmin()) {
      // ya est√° logueado ‚Üí muestra barra
      showMobileAdminBar();
      return;
    }
    // renderizo bot√≥n de google solo ahora (para no ocupar arriba)
    if (googleSignInContainer) {
      googleSignInContainer.style.display = "block";
      // si no hay bot√≥n todav√≠a, lo pinto
      try {
        if (typeof google !== "undefined") {
          google.accounts.id.renderButton(
            googleSignInContainer,
            { theme: "outline", size: "large", text: "signin_with", shape: "rectangular" }
          );
        }
      } catch (e) {}
    }
    alert("Inicia sesi√≥n con tu cuenta de admin y vuelve a tocar ‚ÄúAdmin m√≥vil‚Äù.");
  });

  function showMobileAdminBar() {
    if (IS_MOBILE && canMobileAdmin()) {
      mobileAdminBar.style.display = "flex";
    }
  }
  function hideMobileAdminBar() {
    mobileAdminBar.style.display = "none";
  }

  // botones de la barrita m√≥vil
  mobileEditBtn.addEventListener("click", () => {
    if (!canMobileAdmin()) return;
    currentMode = MODE_ADMIN_EDIT;
    applyUIMode();
    filterAndDisplayProducts();
    updateInventoryTotalDisplay();
    // guarda
    try {
      const saved = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      if (saved) {
        saved.mode = currentMode;
        localStorage.setItem(SESSION_KEY, JSON.stringify(saved));
      }
    } catch (e) {}
  });
  mobileSellBtn.addEventListener("click", () => {
    if (!canMobileAdmin()) return;
    currentMode = MODE_ADMIN_SALE;
    applyUIMode();
    filterAndDisplayProducts();
    updateInventoryTotalDisplay();
  });

  // ===== MODO ‚Üí UI =====
  function applyUIMode() {
    if (IS_MOBILE) {
      mobileAdminBtn.style.display = "block";
      if (canMobileAdmin()) {
        mobileAdminBar.style.display = "flex";
      } else {
        mobileAdminBar.style.display = "none";
      }
    } else {
      mobileAdminBtn.style.display = "none";
      mobileAdminBar.style.display = "none";
    }

    document.querySelectorAll('.only-client').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.only-admin-edit').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.only-admin-sale').forEach(el => el.style.display = 'none');

    if (currentMode === MODE_CLIENT) {
      document.querySelectorAll('.only-client').forEach(el => el.style.display = 'block');
      if (sortPriceBtn) sortPriceBtn.style.display = "inline-block";
      inventoryTotalElement.style.display = "none";
      if (cartContainer) cartContainer.style.display = "block";
      if (invoiceBtn) invoiceBtn.disabled = true;
      if (IS_MOBILE) modeSelector.disabled = true;
    } else if (currentMode === MODE_ADMIN_EDIT) {
      document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'inline-block');
      document.querySelectorAll('.only-admin-edit').forEach(el => el.style.display = 'inline-block');
      if (sortPriceBtn) sortPriceBtn.style.display = "none";
      if (!IS_MOBILE && cartContainer) cartContainer.style.display = "none";
      // en m√≥vil dejamos ver carrito
      inventoryTotalElement.style.display = "inline-block";
      if (invoiceBtn) invoiceBtn.disabled = true;
    } else if (currentMode === MODE_ADMIN_SALE) {
      document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'inline-block');
      document.querySelectorAll('.only-admin-sale').forEach(el => el.style.display = 'inline-block');
      if (sortPriceBtn) sortPriceBtn.style.display = "none";
      if (cartContainer) cartContainer.style.display = "block";
      inventoryTotalElement.style.display = "inline-block";
      if (invoiceBtn) invoiceBtn.disabled = false;
    }
    setQtyHeader();
  }

  function setQtyHeader() {
    if (!qtyHeader) return;
    if (currentMode === MODE_ADMIN_EDIT) {
      qtyHeader.textContent = "Stock";
    } else {
      qtyHeader.textContent = "Cantidad";
    }
  }

  // helpers
  function toTitleCase(str) { return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : ""; }
  function calculateInventoryTotal() {
    return products.reduce((acc, p) => acc + ((p.valor_unitario || 0) * (p.stock || 0)), 0);
  }
  function updateInventoryTotalDisplay() {
    if (currentMode === MODE_ADMIN_EDIT || currentMode === MODE_ADMIN_SALE) {
      inventoryTotalElement.style.display = "inline-block";
      inventoryTotalElement.textContent = `Total: ${currencyFormatter.format(calculateInventoryTotal())}`;
    } else {
      inventoryTotalElement.style.display = "none";
    }
  }
  function formatDateDDMMYYYY(d) {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  // init
  function initializeApp() {
    restoreAdminSession();
    products.sort((a, b) => a.name.localeCompare(b.name));
    const savedCart = localStorage.getItem("shoppingCart");
    try {
      const parsed = JSON.parse(savedCart);
      if (parsed && Object.values(parsed)[0]?.id) {
        cart = parsed;
      }
    } catch (e) { cart = {}; }
    refreshFilters();
    applyUIMode();
    filterAndDisplayProducts();
    updateCart();
    updateInventoryTotalDisplay();
  }

  function normalizeText(t) { return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }

  function refreshFilters() {
    allCategories = [...new Set(products.map(p => p.category))].sort();
    allBrands = [...new Set(products.map(p => p.marca))].sort();

    const cat = ["Todas", ...allCategories];
    categoryMenuContainer.innerHTML = cat.map(c => `
        <label style="display:block; margin-bottom:4px;">
          <input type="radio" name="category" value="${c}" ${c === "Todas" ? "checked" : ""}>
          ${c}
        </label>
      `).join("");

    const br = ["Todas", ...allBrands];
    brandMenuContainer.innerHTML = br.map(b => `
        <label style="display:block; margin-bottom:4px;">
          <input type="radio" name="brand" value="${b}" ${b === "Todas" ? "checked" : ""}>
          ${b}
        </label>
      `).join("");

    categoryMenuContainer.addEventListener("change", () => {
      filterAndDisplayProducts();
      updateCategoryButtonLabel();
      closeDropdowns();
    });
    brandMenuContainer.addEventListener("change", () => {
      filterAndDisplayProducts();
      updateBrandButtonLabel();
      closeDropdowns();
    });

    updateCategoryButtonLabel();
    updateBrandButtonLabel();
  }

  function updateCategoryButtonLabel() {
    const sel = categoryMenuContainer.querySelector('input[name="category"]:checked');
    const val = sel ? sel.value : "Todas";
    categoryToggleBtn.textContent = (val === "Todas") ? "Categor√≠as ‚ñæ" : `${val} ‚ñæ`;
  }

  function updateBrandButtonLabel() {
    const sel = brandMenuContainer.querySelector('input[name="brand"]:checked');
    const val = sel ? sel.value : "Todas";
    brandToggleBtn.textContent = (val === "Todas") ? "Marcas ‚ñæ" : `${val} ‚ñæ`;
  }

  function closeDropdowns() {
    document.querySelectorAll('.custom-dropdown.open').forEach(d => {
      d.classList.remove('open');
      d.querySelector('.custom-menu').setAttribute('aria-hidden', 'true');
    });
  }

  document.addEventListener('click', (e) => {
    const t = e.target;
    if (t.classList.contains('dropdown-toggle-btn')) {
      e.stopPropagation();
      const dd = t.closest('.custom-dropdown');
      const was = dd.classList.contains('open');
      closeDropdowns();
      dd.classList.toggle('open', !was);
      dd.querySelector('.custom-menu').setAttribute('aria-hidden', was ? 'true' : 'false');
    } else if (!t.closest('.custom-dropdown')) {
      closeDropdowns();
    }
  });

  function filterAndDisplayProducts() {
    let list = [...products];

    const catSel = document.querySelector("#categoryMenu input[name='category']:checked");
    const catVal = catSel ? catSel.value : "Todas";
    if (catVal !== "Todas") {
      list = list.filter(p => p.category === catVal);
    }

    const brandSel = document.querySelector("#brandMenu input[name='brand']:checked");
    const brandVal = brandSel ? brandSel.value : "Todas";
    if (brandVal !== "Todas") {
      list = list.filter(p => p.marca === brandVal);
    }

    const searchTerms = normalizeText(searchInput.value).split(/\s+/).filter(Boolean);
    if (searchTerms.length > 0) {
      list = list.filter(p => {
        const s = normalizeText(`${p.id} ${p.name} ${p.category} ${p.marca}`);
        return searchTerms.every(t => s.includes(t));
      });
    }
    if (currentSortOrder === "asc") list.sort((a, b) => a.valor_unitario - b.valor_unitario);
    else if (currentSortOrder === "desc") list.sort((a, b) => b.valor_unitario - a.valor_unitario);
    displayProducts(list);
    updateInventoryTotalDisplay();
  }

  function displayProducts(list) {
    if (list.length === 0) {
      productTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay productos.</td></tr>';
      return;
    }
    const isMobileAdminNow = canMobileAdmin();
    const rows = list.map(p => {
      const qtyInCart = cart[p.id] ? cart[p.id].quantity : 0;
      const isEditing = (currentMode === MODE_ADMIN_EDIT && (!IS_MOBILE || isMobileAdminNow));
      const valueToShow = isEditing ? p.stock : qtyInCart;
      const dataLabel = isEditing ? "Stock" : "Cantidad";
      let subtotal;
      if (isEditing) {
        subtotal = (p.stock || 0) * (p.valor_unitario || 0);
      } else {
        subtotal = qtyInCart * p.valor_unitario;
      }
      const readOnlyAttr = isEditing ? "" : "readonly";

      let nameCell, catCell, brandCell, priceCell;
      if (isEditing) {
        nameCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="name" value="${escapeHtml(p.name)}">`;
        catCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="category" value="${escapeHtml(p.category)}">`;
        brandCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="marca" value="${escapeHtml(p.marca)}">`;
        priceCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="valor_unitario" value="${p.valor_unitario}" placeholder="0">`;
      } else {
        nameCell = `<span>${escapeHtml(p.name)}</span>`;
        catCell = escapeHtml(p.category);
        brandCell = escapeHtml(p.marca);
        priceCell = currencyFormatter.format(p.valor_unitario);
      }

      return `
        <tr>
          <td data-label="Nombre">${nameCell}</td>
          <td data-label="Categor√≠a">${catCell}</td>
          <td data-label="Marca">${brandCell}</td>
          <td class="price-cell" data-label="Valor unitario">${priceCell}</td>
          <td data-label="${dataLabel}">
            <div class="quantity-control">
              <button type="button" class="quantity-btn decrease-btn" aria-label="Disminuir cantidad">-</button>
              <input type="number" class="quantity-input" min="0" value="${valueToShow}"
                data-price="${p.valor_unitario}"
                data-id="${p.id}"
                data-name="${escapeHtml(p.name)}"
                ${readOnlyAttr}>
              <button type="button" class="quantity-btn increase-btn" aria-label="Aumentar cantidad">+</button>
            </div>
          </td>
          <td class="price-cell total-pay" data-label="Total">${currencyFormatter.format(subtotal)}</td>
        </tr>`;
    }).join("");
    productTableBody.innerHTML = rows;
  }

  function updateCart() {
    let total = 0;
    const items = Object.values(cart);
    if (items.length === 0) {
      cartList.innerHTML = "<li class=\"cart-item\"><span class=\"cart-item-title\">El carrito est√° vac√≠o.</span></li>";
    } else {
      cartList.innerHTML = items.map(it => {
        const sub = it.quantity * it.price;
        total += sub;
        return `<li class="cart-item"><span class="cart-item-title">${it.quantity} x ${escapeHtml(it.name)} <strong>(${currencyFormatter.format(sub)})</strong></span><button class="remove-item-btn" data-id="${it.id}">X</button></li>`;
      }).join("");
    }
    totalPriceElement.textContent = `Total: ${currencyFormatter.format(total)}`;
    localStorage.setItem("shoppingCart", JSON.stringify(cart));
  }

  function escapeHtml(t) {
    if (t == null) return '';
    return String(t).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
  }

  // eventos de tabla
  productTableBody.addEventListener("input", (e) => {
    if (e.target.classList.contains("admin-input")) {
      // edici√≥n de texto ‚Üí solo si es admin
      if (!(currentMode === MODE_ADMIN_EDIT && ( !IS_MOBILE || canMobileAdmin()))) return;
      const input = e.target;
      const id = input.dataset.id;
      const field = input.dataset.field;
      const value = input.value;
      const product = products.find(p => p.id === id);
      if (!product) return;
      if (String(product[field]) === String(value)) return;
      updateProductFieldInGoogleSheet(id, field, value, input);
      return;
    }

    if (!e.target.classList.contains("quantity-input")) return;
    const input = e.target;
    let qty = parseInt(input.value, 10) || 0;
    if (qty < 0) qty = 0;
    input.value = qty;
    const id = input.dataset.id;
    const name = input.dataset.name;
    const price = parseInt(input.dataset.price, 10) || 0;
    const tr = input.closest("tr");
    if (tr) tr.querySelector(".total-pay").textContent = currencyFormatter.format(qty * price);

    // admin de escritorio editando stock
    if (currentMode === MODE_ADMIN_EDIT && !IS_MOBILE) {
      updateStockInGoogleSheet(id, qty, input);
      return;
    }
    // admin m√≥vil editando stock
    if (currentMode === MODE_ADMIN_EDIT && canMobileAdmin()) {
      updateStockInGoogleSheet(id, qty, input);
      return;
    }

    // cliente o vendedor ‚Üí carrito
    if (qty > 0) {
      cart[id] = { id, name, quantity: qty, price };
    } else {
      delete cart[id];
    }
    updateCart();
  });

  productTableBody.addEventListener("click", (e) => {
    const t = e.target;
    if (!t.classList.contains("quantity-btn")) return;
    const ctrl = t.closest(".quantity-control");
    const input = ctrl.querySelector(".quantity-input");
    let val = parseInt(input.value, 10) || 0;
    if (t.classList.contains("increase-btn")) val++;
    else val--;
    if (val < 0) val = 0;
    input.value = val;

    const id = input.dataset.id;
    const name = input.dataset.name;
    const price = parseInt(input.dataset.price, 10) || 0;
    const tr = input.closest("tr");
    if (tr) tr.querySelector(".total-pay").textContent = currencyFormatter.format(val * price);

    // admin escritorio
    if (currentMode === MODE_ADMIN_EDIT && !IS_MOBILE) {
      updateStockInGoogleSheet(id, val, input);
      return;
    }
    // admin m√≥vil
    if (currentMode === MODE_ADMIN_EDIT && canMobileAdmin()) {
      updateStockInGoogleSheet(id, val, input);
      return;
    }

    // cliente / vendedor
    if (val > 0) {
      cart[id] = { id, name, quantity: val, price };
    } else {
      delete cart[id];
    }
    updateCart();
  });

  cartList.addEventListener("click", (e) => {
    if (!e.target.classList.contains("remove-item-btn")) return;
    const id = e.target.dataset.id;
    delete cart[id];
    const input = productTableBody.querySelector(`.quantity-input[data-id="${id}"]`);
    if (input) {
      input.value = 0;
      input.dispatchEvent(new Event("input", { bubbles: true }));
    } else {
      updateCart();
    }
  });

  // ===== actualizar en sheets =====
  async function updateStockInGoogleSheet(id, newStock, input) {
    if (!googleUserToken) {
      alert("No est√°s autenticado.");
      return;
    }
    const p = products.find(p => p.id === id);
    const original = p ? p.stock : 0;
    if (input) input.disabled = true;
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "updateStock",
          token: googleUserToken,
          productId: id,
          newStock: newStock,
          adminEmail: currentAdminEmail
        })
      });
      const json = await resp.json();
      if (json.status === "success") {
        if (p) p.stock = newStock;
        filterAndDisplayProducts();
        updateInventoryTotalDisplay();
      } else {
        throw new Error(json.message || "Error guardando");
      }
    } catch (err) {
      alert("Error al guardar stock: " + err.message);
      if (input) input.value = original;
    } finally {
      if (input) input.disabled = false;
    }
  }

  async function updateProductFieldInGoogleSheet(id, field, value, input) {
    if (!googleUserToken) {
      alert("No est√°s autenticado.");
      return;
    }
    const p = products.find(p => p.id === id);
    const original = p ? p[field] : "";
    let newValue = value;
    if (field === "valor_unitario") {
      newValue = (value || "").replace(/[^\d]/g, "");
      newValue = parseInt(newValue, 10) || 0;
    }
    input.disabled = true;
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "updateField",
          token: googleUserToken,
          productId: id,
          fieldToUpdate: field,
          newValue: newValue,
          adminEmail: currentAdminEmail
        })
      });
      const json = await resp.json();
      if (json.status === "success") {
        p[field] = newValue;
        filterAndDisplayProducts();
        updateInventoryTotalDisplay();
      } else {
        throw new Error(json.message || "Error guardando");
      }
    } catch (err) {
      alert("Error al guardar: " + err.message);
      input.value = original;
    } finally {
      if (input) input.disabled = false;
    }
  }

  // ===== WhatsApp & botones =====
  searchInput.addEventListener("input", filterAndDisplayProducts);
  sortPriceBtn.addEventListener("click", () => {
    if (currentSortOrder === "default" || currentSortOrder === "desc") {
      currentSortOrder = "asc"; sortPriceBtn.textContent = "Precio $‚Üì";
    } else {
      currentSortOrder = "desc"; sortPriceBtn.textContent = "Precio $‚Üë";
    }
    filterAndDisplayProducts();
  });

  function openWhatsApp(msg) {
    const encoded = encodeURIComponent(msg);
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const url = isMobile ? `https://api.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`
      : `https://web.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`;
    window.open(url, "_blank");
  }

  whatsappBtn.addEventListener("click", () => {
    if (currentMode !== MODE_CLIENT) return;
    const items = Object.values(cart);
    if (items.length === 0) return;
    const msg = buildWhatsAppMsg(items);
    openWhatsApp(msg);
  });

  function buildWhatsAppMsg(items, extraHeader = "Hola, deseo comprar estos productos en Irenismb Natura Stock:") {
    let msg = extraHeader + "\n\n";
    let total = 0;
    items.forEach(it => {
      const sub = it.quantity * it.price;
      msg += `‚Ä¢ ${it.quantity} x ${it.name} = ${currencyFormatter.format(sub)}\n`;
      total += sub;
    });
    msg += `\nTotal: ${currencyFormatter.format(total)}\n`;
    msg += `\nVendedor: ${SELLER_NAME}\nWhatsApp: ${SELLER_PHONE}\n`;
    return msg;
  }

  contactWhatsappLink.addEventListener("click", (e) => {
    e.preventDefault();
    openWhatsApp("Hola, me interesan los productos de Irenismb Natura Stock.");
  });

  // ===== VENDER (ahora tambi√©n en m√≥vil admin) =====
  invoiceBtn.addEventListener("click", () => {
    if (currentMode !== MODE_ADMIN_SALE) return;
    if (!googleUserToken) {
      alert("Inicia sesi√≥n con Google primero.");
      if (!IS_MOBILE) googleSignInContainer.style.display = "block";
      return;
    }
    startSellFlow();
  });

  function startSellFlow() {
    const items = Object.values(cart);
    if (items.length === 0) {
      alert("No hay productos en el carrito.");
      return;
    }

    const cliente = prompt("Nombre del cliente:", "Cliente contado");
    if (cliente === null) return;
    const hoy = new Date();
    const fechaDef = formatDateDDMMYYYY(hoy);
    let fecha = prompt("Fecha de venta (dd/mm/aaaa):", fechaDef) || fechaDef;
    let abonadoStr = prompt("Valor abonado / pagado:", "0") || "0";
    let plazoStr = prompt("Plazo en d√≠as (30 por defecto):", "30") || "30";

    const abonado = parseInt(abonadoStr.replace(/[^\d]/g, ""), 10) || 0;
    let plazo = parseInt(plazoStr, 10);
    if (isNaN(plazo) || plazo < 0) plazo = 30;

    let total = 0;
    items.forEach(it => total += it.quantity * it.price);
    let saldo = total - abonado;
    if (saldo < 0) saldo = 0;

    let vence = "";
    if (saldo > 0) {
      const p = fecha.split("/");
      let d = new Date();
      if (p.length === 3) {
        d = new Date(parseInt(p[2], 10), parseInt(p[1], 10) - 1, parseInt(p[0], 10));
      }
      d.setDate(d.getDate() + plazo);
      vence = formatDateDDMMYYYY(d);
    }

    // manda venta al script (opcional)
    try {
      fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "registerSale",
          token: googleUserToken,
          adminEmail: currentAdminEmail,
          cliente,
          fecha,
          items,
          total,
          abonado,
          saldo,
          vence
        })
      }).catch(()=>{});
    } catch(e){}

    // factura r√°pida
    const w = window.open("", "_blank");
    w.document.write(`
      <html><head><title>Factura - Irenismb Natura Stock</title></head><body>
      <h2>Irenismb Natura Stock</h2>
      <p><strong>Cliente:</strong> ${cliente}</p>
      <p><strong>Fecha:</strong> ${fecha}</p>
      <p><strong>Vendedor:</strong> ${SELLER_NAME} - ${SELLER_PHONE}</p>
      <table border="1" cellspacing="0" cellpadding="5">
        <tr><th>Producto</th><th>Cant</th><th>V.Unit</th><th>Subtotal</th></tr>
        ${items.map(it => `<tr><td>${it.name}</td><td>${it.quantity}</td><td>${currencyFormatter.format(it.price)}</td><td>${currencyFormatter.format(it.quantity * it.price)}</td></tr>`).join("")}
        <tr><td colspan="3"><strong>Total</strong></td><td>${currencyFormatter.format(total)}</td></tr>
        <tr><td colspan="3"><strong>Abonado/Pagado</strong></td><td>${currencyFormatter.format(abonado)}</td></tr>
        <tr><td colspan="3"><strong>Saldo</strong></td><td>${currencyFormatter.format(saldo)}</td></tr>
        ${saldo>0 ? `<tr><td colspan="3"><strong>Vence</strong></td><td>${vence}</td></tr>` : ""}
      </table>
      <p>Gracias por su compra.</p>
      </body></html>
    `);
    w.document.close();

    // actualizar stock
    items.forEach(it => {
      const prod = products.find(p => p.id === it.id);
      if (prod) {
        const newStock = Math.max((prod.stock || 0) - it.quantity, 0);
        updateStockInGoogleSheet(prod.id, newStock, null);
      }
    });

    // limpiar carrito
    cart = {};
    localStorage.removeItem("shoppingCart");
    productTableBody.querySelectorAll(".quantity-input").forEach(input => {
      if (currentMode !== MODE_ADMIN_EDIT) {
        input.value = 0;
      }
    });
    updateCart();
  }
</script>
