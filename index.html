<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Irenismb Natura Stock - Cat√°logo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --primary-color:#007bff;
      --secondary-color:#25D366;
      --background-color:#f4f4f9;
      --text-color:#333;
      --card-bg-color:#fff;
      --border-color:#ddd;
      --toolbar-h:70px;
      --radius:10px;
      --gap:15px;
    }
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      margin:0;
      padding:10px;
      background-color:var(--background-color);
      color:var(--text-color);
    }
    .container{
      display:flex;
      gap:15px;
      align-items:flex-start;
    }
    .left-panel{
      flex:3 1 700px;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .controls-panel{
      position:sticky;
      top:0;
      z-index:40;
      background:var(--background-color);
      padding-bottom:6px;
      padding-top:4px;
    }
    .products-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      border-bottom:1px solid rgba(0,0,0,.05);
      padding-bottom:6px;
      flex-wrap:wrap;
    }
    .left-controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width:0;
    }
    .search-filters{
      display:flex;
      align-items:center;
      gap:8px;
      flex:1;
      min-width:0;
      flex-wrap:wrap;
    }
    #searchInput{
      flex:1 1 180px;
      min-width:0;
      padding:10px 12px;
      border:1px solid #ccc;
      border-radius:5px;
      background-color:var(--card-bg-color);
      font-size:16px;
    }
    .custom-dropdown{position:relative}
    .dropdown-toggle-btn{
      padding:8px 10px;
      border:1px solid #ccc;
      border-radius:5px;
      background:var(--card-bg-color);
      cursor:pointer;
      white-space:nowrap;
      font-size:14px;
      color:var(--text-color);
      min-height:38px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .custom-menu{
      position:absolute;
      top:calc(100% + 6px);
      right:0;
      left:auto;
      background:var(--card-bg-color);
      border:1px solid var(--border-color);
      padding:8px;
      border-radius:6px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      display:none;
      z-index:50;
      max-height:220px;
      overflow:auto;
      min-width:200px;
    }
    .custom-dropdown.open .custom-menu{display:block}
    #categoryMenu{right:auto;left:0}
    #sortPriceBtn{
      padding:8px 12px;
      font-size:14px;
      border:1px solid #ccc;
      background-color:#f8f9fa;
      border-radius:5px;
      cursor:pointer;
      min-height:38px;
    }
    #modeSelector{
      padding:6px 10px;
      border:1px solid #ccc;
      border-radius:5px;
      background:var(--card-bg-color);
      font-size:14px;
      min-height:36px;
    }
    #googleSignInContainer{display:none; margin-left: 8px;}
    #inventoryTotal{
      margin-left:10px;
      font-weight:bold;
      color:#dc3545;
      white-space:nowrap;
      display:none;
    }

    .table-wrapper{
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      max-height:calc(100vh - 140px);
      overflow-y:auto;
    }
    .product-table{
      width:100%;
      border-collapse:collapse;
      background-color:var(--card-bg-color);
    }
    .product-table th,
    .product-table td{
      border:1px solid var(--border-color);
      padding:10px;
      text-align:left;
      vertical-align:middle;
    }
    .product-table thead th{
      background-color:var(--primary-color);
      color:#fff;
      font-size:14px;
      text-align:center;
      position:sticky;
      top:0;
      z-index:30;
    }
    .product-table tr:nth-child(even){background-color:#f8f9fa}
    .quantity-control{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:0;
    }
    .quantity-btn{
      background-color:#e9ecef;
      border:1px solid #ced4da;
      color:#495057;
      cursor:pointer;
      font-size:1.3rem;
      font-weight:700;
      width:34px;
      height:34px;
      line-height:32px;
      text-align:center;
      border-radius:6px;
      touch-action:manipulation;
    }
    .quantity-input{
      width:55px;
      height:34px;
      padding:5px;
      text-align:center;
      border:1px solid #ced4da;
      background-color:#fff;
      font-size:15px;
      margin:0 3px;
      border-radius:6px;
    }
    .price-cell{font-weight:700;color:#2a9d8f}

    .right-panel{
      flex:1 1 280px;
      position:sticky;
      top:10px;
      display:flex;
      flex-direction:column;
      gap:15px;
      max-height:calc(100vh - 20px);
      overflow-y:auto;
    }

    .cart-container{
      background-color:#e9f5ff;
      padding:15px;
      border-radius:10px;
      border:1px solid #bde0fe;
      box-shadow:0 6px 16px rgba(13,110,253,0.08);
    }
    .cart-container h3{
      margin-top:0;
      display:flex;
      align-items:center;
      gap:6px;
      font-size:16px;
      border-bottom:1px solid rgba(0,0,0,.05);
      padding-bottom:6px;
    }
    #cartList{
      list-style:none;
      padding:0;
      margin:10px 0;
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:220px;
      overflow-y:auto;
    }
    .cart-item{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      background:#fff;
      border:1px solid rgba(0,0,0,.03);
      border-radius:6px;
      padding:6px 8px 6px 10px;
      font-size:13px;
      line-height:1.25;
    }
    .cart-item-title{flex:1;}
    .remove-item-btn{
      border:none;
      background:#f8d7da;
      color:#842029;
      border-radius:4px;
      padding:1px 6px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      touch-action:manipulation;
    }
    .remove-item-btn:hover{background:#f5c2c7;}
    #totalPrice{
      font-weight:700;
      font-size:15px;
      text-align:right;
      margin-top:4px;
      background:#fff;
      border-radius:6px;
      padding:5px 8px;
    }
    #whatsappBtn,#invoiceBtn{
      background-color:var(--secondary-color);
      color:#fff;
      width:100%;
      border:none;
      padding:11px 14px;
      font-size:15px;
      border-radius:8px;
      cursor:pointer;
      margin-top:8px;
      transition:opacity .2s ease;
      touch-action:manipulation;
    }
    #invoiceBtn{background-color:#0d6efd}
    .disabled-btn{
      opacity:.55;
      cursor:not-allowed;
    }

    .contact-info{
      padding:15px;
      background-color:var(--card-bg-color);
      border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,.05);
      font-size:14px;
      line-height:1.25;
      text-align:center;
    }
    .contact-info h3{margin:0;font-size:15px;}
    .contact-info p{margin:0;}
    .contact-info .small-gap{margin-top:4px;}
    .contact-info hr{
      border:none;
      border-top:1px solid #ddd;
      margin:10px 0 8px 0;
    }
    .contact-info a{color:#0d6efd;text-decoration:none;}
    .contact-info a:hover{text-decoration:underline;}

    .only-client{display:block;}
    .only-admin{display:none;}
    .only-admin-edit{display:none;}
    .only-admin-sale{display:none;}

    /* ====== RESPONSIVE ====== */
    @media (max-width:992px){
      .container{
        gap:10px;
      }
      .right-panel{
        position:static;
        max-height:none;
      }
    }

    @media (max-width:768px){
      body{padding:6px;}
      .container{flex-direction:column-reverse}
      .right-panel{position:static;max-height:none}
      .products-header{
        flex-direction:column;
        align-items:stretch;
      }
      .left-controls{
        width:100%;
      }
      .search-filters{
        width:100%;
        flex-direction:row;
        flex-wrap:wrap;
      }
      .dropdown-toggle-btn,
      #sortPriceBtn,
      #modeSelector{
        width:auto;
      }
      .table-wrapper{
        max-height:none;
        overflow:visible;
      }

      /* Tabla ‚Üí tarjetas */
      .product-table{
        border:0;
      }
      .product-table thead{
        display:none;
      }
      .product-table tr{
        display:block;
        background:#fff;
        margin-bottom:12px;
        border:1px solid #eee;
        border-radius:8px;
        overflow:hidden;
      }
      .product-table td{
        display:flex;
        justify-content:space-between;
        gap:12px;
        border:none;
        border-bottom:1px solid #f1f1f1;
        padding:8px 10px;
        font-size:14px;
      }
      .product-table td:last-child{
        border-bottom:none;
      }
      .product-table td::before{
        content:attr(data-label);
        font-weight:600;
        color:#555;
      }
      .quantity-control{
        justify-content:flex-end;
      }
      .quantity-btn{
        width:34px;
        height:34px;
      }
      .quantity-input{
        width:60px;
      }
      /* dropdowns ocupan todo el ancho para que sea f√°cil tocar */
      .custom-menu{
        width: min(300px, 96vw);
      }
    }

    @media (max-width:480px){
      .products-header{
        gap:6px;
      }
      #searchInput{
        width:100%;
        font-size:15px;
      }
      .dropdown-toggle-btn,
      #sortPriceBtn,
      #modeSelector{
        width:100%;
        justify-content:space-between;
      }
      .quantity-control{
        gap:4px;
      }
      .quantity-input{
        height:34px;
      }
      .cart-container{
        padding:12px;
      }
      #whatsappBtn,#invoiceBtn{
        font-size:14px;
      }
      .product-table td{
        padding:7px 9px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <!-- CONTROLES SUPERIORES -->
      <div class="controls-panel">
        <div class="products-header">
          <div class="left-controls">
            <div class="search-filters">
              <input type="text" id="searchInput" autocomplete="off" inputmode="search" placeholder="üîç Buscar por nombre, marca, categor√≠a...">
              <div class="custom-dropdown" id="categoryDropdown">
                <button type="button" id="categoryToggleBtn" class="dropdown-toggle-btn">Categor√≠as ‚ñæ</button>
                <div id="categoryMenu" class="custom-menu" aria-hidden="true"></div>
              </div>
              <div class="custom-dropdown" id="brandDropdown">
                <button type="button" id="brandToggleBtn" class="dropdown-toggle-btn">Marcas ‚ñæ</button>
                <div id="brandMenu" class="custom-menu" aria-hidden="true"></div>
              </div>
            </div>
          </div>
          <button id="sortPriceBtn" class="only-client">Ordenar por precio</button>

          <!-- selector de modos -->
          <select id="modeSelector" title="Seleccionar modo">
            <option value="client" selected>Cliente</option>
            <option value="admin_edit">Edici√≥n</option>
            <option value="admin_sale">Vendedor</option>
          </select>

          <span id="inventoryTotal">Total: $0</span>
          <div id="googleSignInContainer"></div>
        </div>
      </div>

      <!-- TABLA -->
      <div class="table-wrapper">
        <table class="product-table">
          <thead>
          <tr>
            <th>Nombre producto</th>
            <th>Categor√≠a</th>
            <th>Marca</th>
            <th>Valor unitario</th>
            <th id="qtyHeader">Cantidad</th>
            <th>Total a pagar</th>
          </tr>
          </thead>
          <tbody id="productTableBody">
          <tr id="loading-row"><td colspan="6" style="text-align:center;">Cargando productos...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- PANEL DERECHO -->
    <div class="right-panel">
      <div class="cart-container" id="cartContainer">
        <h3>üõí Carrito de Compras</h3>
        <ul id="cartList"><li class="cart-item"><span class="cart-item-title">El carrito est√° vac√≠o.</span></li></ul>
        <div id="totalPrice">Total: 0</div>
        <button id="whatsappBtn" class="only-client">Comprar por WhatsApp (cliente)</button>
        <button id="invoiceBtn" class="only-admin-sale" style="display:none;" disabled>Vender</button>
      </div>
      <div class="contact-info">
        <h3>‚ú® Contacto y Ubicaci√≥n ‚ú®</h3>
        <p class="small-gap">üì± <strong>WhatsApp y llamadas:</strong> <a href="https://wa.me/573042088961" target="_blank" rel="noopener" id="contactWhatsappLink">3042088961</a></p>
        <p class="small-gap">üìç <strong>Ubicaci√≥n:</strong> Estamos en Santa Marta. ¬°Hacemos env√≠os a toda Colombia y pagos contra entrega en Santa Marta!</p>
        <p class="small-gap">üó∫Ô∏è <strong>Vis√≠tanos (GPS):</strong> <a href="https://www.google.com/maps" target="_blank" rel="noopener">Ver en Google Maps</a></p>
        <hr>
        <h3>üåê ¬°S√≠guenos en Nuestras Redes! üåê</h3>
        <p class="small-gap">üëç <a href="#" target="_blank" rel="noopener">Facebook</a></p>
        <p class="small-gap">üì∏ <a href="#" target="_blank" rel="noopener">Instagram</a></p>
        <p class="small-gap">üéµ <a href="#" target="_blank" rel="noopener">TikTok</a></p>
      </div>
    </div>
  </div>
  <footer></footer>

 <script>
  // ===== CONFIG =====
  const googleSheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBTeqbaoB-5-b_h98cslcSic_6QcA1lCkCQagpF8q-yxcr1okC9TEuIYAZDgTL1DSCvdPtwBrApGj6/pub?gid=732037573&single=true&output=tsv';
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgRlyQfToDd8O7JOyRP0XXdryqpksSTu04zuhaZHYnun59S0ALXR_vnHZGfY5ch7SP/exec";
  const GOOGLE_CLIENT_ID = "575624026373-nm1ienpvaaa4its9070pv182quqf544m.apps.googleusercontent.com";
  const DEFAULT_WHATSAPP = "573042088961";
  const SELLER_NAME = "Irenis Stock Natura";
  const SELLER_PHONE = "3042088961";

  // correos autorizados
  const ALLOWED_ADMIN_EMAILS = [
    "irenismendoza@gmail.com",
    "marllerpar@gmail.com",
    "TU_CORREO_ADMIN_ACTUAL@GMAIL.COM"
  ];

  const MODE_CLIENT = "client";
  const MODE_ADMIN_EDIT = "admin_edit";
  const MODE_ADMIN_SALE = "admin_sale";

  // üîê clave para guardar la sesi√≥n
  const SESSION_KEY = "naturaAdminGoogleSession";

  let currentMode = MODE_CLIENT;

  let products = [];
  let allCategories = [];
  let allBrands = [];
  let googleUserToken = null;
  let currentAdminName = null;
  let currentAdminEmail = null;

  // DOM
  const categoryMenuContainer = document.getElementById('categoryMenu');
  const brandMenuContainer = document.getElementById('brandMenu');
  const searchInput = document.getElementById('searchInput');
  const productTableBody = document.getElementById('productTableBody');
  const cartList = document.getElementById('cartList');
  const totalPriceElement = document.getElementById('totalPrice');
  const whatsappBtn = document.getElementById('whatsappBtn');
  const contactWhatsappLink = document.getElementById('contactWhatsappLink');
  const sortPriceBtn = document.getElementById('sortPriceBtn');
  const googleSignInContainer = document.getElementById('googleSignInContainer');
  const inventoryTotalElement = document.getElementById('inventoryTotal');
  const invoiceBtn = document.getElementById('invoiceBtn');
  const qtyHeader = document.getElementById('qtyHeader');
  const modeSelector = document.getElementById('modeSelector');
  const cartContainer = document.getElementById('cartContainer');
  const categoryToggleBtn = document.getElementById('categoryToggleBtn');
  const brandToggleBtn = document.getElementById('brandToggleBtn');

  let cart = {};
  let currentSortOrder = 'default';
  const currencyFormatter = new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP", minimumFractionDigits: 0 });

  // ===== CARGA DE PRODUCTOS =====
  fetch(googleSheetURL)
    .then(r => r.ok ? r.text() : Promise.reject("Error de red"))
    .then(csvText => {
      const rows = csvText.trim().split('\n').slice(2);
      products = rows.map((row, idx) => {
        const cols = row.split('\t');
        if (cols.length < 6) return null;
        const priceStr = (cols[3] || '0').replace(/[^\d]/g, '');
        const stockStr = (cols[4] || '0').replace(/[^\d]/g, '');
        const id = cols[5] ? cols[5].trim() : null;
        const name = cols[0] ? cols[0].trim() : null;
        if (!id || !name) return null;
        return {
          id: id,
          name: name,
          category: cols[1] ? cols[1].trim() : '',
          marca: cols[2] ? toTitleCase(cols[2].trim()) : '',
          valor_unitario: parseInt(priceStr, 10) || 0,
          stock: parseInt(stockStr, 10) || 0
        };
      }).filter(Boolean);
      initializeApp();
    })
    .catch(err => {
      console.error(err);
      productTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">Error al cargar productos.</td></tr>`;
    });

  // ===== Google Sign-In =====
  window.onload = function () {
    if (typeof google === 'undefined') return;
    try {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleSignIn
      });
      google.accounts.id.renderButton(
        googleSignInContainer,
        { theme: "outline", size: "medium", text: "signin_with", shape: "rectangular" }
      );
    } catch (e) { console.warn(e); }
  };

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  // üü¢ restaurar sesi√≥n guardada
  function restoreAdminSession() {
    try {
      const raw = localStorage.getItem(SESSION_KEY);
      if (!raw) return;
      const saved = JSON.parse(raw);
      if (!saved || !saved.token || !saved.email) return;
      googleUserToken = saved.token;
      currentAdminName = saved.name || "Admin";
      currentAdminEmail = saved.email;
      currentMode = saved.mode || MODE_ADMIN_EDIT;
      googleSignInContainer.style.display = "none";
    } catch (e) {
      console.warn("No se pudo restaurar la sesi√≥n:", e);
    }
  }

  function handleGoogleSignIn(resp) {
    if (!resp.credential) {
      alert("Error de login");
      return;
    }
    const payload = parseJwt(resp.credential);
    const email = payload && payload.email ? payload.email : null;
    const name = payload && (payload.given_name || payload.name) ? (payload.given_name || payload.name) : "Admin";

    if (email && !ALLOWED_ADMIN_EMAILS.includes(email)) {
      alert("Este correo no est√° autorizado como administrador.\nCorreo: " + email);
      currentMode = MODE_CLIENT;
      modeSelector.value = MODE_CLIENT;
      applyUIMode();
      filterAndDisplayProducts();
      return;
    }

    googleUserToken = resp.credential;
    currentAdminName = name;
    currentAdminEmail = email;

    localStorage.setItem(SESSION_KEY, JSON.stringify({
      token: googleUserToken,
      name: currentAdminName,
      email: currentAdminEmail,
      mode: modeSelector.value === MODE_ADMIN_SALE ? MODE_ADMIN_SALE : MODE_ADMIN_EDIT
    }));

    if (modeSelector.value === MODE_ADMIN_SALE) {
      enterAdminMode(name, email, MODE_ADMIN_SALE);
    } else {
      enterAdminMode(name, email, MODE_ADMIN_EDIT);
    }
  }

  function enterAdminMode(name, email, modeWanted) {
    currentMode = modeWanted || MODE_ADMIN_EDIT;
    googleSignInContainer.style.display = "none";
    modeSelector.value = currentMode;
    applyUIMode();
    filterAndDisplayProducts();
    updateInventoryTotalDisplay();

    try {
      const saved = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      if (saved) {
        saved.mode = currentMode;
        localStorage.setItem(SESSION_KEY, JSON.stringify(saved));
      }
    } catch (e) {}
  }

  function exitAdminMode() {
    currentMode = MODE_CLIENT;
    googleUserToken = null;
    currentAdminName = null;
    currentAdminEmail = null;
    googleSignInContainer.style.display = "none";
    modeSelector.value = MODE_CLIENT;
    applyUIMode();
    filterAndDisplayProducts();
    updateInventoryTotalDisplay();
  }

  // selector de modo
  modeSelector.addEventListener("change", () => {
    const selected = modeSelector.value;
    if (selected === MODE_CLIENT) {
      exitAdminMode();
      return;
    }
    if (!googleUserToken) {
      alert("Inicia sesi√≥n con un correo autorizado para usar ese modo.");
      googleSignInContainer.style.display = "block";
      modeSelector.value = MODE_CLIENT;
      currentMode = MODE_CLIENT;
      applyUIMode();
      filterAndDisplayProducts();
      return;
    }
    currentMode = selected;
    modeSelector.value = currentMode;
    applyUIMode();
    filterAndDisplayProducts();

    try {
      const saved = JSON.parse(localStorage.getItem(SESSION_KEY) || "null");
      if (saved) {
        saved.mode = currentMode;
        localStorage.setItem(SESSION_KEY, JSON.stringify(saved));
      }
    } catch (e) {}
  });

  // ===== MODO ‚Üí UI =====
  function applyUIMode() {
    document.querySelectorAll('.only-client').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.only-admin-edit').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.only-admin-sale').forEach(el => el.style.display = 'none');

    if (currentMode === MODE_CLIENT) {
      document.querySelectorAll('.only-client').forEach(el => el.style.display = 'block');
      sortPriceBtn.style.display = "inline-block";
      inventoryTotalElement.style.display = "none";
      if (cartContainer) cartContainer.style.display = "block";
      if (invoiceBtn) invoiceBtn.disabled = true;
    } else if (currentMode === MODE_ADMIN_EDIT) {
      document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'inline-block');
      document.querySelectorAll('.only-admin-edit').forEach(el => el.style.display = 'inline-block');
      sortPriceBtn.style.display = "none";
      if (cartContainer) cartContainer.style.display = "none";
      inventoryTotalElement.style.display = "inline-block";
      if (invoiceBtn) invoiceBtn.disabled = true;
    } else if (currentMode === MODE_ADMIN_SALE) {
      document.querySelectorAll('.only-admin').forEach(el => el.style.display = 'inline-block');
      document.querySelectorAll('.only-admin-sale').forEach(el => el.style.display = 'inline-block');
      sortPriceBtn.style.display = "none";
      if (cartContainer) cartContainer.style.display = "block";
      inventoryTotalElement.style.display = "inline-block";
      if (invoiceBtn) invoiceBtn.disabled = false;
    }
    setQtyHeader();
  }

  function setQtyHeader() {
    if (!qtyHeader) return;
    if (currentMode === MODE_ADMIN_EDIT) {
      qtyHeader.textContent = "Stock";
    } else {
      qtyHeader.textContent = "Cantidad";
    }
  }

  // ===== helpers =====
  function toTitleCase(str) { return str ? str.charAt(0).toUpperCase() + str.slice(1).toLowerCase() : ""; }
  function calculateInventoryTotal() {
    return products.reduce((acc, p) => acc + ((p.valor_unitario || 0) * (p.stock || 0)), 0);
  }
  function updateInventoryTotalDisplay() {
    if (currentMode === MODE_ADMIN_EDIT || currentMode === MODE_ADMIN_SALE) {
      inventoryTotalElement.style.display = "inline-block";
      inventoryTotalElement.textContent = `Total: ${currencyFormatter.format(calculateInventoryTotal())}`;
    } else {
      inventoryTotalElement.style.display = "none";
    }
  }
  function formatDateDDMMYYYY(d) {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  // ===== init =====
  function initializeApp() {
    restoreAdminSession();
    products.sort((a, b) => a.name.localeCompare(b.name));
    const savedCart = localStorage.getItem("shoppingCart");
    try {
      const parsed = JSON.parse(savedCart);
      if (parsed && Object.values(parsed)[0]?.id) {
        cart = parsed;
      }
    } catch (e) { cart = {}; }
    refreshFilters();
    applyUIMode();
    filterAndDisplayProducts();
    updateCart();
    updateInventoryTotalDisplay();
  }

  function normalizeText(t) { return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }

  // ===== filters =====
  function refreshFilters() {
    allCategories = [...new Set(products.map(p => p.category))].sort();
    allBrands = [...new Set(products.map(p => p.marca))].sort();

    const cat = ["Todas", ...allCategories];
    categoryMenuContainer.innerHTML = cat.map(c => `
        <label style="display:block; margin-bottom:4px;">
          <input type="radio" name="category" value="${c}" ${c === "Todas" ? "checked" : ""}>
          ${c}
        </label>
      `).join("");

    const br = ["Todas", ...allBrands];
    brandMenuContainer.innerHTML = br.map(b => `
        <label style="display:block; margin-bottom:4px;">
          <input type="radio" name="brand" value="${b}" ${b === "Todas" ? "checked" : ""}>
          ${b}
        </label>
      `).join("");

    categoryMenuContainer.addEventListener("change", () => {
      filterAndDisplayProducts();
      updateCategoryButtonLabel();
      closeDropdowns();
    });
    brandMenuContainer.addEventListener("change", () => {
      filterAndDisplayProducts();
      updateBrandButtonLabel();
      closeDropdowns();
    });

    updateCategoryButtonLabel();
    updateBrandButtonLabel();
  }

  function updateCategoryButtonLabel() {
    const sel = categoryMenuContainer.querySelector('input[name="category"]:checked');
    const val = sel ? sel.value : "Todas";
    categoryToggleBtn.textContent = (val === "Todas") ? "Categor√≠as ‚ñæ" : `${val} ‚ñæ`;
  }

  function updateBrandButtonLabel() {
    const sel = brandMenuContainer.querySelector('input[name="brand"]:checked');
    const val = sel ? sel.value : "Todas";
    brandToggleBtn.textContent = (val === "Todas") ? "Marcas ‚ñæ" : `${val} ‚ñæ`;
  }

  function closeDropdowns() {
    document.querySelectorAll('.custom-dropdown.open').forEach(d => {
      d.classList.remove('open');
      d.querySelector('.custom-menu').setAttribute('aria-hidden', 'true');
    });
  }

  document.addEventListener('click', (e) => {
    const t = e.target;
    if (t.classList.contains('dropdown-toggle-btn')) {
      e.stopPropagation();
      const dd = t.closest('.custom-dropdown');
      const was = dd.classList.contains('open');
      closeDropdowns();
      dd.classList.toggle('open', !was);
      dd.querySelector('.custom-menu').setAttribute('aria-hidden', was ? 'true' : 'false');
    } else if (!t.closest('.custom-dropdown')) {
      closeDropdowns();
    }
  });

  // ===== filter & display =====
  function filterAndDisplayProducts() {
    let list = [...products];

    const catSel = document.querySelector("#categoryMenu input[name='category']:checked");
    const catVal = catSel ? catSel.value : "Todas";
    if (catVal !== "Todas") {
      list = list.filter(p => p.category === catVal);
    }

    const brandSel = document.querySelector("#brandMenu input[name='brand']:checked");
    const brandVal = brandSel ? brandSel.value : "Todas";
    if (brandVal !== "Todas") {
      list = list.filter(p => p.marca === brandVal);
    }

    const searchTerms = normalizeText(searchInput.value).split(/\s+/).filter(Boolean);
    if (searchTerms.length > 0) {
      list = list.filter(p => {
        const s = normalizeText(`${p.id} ${p.name} ${p.category} ${p.marca}`);
        return searchTerms.every(t => s.includes(t));
      });
    }
    if (currentSortOrder === "asc") list.sort((a, b) => a.valor_unitario - b.valor_unitario);
    else if (currentSortOrder === "desc") list.sort((a, b) => b.valor_unitario - a.valor_unitario);
    displayProducts(list);
    updateInventoryTotalDisplay();
  }

  // ===== display =====
  function displayProducts(list) {
    if (list.length === 0) {
      productTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay productos.</td></tr>';
      return;
    }
    const rows = list.map(p => {
      const qtyInCart = cart[p.id] ? cart[p.id].quantity : 0;
      const isEditing = (currentMode === MODE_ADMIN_EDIT);
      const valueToShow = isEditing ? p.stock : qtyInCart;
      const dataLabel = isEditing ? "Stock" : "Cantidad";
      let subtotal;
      if (isEditing) {
        subtotal = (p.stock || 0) * (p.valor_unitario || 0);
      } else {
        subtotal = qtyInCart * p.valor_unitario;
      }
      const readOnlyAttr = (!isEditing && currentMode !== MODE_ADMIN_SALE) ? 'readonly' : '';

      let nameCell, catCell, brandCell, priceCell;
      if (isEditing) {
        nameCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="name"
                        style="width:100%;box-sizing:border-box;max-width:420px;"
                        value="${escapeHtml(p.name)}">`;
        catCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="category"
                        style="width:120px;box-sizing:border-box;"
                        value="${escapeHtml(p.category)}">`;
        brandCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="marca"
                        style="width:110px;box-sizing:border-box;"
                        value="${escapeHtml(p.marca)}">`;
        priceCell = `<input type="text" class="admin-input" data-id="${p.id}" data-field="valor_unitario"
                        style="width:105px;box-sizing:border-box;text-align:right;"
                        value="${p.valor_unitario}" placeholder="0">`;
      } else {
        nameCell = `<span>${escapeHtml(p.name)}</span>`;
        catCell = escapeHtml(p.category);
        brandCell = escapeHtml(p.marca);
        priceCell = currencyFormatter.format(p.valor_unitario);
      }

      return `
          <tr>
            <td style="min-width:210px;" data-label="Nombre">${nameCell}</td>
            <td style="width:125px;" data-label="Categor√≠a">${catCell}</td>
            <td style="width:110px;" data-label="Marca">${brandCell}</td>
            <td class="price-cell" style="width:110px;" data-label="Valor unitario">${priceCell}</td>
            <td data-label="${dataLabel}">
              <div class="quantity-control">
                <button type="button" class="quantity-btn decrease-btn" aria-label="Disminuir cantidad">-</button>
                <input type="number" class="quantity-input" min="0" value="${valueToShow}"
                  data-price="${p.valor_unitario}"
                  data-id="${p.id}"
                  data-name="${escapeHtml(p.name)}"
                  ${readOnlyAttr}>
                <button type="button" class="quantity-btn increase-btn" aria-label="Aumentar cantidad">+</button>
              </div>
            </td>
            <td class="price-cell total-pay" data-label="Total">${currencyFormatter.format(subtotal)}</td>
          </tr>
        `;
    }).join("");
    productTableBody.innerHTML = rows;
  }

  // ===== carrito =====
  function updateCart() {
    let total = 0;
    const items = Object.values(cart);
    if (items.length === 0) {
      cartList.innerHTML = "<li class=\"cart-item\"><span class=\"cart-item-title\">El carrito est√° vac√≠o.</span></li>";
    } else {
      cartList.innerHTML = items.map(it => {
        const sub = it.quantity * it.price;
        total += sub;
        return `<li class="cart-item"><span class="cart-item-title">${it.quantity} x ${escapeHtml(it.name)} <strong>(${currencyFormatter.format(sub)})</strong></span><button class="remove-item-btn" data-id="${it.id}">X</button></li>`;
      }).join("");
    }
    totalPriceElement.textContent = `Total: ${currencyFormatter.format(total)}`;
    localStorage.setItem("shoppingCart", JSON.stringify(cart));
  }

  function escapeHtml(t) {
    if (t == null) return '';
    return String(t).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
  }

  // ===== eventos de tabla =====
  productTableBody.addEventListener("input", (e) => {
    if (currentMode === MODE_ADMIN_EDIT) return;
    if (!e.target.classList.contains("quantity-input")) return;
    const input = e.target;
    let qty = parseInt(input.value, 10) || 0;
    if (qty < 0) qty = 0;
    input.value = qty;
    const id = input.dataset.id;
    const name = input.dataset.name;
    const price = parseInt(input.dataset.price, 10) || 0;
    const tr = input.closest("tr");
    if (tr) tr.querySelector(".total-pay").textContent = currencyFormatter.format(qty * price);
    if (qty > 0) {
      cart[id] = { id, name, quantity: qty, price };
    } else {
      delete cart[id];
    }
    updateCart();
  });

  productTableBody.addEventListener("click", (e) => {
    const t = e.target;
    if (!t.classList.contains("quantity-btn")) return;
    const ctrl = t.closest(".quantity-control");
    const input = ctrl.querySelector(".quantity-input");
    let val = parseInt(input.value, 10) || 0;
    if (t.classList.contains("increase-btn")) val++;
    else val--;
    if (val < 0) val = 0;
    input.value = val;
    if (currentMode === MODE_ADMIN_EDIT) {
      const id = input.dataset.id;
      updateStockInGoogleSheet(id, val, input);
    } else {
      input.dispatchEvent(new Event("input", { bubbles: true }));
    }
  });

  productTableBody.addEventListener("change", (e) => {
    if (currentMode !== MODE_ADMIN_EDIT) return;
    if (!e.target.classList.contains("admin-input")) return;
    const input = e.target;
    const id = input.dataset.id;
    const field = input.dataset.field;
    const value = input.value;
    const product = products.find(p => p.id === id);
    if (!product) return;
    if (String(product[field]) === String(value)) return;
    updateProductFieldInGoogleSheet(id, field, value, input);
  });

  // ===== actualizar en sheets =====
  async function updateStockInGoogleSheet(id, newStock, input) {
    if (!googleUserToken) {
      alert("No est√°s autenticado. Vuelve a iniciar sesi√≥n (pero tu sesi√≥n guardada sigue ah√≠).");
      googleSignInContainer.style.display = "block";
      return;
    }
    const p = products.find(p => p.id === id);
    const original = p ? p.stock : 0;
    if (input) input.disabled = true;
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "updateStock",
          token: googleUserToken,
          productId: id,
          newStock: newStock,
          adminEmail: currentAdminEmail
        })
      });
      const json = await resp.json();
      if (json.status === "success") {
        if (p) p.stock = newStock;
        filterAndDisplayProducts();
        updateInventoryTotalDisplay();
      } else {
        throw new Error(json.message || "Error guardando");
      }
    } catch (err) {
      alert("Error al guardar stock: " + err.message);
      if (input) input.value = original;
    } finally {
      if (input) input.disabled = false;
    }
  }

  async function updateProductFieldInGoogleSheet(id, field, value, input) {
    if (!googleUserToken) {
      alert("No est√°s autenticado. Vuelve a iniciar sesi√≥n (pero tu sesi√≥n guardada sigue ah√≠).");
      googleSignInContainer.style.display = "block";
      return;
    }
    const p = products.find(p => p.id === id);
    const original = p ? p[field] : "";
    let newValue = value;
    if (field === "valor_unitario") {
      newValue = (value || "").replace(/[^\d]/g, "");
      newValue = parseInt(newValue, 10) || 0;
    }
    input.disabled = true;
    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({
          action: "updateField",
          token: googleUserToken,
          productId: id,
          fieldToUpdate: field,
          newValue: newValue,
          adminEmail: currentAdminEmail
        })
      });
      const json = await resp.json();
      if (json.status === "success") {
        p[field] = newValue;
        filterAndDisplayProducts();
        updateInventoryTotalDisplay();
      } else {
        throw new Error(json.message || "Error guardando");
      }
    } catch (err) {
      alert("Error al guardar: " + err.message);
      input.value = original;
    } finally {
      input.disabled = false;
    }
  }

  // ===== WhatsApp & botones =====
  searchInput.addEventListener("input", filterAndDisplayProducts);
  sortPriceBtn.addEventListener("click", () => {
    if (currentSortOrder === "default" || currentSortOrder === "desc") {
      currentSortOrder = "asc"; sortPriceBtn.textContent = "Precio $‚Üì";
    } else {
      currentSortOrder = "desc"; sortPriceBtn.textContent = "Precio $‚Üë";
    }
    filterAndDisplayProducts();
  });

  function openWhatsApp(msg) {
    const encoded = encodeURIComponent(msg);
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const url = isMobile ? `https://api.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`
      : `https://web.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`;
    window.open(url, "_blank");
  }

  whatsappBtn.addEventListener("click", () => {
    if (currentMode !== MODE_CLIENT) return;
    const items = Object.values(cart);
    if (items.length === 0) return;
    const msg = buildWhatsAppMsg(items);
    openWhatsApp(msg);
  });

  function buildWhatsAppMsg(items, extraHeader = "Hola, deseo comprar estos productos en Irenismb Natura Stock:") {
    let msg = extraHeader + "\n\n";
    let total = 0;
    items.forEach(it => {
      const sub = it.quantity * it.price;
      msg += `‚Ä¢ ${it.quantity} x ${it.name} = ${currencyFormatter.format(sub)}\n`;
      total += sub;
    });
    msg += `\nTotal: ${currencyFormatter.format(total)}\n`;
    msg += `\nVendedor: ${SELLER_NAME}\nWhatsApp: ${SELLER_PHONE}\n`;
    return msg;
  }

  contactWhatsappLink.addEventListener("click", (e) => {
    e.preventDefault();
    openWhatsApp("Hola, me interesan los productos de Irenismb Natura Stock.");
  });

  cartList.addEventListener("click", (e) => {
    if (!e.target.classList.contains("remove-item-btn")) return;
    const id = e.target.dataset.id;
    delete cart[id];
    const input = productTableBody.querySelector(`.quantity-input[data-id="${id}"]`);
    if (input) {
      input.value = 0;
      input.dispatchEvent(new Event("input", { bubbles: true }));
    } else {
      updateCart();
    }
  });

  // ===== VENDER (admin venta) =====
  invoiceBtn.addEventListener("click", () => {
    if (currentMode !== MODE_ADMIN_SALE) return;
    if (!googleUserToken) {
      alert("Inicia sesi√≥n con Google primero.");
      googleSignInContainer.style.display = "block";
      return;
    }
    startSellFlow();
  });

  function openInvoiceWindow(html) {
    const w = window.open("", "_blank");
    w.document.write(html);
    w.document.close();
  }

  function startSellFlow() {
    const items = Object.values(cart);
    if (items.length === 0) {
      alert("No hay productos en el carrito.");
      return;
    }

    const action = prompt(
      "Seleccione la acci√≥n:\n1. Generar factura (predeterminado)\n2. Enviar por WhatsApp",
      "1"
    );
    const actionNum = (action || "1").trim();

    const cliente = prompt("Nombre del cliente:", "Cliente contado");
    if (cliente === null) return;
    const hoy = new Date();
    const fechaDef = formatDateDDMMYYYY(hoy);
    let fecha = prompt("Fecha de venta (dd/mm/aaaa):", fechaDef) || fechaDef;
    let abonadoStr = prompt("Valor abonado / pagado:", "0") || "0";
    let plazoStr = prompt("Plazo en d√≠as (30 por defecto):", "30") || "30";

    const abonado = parseInt(abonadoStr.replace(/[^\d]/g, ""), 10) || 0;
    let plazo = parseInt(plazoStr, 10);
    if (isNaN(plazo) || plazo < 0) plazo = 30;

    let total = 0;
    items.forEach(it => total += it.quantity * it.price);
    let saldo = total - abonado;
    if (saldo < 0) saldo = 0;

    let vence = "";
    if (saldo > 0) {
      const p = fecha.split("/");
      let d = new Date();
      if (p.length === 3) {
        d = new Date(parseInt(p[2], 10), parseInt(p[1], 10) - 1, parseInt(p[0], 10));
      }
      d.setDate(d.getDate() + plazo);
      vence = formatDateDDMMYYYY(d);
    }

    if (actionNum === "1" || actionNum === "") {
      const html = `
          <html><head><title>Factura - Irenismb Natura Stock</title></head><body>
          <h2>Irenismb Natura Stock</h2>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Fecha:</strong> ${fecha}</p>
          <p><strong>Vendedor:</strong> ${SELLER_NAME} - ${SELLER_PHONE}</p>
          <table border="1" cellspacing="0" cellpadding="5">
            <tr><th>Producto</th><th>Cant</th><th>V.Unit</th><th>Subtotal</th></tr>
            ${items.map(it => `<tr><td>${it.name}</td><td>${it.quantity}</td><td>${currencyFormatter.format(it.price)}</td><td>${currencyFormatter.format(it.quantity * it.price)}</td></tr>`).join("")}
            <tr><td colspan="3"><strong>Total</strong></td><td>${currencyFormatter.format(total)}</td></tr>
            <tr><td colspan="3"><strong>Abonado/Pagado</strong></td><td>${currencyFormatter.format(abonado)}</td></tr>
            <tr><td colspan="3"><strong>Saldo</strong></td><td>${currencyFormatter.format(saldo)}</td></tr>
            ${saldo > 0 ? `<tr><td colspan="3"><strong>Vence</strong></td><td>${vence}</td></tr>` : ""}
          </table>
          <p>Gracias por su compra.</p>
          </body></html>
        `;
      openInvoiceWindow(html);
    } else if (actionNum === "2") {
      let msg = `Venta para ${cliente}\nFecha: ${fecha}\n\n`;
      items.forEach(it => {
        const sub = it.quantity * it.price;
        msg += `‚Ä¢ ${it.quantity} x ${it.name} = ${currencyFormatter.format(sub)}\n`;
      });
      msg += `\nTotal: ${currencyFormatter.format(total)}\n`;
      msg += `Abonado/Pagado: ${currencyFormatter.format(abonado)}\n`;
      msg += `Saldo: ${currencyFormatter.format(saldo)}\n`;
      if (saldo > 0) msg += `Vence: ${vence}\n`;
      msg += `\nVendedor: ${SELLER_NAME} - ${SELLER_PHONE}`;
      const encoded = encodeURIComponent(msg);
      const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      const url = isMobile ? `https://api.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`
        : `https://web.whatsapp.com/send?phone=${DEFAULT_WHATSAPP}&text=${encoded}`;
      window.open(url, "_blank");
    } else {
      const html = `
          <html><head><title>Factura - Irenismb Natura Stock</title></head><body>
          <h2>Irenismb Natura Stock</h2>
          <p><strong>Cliente:</strong> ${cliente}</p>
          <p><strong>Fecha:</strong> ${fecha}</p>
          <p><strong>Vendedor:</strong> ${SELLER_NAME} - ${SELLER_PHONE}</p>
          <table border="1" cellspacing="0" cellpadding="5">
            <tr><th>Producto</th><th>Cant</th><th>V.Unit</th><th>Subtotal</th></tr>
            ${items.map(it => `<tr><td>${it.name}</td><td>${it.quantity}</td><td>${currencyFormatter.format(it.price)}</td><td>${currencyFormatter.format(it.quantity * it.price)}</td></tr>`).join("")}
            <tr><td colspan="3"><strong>Total</strong></td><td>${currencyFormatter.format(total)}</td></tr>
            <tr><td colspan="3"><strong>Abonado/Pagado</strong></td><td>${currencyFormatter.format(abonado)}</td></tr>
            <tr><td colspan="3"><strong>Saldo</strong></td><td>${currencyFormatter.format(saldo)}</td></tr>
            ${saldo > 0 ? `<tr><td colspan="3"><strong>Vence</strong></td><td>${vence}</td></tr>` : ""}
          </table>
          <p>Gracias por su compra.</p>
          </body></html>
        `;
      openInvoiceWindow(html);
    }

    items.forEach(it => {
      const prod = products.find(p => p.id === it.id);
      if (prod) {
        const newStock = Math.max((prod.stock || 0) - it.quantity, 0);
        updateStockInGoogleSheet(prod.id, newStock, null);
      }
    });

    cart = {};
    localStorage.removeItem("shoppingCart");
    productTableBody.querySelectorAll(".quantity-input").forEach(input => {
      if (currentMode !== MODE_ADMIN_EDIT) {
        input.value = 0;
      }
    });
    updateCart();
  }
</script>
</body>
</html>
