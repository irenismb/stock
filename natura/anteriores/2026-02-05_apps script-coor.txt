const SPREADSHEET_ID = "1vxxTu4HWcgDm2HcCwPykMXyepVAFQcFsQkHUS6ed81g";
const SHEET_NAME = ""; // vacío = primera hoja
const REQUIRED_HEADERS = ["coordenadas", "fecha", "hora", "minutos"];
const TZ = "America/Bogota";

function doGet(e)  { return handleRequest_(e); }
function doPost(e) { return handleRequest_(e); }

// Ejecuta esta función 1 vez desde el editor para autorizar permisos:
function authTest(){
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sh = SHEET_NAME ? ss.getSheetByName(SHEET_NAME) : ss.getSheets()[0];
  if (!sh) return;
  sh.getRange(1,1).getValue();
}

function handleRequest_(e){
  let lock = null;

  try{
    const p = parseParams_(e);
    const lat = toNum_(p.lat);
    const lng = toNum_(p.lng);

    // Sin coords válidas -> ok silencioso
    if (!isFinite(lat) || !isFinite(lng)) return ok_();

    lock = LockService.getScriptLock();
    // Si hay mucha concurrencia, mejor salir silencioso
    if (!lock.tryLock(2000)) return ok_();

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sh = SHEET_NAME ? ss.getSheetByName(SHEET_NAME) : ss.getSheets()[0];
    if (!sh) return ok_();

    // Asegurar encabezados y mapear columnas
    const headerIndex = ensureHeaders_(sh, REQUIRED_HEADERS);

    const now = new Date();
    const dateStr   = Utilities.formatDate(now, TZ, "yyyy-MM-dd");
    const timeStr   = Utilities.formatDate(now, TZ, "HH:mm");
    const minuteStr = Utilities.formatDate(now, TZ, "mm");

    const coordText = `${lat.toFixed(6)},${lng.toFixed(6)}`;
    const mapsUrl   = `https://www.google.com/maps?q=${encodeURIComponent(coordText)}`;

    const lastCol = sh.getLastColumn();
    const row = new Array(lastCol).fill("");

    if (headerIndex.fecha != null)   row[headerIndex.fecha]   = dateStr;
    if (headerIndex.hora != null)    row[headerIndex.hora]    = timeStr;
    if (headerIndex.minutos != null) row[headerIndex.minutos] = minuteStr;

    const nextRow = Math.max(2, sh.getLastRow() + 1);
    sh.getRange(nextRow, 1, 1, lastCol).setValues([row]);

    // Coordenadas como hipervínculo REAL (no fórmula)
    if (headerIndex.coordenadas != null){
      const cell = sh.getRange(nextRow, headerIndex.coordenadas + 1);
      const rich = SpreadsheetApp.newRichTextValue()
        .setText(coordText)
        .setLinkUrl(mapsUrl)
        .build();
      cell.setRichTextValue(rich);
    }

  }catch(err){
    // Silencio total
  }finally{
    try{
      if (lock) lock.releaseLock();
    }catch(_){}
  }

  return ok_();
}

function ok_(){
  return ContentService
    .createTextOutput("ok")
    .setMimeType(ContentService.MimeType.TEXT);
}

function parseParams_(e){
  const out = Object.assign({}, (e && e.parameter) || {});
  try{
    const raw = e && e.postData && e.postData.contents;
    if (!raw) return out;

    const ct = String(e.postData.type || "").toLowerCase();
    if (ct.includes("application/json")){
      const j = JSON.parse(raw);
      if (j && typeof j === "object"){
        Object.keys(j).forEach(k => out[k] = String(j[k]));
      }
      return out;
    }

    raw.split("&").forEach(part => {
      if(!part) return;
      const kv = part.split("=");
      const k = kv[0];
      const v = kv.slice(1).join("=");
      if(!k) return;
      out[decodeURIComponent(k)] = decodeURIComponent(v || "");
    });
  }catch(_){}
  return out;
}

function toNum_(x){ return Number(x); }

function norm_(s){
  return String(s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim()
    .replace(/\s+/g, " ");
}

function ensureHeaders_(sh, required){
  const lastCol = Math.max(1, sh.getLastColumn());
  const headerRow = sh.getRange(1, 1, 1, lastCol).getValues()[0];

  const idx = {};
  headerRow.forEach((h, i) => idx[norm_(h)] = i);

  let changed = false;
  const extended = headerRow.slice();

  required.forEach(h => {
    const key = norm_(h);
    if (idx[key] == null){
      extended.push(h);
      idx[key] = extended.length - 1;
      changed = true;
    }
  });

  if (changed){
    sh.getRange(1, 1, 1, extended.length).setValues([extended]);
  }

  return {
    coordenadas: idx[norm_("coordenadas")],
    fecha:       idx[norm_("fecha")],
    hora:        idx[norm_("hora")],
    minutos:     idx[norm_("minutos")]
  };
}
