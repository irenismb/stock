/**
 * ============================================
 * CONFIGURACIÓN
 * ============================================
 */
const SPREADSHEET_ID = "1B0p9D64kMN-oLLW3gD77iaWtLqlVBOgC-J2GyUgrhJ0";

const CATALOG_SHEET_NAME = "catalogo";
const VISITS_SHEET_NAME  = "visitas";

// URLs para redes sociales que usará el HTML (ajusta a tus enlaces reales)
const SOCIAL_WHATSAPP_URL = "https://wa.me/573146084776"; // Cambia si usas otro número
const SOCIAL_INSTAGRAM_URL = ""; // Ejemplo: "https://www.instagram.com/tu_cuenta"
const SOCIAL_FACEBOOK_URL  = ""; // Ejemplo: "https://www.facebook.com/tu_pagina"

const START_ROW  = 3; // primera fila con datos reales
const HEADER_ROW = 2; // fila donde están los títulos de columnas

function getBook_() {
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}

/**
 * Normaliza encabezados para compararlos (minúsculas y recorte)
 */
function normalizeHeader_(s) {
  return String(s || "")
    .trim()
    .toLowerCase();
}

/**
 * Busca índice (0-based) de una lista de posibles nombres de columna.
 */
function findHeaderIndex_(headers, names) {
  if (!Array.isArray(names)) {
    names = [names];
  }
  const normHeaders = headers.map(normalizeHeader_);
  for (var i = 0; i < names.length; i++) {
    var target = normalizeHeader_(names[i]);
    var idx = normHeaders.indexOf(target);
    if (idx !== -1) return idx;
  }
  return -1;
}

/**
 * Obtiene configuración de columnas de la hoja "catalogo"
 * usando los nombres: Id, Descripcion, Orden, etc.
 */
function getCatalogColumnConfig_(sheet) {
  const lastCol = sheet.getLastColumn();
  const headers = sheet.getRange(HEADER_ROW, 1, 1, lastCol).getValues()[0];

  // Admitimos varias formas de escribir los encabezados
  const idIdx    = findHeaderIndex_(headers, ["Id", "ID", "Codigo", "Código", "Cód.", "Cod", "cod", "codigo"]);
  const descIdx  = findHeaderIndex_(headers, [
    "Descripcion",
    "Descripción",
    "Descripcion producto",
    "Descripción producto",
    "Detalle",
    "Detalle producto"
  ]);
  const ordenIdx = findHeaderIndex_(headers, ["Orden", "Orden catalogo", "Orden catálogo", "Ordenamiento"]);

  if (idIdx === -1)   throw new Error('No se encontró la columna "Id/Código" en la hoja "' + CATALOG_SHEET_NAME + '".');
  if (descIdx === -1) throw new Error('No se encontró la columna "Descripcion/Descripción" en la hoja "' + CATALOG_SHEET_NAME + '".');
  if (ordenIdx === -1)throw new Error('No se encontró la columna "Orden" en la hoja "' + CATALOG_SHEET_NAME + '".');

  // Estas otras columnas se intentan localizar por nombre,
  // y si no, se asume la posición clásica:
  // A: Nombre, B: Categoría, C: Marca, D: Valor unitario, E: Stock
  const nameIdx = (function(){
    const ix = findHeaderIndex_(headers, ["Nombre", "Nombre producto", "Producto"]);
    return ix !== -1 ? ix : 0;
  })();
  const categoryIdx = (function(){
    const ix = findHeaderIndex_(headers, ["Categoria", "Categoría"]);
    return ix !== -1 ? ix : 1;
  })();
  const marcaIdx = (function(){
    const ix = findHeaderIndex_(headers, "Marca");
    return ix !== -1 ? ix : 2;
  })();
  const priceIdx = (function(){
    const ix = findHeaderIndex_(headers, ["Valor unitario", "Precio"]);
    return ix !== -1 ? ix : 3;
  })();
  const stockIdx = (function(){
    const ix = findHeaderIndex_(headers, ["Stock", "Existencia"]);
    return ix !== -1 ? ix : 4;
  })();

  return {
    lastCol:     lastCol,
    nameIdx:     nameIdx,
    categoryIdx: categoryIdx,
    marcaIdx:    marcaIdx,
    priceIdx:    priceIdx,
    stockIdx:    stockIdx,
    idIdx:       idIdx,
    descIdx:     descIdx,
    ordenIdx:    ordenIdx
  };
}

/**
 * ============================================
 * doGet
 *  - GET .../exec?action=getAll
 *  - GET .../exec?action=listProducts
 *  - GET .../exec?action=products
 *  - GET .../exec?action=logVisit
 *  - GET .../exec?action=visit
 *  - GET .../exec?action=visits
 *  - GET .../exec?action=social
 * ============================================
 */
function doGet(e) {
  var action = e && e.parameter && e.parameter.action ? e.parameter.action : "getAll";

  // Listado de productos
  if (action === "getAll" || action === "listProducts" || action === "products") {
    return listProducts_();
  }

  // Registro detallado de clics / búsquedas (no lo usa el HTML actual)
  if (action === "logVisit") {
    var clickText  = (e.parameter.clickText  || "");
    var searchText = (e.parameter.searchText || "");
    appendVisit_(clickText, searchText);
    return json_({ status: "success" });
  }

  // Registro simple de visita (se llama desde logVisitOnce del HTML)
  if (action === "visit") {
    appendVisit_("entrada_catalogo", "");
    return json_({ status: "success" });
  }

  // Resumen de visitas para la tarjeta lateral
  if (action === "visits") {
    return json_(getVisitsSummary_());
  }

  // URLs de redes sociales para los botones de contacto
  if (action === "social") {
    return json_(getSocialInfo_());
  }

  return json_({ status: "error", message: "Acción GET no soportada." });
}

/**
 * Lee la hoja "catalogo" y devuelve JSON de productos.
 */
function listProducts_() {
  var ss = getBook_();
  var sheet = ss.getSheetByName(CATALOG_SHEET_NAME);
  if (!sheet) {
    return json_({
      status: "error",
      message: 'No se encontró la hoja "' + CATALOG_SHEET_NAME + '"'
    });
  }

  var lastRow = sheet.getLastRow();
  if (lastRow < START_ROW) {
    return json_({ status: "success", products: [], ts: Date.now() });
  }

  var cfg = getCatalogColumnConfig_(sheet);

  var numRows = lastRow - START_ROW + 1;
  var values = sheet.getRange(START_ROW, 1, numRows, cfg.lastCol).getValues();

  var products = [];
  for (var i = 0; i < values.length; i++) {
    var row = values[i];

    var id   = row[cfg.idIdx];
    var name = row[cfg.nameIdx];

    if (!id || !name) continue; // saltar filas vacías o sin ID

    var priceRaw  = row[cfg.priceIdx] || 0;
    var stockRaw  = row[cfg.stockIdx] || 0;
    var descRaw   = row[cfg.descIdx] || "";
    var ordenRaw  = row[cfg.ordenIdx];

    var ordenNum = Number(String(ordenRaw).replace(/[^\d\-]/g, ""));
    if (isNaN(ordenNum)) ordenNum = 0;

    var idStr        = String(id).trim();
    var nameStr      = String(name).trim();
    var categoryStr  = String(row[cfg.categoryIdx] || "").trim();
    var marcaStr     = String(row[cfg.marcaIdx] || "").trim();
    var price        = Number(String(priceRaw).replace(/[^\d]/g, "")) || 0;
    var stock        = Number(String(stockRaw).replace(/[^\d]/g, "")) || 0;
    var desc         = String(descRaw || "").trim();

    products.push({
      // Claves que espera el HTML (en español)
      id:            idStr,
      codigo:        idStr,
      nombre:        nameStr,
      descripcion:   desc,
      categoria:     categoryStr,
      marca:         marcaStr,
      precio:        price,
      precioVenta:   price,
      stock:         stock,
      orden:         ordenNum,

      // Claves originales (por si las necesitas en otros sitios)
      name:          nameStr,
      description:   desc,
      category:      categoryStr,
      valor_unitario: price
    });
  }

  return json_({
    status: "success",
    products: products,
    ts: Date.now()
  });
}

/**
 * ============================================
 * doPost
 *  - action=logVisit   → registra en hoja "visitas"
 * ============================================
 */
function doPost(e) {
  var out;
  try {
    var data = e && e.postData && e.postData.contents
      ? JSON.parse(e.postData.contents)
      : {};
    var action = data.action || "";

    if (action === "logVisit") {
      var clickText  = data.clickText  || "";
      var searchText = data.searchText || "";
      appendVisit_(clickText, searchText);
      out = { status: "success" };
    } else {
      out = { status: "error", message: "Acción POST no soportada." };
    }
  } catch (err) {
    out = { status: "error", message: err.message };
  }
  return json_(out);
}

/**
 * Registra una fila en la hoja "visitas".
 *
 * Estructura esperada:
 *   Columna B: Fecha (YYYY-MM-DD)
 *   Columna C: Hora (hh:mm a)
 *   Columna D: Clic en el producto
 *   Columna E: Texto buscado
 *   Columna F: Entrada al catálogo (ej. "x")
 */
function appendVisit_(clickText, searchText) {
  var ss = getBook_();
  var sheet = ss.getSheetByName(VISITS_SHEET_NAME);
  if (!sheet) {
    throw new Error('No se encontró la hoja "' + VISITS_SHEET_NAME + '"');
  }

  // Normalizar parámetros a string
  clickText  = String(clickText  || "");
  searchText = String(searchText || "");

  var now = new Date();
  var tz  = Session.getScriptTimeZone();

  // B: Fecha, C: Hora
  var fecha = Utilities.formatDate(now, tz, "yyyy-MM-dd");
  var hora  = Utilities.formatDate(now, tz, "hh:mm a");

  // D, E, F
  var clicProducto    = "";
  var textoBuscado    = "";
  var entradaCatalogo = "";

  if (clickText === "entrada_catalogo") {
    entradaCatalogo = "x";
  } else if (clickText === "busqueda") {
    textoBuscado = searchText;
  } else if (/^producto:\s*/i.test(clickText)) {
    // "producto: Nombre X" → solo dejamos el nombre en la celda
    clicProducto = clickText.replace(/^producto:\s*/i, "");
    textoBuscado = searchText;
  } else {
    // Caso de seguridad: si llega algo inesperado, lo guardamos como clic
    clicProducto = clickText;
    if (searchText) {
      textoBuscado = searchText;
    }
  }

  var nextRow = sheet.getLastRow() + 1;

  // Escribimos en columnas B–F (G queda libre para uso manual si quieres)
  sheet.getRange(nextRow, 2, 1, 5).setValues([[
    fecha,         // Columna B
    hora,          // Columna C
    clicProducto,  // Columna D
    textoBuscado,  // Columna E
    entradaCatalogo// Columna F
  ]]);
}

/**
 * Devuelve un pequeño resumen para la tarjeta de "Visitas a este catálogo"
 */
function getVisitsSummary_() {
  var result = {
    status: "success",
    total: 0,
    lastVisit: "",
    sessionId: "",
    referrer: ""
  };

  var ss = getBook_();
  var sheet = ss.getSheetByName(VISITS_SHEET_NAME);
  if (!sheet) {
    result.status = "error";
    result.message = 'No se encontró la hoja "' + VISITS_SHEET_NAME + '"';
    return result;
  }

  var lastRow = sheet.getLastRow();
  // Suponemos fila 1 como encabezado; datos desde la 2
  if (lastRow <= 1) {
    return result;
  }

  result.total = lastRow - 1;

  var lastData = sheet.getRange(lastRow, 2, 1, 2).getValues()[0]; // B y C
  var fecha = lastData[0];
  var hora  = lastData[1];

  var tz = Session.getScriptTimeZone();

  var fechaStr = fecha instanceof Date
    ? Utilities.formatDate(fecha, tz, "yyyy-MM-dd")
    : String(fecha || "");

  var horaStr = hora instanceof Date
    ? Utilities.formatDate(hora, tz, "HH:mm")
    : String(hora || "");

  result.lastVisit = (fechaStr + " " + horaStr).trim();

  return result;
}

/**
 * Devuelve las URLs de redes sociales para los botones de contacto
 */
function getSocialInfo_() {
  var tz = Session.getScriptTimeZone();
  var updatedAt = Utilities.formatDate(new Date(), tz, "yyyy-MM-dd");

  return {
    status: "success",
    whatsapp: SOCIAL_WHATSAPP_URL || null,
    instagram: SOCIAL_INSTAGRAM_URL || null,
    facebook: SOCIAL_FACEBOOK_URL || null,
    updatedAt: updatedAt
  };
}

/**
 * ============================================
 * UTIL
 * ============================================
 */
function json_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function testAppendVisit() {
  // Ejemplos de prueba manual (ejecutar desde el editor)
  appendVisit_("entrada_catalogo", "");
  appendVisit_("busqueda", "perfume de");
  appendVisit_("producto: Aguas Tropicales 150 ml", "perfume de");
}
