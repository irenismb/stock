<!doctype html>
<html lang="es-CO">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta http-equiv="x-dns-prefetch-control" content="on" />
  <title>Irenismb Stock Natura | Cat√°logo en Santa Marta | Compra por WhatsApp</title>
  <meta name="description" content="Cat√°logo Natura en Santa Marta: fragancias, cuidado personal, maquillaje y m√°s. Compra f√°cil por WhatsApp." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="format-detection" content="telephone=no" />

  <link rel="canonical" href="https://irenismb.github.io/stock/natura/catalogo.html" />
  <link rel="alternate" hreflang="es-CO" href="https://irenismb.github.io/stock/natura/catalogo.html" />

  <!-- Favicons -->
  <link rel="icon" type="image/webp" href="logos/logo_empresa.webp" />
  <link rel="icon" type="image/png" href="logos/logo_empresa.png" />
  <link rel="apple-touch-icon" href="logos/logo_empresa.png" />

  <!-- OpenGraph / Twitter -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://irenismb.github.io/stock/natura/catalogo.html" />
  <meta property="og:title" content="Irenismb Stock Natura | Cat√°logo con compra por WhatsApp" />
  <meta property="og:description" content="Explora el cat√°logo Natura en Santa Marta. Compra f√°cil por WhatsApp." />
  <meta property="og:image" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.png" />
  <meta property="og:image:secure_url" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="800" />
  <meta property="og:image:height" content="800" />
  <meta property="og:image:alt" content="Logo Irenismb Stock Natura" />
  <meta property="og:site_name" content="Irenismb Stock Natura" />
  <meta property="og:locale" content="es_CO" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Irenismb Stock Natura | Cat√°logo" />
  <meta name="twitter:description" content="Cat√°logo Natura en Santa Marta. Compra f√°cil por WhatsApp." />
  <meta name="twitter:image" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.png" />
  <meta name="twitter:image:alt" content="Logo Irenismb Stock Natura" />

  <link rel="dns-prefetch" href="//web.whatsapp.com" />
  <link rel="preconnect" href="https://web.whatsapp.com" crossorigin />
  <link rel="preconnect" href="https://api.github.com" crossorigin />

  <link rel="preload" as="image" href="logos/logo_empresa.webp" type="image/webp" fetchpriority="high" />
  <link rel="preload" as="image" href="logos/logo_empresa.png" type="image/png" fetchpriority="high" />
  <link rel="preload" as="image" href="logos/suplente.webp" type="image/webp" fetchpriority="high" />
  <link rel="preload" as="image" href="logos/suplente.png" type="image/png" fetchpriority="high" />

  <!-- ‚úÖ NUEVO: Corrige 100vh en m√≥viles (barra del navegador / notch) -->
  <script>
    (function () {
      function applyAppHeight() {
        document.documentElement.style.setProperty("--app-height", window.innerHeight + "px");
      }
      applyAppHeight();
      window.addEventListener("resize", applyAppHeight, { passive: true });
      window.addEventListener("orientationchange", applyAppHeight, { passive: true });
    })();
  </script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --txt:#e7edf5;
      --mut:#a9b4c2;
      --acc:#20c997;
      --br:14px;
      --line:#22304a;
      --focus:#60a5fa;
      --pill:#0e1524;
      --danger:#ef4444;

      --social-size: clamp(26px, 8.5vw, 38px);
      --social-gap: clamp(3px, 1.6vw, 10px);

      /* ‚úÖ NUEVO: altura real de la pantalla en m√≥vil */
      --app-height: 100vh;
    }

    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0b0f14,#0c1220);
      color:var(--txt);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto}
    .site-header{ padding:16px 16px 10px; }
    .site-header-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      border:1px solid var(--line);
      background:rgba(18,24,38,.55);
      border-radius:18px;
      padding:12px 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:260px;
    }
    .brand img{
      width:52px;height:52px;border-radius:16px;
      object-fit:cover;
      background:#0b1220;
      border:1px solid rgba(255,255,255,.06);
      display:block;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .brand p{
      margin:3px 0 0;
      font-size:12.5px;
      color:var(--mut);
      line-height:1.35;
    }
    .badge{
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#a3e635);
      padding:6px 14px;
      font-size:12px;
      color:#052e16;
      font-weight:800;
      white-space:nowrap;
    }

    header .intro{ padding:14px 16px 8px; }
    .about-card{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(18,24,38,.55);
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .about-text{
      margin:0;
      font-size:12px;
      line-height:1.35;
    }

    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    input,select,button,textarea{
      border-radius:12px;border:1px solid #263246;background:var(--pill);
      color:var(--txt);padding:10px 12px;font-size:14px
    }
    input{flex:1;min-width:220px}
    button{cursor:pointer}
    button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
      outline:2px solid var(--focus);
      outline-offset:2px;
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .btn-acc{ background:linear-gradient(90deg,#20c997,#2dd4bf); border:none;color:#04120d;font-weight:900; }
    .btn-ghost{ background:transparent; border:1px solid #2a3b5c; color:var(--txt); font-weight:800; }
    .btn-danger{ background:transparent; border:1px solid rgba(239,68,68,.55); color:#fecaca; font-weight:900; }

    /* ‚úÖ NUEVO: botones siempre centrados internamente (texto/√≠conos) */
    .btn-acc, .btn-ghost, .btn-danger,
    .cart-remove, .cart-qty-btn,
    button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      gap:8px;
    }

    .social-icons{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:var(--social-gap);
      flex-wrap:nowrap;
      margin-top:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(18,24,38,.45);
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .social-icons::-webkit-scrollbar{ display:none; }
    .social-icons a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:var(--social-size);
      height:var(--social-size);
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(11,18,32,.35);
      text-decoration:none;
      flex:0 0 auto;
    }
    .social-icons a:hover{border-color:#3b82f6}
    .social-icons img{
      width:calc(var(--social-size) * 0.58);
      height:calc(var(--social-size) * 0.58);
      object-fit:contain;
      border-radius:999px;
      display:block;
    }
    .social-icons picture{ display:block; line-height:0; }

    main{max-width:1100px;margin:0 auto;padding:0 16px 20px}
    .topline{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:10px 0 6px;
    }
    .count{
      font-size:12px;
      color:var(--mut);
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background:rgba(11,18,32,.18);
      max-width:100%;
    }

    .grid{
      display:grid;
      gap:12px;
      margin-top:12px;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      align-items:stretch;
    }
    @media (max-width:1024px){ .grid{ grid-template-columns:repeat(3, minmax(0, 1fr)); } }
    @media (max-width:760px){ .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); } }
    @media (max-width:360px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:rgba(18,24,38,.92);
      border:1px solid var(--line);
      border-radius:var(--br);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
      content-visibility:auto;
      contain-intrinsic-size: 420px 520px;
    }
    .img{
      position:relative;
      width:100%;
      background:#0b1220;
      border-bottom:1px solid var(--line);
      overflow:hidden;
    }
    .img::before{ content:""; display:block; padding-top:100%; }
    .img > img{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      max-width:calc(100% - 16px);
      max-height:calc(100% - 16px);
      width:auto;
      height:auto;
      object-fit:contain;
      display:block;
      cursor:zoom-in;
    }
    .pad{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1 1 auto;
      min-height:0;
    }
    .name{font-weight:950;margin:0;font-size:15px;line-height:1.25}
    .meta{color:var(--mut);font-size:12px;margin:0;line-height:1.35}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .price{font-weight:950}
    .pill{
      display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid #2a3b5c;color:var(--mut);
      background:rgba(11,18,32,.35);
      white-space:nowrap;
    }

    .actions{
      margin-top:auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .actions button{ width:100%; min-width:0; white-space:nowrap; }

    /* Cart modal */
    .cart-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:12px;
    }
    .cart-modal.open{display:flex}
    .cart-modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.75);
    }
    .cart-modal-content{
      position:relative;
      z-index:1;
      width:min(720px, 100%);
      max-height:86vh;
      background:rgba(18,24,38,.98);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 28px 70px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .cart-modal-header{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(11,18,32,.35);
    }
    .cart-modal-title{ margin:0; font-size:16px; font-weight:950; letter-spacing:.02em; }
    .cart-modal-close{
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,32,.35);
      color:var(--txt);
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .cart-modal-body{ padding:12px 14px; overflow:auto; }
    .cart-empty{
      padding:10px 12px;
      border:1px dashed #2a3b5c;
      border-radius:14px;
      color:var(--mut);
      background:rgba(11,18,32,.25);
      line-height:1.45;
    }
    .cart-item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(11,18,32,.28);
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .cart-item-left{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1 1 280px;
      min-width:220px;
    }
    .cart-thumb{
      width:46px;
      height:46px;
      border-radius:12px;
      object-fit:contain;
      background:#0b1220;
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      cursor:zoom-in;
      display:block;
    }
    .cart-item-main{ flex:1 1 auto; min-width:0; }
    .cart-item-name{ font-weight:950; margin:0 0 4px; font-size:13.5px; line-height:1.25; }
    .cart-item-sub{ margin:0; color:var(--mut); font-size:12px; line-height:1.3; }
    .cart-controls{
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(18,24,38,.55);
      border:1px solid #2a3b5c;
      border-radius:999px;
      padding:6px 8px;
    }
    .cart-qty-btn{
      width:32px;height:32px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,32,.25);
      color:var(--txt);
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .cart-qty{ min-width:26px; text-align:center; font-weight:950; color:var(--txt); font-size:13px; }
    .cart-subtotal{ font-weight:950; white-space:nowrap; color:var(--txt); }
    .cart-remove{
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(239,68,68,.55);
      background:rgba(239,68,68,.10);
      color:#fecaca;
      font-weight:950;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ‚úÖ MEJORA: centrar botones del carrito (PC y m√≥vil) */
    .cart-modal-footer{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      flex-direction:column;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
      gap:10px;
      background:rgba(11,18,32,.35);
      text-align:center;
    }
    .cart-total{
      font-weight:950;
      color:var(--txt);
      width:100%;
      text-align:center;
    }
    .cart-footer-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      width:100%;
    }

    /* Image modal */
    .img-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
      overflow:hidden;
    }
    .img-modal.open{display:flex}
    .img-modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.80); }
    .img-modal-content{
      position:relative;
      z-index:1;
      width:100vw;
      height:100vh;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .img-modal-content img{
      max-width:100%;
      max-height:100%;
      width:auto;
      height:auto;
      object-fit:contain;
      border-radius:14px;
      background:#000;
      box-shadow:0 22px 60px rgba(0,0,0,.6);
      display:block;
    }
    .img-modal-close{
      position:absolute;
      z-index:2;
      top:10px;
      right:10px;
      width:38px;
      height:38px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(11,18,32,.55);
      color:var(--txt);
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Generic modal (reused for address + other data) */
    .client-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10002;

      padding:12px;
      padding-top:calc(12px + env(safe-area-inset-top));
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .client-modal.open{ display:flex; }
    .client-modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.72);
      backdrop-filter: blur(10px);
    }

    /* ‚úÖ MEJORA: modal en m√≥vil SIEMPRE encaja completo (sin partes ocultas)
       - quitamos overflow:auto del contenedor
       - hacemos layout tipo "header fijo + body scroll + footer fijo"
       - usamos --app-height (window.innerHeight) para evitar problemas de 100vh en m√≥viles
    */
    .client-modal-content{
      position:relative;
      z-index:1;
      width:100%;
      max-width:560px;

      max-height: calc(var(--app-height) - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      background:linear-gradient(180deg, rgba(18,24,38,.98), rgba(10,16,28,.96));
      border:1px solid rgba(96,165,250,.18);
      border-radius:18px;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);

      overflow:hidden;
      display:flex;
      flex-direction:column;
      -webkit-overflow-scrolling: touch;
    }
    .client-modal-header{
      padding:14px 16px;
      border-bottom:1px solid rgba(34,48,74,.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(11,18,32,.40);
      position:relative;
      z-index:3;
      flex:0 0 auto;
    }
    .client-modal-title{ margin:0; font-size:15.5px; font-weight:950; letter-spacing:.02em; }
    .client-modal-close{
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,32,.35);
      color:var(--txt);
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      flex:0 0 auto;
    }

    .client-modal-body{
      padding:14px 16px 12px;
      overflow:auto;
      flex:1 1 auto;
      min-height:0;
    }
    .client-hint{
      margin:0 0 12px;
      color:rgba(169,180,194,.95);
      font-size:12.5px;
      line-height:1.45;
    }
    .client-grid{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    .client-field.span-2{ grid-column: 1 / -1; }
    .client-field label{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12.5px;
      color:rgba(231,237,245,.92);
      margin:0 0 6px;
    }
    .client-opt{
      font-size:11px;
      color:rgba(169,180,194,.9);
      border:1px solid rgba(42,59,92,.8);
      background:rgba(11,18,32,.25);
      padding:3px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .client-field input,
    .client-field textarea,
    .client-field select{
      width:100%;
      background:rgba(14,21,36,.65);
      border:1px solid rgba(42,59,92,.9);
    }
    .client-field textarea{ min-height:68px; resize:vertical; line-height:1.35; }
    .client-total-preview{
      margin:12px 0 0;
      color:rgba(231,237,245,.92);
      font-size:12.5px;
      line-height:1.45;
      padding:10px 12px;
      border:1px dashed rgba(42,59,92,.85);
      border-radius:14px;
      background:rgba(11,18,32,.18);
    }

    /* ‚úÖ MEJORA: botones del footer centrados */
    .client-modal-footer{
      padding:12px 16px 14px;
      border-top:1px solid rgba(34,48,74,.9);
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      background:rgba(11,18,32,.35);
      position:relative;
      z-index:2;
      flex:0 0 auto;
      text-align:center;
    }

    /* ‚úÖ En m√≥viles: grid a una columna para que no se recorte */
    @media (max-width:520px){
      .client-grid{ grid-template-columns:1fr; }
      .client-field.span-2{ grid-column:auto; }
    }

    /* ‚úÖ Acciones superiores para Direcci√≥n (m√≥vil) */
    .address-top-actions{
      display:none;
      background:rgba(11,18,32,.55);
      border-bottom:1px solid rgba(34,48,74,.9);
      padding:10px 12px;
      flex:0 0 auto;
    }
    .address-top-actions-inner{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .address-top-actions-inner button{
      min-width:140px;
    }
    @media (max-width:560px){
      #addressModal .address-top-actions{ display:block; }
      #addressModal .client-modal-footer{ display:none; }
      #addressModal .client-modal-close{ display:none; } /* en m√≥vil queda Cancelar arriba */
      #addressModal .client-modal-header{ justify-content:center; }
    }

    /* Responsive polish */
    @media (max-width:720px){
      .badge{width:100%;text-align:center}
      .site-header-inner{padding:12px}
    }
    @media (max-width:560px){
      .actions{ gap:8px; }
      .actions button{ font-size:12.5px; padding:9px 8px; border-radius:10px; }

      .cart-footer-actions button{ width:100%; }
      .cart-footer-actions{ width:100%; }
      .cart-total{ width:100%; }
    }
    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto!important;transition:none!important;animation:none!important}
    }
  </style>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Store",
    "name":"Irenismb Stock Natura",
    "url":"https://irenismb.github.io/stock/natura/catalogo.html",
    "description":"Cat√°logo Natura en Santa Marta. Compra f√°cil por WhatsApp.",
    "telephone":"+57 304 208 8961",
    "address":{
      "@type":"PostalAddress",
      "streetAddress":"Calle 10A #20A-06 barrio Los Almendros",
      "addressLocality":"Santa Marta",
      "addressRegion":"Magdalena",
      "addressCountry":"CO"
    },
    "geo":{
      "@type":"GeoCoordinates",
      "latitude":11.244833370782679,
      "longitude":-74.19066001689564
    },
    "hasMap":"https://maps.google.com/?q=11.244833370782679,-74.19066001689564",
    "areaServed":"Colombia"
  }
  </script>
</head>

<body>
  <header class="site-header">
    <div class="wrap site-header-inner">
      <div class="brand">
        <picture>
          <source srcset="logos/logo_empresa.webp" type="image/webp">
          <img src="logos/logo_empresa.png" alt="Logo Irenismb Stock Natura" width="52" height="52" />
        </picture>
        <div>
          <h1>IRENISMB STOCK NATURA</h1>
          <p>Cat√°logo Natura en Santa Marta ‚Ä¢ Compra por WhatsApp</p>
        </div>
      </div>
      <div class="badge">Natura ¬∑ Maquillaje ¬∑ Cuidado personal</div>
    </div>

    <div class="wrap intro">
      <section class="about-card" aria-label="Sobre nosotros y contacto">
        <p class="about-text">
          Irenismb Stock Natura es una tienda en l√≠nea con punto f√≠sico en Santa Marta especializada en productos Natura, AVON y Esika.
          Te asesoramos por WhatsApp o de manera presencial en el barrio Los Almendros. Direcci√≥n: Calle 10A #20A-06. Tel√©fono: +57 304 208 8961.
        </p>
      </section>

      <div class="social-icons" aria-label="Redes sociales, ubicaci√≥n, WhatsApp y llamada">
        <a href="https://maps.google.com/?q=11.244833370782679,-74.19066001689564" target="_blank" rel="noopener noreferrer" aria-label="Ubicaci√≥n en Google Maps">
          <img src="logos/maps.webp" alt="Google Maps" loading="lazy" decoding="async" />
        </a>

        <a id="waTopLink" href="https://wa.me/573042088961" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
          <img src="logos/whatsapp.webp" alt="WhatsApp" loading="lazy" decoding="async" />
        </a>

        <a id="callTopLink" href="tel:+573042088961" rel="nofollow" aria-label="Llamar">
          <img src="logos/phone.webp" alt="Llamar" loading="lazy" decoding="async" />
        </a>
      </div>

      <div class="bar" role="search" aria-label="Buscar y filtrar productos">
        <input id="q" type="search" inputmode="search"
               placeholder="üîç Buscar por nombre, marca, categor√≠a..."
               aria-label="Buscar producto" />

        <select id="cat" aria-label="Filtrar por categor√≠a"><option value="">Todas las categor√≠as</option></select>
        <select id="brand" aria-label="Filtrar por marca"><option value="">Todas las marcas</option></select>
        <select id="sort" aria-label="Ordenar productos">
          <option value="">Ordenar</option>
          <option value="price_asc">Precio: menor a mayor</option>
          <option value="price_desc">Precio: mayor a menor</option>
          <option value="name_asc">Nombre: A ‚Üí Z</option>
        </select>

        <button class="btn-acc" id="btn-cart" type="button" aria-label="Ver carrito">
          Ver carrito <span id="cartCount" class="pill">0</span>
        </button>
      </div>

      <noscript>
        <div style="margin-top:12px;border:1px solid #22304a;border-radius:14px;padding:12px;background:rgba(18,24,38,.55);">
          <h2 style="margin:0 0 6px;font-size:16px;">Cat√°logo Natura en Santa Marta</h2>
          <p style="margin:0 0 8px;color:#a9b4c2;line-height:1.45;">
            Activa JavaScript para ver el cat√°logo completo.
          </p>
          <p style="margin:0;">
            <a href="https://wa.me/573042088961" rel="noopener noreferrer" target="_blank" style="font-weight:900;">
              Comprar por WhatsApp
            </a>
          </p>
        </div>
      </noscript>
    </div>
  </header>

  <main class="wrap">
    <div class="topline">
      <div class="count" id="count" aria-live="polite">Cargando productos‚Ä¶</div>
    </div>
    <section id="grid" class="grid" aria-label="Productos"></section>
  </main>

  <!-- CART MODAL -->
  <div class="cart-modal" id="cartModal" aria-hidden="true" role="dialog" aria-label="Carrito">
    <div class="cart-modal-backdrop" id="cartModalBackdrop"></div>
    <div class="cart-modal-content" role="document" aria-label="Contenido del carrito">
      <div class="cart-modal-header">
        <h3 class="cart-modal-title">üõí Carrito</h3>
        <button class="cart-modal-close" id="cartModalClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="cart-modal-body">
        <div id="cartItems"></div>
      </div>

      <div class="cart-modal-footer">
        <div class="cart-total" id="cartTotal">Total: $0</div>

        <div class="cart-footer-actions">
          <button class="btn-danger" id="cartClearBtn" type="button">Vaciar carrito</button>
          <button class="btn-ghost" id="cartAddressBtn" type="button">üìç Direcci√≥n</button>
          <button class="btn-ghost" id="cartClientBtn" type="button">üßæ Otros datos</button>

          <button class="btn-acc" id="cartBuyBtn" type="button">Enviar como comprador</button>
          <button class="btn-ghost" id="cartSellBtn" type="button">Enviar como vendedor</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: OTROS DATOS -->
  <div class="client-modal" id="clientModal" aria-hidden="true" role="dialog" aria-label="Otros datos del cliente">
    <div class="client-modal-backdrop" id="clientModalBackdrop"></div>

    <div class="client-modal-content" role="document" aria-label="Formulario de otros datos">
      <div class="client-modal-header">
        <h3 class="client-modal-title">üßæ Otros datos</h3>
        <button class="client-modal-close" id="clientModalClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="client-modal-body">
        <p class="client-hint">
          Estos datos son <b>opcionales</b>. Puedes guardarlos y luego usar ‚ÄúEnviar como comprador‚Äù o ‚ÄúEnviar como vendedor‚Äù.
          El <b>env√≠o</b> se maneja <b>solo manual</b>.
        </p>

        <div class="client-grid">
          <div class="client-field">
            <label for="clientName">
              <span>Nombre</span>
              <span class="client-opt">Opcional</span>
            </label>
            <input id="clientName" type="text" autocomplete="name" placeholder="Ej: Ana P√©rez" />
          </div>

          <div class="client-field">
            <label for="clientPhone">
              <span>Celular</span>
              <span class="client-opt">Opcional</span>
            </label>
            <input id="clientPhone" type="tel" inputmode="tel" autocomplete="tel" placeholder="Ej: 3042088961" />
          </div>

          <div class="client-field">
            <label for="clientShipping">
              <span>Env√≠o manual (COP)</span>
              <span class="client-opt">Opcional</span>
            </label>
            <input id="clientShipping" type="text" inputmode="numeric" autocomplete="off" placeholder="Ej: 8000" />
          </div>

          <div class="client-field span-2">
            <label for="clientObs">
              <span>Observaci√≥n</span>
              <span class="client-opt">Opcional</span>
            </label>
            <textarea id="clientObs" rows="1" placeholder="Ej: Entregar en porter√≠a / horario / referencia..."></textarea>
          </div>
        </div>

        <p class="client-total-preview" id="clientTotalPreview"></p>
      </div>

      <div class="client-modal-footer">
        <button class="btn-ghost" id="clientCloseBtn" type="button">Cerrar</button>
        <button class="btn-acc" id="clientSaveBtn" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: DIRECCI√ìN -->
  <div class="client-modal" id="addressModal" aria-hidden="true" role="dialog" aria-label="Direcci√≥n del cliente">
    <div class="client-modal-backdrop" id="addressModalBackdrop"></div>

    <div class="client-modal-content" role="document" aria-label="Formulario de direcci√≥n">
      <div class="client-modal-header">
        <h3 class="client-modal-title">üìç Direcci√≥n</h3>
        <button class="client-modal-close" id="addressModalClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <!-- ‚úÖ (m√≥vil): Cancelar + Guardar centrados y arriba -->
      <div class="address-top-actions" aria-label="Acciones de direcci√≥n">
        <div class="address-top-actions-inner">
          <button class="btn-ghost" id="addressCancelTopBtn" type="button">Cancelar</button>
          <button class="btn-acc" id="addressSaveTopBtn" type="button">Guardar</button>
        </div>
      </div>

      <div class="client-modal-body">
        <p class="client-hint">
          Ciudad y departamento vienen predefinidos, pero puedes cambiarlos. El enlace de Google Maps <b>muestra el punto en el mapa</b> (no una ruta) y <b>NO</b> usa el barrio.
        </p>

        <div class="client-grid">
          <div class="client-field">
            <label for="addrCity">
              <span>Ciudad</span>
              <span class="client-opt">Editable</span>
            </label>
            <input id="addrCity" type="text" autocomplete="address-level2" placeholder="Ej: Santa Marta" />
          </div>

          <div class="client-field">
            <label for="addrRegion">
              <span>Departamento</span>
              <span class="client-opt">Editable</span>
            </label>
            <input id="addrRegion" type="text" autocomplete="address-level1" placeholder="Ej: Magdalena" />
          </div>

          <div class="client-field">
            <label for="addrViaTipo">
              <span>Tipo</span>
              <span class="client-opt">Predeterminado</span>
            </label>
            <select id="addrViaTipo">
              <option value="Calle">Calle (Cl)</option>
              <option value="Carrera">Carrera (Cra)</option>
              <option value="Avenida">Avenida (Av)</option>
              <option value="Diagonal">Diagonal (Dg)</option>
              <option value="Transversal">Transversal (Tv)</option>
            </select>
          </div>

          <div class="client-field">
            <label for="addrViaNum">
              <span>N√∫mero</span>
              <span class="client-opt">Opcional</span>
            </label>
            <input id="addrViaNum" type="text" placeholder="Ej: 10A" />
          </div>

          <div class="client-field">
            <label for="addrPlaca">
              <span># / Placa</span>
              <span class="client-opt">Opcional</span>
            </label>
            <input id="addrPlaca" type="text" placeholder="Ej: 20A-06" />
          </div>

          <div class="client-field">
            <label for="addrBarrio">
              <span>Barrio</span>
              <span class="client-opt">Opcional</span>
            </label>
            <input id="addrBarrio" type="text" placeholder="Ej: Los Almendros" />
          </div>

          <div class="client-field span-2">
            <label for="addrFinal">
              <span>Direcci√≥n final</span>
              <span class="client-opt">Se genera sola</span>
            </label>
            <input id="addrFinal" type="text" readonly placeholder="Se llenar√° autom√°ticamente‚Ä¶" />

            <a id="addrMapsLink"
               class="btn-ghost"
               href="#"
               target="_blank"
               rel="noopener noreferrer"
               style="display:flex; justify-content:center; align-items:center; margin-top:8px; padding:10px 12px; border-radius:12px; text-decoration:none; width:100%;">
              üìå Ver punto en Google Maps
            </a>
          </div>
        </div>
      </div>

      <!-- (Escritorio): acciones abajo, pero en m√≥vil se ocultan por CSS -->
      <div class="client-modal-footer">
        <button class="btn-ghost" id="addressCloseBtn" type="button">Cancelar</button>
        <button class="btn-acc" id="addressSaveBtn" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- IMAGE MODAL -->
  <div class="img-modal" id="imgModal" aria-hidden="true" role="dialog" aria-label="Imagen ampliada">
    <div class="img-modal-backdrop" id="imgModalBackdrop"></div>
    <button class="img-modal-close" id="imgModalClose" type="button" aria-label="Cerrar">‚úï</button>
    <div class="img-modal-content" role="document">
      <img id="imgModalImg" alt="Imagen ampliada del producto" />
    </div>
  </div>

  <script>
    /* ==========================================================
       CONFIG (SIMPLIFICADO)
       - NO se guarda el pedido en Google Sheets (eliminado).
       - SOLO se mantiene el guardado de coordenadas (script al final).
       - Direcci√≥n y Otros datos van en modales separados desde el carrito.
       - WhatsApp: dos modos de env√≠o (comprador -> tienda / vendedor -> cliente)
       - ‚úÖ Env√≠o: SOLO MANUAL (se elimin√≥ todo lo de env√≠o estimado)
       ========================================================== */

    // ====== WhatsApp destino (tienda) (editable con SHIFT+clic en √≠cono) ======
    const WHATSAPP_TO_STORAGE_KEY = "irenismb_whatsapp_to";
    const WHATSAPP_TO_DEFAULT = "3042088961";

    const STORE_NAME = "IRENISMB STOCK NATURA";
    const STORE_PHONE_E164 = "573042088961"; // solo d√≠gitos

    function normalizeWhatsAppToE164Digits(input){
      const digits = String(input || "").replace(/[^\d]/g, "");
      if(!digits) return "";
      if(digits.startsWith("57") && digits.length === 12) return digits;
      if(digits.length === 10) return "57" + digits;
      if(digits.startsWith("57") && digits.length >= 12) return digits;
      return digits;
    }
    function getWhatsAppTo(){
      try{
        const stored = localStorage.getItem(WHATSAPP_TO_STORAGE_KEY);
        return normalizeWhatsAppToE164Digits(stored || WHATSAPP_TO_DEFAULT);
      }catch(_){
        return normalizeWhatsAppToE164Digits(WHATSAPP_TO_DEFAULT);
      }
    }
    function getWhatsAppToForPrompt(){
      const d = getWhatsAppTo();
      if(d.startsWith("57") && d.length === 12) return d.slice(2);
      return d;
    }
    function setWhatsAppToFromUserValue(v){
      const normalized = normalizeWhatsAppToE164Digits(v);
      if(!normalized) return false;
      try{ localStorage.setItem(WHATSAPP_TO_STORAGE_KEY, normalized); }catch(_){}
      updateWhatsAppLinks();
      return true;
    }

    function isMobileDevice(){
      try{
        const ua = (navigator.userAgent || "").toLowerCase();
        const byUA = /android|iphone|ipad|ipod|iemobile|opera mini/.test(ua);
        const byPointer = window.matchMedia && window.matchMedia("(pointer:coarse)").matches;
        return Boolean(byUA || byPointer);
      }catch(_){ return false; }
    }

    // ‚úÖ Link WhatsApp para cualquier destino
    function waLinkTo(toE164Digits, text){
      const to = normalizeWhatsAppToE164Digits(toE164Digits);
      const msg = String(text || "");
      if(!to) return "";
      if (isMobileDevice()){
        return `https://wa.me/${encodeURIComponent(to)}${msg ? `?text=${encodeURIComponent(msg)}` : ""}`;
      }
      return `https://web.whatsapp.com/send?phone=${encodeURIComponent(to)}${msg ? `&text=${encodeURIComponent(msg)}` : ""}`;
    }

    // Link WhatsApp para tienda (default)
    function waLink(text){
      return waLinkTo(getWhatsAppTo(), text);
    }

    function updateWhatsAppLinks(){
      const wa = document.getElementById("waTopLink");
      const call = document.getElementById("callTopLink");
      const to = getWhatsAppTo();
      if(wa) wa.href = waLink("");
      if(call) call.href = "tel:+" + to;
    }
    (function initTopWhatsAppEditing(){
      updateWhatsAppLinks();
      const wa = document.getElementById("waTopLink");
      if(!wa) return;
      wa.addEventListener("click", (e)=>{
        if(!e.shiftKey) return;
        e.preventDefault();
        const current = getWhatsAppToForPrompt();
        const next = prompt("N√∫mero destino de WhatsApp (solo d√≠gitos). Ej: 3042088961", current);
        if(next == null) return;
        const ok = setWhatsAppToFromUserValue(next);
        if(!ok) alert("N√∫mero inv√°lido. Intenta de nuevo (solo d√≠gitos).");
      });
    })();

    // ====== Utilidades ======
    const fmtCOP = new Intl.NumberFormat("es-CO", { style:"currency", currency:"COP", maximumFractionDigits:0 });
    const SITE_BASE = new URL("./", document.baseURI).href;
    const IMG_DIR = "imagenes_de_productos";
    const LOGOS_DIR = "logos";
    const COMPANY_LOGO = SITE_BASE + LOGOS_DIR + "/logo_empresa.webp";

    const CATALOG_URL = (document.querySelector('link[rel="canonical"]')?.href) || (window.location.href.split("#")[0]);

    const IMAGE_EXTS = ["webp","jpg","jpeg","png"];
    const NON_IMAGE_EXTS = ["txt"];
    const SUPPORTED_EXTS = [...IMAGE_EXTS, ...NON_IMAGE_EXTS];

    function normalizeText(t){
      return (t || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }
    function toNumberDigits(s){ return Number(String(s ?? "").replace(/[^\d]/g,"")) || 0; }
    function safeInt(s, def=0){
      const n = parseInt(String(s ?? "").replace(/[^\d]/g,""), 10);
      return Number.isFinite(n) ? n : def;
    }
    function extOf(filename){
      const i = String(filename || "").lastIndexOf(".");
      if(i < 0) return "";
      return String(filename).slice(i+1).toLowerCase();
    }
    function baseOf(filename){
      const s = String(filename || "");
      const i = s.lastIndexOf(".");
      return (i < 0) ? s : s.slice(0, i);
    }
    function encodePath(p){
      return String(p || "")
        .split("/")
        .map(seg => encodeURIComponent(seg))
        .join("/");
    }
    function isImageExt(ext){ return IMAGE_EXTS.includes(String(ext || "").toLowerCase()); }
    function leafName(p){
      const s = String(p || "");
      const parts = s.split("/");
      return parts[parts.length - 1] || s;
    }

    // Placeholder simple
    const PRODUCT_PLACEHOLDER = SITE_BASE + LOGOS_DIR + "/suplente.webp";

    function productImageAbsoluteUrlFromFilename(filename){
      if(!filename) return PRODUCT_PLACEHOLDER;
      return SITE_BASE + IMG_DIR + "/" + encodePath(filename);
    }

    async function fetchJson(url){
      const res = await fetch(url, {
        method:"GET",
        headers:{ "Accept":"application/vnd.github+json" },
        cache:"no-store",
        credentials:"omit"
      });
      if(!res.ok){
        const text = await res.text().catch(()=> "");
        throw new Error("HTTP " + res.status + " " + (text || ""));
      }
      return await res.json();
    }

    // ====== Parse producto desde nombre de archivo ======
    // Formato esperado: ID_NOMBRE..._MARCA_CATEGORIA_VALOR_STOCK.ext
    function parseProductFromBaseName(baseName){
      const parts = String(baseName || "").split("_");
      if(parts.length < 6) return null;

      const id = String(parts[0] || "").trim();
      const qty = safeInt(parts[parts.length - 1], 0);
      const price = toNumberDigits(parts[parts.length - 2]);

      const category = String(parts[parts.length - 3] || "").trim();
      const brand = String(parts[parts.length - 4] || "").trim();
      const name = String(parts.slice(1, parts.length - 4).join("_") || "").trim();

      if(!id || !name) return null;

      return {
        id,
        name,
        category,
        brand,
        price,
        stock: Math.max(0, qty),
        searchKey: normalizeText(`${name} ${brand} ${category} ${id}`)
      };
    }

    // ====== GitHub load (Tree API + fallback contents) ======
    const GITHUB_OWNER = "irenismb";
    const GITHUB_REPO = "stock";
    const GITHUB_PRODUCTS_PATH = "natura/imagenes_de_productos";

    const PRODUCTS_CACHE_KEY = "irenismb_products_cache_v6";
    const PRODUCTS_CACHE_TTL_MS = 30 * 60 * 1000;

    function readProductsCache(allowStale){
      try{
        const raw = localStorage.getItem(PRODUCTS_CACHE_KEY);
        if(!raw) return null;
        const obj = JSON.parse(raw);
        if(!obj || !Array.isArray(obj.products) || !Number.isFinite(obj.ts)) return null;
        const age = Date.now() - obj.ts;
        const isFresh = age <= PRODUCTS_CACHE_TTL_MS;
        if(!allowStale && !isFresh) return null;
        return { products: obj.products, isFresh };
      }catch(_){ return null; }
    }
    function writeProductsCache(products){
      try{
        localStorage.setItem(PRODUCTS_CACHE_KEY, JSON.stringify({ v:6, ts: Date.now(), products: products || [] }));
      }catch(_){}
    }

    function preferredExtScore(ext){
      const order = { webp:0, jpg:1, jpeg:2, png:3 };
      return (ext in order) ? order[ext] : 99;
    }
    function pickBetterRepresentative(existing, candidate){
      if(!existing) return candidate;
      const eImg = !!existing.hasImage;
      const cImg = !!candidate.hasImage;
      if(eImg && !cImg) return existing;
      if(!eImg && cImg) return candidate;
      if(eImg && cImg){
        const eExt = String(existing.fileExt || extOf(existing.srcFilename || existing.imgFilename || "")).toLowerCase();
        const cExt = String(candidate.fileExt || extOf(candidate.srcFilename || candidate.imgFilename || "")).toLowerCase();
        if(preferredExtScore(cExt) < preferredExtScore(eExt)) return candidate;
        return existing;
      }
      return existing;
    }

    async function fetchProductsViaTree(){
      const repoInfo = await fetchJson(`https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}`);
      const branch = String(repoInfo && repoInfo.default_branch ? repoInfo.default_branch : "main");
      const branchInfo = await fetchJson(`https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/branches/${encodeURIComponent(branch)}`);
      const sha = branchInfo && branchInfo.commit && branchInfo.commit.sha ? branchInfo.commit.sha : "";
      if(!sha) throw new Error("No se pudo obtener SHA.");

      const tree = await fetchJson(`https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/git/trees/${encodeURIComponent(sha)}?recursive=1`);
      const nodes = (tree && Array.isArray(tree.tree)) ? tree.tree : [];

      const dirPrefix = (GITHUB_PRODUCTS_PATH.replace(/\/+$/,"") + "/");
      const files = nodes
        .filter(n => n && n.type === "blob" && typeof n.path === "string" && n.path.startsWith(dirPrefix))
        .map(n => n.path.slice(dirPrefix.length))
        .filter(Boolean);

      const byId = new Map();
      for(const relPath of files){
        const leaf = leafName(relPath);
        const ext = extOf(leaf);
        if(!SUPPORTED_EXTS.includes(ext)) continue;

        const base = baseOf(leaf);
        const parsed = parseProductFromBaseName(base);
        if(!parsed) continue;

        const hasImage = isImageExt(ext);
        const candidate = {
          ...parsed,
          srcFilename: relPath,
          fileExt: ext,
          hasImage,
          imgFilename: hasImage ? relPath : null
        };

        const existing = byId.get(parsed.id);
        byId.set(parsed.id, pickBetterRepresentative(existing, candidate));
      }

      return Array.from(byId.values())
        .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "es", { sensitivity:"base" }) || String(a.id).localeCompare(String(b.id)));
    }

    async function listContentsFilesRecursive(path, depth=0){
      const MAX_DEPTH = 8;
      if(depth > MAX_DEPTH) return [];
      const url = `https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/contents/${encodePath(path)}`;
      const data = await fetchJson(url);
      if(!Array.isArray(data)) return [];
      const out = [];
      for(const it of data){
        if(!it || typeof it.type !== "string") continue;
        if(it.type === "file" && typeof it.path === "string") out.push(it.path);
        else if(it.type === "dir" && typeof it.path === "string"){
          const inner = await listContentsFilesRecursive(it.path, depth+1);
          for(const p of inner) out.push(p);
        }
      }
      return out;
    }
    async function fetchProductsViaContentsApi(){
      const fullPaths = await listContentsFilesRecursive(GITHUB_PRODUCTS_PATH);
      const prefix = (GITHUB_PRODUCTS_PATH.replace(/\/+$/,"") + "/");
      const relPaths = fullPaths
        .filter(p => typeof p === "string" && p.startsWith(prefix))
        .map(p => p.slice(prefix.length))
        .filter(Boolean);

      const byId = new Map();
      for(const relPath of relPaths){
        const leaf = leafName(relPath);
        const ext = extOf(leaf);
        if(!SUPPORTED_EXTS.includes(ext)) continue;

        const base = baseOf(leaf);
        const parsed = parseProductFromBaseName(base);
        if(!parsed) continue;

        const hasImage = isImageExt(ext);
        const candidate = {
          ...parsed,
          srcFilename: relPath,
          fileExt: ext,
          hasImage,
          imgFilename: hasImage ? relPath : null
        };

        const existing = byId.get(parsed.id);
        byId.set(parsed.id, pickBetterRepresentative(existing, candidate));
      }

      return Array.from(byId.values())
        .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "es", { sensitivity:"base" }) || String(a.id).localeCompare(String(b.id)));
    }
    async function loadProductsFresh(){
      try{ return await fetchProductsViaTree(); }
      catch(_){ return await fetchProductsViaContentsApi(); }
    }

    // ====== UI: imagen modal ======
    const imgModal = document.getElementById("imgModal");
    const imgModalImg = document.getElementById("imgModalImg");
    const imgModalClose = document.getElementById("imgModalClose");
    const imgModalBackdrop = document.getElementById("imgModalBackdrop");

    function openImgModal(src, alt){
      if(!imgModal || !imgModalImg || !src) return;
      imgModalImg.src = src;
      imgModalImg.alt = alt || "Imagen ampliada del producto";
      imgModal.classList.add("open");
      imgModal.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeImgModal(){
      if(!imgModal || !imgModalImg) return;
      imgModal.classList.remove("open");
      imgModal.setAttribute("aria-hidden","true");
      imgModalImg.src = "";
      recomputeBodyOverflow();
    }
    if(imgModalClose) imgModalClose.addEventListener("click", closeImgModal);
    if(imgModalBackdrop) imgModalBackdrop.addEventListener("click", closeImgModal);

    function makeImgFromFilename(filename, name){
      const img = document.createElement("img");
      img.alt = name ? ("Foto " + name) : "Foto del producto";
      img.loading = "lazy";
      img.decoding = "async";
      img.src = productImageAbsoluteUrlFromFilename(filename);
      img.onerror = ()=>{
        if(img.dataset.fallbackTried === "1"){
          img.onerror = null;
          img.src = COMPANY_LOGO;
          return;
        }
        img.dataset.fallbackTried = "1";
        img.src = PRODUCT_PLACEHOLDER;
      };
      img.addEventListener("click", ()=>{
        const src = img.currentSrc || img.src;
        if(src) openImgModal(src, img.alt);
      });
      return img;
    }

    // ====== Carrito ======
    let all = [];
    let productById = new Map();

    const cart = (() => {
      try{
        const rawCart = localStorage.getItem("cart");
        const parsed = JSON.parse(rawCart || "{}");
        return (parsed && typeof parsed === "object") ? parsed : {};
      }catch(_){
        try{ localStorage.removeItem("cart"); }catch(__){}
        return {};
      }
    })();

    function cartItemsArray(){
      return Object.values(cart)
        .filter(it => it && it.qty > 0 && it.id && productById.has(String(it.id)));
    }
    function cartTotalValue(){
      return cartItemsArray().reduce((s,it)=> s + ((Number(it.price)||0) * (Number(it.qty)||0)), 0);
    }
    function cartTotalQty(){
      return cartItemsArray().reduce((s,it)=> s + (Number(it.qty)||0), 0);
    }
    function saveCart(){
      try{ localStorage.setItem("cart", JSON.stringify(cart)); }catch(_){}
      refreshCartCount();
    }
    function refreshCartCount(){
      const el = document.getElementById("cartCount");
      if(!el) return;
      const qty = cartTotalQty();
      el.textContent = String(qty);
    }

    // ====== Env√≠o (manual, local) ======
    const SHIPPING_COST_KEY = "irenismb_shipping_cop";
    function readStoredShippingCost(){
      try{ return Math.max(0, safeInt(localStorage.getItem(SHIPPING_COST_KEY), 0)); }catch(_){ return 0; }
    }
    function writeStoredShippingCost(v){
      try{ localStorage.setItem(SHIPPING_COST_KEY, String(Math.max(0, safeInt(v, 0)))); }catch(_){}
    }

    // ====== Datos cliente + Direcci√≥n (local) ======
    const DEFAULT_CITY = "Santa Marta";
    const DEFAULT_REGION = "Magdalena";
    const DEFAULT_COUNTRY = "Colombia";

    const LS_CLIENT_KEY  = "irenismb_client_v2";
    const LS_ADDRESS_KEY = "irenismb_address_v3";

    function safeParseJson(raw, fallback){
      try{
        const obj = JSON.parse(raw);
        return (obj && typeof obj === "object") ? obj : fallback;
      }catch(_){ return fallback; }
    }
    function cleanToken(s){ return String(s || "").trim().replace(/\s+/g, " "); }
    function normalizePlaca(s){ return cleanToken(s).replace(/\s*-\s*/g, "-"); }

    function googleMapsPointUrl(query){
      return "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(query);
    }

    function readClientStored(){
      const base = safeParseJson(localStorage.getItem(LS_CLIENT_KEY) || "{}", {});
      return {
        nombre: cleanToken(base.nombre),
        celular: cleanToken(base.celular),
        observacion: cleanToken(base.observacion)
      };
    }
    function writeClientStored(obj){
      const payload = {
        nombre: cleanToken(obj?.nombre),
        celular: cleanToken(obj?.celular),
        observacion: cleanToken(obj?.observacion)
      };
      try{ localStorage.setItem(LS_CLIENT_KEY, JSON.stringify(payload)); }catch(_){}
    }

    function readAddressStored(){
      const base = safeParseJson(localStorage.getItem(LS_ADDRESS_KEY) || "{}", {});
      return {
        city: cleanToken(base.city) || DEFAULT_CITY,
        region: cleanToken(base.region) || DEFAULT_REGION,
        tipo: cleanToken(base.tipo) || "Calle",
        viaNum: cleanToken(base.viaNum),
        placa: normalizePlaca(base.placa),
        barrio: cleanToken(base.barrio)
      };
    }
    function writeAddressStored(obj){
      const payload = {
        city: cleanToken(obj?.city) || DEFAULT_CITY,
        region: cleanToken(obj?.region) || DEFAULT_REGION,
        tipo: cleanToken(obj?.tipo) || "Calle",
        viaNum: cleanToken(obj?.viaNum),
        placa: normalizePlaca(obj?.placa),
        barrio: cleanToken(obj?.barrio)
      };
      try{ localStorage.setItem(LS_ADDRESS_KEY, JSON.stringify(payload)); }catch(_){}
    }

    function buildAddressLine1(tipo, viaNum, placa){
      const via = [tipo, viaNum].filter(Boolean).join(" ").trim();
      const p = placa ? ("#" + placa) : "";
      return [via, p].filter(Boolean).join(" ").trim();
    }

    function addressForWhatsApp(){
      const a = readAddressStored();
      const line1 = buildAddressLine1(a.tipo, a.viaNum, a.placa);

      const city = a.city || DEFAULT_CITY;
      const region = a.region || DEFAULT_REGION;

      const main = [line1, city, region].filter(Boolean).join(", ").trim();
      const mapsQuery = [line1, city, region, DEFAULT_COUNTRY].filter(Boolean).join(", ").trim();

      return { line1, barrio: a.barrio, full: main, mapsQuery };
    }

    // ====== WhatsApp: obtener destinatario cliente (para modo vendedor) ======
    function getClientWhatsAppTo(){
      const c = readClientStored();
      const normalized = normalizeWhatsAppToE164Digits(c.celular);
      return normalized || "";
    }

    // ====== Mensaje WhatsApp (comprador / vendedor) - SOLO ENV√çO MANUAL ======
    function buildWhatsAppMessage(mode){
      const items = cartItemsArray();
      const c = readClientStored();
      const a = addressForWhatsApp();

      const catalogLine = `Cat√°logo: ${CATALOG_URL}`;
      const shippingManual = readStoredShippingCost();

      if(!items.length){
        if(mode === "seller"){
          const lines = [];
          lines.push(`Hola${c.nombre ? " " + c.nombre : ""}, soy ${STORE_NAME}.`);
          lines.push(`Te comparto el cat√°logo y mis datos de contacto:`);
          lines.push(`WhatsApp tienda: +${STORE_PHONE_E164}`);
          if(a.full) lines.push(`Direcci√≥n cliente: ${a.full}`);
          if(a.barrio) lines.push(`Barrio: ${a.barrio}`);
          if(a.line1) lines.push(`Mapa (punto): ${googleMapsPointUrl(a.mapsQuery)}`);
          if(c.observacion) lines.push(`Observaci√≥n: ${c.observacion}`);
          lines.push(`Env√≠o manual: ${fmtCOP.format(shippingManual)}`);
          lines.push("");
          lines.push(catalogLine);
          return lines.join("\n");
        }else{
          const lines = [];
          lines.push(`Hola, quiero informaci√≥n del cat√°logo.`);
          if(c.nombre) lines.push(`Nombre: ${c.nombre}`);
          if(c.celular) lines.push(`Celular: ${c.celular}`);
          if(a.full) lines.push(`Direcci√≥n: ${a.full}`);
          if(a.barrio) lines.push(`Barrio: ${a.barrio}`);
          if(a.line1) lines.push(`Mapa (punto): ${googleMapsPointUrl(a.mapsQuery)}`);
          if(c.observacion) lines.push(`Observaci√≥n: ${c.observacion}`);
          lines.push(`Env√≠o manual: ${fmtCOP.format(shippingManual)}`);
          lines.push("");
          lines.push(catalogLine);
          return lines.join("\n");
        }
      }

      const subtotal = cartTotalValue();
      const total = subtotal + Math.max(0, shippingManual);

      const clientLines = [];
      if(mode === "seller"){
        clientLines.push(`Hola${c.nombre ? " " + c.nombre : ""}, soy ${STORE_NAME}.`);
        clientLines.push(`Este es el resumen del pedido:`);
        clientLines.push(`WhatsApp tienda: +${STORE_PHONE_E164}`);
      }else{
        clientLines.push(`Hola, quiero comprar:`);
      }

      if(c.nombre) clientLines.push(`Nombre: ${c.nombre}`);
      if(c.celular) clientLines.push(`Celular: ${c.celular}`);

      if(a.full) clientLines.push(`Direcci√≥n: ${a.full}`);
      if(a.barrio) clientLines.push(`Barrio: ${a.barrio}`);
      if(a.line1) clientLines.push(`Mapa (punto): ${googleMapsPointUrl(a.mapsQuery)}`);
      if(c.observacion) clientLines.push(`Observaci√≥n: ${c.observacion}`);

      const lines = items.map(it => `- ${it.name} (Id: ${it.id}) x${it.qty} = ${fmtCOP.format((Number(it.price)||0) * (Number(it.qty)||0))}`);

      const totals = [];
      totals.push(`Subtotal: ${fmtCOP.format(subtotal)}`);
      totals.push(`Env√≠o manual: ${fmtCOP.format(shippingManual)}`);
      totals.push(`Total: ${fmtCOP.format(total)}`);

      return `${clientLines.join("\n")}\n\n${lines.join("\n")}\n\n${totals.join("\n")}\n\n${catalogLine}`;
    }

    // ====== Modales: control general ======
    const cartModal = document.getElementById("cartModal");
    const cartModalBackdrop = document.getElementById("cartModalBackdrop");
    const cartModalClose = document.getElementById("cartModalClose");

    const clientModal = document.getElementById("clientModal");
    const clientModalBackdrop = document.getElementById("clientModalBackdrop");
    const clientModalClose = document.getElementById("clientModalClose");
    const clientCloseBtn = document.getElementById("clientCloseBtn");
    const clientSaveBtn = document.getElementById("clientSaveBtn");

    const addressModal = document.getElementById("addressModal");
    const addressModalBackdrop = document.getElementById("addressModalBackdrop");
    const addressModalClose = document.getElementById("addressModalClose");

    const addressCancelTopBtn = document.getElementById("addressCancelTopBtn");
    const addressSaveTopBtn = document.getElementById("addressSaveTopBtn");

    const addressCloseBtn = document.getElementById("addressCloseBtn");
    const addressSaveBtn = document.getElementById("addressSaveBtn");

    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");
    const cartBuyBtn = document.getElementById("cartBuyBtn");
    const cartSellBtn = document.getElementById("cartSellBtn");
    const cartClearBtn = document.getElementById("cartClearBtn");
    const cartAddressBtn = document.getElementById("cartAddressBtn");
    const cartClientBtn = document.getElementById("cartClientBtn");

    const clientNameInp = document.getElementById("clientName");
    const clientPhoneInp = document.getElementById("clientPhone");
    const clientObsInp = document.getElementById("clientObs");
    const clientShippingInp = document.getElementById("clientShipping");
    const clientTotalPreviewEl = document.getElementById("clientTotalPreview");

    // inputs direcci√≥n
    const addrCity = document.getElementById("addrCity");
    const addrRegion = document.getElementById("addrRegion");
    const addrViaTipo = document.getElementById("addrViaTipo");
    const addrViaNum = document.getElementById("addrViaNum");
    const addrPlaca = document.getElementById("addrPlaca");
    const addrBarrio = document.getElementById("addrBarrio");
    const addrFinal = document.getElementById("addrFinal");
    const addrMapsLink = document.getElementById("addrMapsLink");

    function anyModalOpen(){
      const cartOpen = cartModal && cartModal.classList.contains("open");
      const imgOpen  = imgModal && imgModal.classList.contains("open");
      const cliOpen  = clientModal && clientModal.classList.contains("open");
      const adrOpen  = addressModal && addressModal.classList.contains("open");
      return !!(cartOpen || imgOpen || cliOpen || adrOpen);
    }
    function recomputeBodyOverflow(){
      document.body.style.overflow = anyModalOpen() ? "hidden" : "";
    }

    function openCartModal(){
      renderCartModal();
      cartModal.classList.add("open");
      cartModal.setAttribute("aria-hidden", "false");
      recomputeBodyOverflow();
    }
    function closeCartModal(){
      cartModal.classList.remove("open");
      cartModal.setAttribute("aria-hidden", "true");
      recomputeBodyOverflow();
    }

    function openClientModal(){
      const c = readClientStored();
      if(clientNameInp) clientNameInp.value = c.nombre || "";
      if(clientPhoneInp) clientPhoneInp.value = c.celular || "";
      if(clientObsInp) clientObsInp.value = c.observacion || "";

      const ship = readStoredShippingCost();
      if(clientShippingInp) clientShippingInp.value = ship > 0 ? String(ship) : "";

      updateClientTotalPreview();

      clientModal.classList.add("open");
      clientModal.setAttribute("aria-hidden","false");
      recomputeBodyOverflow();
      setTimeout(()=> clientNameInp && clientNameInp.focus(), 50);
    }
    function closeClientModal(){
      clientModal.classList.remove("open");
      clientModal.setAttribute("aria-hidden","true");
      recomputeBodyOverflow();
    }

    function refreshAddressModalPreview(){
      const city = cleanToken(addrCity?.value) || DEFAULT_CITY;
      const region = cleanToken(addrRegion?.value) || DEFAULT_REGION;

      const tipo = cleanToken(addrViaTipo?.value) || "Calle";
      const viaNum = cleanToken(addrViaNum?.value);
      const placa = normalizePlaca(addrPlaca?.value);

      const line1 = buildAddressLine1(tipo, viaNum, placa);
      const full = [line1, city, region].filter(Boolean).join(", ").trim();

      if(addrFinal) addrFinal.value = full;

      if(addrMapsLink){
        if(line1){
          const query = [line1, city, region, DEFAULT_COUNTRY].join(", ");
          addrMapsLink.href = googleMapsPointUrl(query);
          addrMapsLink.style.pointerEvents = "";
          addrMapsLink.style.opacity = "1";
        }else{
          addrMapsLink.href = "#";
          addrMapsLink.style.pointerEvents = "none";
          addrMapsLink.style.opacity = ".55";
        }
      }
    }

    function openAddressModal(){
      const a = readAddressStored();

      if(addrCity) addrCity.value = a.city || DEFAULT_CITY;
      if(addrRegion) addrRegion.value = a.region || DEFAULT_REGION;

      if(addrViaTipo) addrViaTipo.value = a.tipo || "Calle";
      if(addrViaNum) addrViaNum.value = a.viaNum || "";
      if(addrPlaca) addrPlaca.value = a.placa || "";
      if(addrBarrio) addrBarrio.value = a.barrio || "";

      refreshAddressModalPreview();

      addressModal.classList.add("open");
      addressModal.setAttribute("aria-hidden","false");
      recomputeBodyOverflow();
      setTimeout(()=> addrViaNum && addrViaNum.focus(), 50);
    }
    function closeAddressModal(){
      addressModal.classList.remove("open");
      addressModal.setAttribute("aria-hidden","true");
      recomputeBodyOverflow();
    }

    function saveAddressFromInputs(){
      writeAddressStored({
        city: addrCity?.value || DEFAULT_CITY,
        region: addrRegion?.value || DEFAULT_REGION,
        tipo: addrViaTipo?.value || "Calle",
        viaNum: addrViaNum?.value || "",
        placa: addrPlaca?.value || "",
        barrio: addrBarrio?.value || ""
      });
      closeAddressModal();
    }

    function updateClientTotalPreview(){
      if(!clientTotalPreviewEl) return;
      const shipping = Math.max(0, toNumberDigits(clientShippingInp?.value || "") || readStoredShippingCost());
      const subtotal = cartTotalValue();
      const total = subtotal + shipping;

      if(cartTotalQty() > 0){
        clientTotalPreviewEl.textContent = `Subtotal: ${fmtCOP.format(subtotal)} ¬∑ Env√≠o manual: ${fmtCOP.format(shipping)} ¬∑ Total: ${fmtCOP.format(total)}`;
      }else{
        clientTotalPreviewEl.textContent = `Carrito vac√≠o ¬∑ Env√≠o manual: ${fmtCOP.format(shipping)}`;
      }
    }

    // Listeners modales
    if(cartModalBackdrop) cartModalBackdrop.addEventListener("click", closeCartModal);
    if(cartModalClose) cartModalClose.addEventListener("click", closeCartModal);

    if(clientModalBackdrop) clientModalBackdrop.addEventListener("click", closeClientModal);
    if(clientModalClose) clientModalClose.addEventListener("click", closeClientModal);
    if(clientCloseBtn) clientCloseBtn.addEventListener("click", closeClientModal);

    if(addressModalBackdrop) addressModalBackdrop.addEventListener("click", closeAddressModal);
    if(addressModalClose) addressModalClose.addEventListener("click", closeAddressModal);
    if(addressCloseBtn) addressCloseBtn.addEventListener("click", closeAddressModal);
    if(addressCancelTopBtn) addressCancelTopBtn.addEventListener("click", closeAddressModal);

    [addrCity, addrRegion, addrViaTipo, addrViaNum, addrPlaca, addrBarrio].forEach(el=>{
      if(!el) return;
      el.addEventListener("input", refreshAddressModalPreview);
      el.addEventListener("change", refreshAddressModalPreview);
    });

    if(addressSaveBtn) addressSaveBtn.addEventListener("click", saveAddressFromInputs);
    if(addressSaveTopBtn) addressSaveTopBtn.addEventListener("click", saveAddressFromInputs);

    if(clientShippingInp){
      clientShippingInp.addEventListener("input", updateClientTotalPreview);
      clientShippingInp.addEventListener("blur", ()=>{
        const v = Math.max(0, toNumberDigits(clientShippingInp.value));
        writeStoredShippingCost(v);
        clientShippingInp.value = v > 0 ? String(v) : "";
        updateClientTotalPreview();
        if(cartModal && cartModal.classList.contains("open")) renderCartModal();
      });
    }

    if(clientSaveBtn){
      clientSaveBtn.addEventListener("click", ()=>{
        writeClientStored({
          nombre: clientNameInp?.value || "",
          celular: clientPhoneInp?.value || "",
          observacion: clientObsInp?.value || ""
        });

        const envio = Math.max(0, toNumberDigits(clientShippingInp?.value || ""));
        writeStoredShippingCost(envio);

        closeClientModal();

        if(cartModal && cartModal.classList.contains("open")) renderCartModal();
      });
    }

    // Botones del carrito
    document.getElementById("btn-cart").addEventListener("click", openCartModal);
    if(cartAddressBtn) cartAddressBtn.addEventListener("click", openAddressModal);
    if(cartClientBtn) cartClientBtn.addEventListener("click", openClientModal);

    if(cartClearBtn){
      cartClearBtn.addEventListener("click", ()=>{
        if(!cartTotalQty()) return;
        const ok = window.confirm("¬øSeguro que deseas vaciar todo el carrito?");
        if(!ok) return;
        for(const k of Object.keys(cart)) delete cart[k];
        saveCart();
        renderCartModal();
        refreshVisibleCardsFromCart();
      });
    }

    // ‚úÖ Enviar como comprador (a tienda)
    if(cartBuyBtn){
      cartBuyBtn.addEventListener("click", ()=>{
        const msg = buildWhatsAppMessage("buyer");
        window.open(waLink(msg), "_blank", "noopener");
      });
    }

    // ‚úÖ Enviar como vendedor (a cliente)
    if(cartSellBtn){
      cartSellBtn.addEventListener("click", ()=>{
        const msg = buildWhatsAppMessage("seller");

        let to = getClientWhatsAppTo();
        if(!to){
          const entered = prompt("Para enviar como vendedor, escribe el celular del cliente (solo d√≠gitos). Ej: 3042088961", "");
          if(entered == null) return;
          const normalized = normalizeWhatsAppToE164Digits(entered);
          if(!normalized){
            alert("Celular inv√°lido.");
            return;
          }
          const cur = readClientStored();
          writeClientStored({ ...cur, celular: entered });
          to = normalized;
        }

        window.open(waLinkTo(to, msg), "_blank", "noopener");
      });
    }

    // ESC
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if(addressModal && addressModal.classList.contains("open")) closeAddressModal();
        if(clientModal && clientModal.classList.contains("open")) closeClientModal();
        if(imgModal && imgModal.classList.contains("open")) closeImgModal();
        if(cartModal && cartModal.classList.contains("open")) closeCartModal();
        recomputeBodyOverflow();
      }
    });

    // ====== Render carrito ======
    function makeCartThumbFromFilename(filename, name){
      const img = document.createElement("img");
      img.className = "cart-thumb";
      img.alt = name ? ("Foto " + name) : "Foto del producto";
      img.loading = "lazy";
      img.decoding = "async";
      img.src = productImageAbsoluteUrlFromFilename(filename);
      img.onerror = ()=>{
        if(img.dataset.fallbackTried === "1"){
          img.onerror = null;
          img.src = COMPANY_LOGO;
          return;
        }
        img.dataset.fallbackTried = "1";
        img.src = PRODUCT_PLACEHOLDER;
      };
      img.addEventListener("click", ()=>{
        const src = img.currentSrc || img.src;
        if(src) openImgModal(src, img.alt);
      });
      return img;
    }

    function renderCartModal(){
      const items = cartItemsArray();
      const subtotal = cartTotalValue();
      const shipping = readStoredShippingCost();
      const total = subtotal + shipping;

      cartTotalEl.textContent = `Subtotal: ${fmtCOP.format(subtotal)} ¬∑ Env√≠o manual: ${fmtCOP.format(shipping)} ¬∑ Total: ${fmtCOP.format(total)}`;

      if(cartBuyBtn) cartBuyBtn.disabled = false;
      if(cartSellBtn) cartSellBtn.disabled = false;

      if(cartClearBtn) cartClearBtn.disabled = !items.length;

      if(!items.length){
        cartItemsEl.innerHTML = `<div class="cart-empty">El carrito est√° vac√≠o. Puedes usar ‚ÄúEnviar como comprador‚Äù para pedir informaci√≥n (incluye enlace al cat√°logo) o ‚ÄúEnviar como vendedor‚Äù para compartir el cat√°logo con un cliente.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "cart-item";
        row.setAttribute("data-id", it.id);

        const left = document.createElement("div");
        left.className = "cart-item-left";

        const p = productById.get(String(it.id));
        const imgFilename = (p && p.imgFilename) ? p.imgFilename : it.imgFilename;

        left.appendChild(makeCartThumbFromFilename(imgFilename, it.name));

        const main = document.createElement("div");
        main.className = "cart-item-main";
        main.innerHTML = `<p class="cart-item-name"></p><p class="cart-item-sub"></p>`;
        main.querySelector(".cart-item-name").textContent = it.name;
        main.querySelector(".cart-item-sub").textContent = `Id: ${it.id} ¬∑ Precio: ${fmtCOP.format(Number(it.price)||0)}`;
        left.appendChild(main);

        const controls = document.createElement("div");
        controls.className = "cart-controls";
        controls.innerHTML = `
          <button class="cart-qty-btn" type="button" data-act="dec" aria-label="Disminuir">‚àí</button>
          <span class="cart-qty" aria-label="Cantidad">${it.qty}</span>
          <button class="cart-qty-btn" type="button" data-act="inc" aria-label="Aumentar">+</button>
        `;

        const subtotalEl = document.createElement("div");
        subtotalEl.className = "cart-subtotal";
        subtotalEl.textContent = fmtCOP.format((Number(it.price)||0) * (Number(it.qty)||0));

        const remove = document.createElement("button");
        remove.className = "cart-remove";
        remove.type = "button";
        remove.textContent = "Eliminar";
        remove.setAttribute("data-act", "remove");

        row.appendChild(left);
        row.appendChild(controls);
        row.appendChild(subtotalEl);
        row.appendChild(remove);
        frag.appendChild(row);
      });

      cartItemsEl.innerHTML = "";
      cartItemsEl.appendChild(frag);
    }

    cartItemsEl.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const itemRow = e.target.closest(".cart-item");
      if(!itemRow) return;
      const id = itemRow.getAttribute("data-id");
      if(!id || !cart[id]) return;

      const act = btn.getAttribute("data-act");
      let newQty = safeInt(cart[id].qty, 0);

      if(act === "inc") newQty += 1;
      if(act === "dec") newQty = Math.max(0, newQty - 1);
      if(act === "remove") newQty = 0;

      if(!newQty) delete cart[id];
      else cart[id].qty = newQty;

      saveCart();
      renderCartModal();
      refreshVisibleCardsFromCart();
      updateClientTotalPreview();
    });

    function refreshVisibleCardsFromCart(){
      try{
        document.querySelectorAll(".card").forEach(card=>{
          const id = card.dataset.id;
          if(!id) return;
          const p = productById.get(String(id));
          if(p) refreshCardUI(card, p);
        });
      }catch(_){}
    }

    // ====== Render cat√°logo ======
    const catSel = document.getElementById("cat");
    const brandSel = document.getElementById("brand");
    const sortSel = document.getElementById("sort");
    const qInp = document.getElementById("q");
    const grid = document.getElementById("grid");
    const countEl = document.getElementById("count");

    const cardTemplate = document.createElement("template");
    cardTemplate.innerHTML = `
      <article class="card">
        <div class="img"></div>
        <div class="pad">
          <h3 class="name"></h3>
          <p class="meta"></p>
          <div class="row">
            <span class="price"></span>
            <span class="pill" data-role="qty"></span>
          </div>
          <div class="actions">
            <button type="button" class="btn-danger" data-act="dec">Quitar</button>
            <button type="button" class="btn-acc" data-act="inc">Agregar</button>
          </div>
        </div>
      </article>
    `;

    function fillSelect(sel, values, firstLabel){
      sel.innerHTML = "";
      const first = document.createElement("option");
      first.value = "";
      first.textContent = firstLabel;
      sel.appendChild(first);
      for(const v of values){
        const opt = document.createElement("option");
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      }
    }

    function stockMetaText(p){
      return `${p.category} ¬∑ ${p.brand} ¬∑ Id: ${p.id}`;
    }

    function refreshCardUI(card, p){
      const id = String(p.id);
      const q = (cart[id]?.qty || 0);
      const qtyPill = card.querySelector('[data-role="qty"]');
      const decBtn = card.querySelector('button[data-act="dec"]');
      if(qtyPill) qtyPill.textContent = `En carrito: ${q}`;
      if(decBtn) decBtn.disabled = q <= 0;
    }

    function makeCard(p){
      const card = cardTemplate.content.firstElementChild.cloneNode(true);
      card.id = "p-" + p.id;
      card.dataset.id = String(p.id);

      const imgBox = card.querySelector(".img");
      imgBox.appendChild(makeImgFromFilename(p.imgFilename, p.name));

      card.querySelector(".name").textContent = p.name;
      card.querySelector(".meta").textContent = stockMetaText(p);
      card.querySelector(".price").textContent = fmtCOP.format(p.price);

      refreshCardUI(card, p);
      return card;
    }

    function buildFilteredList(){
      const cat = catSel.value;
      const br = brandSel.value;
      const sortMode = sortSel.value;
      const terms = normalizeText(qInp.value).split(/\s+/).filter(Boolean);

      let filtered = all.filter(p=>{
        if(cat && p.category !== cat) return false;
        if(br && p.brand !== br) return false;
        if(terms.length) return terms.every(t => p.searchKey.includes(t));
        return true;
      });

      if(sortMode === "price_asc"){
        filtered.sort((a,b)=> (a.price||0) - (b.price||0) || String(a.id).localeCompare(String(b.id)));
      }else if(sortMode === "price_desc"){
        filtered.sort((a,b)=> (b.price||0) - (a.price||0) || String(a.id).localeCompare(String(b.id)));
      }else if(sortMode === "name_asc"){
        filtered.sort((a,b)=>{
          const cmp = String(a.name||"").localeCompare(String(b.name||""), "es", { sensitivity:"base" });
          return cmp !== 0 ? cmp : String(a.id).localeCompare(String(b.id));
        });
      }
      return filtered;
    }

    let _renderToken = 0;
    function render(){
      const token = ++_renderToken;
      const filtered = buildFilteredList();

      countEl.textContent = (filtered.length === 0)
        ? "0 producto(s) encontrado(s)."
        : `Se encontraron ${filtered.length} producto(s).`;

      grid.textContent = "";
      const CHUNK = 60;
      let i = 0;
      function drawChunk(){
        if(token !== _renderToken) return;
        const frag = document.createDocumentFragment();
        const end = Math.min(i + CHUNK, filtered.length);
        for(; i < end; i++){
          frag.appendChild(makeCard(filtered[i]));
        }
        grid.appendChild(frag);
        if(i < filtered.length) requestAnimationFrame(drawChunk);
      }
      drawChunk();

      updateClientTotalPreview();
    }

    grid.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const card = e.target.closest(".card");
      if(!card) return;
      const id = card.dataset.id;
      if(!id) return;

      const p = productById.get(String(id));
      if(!p) return;

      const act = btn.getAttribute("data-act");
      if(act === "inc"){
        const cur = cart[id] || { id:p.id, name:p.name, price:p.price, qty:0, imgFilename:p.imgFilename || null };
        cur.qty = safeInt(cur.qty, 0) + 1;
        cur.name = p.name;
        cur.price = p.price;
        cur.imgFilename = p.imgFilename || null;
        cart[id] = cur;
        saveCart();
        refreshCardUI(card, p);
        if(cartModal.classList.contains("open")) renderCartModal();
        updateClientTotalPreview();
        return;
      }
      if(act === "dec"){
        const cur = cart[id];
        if(!cur) return;
        cur.qty = Math.max(0, safeInt(cur.qty, 0) - 1);
        if(!cur.qty) delete cart[id];
        else cart[id] = cur;
        saveCart();
        refreshCardUI(card, p);
        if(cartModal.classList.contains("open")) renderCartModal();
        updateClientTotalPreview();
      }
    });

    qInp.addEventListener("input", ()=>{
      clearTimeout(qInp._t);
      qInp._t = setTimeout(render, 80);
    });
    catSel.addEventListener("change", render);
    brandSel.addEventListener("change", render);
    sortSel.addEventListener("change", render);

    function bootstrapFromProducts(products){
      all = products || [];
      productById = new Map(all.map(p => [String(p.id), p]));

      const cats = [...new Set(all.map(p=>p.category).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"es",{sensitivity:"base"}));
      const brands = [...new Set(all.map(p=>p.brand).filter(Boolean))].sort((a,b)=>a.localeCompare(b,"es",{sensitivity:"base"}));
      fillSelect(catSel, cats, "Todas las categor√≠as");
      fillSelect(brandSel, brands, "Todas las marcas");

      refreshCartCount();
      render();
    }

    async function init(){
      try{
        countEl.textContent = "Cargando productos‚Ä¶";
        const cached = readProductsCache(true);
        if(cached && cached.products && cached.products.length){
          bootstrapFromProducts(cached.products);

          setTimeout(async ()=>{
            try{
              const fresh = await loadProductsFresh();
              writeProductsCache(fresh);
              bootstrapFromProducts(fresh);
            }catch(_){}
          }, cached.isFresh ? 2500 : 800);
          return;
        }

        const fresh = await loadProductsFresh();
        writeProductsCache(fresh);
        bootstrapFromProducts(fresh);

      }catch(_){
        countEl.textContent = "No se pudo cargar el cat√°logo. Verifica tu conexi√≥n e intenta recargar.";
        grid.innerHTML = "";
        refreshCartCount();
      }
    }
    init();
  </script>

  <script>
    /* ==========================================================
       ‚úÖ GUARDADO DE COORDENADAS (√öNICO LOG QUE QUEDA)
       - No guarda pedidos, no guarda carrito, solo coordenadas.
       ========================================================== */

    const HABILITAR_UBICACION_GPS = true;

    const LOCATION_LOG_ENDPOINT = "https://script.google.com/macros/s/AKfycbygXijUyDrpyeA8qmheyZpYw9HVWuN_JZPIeYNbqRKKNYhqFFUguEMZmof4yLTtGbVO/exec";

    const LOCATION_MODE = "LOAD"; // "LOAD" o "INTERVAL"
    const LOCATION_LOG_INTERVAL_MINUTES = 1;

    (function(){
      if(!HABILITAR_UBICACION_GPS) return;

      function canGeo(){ return ("geolocation" in navigator); }

      function sendCoord(lat, lng, acc){
        try{
          const payload = new URLSearchParams({
            lat: String(lat ?? ""),
            lng: String(lng ?? ""),
            acc: String(acc ?? ""),
            ts: String(Date.now()),
            cb: Math.random().toString(36).slice(2)
          });
          const url = LOCATION_LOG_ENDPOINT + "?" + payload.toString();

          if(navigator.sendBeacon){
            try{
              const blob = new Blob([], { type: "text/plain" });
              navigator.sendBeacon(url, blob);
              return;
            }catch(_){}
          }
          fetch(url, { method:"GET", mode:"no-cors", cache:"no-store", keepalive:true })
            .catch(()=>{ try{ const img = new Image(); img.src = url; }catch(_){ } });
        }catch(_){}
      }

      function logOnce(){
        try{
          if(!canGeo()){
            sendCoord("", "", "");
            return;
          }
          navigator.geolocation.getCurrentPosition(
            (pos)=>{
              const c = pos && pos.coords;
              if(!c){ sendCoord("", "", ""); return; }
              sendCoord(c.latitude, c.longitude, c.accuracy);
            },
            (_err)=>{
              sendCoord("", "", "");
            },
            { enableHighAccuracy:true, timeout:30000, maximumAge: 0 }
          );
        }catch(_){
          sendCoord("", "", "");
        }
      }

      function startTracking(){
        const intervalMs = Math.max(1, Number(LOCATION_LOG_INTERVAL_MINUTES) || 5) * 60 * 1000;
        const m = String(LOCATION_MODE || "").toUpperCase();

        if(m === "INTERVAL"){
          logOnce();
          setInterval(logOnce, intervalMs);
        }else{
          logOnce();
        }
      }

      if (document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", startTracking, { once:true });
      }else{
        startTracking();
      }
    })();
  </script>
</body>
</html>
