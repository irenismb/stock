<!doctype html>
<!-- Necesito aplicar los cambios solicitados al carrito y a los modales (Direcci√≥n y Otros datos) solo ajustando maquetaci√≥n/HTML/CSS m√≠nimo y textos, sin cambiar la l√≥gica del carrito, sin romper funcionalidades, sin perder informaci√≥n visible y sin alterar el estado ni el formato de guardado en localStorage. -->
<html lang="es-CO">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta http-equiv="x-dns-prefetch-control" content="on" />
  <title>Irenismb Stock Natura | Cat√°logo en Santa Marta | Compra por WhatsApp</title>
  <meta name="description" content="Cat√°logo Natura en Santa Marta: fragancias, cuidado personal, maquillaje y m√°s. Compra f√°cil por WhatsApp." />
  <meta name="robots" content="index,follow,max-image-preview:large,max-snippet=-1,max-video-preview=-1" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="format-detection" content="telephone=no" />
  <link rel="canonical" href="https://irenismb.github.io/stock/natura/catalogo.html" />
  <link rel="alternate" hreflang="es-CO" href="https://irenismb.github.io/stock/natura/catalogo.html" />

  <link rel="icon" type="image/webp" href="logos/logo_empresa.webp" />
  <link rel="icon" type="image/png" href="logos/logo_empresa.png" />
  <link rel="apple-touch-icon" href="logos/logo_empresa.png" />

  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://irenismb.github.io/stock/natura/catalogo.html" />
  <meta property="og:title" content="Irenismb Stock Natura | Cat√°logo con compra por WhatsApp" />
  <meta property="og:description" content="Explora el cat√°logo Natura en Santa Marta. Compra f√°cil por WhatsApp." />
  <meta property="og:image" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.png" />
  <meta property="og:image:secure_url" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="800" />
  <meta property="og:image:height" content="800" />
  <meta property="og:image:alt" content="Logo Irenismb Stock Natura" />
  <meta property="og:image" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.webp" />
  <meta property="og:image:secure_url" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.webp" />
  <meta property="og:image:type" content="image/webp" />
  <meta property="og:image:width" content="800" />
  <meta property="og:image:height" content="800" />
  <meta property="og:image:alt" content="Logo Irenismb Stock Natura" />
  <meta property="og:site_name" content="Irenismb Stock Natura" />
  <meta property="og:locale" content="es_CO" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Irenismb Stock Natura | Cat√°logo" />
  <meta name="twitter:description" content="Cat√°logo Natura en Santa Marta. Compra f√°cil por WhatsApp." />
  <meta name="twitter:image" content="https://irenismb.github.io/stock/natura/logos/logo_empresa.png" />
  <meta name="twitter:image:alt" content="Logo Irenismb Stock Natura" />

  <link rel="dns-prefetch" href="//web.whatsapp.com" />
  <link rel="preconnect" href="https://web.whatsapp.com" crossorigin />
  <link rel="preconnect" href="https://api.github.com" crossorigin />

  <link rel="preload" as="image" href="logos/logo_empresa.webp" type="image/webp" fetchpriority="high" />
  <link rel="preload" as="image" href="logos/logo_empresa.png" type="image/png" fetchpriority="high" />
  <link rel="preload" as="image" href="logos/suplente.webp" type="image/webp" fetchpriority="high" />
  <link rel="preload" as="image" href="logos/suplente.png" type="image/png" fetchpriority="high" />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --txt:#e7edf5;
      --mut:#a9b4c2;
      --acc:#20c997;
      --br:14px;
      --line:#22304a;
      --focus:#60a5fa;
      --pill:#0e1524;
      --danger:#ef4444;

      --social-size: clamp(26px, 8.5vw, 38px);
      --social-gap: clamp(3px, 1.6vw, 10px);

      --count-blink:#facc15;
      --count-blink-2:#fb7185;
    }

    *{box-sizing:border-box}
    html,body{max-width:100%;overflow-x:hidden}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#0b0f14,#0c1220);
      color:var(--txt);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto}

    .site-header{ padding:16px 16px 10px; }
    .site-header-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      border:1px solid var(--line);
      background:rgba(18,24,38,.55);
      border-radius:18px;
      padding:12px 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:260px;
    }
    .brand img{
      width:52px;height:52px;border-radius:16px;
      object-fit:cover;
      background:#0b1220;
      border:1px solid rgba(255,255,255,.06);
      display:block;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .brand p{
      margin:3px 0 0;
      font-size:12.5px;
      color:var(--mut);
      line-height:1.35;
    }
    .badge{
      border-radius:999px;
      background:linear-gradient(90deg,#22c55e,#a3e635);
      padding:6px 14px;
      font-size:12px;
      color:#052e16;
      font-weight:800;
      white-space:nowrap;
    }

    header .intro{ padding:14px 16px 8px; }
    .about-card{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(18,24,38,.55);
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .about-text{
      margin:0;
      font-size:12px;
      line-height:1.35;
    }
    .about-toggle{
      align-self:flex-start;
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
    }

    @media (max-width:768px){
      .about-text{ font-size:11px; }
      .about-card.about-collapsed .about-text{
        display:-webkit-box;
        -webkit-box-orient:vertical;
        -webkit-line-clamp:2;
        overflow:hidden;
      }
      #aboutText{ text-align:center; }
      .about-toggle{ align-self:center; }
    }
    @media (min-width:769px){
      .about-toggle{ display:none; }
    }

    .bar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    input,select,button,textarea{
      border-radius:12px;border:1px solid #263246;background:var(--pill);
      color:var(--txt);padding:10px 12px;font-size:14px
    }
    input,textarea{flex:1;min-width:220px}
    button{cursor:pointer}
    button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
      outline:2px solid var(--focus);
      outline-offset:2px;
    }

    .search-wrap{
      position:relative;
      flex:1 1 220px;
      min-width:220px;
      --marquee-distance: 0px;
      --marquee-duration: 14s;
    }
    .search-wrap input{ width:100%; }
    .search-ticker{
      position:absolute;
      inset:0;
      border-radius:12px;
      display:flex;
      align-items:center;
      padding:10px 12px;
      overflow:hidden;
      pointer-events:none;
      z-index:2;
      opacity:0;
      transition:opacity .15s ease;
      color:var(--mut);
    }
    .search-wrap.show-ticker .search-ticker{ opacity:1; }
    .search-wrap.show-ticker input::placeholder{ color:transparent; }

    .ticker-inner{
      display:flex;
      width:max-content;
      will-change:transform;
      transform:translate3d(0,0,0);
      animation: marquee var(--marquee-duration) linear infinite;
    }
    .ticker-seq{
      display:flex;
      align-items:center;
      width:max-content;
    }
    .ticker-item{
      white-space:nowrap;
      padding-right:48px;
    }
    @keyframes marquee{
      from{ transform: translate3d(0,0,0); }
      to{ transform: translate3d(calc(-1 * var(--marquee-distance)),0,0); }
    }
    @media (prefers-reduced-motion: reduce){
      .ticker-inner{ animation:none; transform:none; }
    }

    .btn-acc{
      background:linear-gradient(90deg,#20c997,#2dd4bf);
      border:none;color:#04120d;font-weight:900;
    }
    .btn-acc.in-cart{
      background: linear-gradient(90deg,#f59e0b,#f97316);
      color:#1f1300;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid #2a3b5c;
      color:var(--txt);
      font-weight:800;
    }
    .btn-danger{
      background:transparent;
      border:1px solid rgba(239,68,68,.55);
      color:#fecaca;
      font-weight:900;
    }
    button:disabled, a.btn-disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .social-icons{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:var(--social-gap);
      flex-wrap:nowrap;
      margin-top:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(18,24,38,.45);
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .social-icons::-webkit-scrollbar{ display:none; }
    .social-icons a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:var(--social-size);
      height:var(--social-size);
      border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(11,18,32,.35);
      text-decoration:none;
      flex:0 0 auto;
    }
    .social-icons a:hover{border-color:#3b82f6}
    .social-icons img{
      width:calc(var(--social-size) * 0.58);
      height:calc(var(--social-size) * 0.58);
      object-fit:contain;
      border-radius:999px;
      display:block;
    }
    .social-icons picture{ display:block; line-height:0; }
    .social-icons svg{
      width:calc(var(--social-size) * 0.58);
      height:calc(var(--social-size) * 0.58);
      fill:var(--txt);
      display:block;
    }

    main{max-width:1100px;margin:0 auto;padding:0 16px 20px}
    .topline{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding:10px 0 6px;
    }
    .topline.hidden{ display:none; }

    .count{
      font-size:12px;
      color:var(--mut);
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background:rgba(11,18,32,.18);
      max-width:100%;
    }

    .count-slot{
      display:none;
      width:100%;
    }

    @keyframes countBlink{
      0%, 100%{
        opacity:1;
        transform:translateY(0);
        text-shadow:
          0 0 10px rgba(250,204,21,.55),
          0 0 22px rgba(251,113,133,.35);
        border-color: rgba(250,204,21,.35);
      }
      50%{
        opacity:.28;
        transform:translateY(-.5px);
        text-shadow:
          0 0 2px rgba(250,204,21,.22),
          0 0 8px rgba(251,113,133,.22);
        border-color: rgba(251,113,133,.25);
      }
    }
    .count.search-active{
      color:var(--count-blink);
      font-weight:950;
      background:linear-gradient(90deg, rgba(250,204,21,.14), rgba(251,113,133,.10));
      animation: countBlink 1.15s ease-in-out infinite;
    }
    @media (prefers-reduced-motion: reduce){
      .count.search-active{ animation:none; opacity:1; }
    }

    .grid{
      display:grid;
      gap:12px;
      margin-top:12px;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      align-items:stretch;
    }
    @media (max-width:1024px){
      .grid{ grid-template-columns:repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width:760px){
      .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width:420px){
      .grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width:360px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:rgba(18,24,38,.92);
      border:1px solid var(--line);
      border-radius:var(--br);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      height:100%;
      align-self:stretch;
      content-visibility:auto;
      contain-intrinsic-size: 420px 520px;
    }

    .img{
      position:relative;
      width:100%;
      background:#0b1220;
      border-bottom:1px solid var(--line);
      overflow:hidden;
    }
    .img::before{
      content:"";
      display:block;
      padding-top:100%;
    }
    .img > img{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      max-width:calc(100% - 16px);
      max-height:calc(100% - 16px);
      width:auto;
      height:auto;
      object-fit:contain;
      display:block;
      cursor:zoom-in;
    }

    .pad{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1 1 auto;
      min-height:0;
    }

    .name{font-weight:950;margin:0;font-size:15px;line-height:1.25}
    .meta{color:var(--mut);font-size:12px;margin:0;line-height:1.35}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .price{font-weight:950}

    .pill{
      display:inline-block;font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid #2a3b5c;color:var(--mut);
      background:rgba(11,18,32,.35);
      white-space:nowrap;
    }

    #cartCount{
      margin-left:8px;
      border-color: rgba(0,0,0,.18);
      background: rgba(255,255,255,.25);
      color:#04120d;
    }
    #cartCount.has-items{
      background: linear-gradient(90deg,#f59e0b,#f97316);
      color:#1f1300;
      border-color: rgba(0,0,0,.25);
    }

    .actions{
      margin-top:auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .actions button{
      width:100%;
      min-width:0;
      white-space:nowrap;
    }

    .cart-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .cart-modal.open{display:flex}
    .cart-modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.75);
    }
    .cart-modal-content{
      position:relative;
      z-index:1;
      width:min(640px, 94vw);
      max-height:86vh;
      background:rgba(18,24,38,.98);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 28px 70px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .cart-modal-header{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(11,18,32,.35);
      min-width:0;
    }
    .cart-modal-title{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.02em;
      min-width:0;
    }
    .cart-modal-close{
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,32,.35);
      color:var(--txt);
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      flex:0 0 auto;
    }
    .cart-modal-body{
      padding:12px 14px;
      overflow:auto;
      min-width:0;
    }
    .cart-empty{
      padding:10px 12px;
      border:1px dashed #2a3b5c;
      border-radius:14px;
      color:var(--mut);
      background:rgba(11,18,32,.25);
      line-height:1.45;
    }
    .cart-item{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(11,18,32,.28);
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      min-width:0;
    }
    .cart-item-left{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1 1 280px;
      min-width:220px;
      min-width:0;
    }

    .cart-thumb{
      width:46px;
      height:46px;
      border-radius:12px;
      object-fit:contain;
      background:#0b1220;
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      cursor:zoom-in;
      display:block;
    }

    .cart-item-main{
      flex:1 1 auto;
      min-width:0;
    }
    .cart-item-name{
      font-weight:950;
      margin:0 0 4px;
      font-size:13.5px;
      line-height:1.25;
      word-break:break-word;
    }
    .cart-item-sub{
      margin:0;
      color:var(--mut);
      font-size:12px;
      line-height:1.3;
      word-break:break-word;
    }
    .cart-controls{
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(18,24,38,.55);
      border:1px solid #2a3b5c;
      border-radius:999px;
      padding:6px 8px;
      min-width:0;
    }
    .cart-qty-btn{
      width:32px;height:32px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,18,32,.25);
      color:var(--txt);
      font-size:16px;
      font-weight:900;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      flex:0 0 auto;
    }
    .cart-qty-btn:disabled{
      opacity:.45;
      cursor:not-allowed;
    }
    .cart-qty{
      min-width:26px;
      text-align:center;
      font-weight:950;
      color:var(--txt);
      font-size:13px;
    }
    .cart-subtotal{
      font-weight:950;
      white-space:nowrap;
      color:var(--txt);
      flex:0 0 auto;
    }
    .cart-remove{
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(239,68,68,.55);
      background:rgba(239,68,68,.10);
      color:#fecaca;
      font-weight:950;
      cursor:pointer;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .cart-modal-footer{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:flex-start;
      gap:10px;
      background:rgba(11,18,32,.35);
      min-width:0;
    }
    .cart-total{
      font-weight:950;
      color:var(--txt);
      width:100%;
    }
    .cart-shipping{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      min-width:0;
    }
    .cart-shipping label{
      color:var(--mut);
      font-size:12px;
      font-weight:900;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .cart-shipping input{
      width:100%;
      min-width:0;
      flex:1 1 auto;
      text-align:right;
      padding:10px 12px;
      font-weight:900;
    }

    .cart-footer-actions{
      width:100%;
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
      justify-items:stretch;
      align-items:stretch;
      min-width:0;
      justify-content:center;
    }
    .cart-footer-actions > *{
      width:100%;
      min-width:0;
      white-space:normal;
      line-height:1.2;
      word-break:break-word;
    }
    .cart-footer-actions > *:last-child:nth-child(odd){
      grid-column:1 / -1;
      max-width:320px;
      justify-self:center;
    }

    .form-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999; /* mismo z-index que carrito; el orden en el DOM la pone encima */
    }
    .form-modal.open{display:flex}
    .form-modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.78);
    }
    .form-modal-content{
      position:relative;
      z-index:1;
      width:min(720px, 94vw);
      max-height:86vh;
      background:rgba(18,24,38,.98);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 28px 70px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .form-modal-header{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:rgba(11,18,32,.35);
      min-width:0;
    }
    .form-modal-title{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.02em;
      min-width:0;
    }
    .form-modal-close{
      width:34px;height:34px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,18,32,.35);
      color:var(--txt);
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      flex:0 0 auto;
    }
    .form-modal-body{
      padding:12px 14px;
      overflow:auto;
      min-width:0;
    }
    .form-modal-footer{
      padding:12px 14px;
      border-top:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      background:rgba(11,18,32,.35);
      min-width:0;
      flex-wrap:wrap;
    }

    .addr-actions-top{
      padding:12px 14px 0;
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
      justify-items:stretch;
      align-items:stretch;
      min-width:0;
      background:rgba(18,24,38,.98);
    }
    .addr-actions-top > *{
      width:100%;
      min-width:0;
      white-space:normal;
      line-height:1.2;
      text-align:center;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:12px;
    }
    #addrMapsLink[aria-disabled="true"]{
      pointer-events:none;
      opacity:.55;
    }

    .client-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
      min-width:0;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .field label{
      font-size:12px;
      font-weight:900;
      color:var(--mut);
      line-height:1.2;
      white-space:normal;
      word-break:break-word;
    }
    .field input, .field select, .field textarea{
      width:100%;
      min-width:0;
    }
    .field textarea{
      resize:vertical;
      min-height:44px; /* antes muy alto; ahora ocupa una fila por defecto */
    }
    .span-2{ grid-column: 1 / -1; }

    .img-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
      overflow:hidden;
    }
    .img-modal.open{display:flex}
    .img-modal-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.80);
    }
    .img-modal-content{
      position:relative;
      z-index:1;
      width:100vw;
      height:100vh;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .img-modal-content img{
      max-width:100%;
      max-height:100%;
      width:auto;
      height:auto;
      object-fit:contain;
      border-radius:14px;
      background:#000;
      box-shadow:0 22px 60px rgba(0,0,0,.6);
      display:block;
    }
    .img-modal-close{
      position:absolute;
      z-index:2;
      top:10px;
      right:10px;
      width:38px;
      height:38px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(11,18,32,.55);
      color:var(--txt);
      font-size:18px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    #btn-cart .btn-cart-label-short{ display:none; }

    @media (max-width:560px){
      .bar{ align-items:stretch; row-gap:8px; }
      .bar .search-wrap{ flex:1 1 100%; min-width:0; }

      .count-slot{
        display:flex;
        justify-content:center;
        align-items:center;
        flex:1 1 100%;
        margin-top:-2px;
      }
      .count.count-mobile{
        display:block;
        width:100%;
        text-align:center;
        margin:0 auto;
      }

      #cat, #brand, #sort, #btn-cart{
        flex:1 1 calc(50% - 5px);
        min-width:0;
      }

      .bar select, .bar button{ min-height:44px; }

      #btn-cart{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        white-space:nowrap;
        overflow:visible;
        text-overflow:clip;
      }

      #btn-cart .btn-cart-label{ display:none; }
      #btn-cart .btn-cart-label-short{ display:inline; }

      .actions{ gap:8px; }
      .actions button{
        font-size:12.5px;
        padding:9px 8px;
        border-radius:10px;
      }
    }

    @media (max-width:720px){
      .badge{width:100%;text-align:center}
      .site-header-inner{padding:12px}
    }
    @media (max-width:420px){
      .name{ font-size:14px; }
      .meta{ font-size:11px; }
      .actions button{
        font-size:12px;
        padding:8px 7px;
      }
    }

    @media (prefers-reduced-motion: reduce){
      *{scroll-behavior:auto!important;transition:none!important;animation:none!important}
    }

    input::placeholder, textarea::placeholder{
      color: rgba(169,180,194,.78);
    }
  </style>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Store",
    "name":"Irenismb Stock Natura",
    "url":"https://irenismb.github.io/stock/natura/catalogo.html",
    "description":"Cat√°logo Natura en Santa Marta. Compra f√°cil por WhatsApp.",
    "telephone":"+57 304 208 8961",
    "address":{
      "@type":"PostalAddress",
      "streetAddress":"Calle 10A #20A-06 barrio Los Almendros",
      "addressLocality":"Santa Marta",
      "addressRegion":"Magdalena",
      "addressCountry":"CO"
    },
    "geo":{
      "@type":"GeoCoordinates",
      "latitude":11.244833370782679,
      "longitude":-74.19066001689564
    },
    "hasMap":"https://maps.google.com/?q=11.244833370782679,-74.19066001689564",
    "areaServed":"Colombia",
    "sameAs":[
      "https://www.facebook.com/marketplace/profile/100084865295132",
      "https://www.instagram.com/irenismb_stocknaturasm",
      "https://www.tiktok.com/@irenismbstocknatura",
      "https://www.youtube.com/@irenismendoza3615",
      "https://www.google.com/search?q=Vendedora+de+productos+de+belleza+Natura+y+Avon+en+Santa+Marta+-+NaturaStock+-+Consultora&stick=H4sIAAAAAAAA_y2MsQrCMBBAJ8XPOARHoaWJXt1KZ10KguM1uS6GO0kTqX6OX2oElwePB2-z3u6qBXkyk8UGPeLx0LSnamGqnTXGco0GnRk_q9uVxbPXSOAZHlF9dknnn4wcAr8JLpRyyS_onirAAgNJIjhTLNz_85DU3Yv1KnMOqfy-HB1A2oUAAAA&hl=es&mat=Ca0DNKJEuZnvElcBTVDHnhCRNO4f76He0gBHXwhbrob3GAaW6TYVDt7oFfRBvX8RXOdAY80UJzgwnY-lM1rJl0_0MhFuTJLig6PjtZcDFw8inJAS7CO2GHXYDb00SMyaaro&authuser=1&sei=HqiKafiVK4ubwbkPgpqnyAI"
    ]
  }
  </script>
  <script type="application/ld+json" id="ld-products">{}</script>
</head>

<body>
  <header class="site-header">
    <div class="wrap site-header-inner">
      <div class="brand">
        <picture>
          <source srcset="logos/logo_empresa.webp" type="image/webp">
          <img src="logos/logo_empresa.png" alt="Logo Irenismb Stock Natura" width="52" height="52" />
        </picture>
        <div>
          <h1>IRENISMB STOCK NATURA</h1>
          <p>Cat√°logo Natura en Santa Marta ‚Ä¢ Compra por WhatsApp</p>
        </div>
      </div>
      <div class="badge">Natura ¬∑ Maquillaje ¬∑ Cuidado personal</div>
    </div>

    <div class="wrap intro">
      <section class="about-card" id="aboutCard" aria-label="Sobre nosotros y contacto">
        <p class="small about-text" id="aboutText">
          Irenismb Stock Natura es una tienda en l√≠nea con punto f√≠sico en Santa Marta especializada en productos Natura, AVON y Esika.
          Te asesoramos por WhatsApp, v√≠a telef√≥nica o de manera presencial en el barrio los Almendros. Direcci√≥n: Calle 10A #20A-06. Tel√©fono: +57 304 208 8961.
          Realizamos env√≠os nacionales e Internacionales.
        </p>
        <button class="btn-ghost about-toggle" id="aboutToggle" type="button"
                aria-expanded="false" aria-controls="aboutText">
          Ver m√°s
        </button>
      </section>

      <div class="social-icons" aria-label="Redes sociales, ubicaci√≥n, WhatsApp y llamada">
        <a href="https://www.facebook.com/marketplace/profile/100084865295132" target="_blank" rel="noopener noreferrer" aria-label="Facebook">
          <img src="logos/facebook.webp" alt="Facebook" loading="lazy" decoding="async" />
        </a>
        <a href="https://www.instagram.com/irenismb_stocknaturasm" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <img src="logos/instagram.webp" alt="Instagram" loading="lazy" decoding="async" />
        </a>
        <a href="https://www.tiktok.com/@irenismbstocknatura" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
          <img src="logos/tiktok.webp" alt="TikTok" loading="lazy" decoding="async" />
        </a>

        <a href="https://www.youtube.com/@irenismendoza3615" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
          <picture>
            <source srcset="logos/youtube.webp" type="image/webp">
            <img src="logos/youtube.png" alt="YouTube" loading="lazy" decoding="async" />
          </picture>
        </a>

        <a href="https://maps.google.com/?q=11.244833370782679,-74.19066001689564" target="_blank" rel="noopener noreferrer" aria-label="Ubicaci√≥n en Google Maps">
          <img src="logos/maps.webp" alt="Google Maps" loading="lazy" decoding="async" />
        </a>

        <a href="https://www.google.com/search?q=Vendedora+de+productos+de+belleza+Natura+y+Avon+en+Santa+Marta+-+NaturaStock+-+Consultora&stick=H4sIAAAAAAAA_y2MsQrCMBBAJ8XPOARHoaWJXt1KZ10KguM1uS6GO0kTqX6OX2oElwePB2-z3u6qBXkyk8UGPeLx0LSnamGqnTXGco0GnRk_q9uVxbPXSOAZHlF9dknnn4wcAr8JLpRyyS_onirAAgNJIjhTLNz_85DU3Yv1KnMOqfy-HB1A2oUAAAA&hl=es&mat=Ca0DNKJEuZnvElcBTVDHnhCRNO4f76He0gBHXwhbrob3GAaW6TYVDt7oFfRBvX8RXOdAY80UJzgwnY-lM1rJl0_0MhFuTJLig6PjtZcDFw8inJAS7CO2GHXYDb00SMyaaro&authuser=1&sei=HqiKafiVK4ubwbkPgpqnyAI"
           target="_blank" rel="noopener noreferrer" aria-label="Google Business">
          <img src="logos/google_business.webp" alt="Google Business" loading="lazy" decoding="async" />
        </a>

        <a id="waTopLink" href="https://wa.me/573042088961" target="_blank" rel="noopener noreferrer" aria-label="WhatsApp">
          <img src="logos/whatsapp.webp" alt="WhatsApp" loading="lazy" decoding="async" />
        </a>
        <a href="tel:+573042088961" rel="nofollow" aria-label="Llamar">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.02-.24c1.12.37 2.33.57 3.57.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1C10.07 21 3 13.93 3 5a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.24.2 2.45.57 3.57a1 1 0 0 1-.24 1.02l-2.2 2.2z"/>
          </svg>
        </a>
      </div>

      <div class="bar" role="search" aria-label="Buscar y filtrar productos">
        <div class="search-wrap" id="searchWrap">
          <div class="search-ticker" id="searchTicker" aria-hidden="true">
            <div class="ticker-inner" id="tickerInner"></div>
          </div>

          <input id="q" type="search" inputmode="search"
                 placeholder="üîç Busca aqui, por nombre, marca, categor√≠a..."
                 aria-label="Buscar producto" />
        </div>

        <div class="count-slot" id="countSlot"></div>

        <select id="cat" aria-label="Filtrar por categor√≠a"><option value="">Todas las categor√≠as</option></select>
        <select id="brand" aria-label="Filtrar por marca"><option value="">Todas las marcas</option></select>
        <select id="sort" aria-label="Ordenar productos">
          <option value="">Ordenar</option>
          <option value="price_asc">Precio: menor a mayor</option>
          <option value="price_desc">Precio: mayor a mayor</option>
          <option value="name_asc">Nombre: A ‚Üí Z</option>
        </select>

        <button class="btn-acc" id="btn-cart" type="button" aria-label="Ver carrito WhatsApp">
          <span class="btn-cart-label">Ver carrito WhatsApp</span>
          <span class="btn-cart-label-short" aria-hidden="true">Carrito</span>
          <span id="cartCount" class="pill">0</span>
        </button>
      </div>

      <noscript>
        <div style="margin-top:12px;border:1px solid #22304a;border-radius:14px;padding:12px;background:rgba(18,24,38,.55);">
          <h2 style="margin:0 0 6px;font-size:16px;">Cat√°logo Natura en Santa Marta</h2>
          <p style="margin:0 0 8px;color:#a9b4c2;line-height:1.45;">
            Activa JavaScript para ver el cat√°logo completo.
          </p>
          <p style="margin:0;">
            <a href="https://wa.me/573042088961"
               rel="noopener noreferrer" target="_blank" style="font-weight:900;">
              Comprar por WhatsApp
            </a>
          </p>
        </div>
      </noscript>
    </div>
  </header>

  <main class="wrap">
    <div class="topline" id="topline">
      <div class="count" id="count" aria-live="polite">Cargando productos‚Ä¶</div>
    </div>
    <section id="grid" class="grid" aria-label="Productos"></section>
  </main>

  <div class="cart-modal" id="cartModal" aria-hidden="true" role="dialog" aria-label="Carrito">
    <div class="cart-modal-backdrop" id="cartModalBackdrop"></div>
    <div class="cart-modal-content" role="document" aria-label="Contenido del carrito">
      <div class="cart-modal-header">
        <h3 class="cart-modal-title">üõí Carrito</h3>
        <button class="cart-modal-close" id="cartModalClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="cart-modal-body">
        <div id="cartItems"></div>
      </div>
      <div class="cart-modal-footer">
        <div class="cart-shipping">
          <label for="shippingCop">Env√≠o</label>
          <input id="shippingCop" type="text" inputmode="numeric" placeholder="M√≠nimo 6.000" aria-label="Env√≠o en COP" />
        </div>

        <div class="cart-total" id="cartTotal">Total: $0</div>

        <div class="cart-footer-actions">
          <button class="btn-danger" id="cartClearBtn" type="button">Vaciar carrito</button>
          <button class="btn-ghost" id="cartAddressBtn" type="button">üìç Direcci√≥n</button>
          <button class="btn-ghost" id="cartClientBtn" type="button">üßæ Otros datos</button>
          <button class="btn-acc" id="cartBuyBtn" type="button">Comprar por WhatsApp</button>
        </div>
      </div>
    </div>
  </div>

  <div class="form-modal" id="addressModal" aria-hidden="true" role="dialog" aria-label="Direcci√≥n">
    <div class="form-modal-backdrop" id="addressModalBackdrop"></div>
    <div class="form-modal-content" role="document" aria-label="Contenido de direcci√≥n">
      <div class="form-modal-header">
        <h3 class="form-modal-title">üìç Direcci√≥n</h3>
        <button class="form-modal-close" id="addressModalClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="addr-actions-top" aria-label="Acciones direcci√≥n">
        <button class="btn-ghost" id="addrCancelBtn" type="button">Cancelar</button>
        <button class="btn-acc" id="addrSaveBtn" type="button">Guardar</button>
        <a class="btn-ghost" id="addrMapsLink" href="#" target="_blank" rel="noopener noreferrer" aria-disabled="true" tabindex="-1">Ver en mapa</a>
      </div>

      <div class="form-modal-body">
        <div class="client-grid">
          <div class="field">
            <label for="addrCity">Ciudad</label>
            <input id="addrCity" type="text" autocomplete="address-level2" placeholder="Ej: Santa Marta" />
          </div>
          <div class="field">
            <label for="addrRegion">Departamento</label>
            <input id="addrRegion" type="text" autocomplete="address-level1" placeholder="Ej: Magdalena" />
          </div>

          <div class="field">
            <label for="addrViaTipo">Tipo de v√≠a</label>
            <select id="addrViaTipo">
              <option value="">Ej: Calle / Carrera / Av</option>
              <option value="Cl">Calle (Cl)</option>
              <option value="Cra">Carrera (Cra)</option>
              <option value="Av">Avenida (Av)</option>
              <option value="Dg">Diagonal (Dg)</option>
              <option value="Tv">Transversal (Tv)</option>
            </select>
          </div>
          <div class="field">
            <label for="addrViaNum">N√∫mero</label>
            <input id="addrViaNum" type="text" inputmode="text" placeholder="Ej: 10A" />
          </div>

          <div class="field">
            <label for="addrPlaca">#/Placa</label>
            <input id="addrPlaca" type="text" inputmode="text" placeholder="Ej: 20A-06" />
          </div>
          <div class="field">
            <label for="addrBarrio">Barrio</label>
            <input id="addrBarrio" type="text" autocomplete="address-line2" placeholder="Ej: Los Almendros" />
          </div>

          <div class="field span-2">
            <label for="addrFinal">Direcci√≥n final</label>
            <input id="addrFinal" type="text" readonly />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="form-modal" id="clientModal" aria-hidden="true" role="dialog" aria-label="Otros datos">
    <div class="form-modal-backdrop" id="clientModalBackdrop"></div>
    <div class="form-modal-content" role="document" aria-label="Contenido de otros datos">
      <div class="form-modal-header">
        <h3 class="form-modal-title">üßæ Otros datos</h3>
        <button class="form-modal-close" id="clientModalClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="form-modal-body">
        <div class="client-grid">
          <div class="field">
            <label for="clientName">Nombre</label>
            <input id="clientName" type="text" autocomplete="name" placeholder="Ej: Juan P√©rez" />
          </div>
          <div class="field">
            <label for="clientPhone">Tel√©fono (WhatsApp)</label>
            <input id="clientPhone" type="tel" inputmode="tel" autocomplete="tel" placeholder="Ej: 3111234567" />
          </div>

          <div class="field span-2">
            <label for="clientObs">Observaci√≥n</label>
            <textarea id="clientObs" rows="1" placeholder="Ej: Dejar en porter√≠a, horario de entrega, pago por Nequi..."></textarea>
          </div>
        </div>
      </div>

      <div class="form-modal-footer">
        <button class="btn-ghost" id="clientCancelBtn" type="button">Cancelar</button>
        <button class="btn-acc" id="clientSaveBtn" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <div class="img-modal" id="imgModal" aria-hidden="true" role="dialog" aria-label="Imagen ampliada">
    <div class="img-modal-backdrop" id="imgModalBackdrop"></div>
    <button class="img-modal-close" id="imgModalClose" type="button" aria-label="Cerrar">‚úï</button>
    <div class="img-modal-content" role="document">
      <img id="imgModalImg" alt="Imagen ampliada del producto" />
    </div>
  </div>

  <script>
    const INTERRUPTORES = {
      MOSTRAR_CANTIDAD_STOCK: false,
      MOSTRAR_TEXTO_ESTADO_STOCK: false,
      HABILITAR_UBICACION_GPS: true,
      APLICAR_LIMITES_STOCK: false,
      MOSTRAR_IMAGENES_PRODUCTO: true,
      IMAGEN_SUPLENTE_PRODUCTO: "suplente.webp"
    };
    window.INTERRUPTORES = INTERRUPTORES;

    function shouldEnforceStockLimits(){
      return !!(window.INTERRUPTORES && window.INTERRUPTORES.APLICAR_LIMITES_STOCK === true);
    }
    function shouldShowProductImages(){
      return !!(window.INTERRUPTORES && window.INTERRUPTORES.MOSTRAR_IMAGENES_PRODUCTO !== false);
    }

    const _hasIdle = ("requestIdleCallback" in window);
    function runIdle(fn, timeout=1200){
      if(_hasIdle) return requestIdleCallback(fn, { timeout });
      return setTimeout(fn, Math.min(250, timeout));
    }

    const WHATSAPP_NUMBER = "573042088961";

    const IMG_DIR = "imagenes_de_productos";
    const LOGOS_DIR = "logos";

    const IMAGE_EXTS = ["webp","jpg","jpeg","png"];
    const NON_IMAGE_EXTS = ["txt"];
    const SUPPORTED_EXTS = [...IMAGE_EXTS, ...NON_IMAGE_EXTS];

    const fmtCOP = new Intl.NumberFormat("es-CO", { style:"currency", currency:"COP", maximumFractionDigits:0 });

    const SITE_BASE = new URL("./", document.baseURI).href;

    const COMPANY_LOGOS = [
      SITE_BASE + LOGOS_DIR + "/logo_empresa.webp",
      SITE_BASE + LOGOS_DIR + "/logo_empresa.png"
    ];
    const COMPANY_LOGO = COMPANY_LOGOS[0];

    function normalizeText(t){
      return (t || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }
    function toNumberDigits(s){
      return Number(String(s ?? "").replace(/[^\d]/g,"")) || 0;
    }
    function safeInt(s, def=0){
      const n = parseInt(String(s ?? "").replace(/[^\d]/g,""), 10);
      return Number.isFinite(n) ? n : def;
    }
    function extOf(filename){
      const i = String(filename || "").lastIndexOf(".");
      if(i < 0) return "";
      return String(filename).slice(i+1).toLowerCase();
    }
    function baseOf(filename){
      const s = String(filename || "");
      const i = s.lastIndexOf(".");
      return (i < 0) ? s : s.slice(0, i);
    }
    function encodePath(p){
      return String(p || "")
        .split("/")
        .map(seg => encodeURIComponent(seg))
        .join("/");
    }
    function isImageExt(ext){
      return IMAGE_EXTS.includes(String(ext || "").toLowerCase());
    }
    function leafName(p){
      const s = String(p || "");
      const parts = s.split("/");
      return parts[parts.length - 1] || s;
    }

    function sanitizeLogoFilename(input){
      const raw = String(input || "").trim();
      if(!raw) return "";
      const just = raw.split(/[\/\\]/).pop();
      if(!just || just.includes("..")) return "";
      return just.replace(/[^\w.\- ]+/g, "").trim();
    }

    function buildPlaceholderCandidates(){
      const list = [];
      const picked = sanitizeLogoFilename(window.INTERRUPTORES?.IMAGEN_SUPLENTE_PRODUCTO);

      if(picked){
        const e = extOf(picked);
        if(e){
          list.push(SITE_BASE + LOGOS_DIR + "/" + encodePath(picked));
        }else{
          list.push(SITE_BASE + LOGOS_DIR + "/" + encodePath(picked) + ".webp");
          list.push(SITE_BASE + LOGOS_DIR + "/" + encodePath(picked) + ".png");
        }
      }

      list.push(
        SITE_BASE + LOGOS_DIR + "/suplente.webp",
        SITE_BASE + LOGOS_DIR + "/suplente.png",
        ...COMPANY_LOGOS
      );

      return [...new Set(list)];
    }

    let PRODUCT_PLACEHOLDERS = buildPlaceholderCandidates();
    let PRODUCT_PLACEHOLDER_IMAGE = (PRODUCT_PLACEHOLDERS[0] || COMPANY_LOGO);

    function productPlaceholderAbsoluteUrl(){
      return PRODUCT_PLACEHOLDER_IMAGE || COMPANY_LOGO;
    }

    function productImageAbsoluteUrlFromFilename(filename){
      if(!shouldShowProductImages()){
        return productPlaceholderAbsoluteUrl();
      }
      if(!filename) return productPlaceholderAbsoluteUrl();
      return SITE_BASE + IMG_DIR + "/" + encodePath(filename);
    }

    async function fetchJson(url){
      const res = await fetch(url, {
        method:"GET",
        headers:{ "Accept":"application/vnd.github+json" },
        cache:"no-store",
        credentials:"omit"
      });
      if(!res.ok){
        const text = await res.text().catch(()=> "");
        throw new Error("HTTP " + res.status + " " + (text || ""));
      }
      return await res.json();
    }

    function warmupPlaceholderOnce(){
      return new Promise((resolve)=>{
        try{
          PRODUCT_PLACEHOLDERS = buildPlaceholderCandidates();

          let i = 0;
          const tryNext = ()=>{
            if(i >= PRODUCT_PLACEHOLDERS.length){
              PRODUCT_PLACEHOLDER_IMAGE = COMPANY_LOGO;
              resolve();
              return;
            }

            const url = PRODUCT_PLACEHOLDERS[i++];
            const test = new Image();
            test.onload = ()=>{
              PRODUCT_PLACEHOLDER_IMAGE = url;
              resolve();
            };
            test.onerror = tryNext;
            test.decoding = "async";
            test.loading = "eager";
            test.src = url;
          };

          tryNext();
        }catch(_){
          PRODUCT_PLACEHOLDER_IMAGE = COMPANY_LOGO;
          resolve();
        }
      });
    }

    function parseProductFromBaseName(baseName){
      const parts = String(baseName || "").split("_");
      if(parts.length < 6) return null;

      const id = String(parts[0] || "").trim();
      const qty = safeInt(parts[parts.length - 1], 0);
      const price = toNumberDigits(parts[parts.length - 2]);
      const category = String(parts[parts.length - 3] || "").trim();
      const brand = String(parts[parts.length - 4] || "").trim();
      const name = String(parts.slice(1, parts.length - 4).join("_") || "").trim();

      if(!id || !name) return null;

      return {
        id,
        name,
        category,
        brand,
        price,
        stock: Math.max(0, qty),
        searchKey: normalizeText(`${name} ${brand} ${category} ${id}`)
      };
    }

    function preferredExtScore(ext){
      const order = { webp:0, jpg:1, jpeg:2, png:3 };
      return (ext in order) ? order[ext] : 99;
    }

    const GITHUB_OWNER = "irenismb";
    const GITHUB_REPO = "stock";
    const GITHUB_PRODUCTS_PATH = "natura/imagenes_de_productos";

    const PRODUCTS_CACHE_KEY_V5 = "irenismb_products_cache_v5";
    const PRODUCTS_OLD_CACHE_KEYS = ["irenismb_products_cache_v4", "irenismb_products_cache_v3"];
    const PRODUCTS_CACHE_TTL_MS = 30 * 60 * 1000;

    function readProductsCacheObj(){
      const keys = [PRODUCTS_CACHE_KEY_V5, ...PRODUCTS_OLD_CACHE_KEYS];
      for(const key of keys){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) continue;
          const obj = JSON.parse(raw);
          if(!obj || typeof obj !== "object") continue;
          if(!Array.isArray(obj.products)) continue;
          if(!Number.isFinite(obj.ts)) continue;
          return { ...obj, _key: key };
        }catch(_){}
      }
      return null;
    }

    function readProductsCache(allowStale){
      const obj = readProductsCacheObj();
      if(!obj) return null;
      const age = Date.now() - obj.ts;
      const isFresh = age <= PRODUCTS_CACHE_TTL_MS;
      if(!allowStale && !isFresh) return null;
      return { products: obj.products, isFresh, fromKey: obj._key };
    }

    function writeProductsCache(products){
      try{
        localStorage.setItem(PRODUCTS_CACHE_KEY_V5, JSON.stringify({
          v: 5,
          ts: Date.now(),
          products: products || []
        }));
      }catch(_){}
    }

    function pickBetterRepresentative(existing, candidate){
      if(!existing) return candidate;

      const eImg = !!existing.hasImage;
      const cImg = !!candidate.hasImage;

      if(eImg && !cImg) return existing;
      if(!eImg && cImg) return candidate;

      if(eImg && cImg){
        const eExt = String(existing.fileExt || extOf(existing.srcFilename || existing.imgFilename || "")).toLowerCase();
        const cExt = String(candidate.fileExt || extOf(candidate.srcFilename || candidate.imgFilename || "")).toLowerCase();
        if(preferredExtScore(cExt) < preferredExtScore(eExt)) return candidate;
        return existing;
      }
      return existing;
    }

    async function fetchProductsViaTree(){
      const repoInfo = await fetchJson(`https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}`);
      const branch = String(repoInfo && repoInfo.default_branch ? repoInfo.default_branch : "main");
      const branchInfo = await fetchJson(`https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/branches/${encodeURIComponent(branch)}`);
      const sha = branchInfo && branchInfo.commit && branchInfo.commit.sha ? branchInfo.commit.sha : "";
      if(!sha) throw new Error("No se pudo obtener el SHA del branch.");

      const tree = await fetchJson(`https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/git/trees/${encodeURIComponent(sha)}?recursive=1`);
      const nodes = (tree && Array.isArray(tree.tree)) ? tree.tree : [];

      const dirPrefix = (GITHUB_PRODUCTS_PATH.replace(/\/+$/,"") + "/");

      const files = nodes
        .filter(n => n && n.type === "blob" && typeof n.path === "string" && n.path.startsWith(dirPrefix))
        .map(n => n.path.slice(dirPrefix.length))
        .filter(Boolean);

      const byId = new Map();
      for(const relPath of files){
        const leaf = leafName(relPath);
        const ext = extOf(leaf);
        if(!SUPPORTED_EXTS.includes(ext)) continue;

        const base = baseOf(leaf);
        const parsed = parseProductFromBaseName(base);
        if(!parsed) continue;

        const hasImage = isImageExt(ext);
        const candidate = {
          ...parsed,
          srcFilename: relPath,
          fileExt: ext,
          hasImage,
          imgFilename: hasImage ? relPath : null
        };

        const existing = byId.get(parsed.id);
        byId.set(parsed.id, pickBetterRepresentative(existing, candidate));
      }

      return Array.from(byId.values())
        .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "es", { sensitivity:"base" }) || String(a.id).localeCompare(String(b.id)));
    }

    async function listContentsFilesRecursive(path, depth=0){
      const MAX_DEPTH = 8;
      if(depth > MAX_DEPTH) return [];

      const url = `https://api.github.com/repos/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/contents/${encodePath(path)}`;
      const data = await fetchJson(url);

      if(!Array.isArray(data)) return [];

      const out = [];
      for(const it of data){
        if(!it || typeof it.type !== "string") continue;
        if(it.type === "file" && typeof it.path === "string"){
          out.push(it.path);
        }else if(it.type === "dir" && typeof it.path === "string"){
          const inner = await listContentsFilesRecursive(it.path, depth+1);
          for(const p of inner) out.push(p);
        }
      }
      return out;
    }

    async function fetchProductsViaContentsApi(){
      const fullPaths = await listContentsFilesRecursive(GITHUB_PRODUCTS_PATH);
      if(!Array.isArray(fullPaths) || !fullPaths.length){
        throw new Error("No se encontraron archivos en la carpeta de productos.");
      }

      const prefix = (GITHUB_PRODUCTS_PATH.replace(/\/+$/,"") + "/");
      const relPaths = fullPaths
        .filter(p => typeof p === "string" && p.startsWith(prefix))
        .map(p => p.slice(prefix.length))
        .filter(Boolean);

      const byId = new Map();

      for(const relPath of relPaths){
        const leaf = leafName(relPath);
        const ext = extOf(leaf);
        if(!SUPPORTED_EXTS.includes(ext)) continue;

        const base = baseOf(leaf);
        const parsed = parseProductFromBaseName(base);
        if(!parsed) continue;

        const hasImage = isImageExt(ext);
        const candidate = {
          ...parsed,
          srcFilename: relPath,
          fileExt: ext,
          hasImage,
          imgFilename: hasImage ? relPath : null
        };

        const existing = byId.get(parsed.id);
        byId.set(parsed.id, pickBetterRepresentative(existing, candidate));
      }

      return Array.from(byId.values())
        .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), "es", { sensitivity:"base" }) || String(a.id).localeCompare(String(b.id)));
    }

    async function loadProductsFresh(){
      try{
        return await fetchProductsViaTree();
      }catch(_){
        return await fetchProductsViaContentsApi();
      }
    }

    function isMobileDevice(){
      try{
        const ua = (navigator.userAgent || "").toLowerCase();
        const byUA = /android|iphone|ipad|ipod|iemobile|opera mini/.test(ua);
        const byPointer = window.matchMedia && window.matchMedia("(pointer:coarse)").matches;
        return Boolean(byUA || byPointer);
      }catch(_){
        return false;
      }
    }

    /* ==========================
       WhatsApp (se env√≠a al celular del cliente)
       ========================== */
    const LS_CLIENT_KEY = "irenismb_client_v2";
    const LS_ADDRESS_KEY = "irenismb_address_v3";
    const LS_SHIPPING_KEY = "irenismb_shipping_cop";
    const LS_WA_TO_KEY = "irenismb_whatsapp_to";

    function readJsonLS(key, fallbackObj){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallbackObj;
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object") return obj;
        return fallbackObj;
      }catch(_){
        return fallbackObj;
      }
    }
    function writeJsonLS(key, obj){
      try{ localStorage.setItem(key, JSON.stringify(obj || {})); }catch(_){}
    }
    function readStringLS(key, fallback=""){
      try{
        const raw = localStorage.getItem(key);
        if(raw == null) return fallback;
        return String(raw);
      }catch(_){
        return fallback;
      }
    }
    function writeStringLS(key, val){
      try{ localStorage.setItem(key, String(val ?? "")); }catch(_){}
    }

    function normalizeWhatsAppToE164Digits(input){
      let d = String(input ?? "").replace(/[^\d]/g,"");
      if(!d) return "";
      if(d.startsWith("00")) d = d.slice(2);
      if(d.length === 10) d = "57" + d; // Colombia por defecto
      if(d.length < 11 || d.length > 15) return "";
      return d;
    }

    function getWhatsAppTo(){
      const saved = readStringLS(LS_WA_TO_KEY, "");
      const norm = normalizeWhatsAppToE164Digits(saved);
      return norm || WHATSAPP_NUMBER;
    }

    function waLinkTo(toDigits, text){
      const msg = String(text || "");
      const to = String(toDigits || "");
      if (isMobileDevice()){
        return `https://wa.me/${encodeURIComponent(to)}${msg ? `?text=${encodeURIComponent(msg)}` : ""}`;
      }
      return `https://web.whatsapp.com/send?phone=${encodeURIComponent(to)}${msg ? `&text=${encodeURIComponent(msg)}` : ""}`;
    }
    function waLink(text){
      return waLinkTo(getWhatsAppTo(), text);
    }

    (function syncTopWhatsApp(){
      const a = document.getElementById("waTopLink");
      if (!a) return;
      a.href = waLink("");
      a.setAttribute("aria-label", isMobileDevice() ? "WhatsApp" : "WhatsApp Web");
    })();

    (function initAboutCollapse(){
      const card = document.getElementById("aboutCard");
      const btn = document.getElementById("aboutToggle");
      if(!card || !btn) return;
      const mq = window.matchMedia("(max-width:768px)");
      function setExpanded(expanded){
        card.classList.toggle("about-collapsed", !expanded);
        btn.setAttribute("aria-expanded", expanded ? "true" : "false");
        btn.textContent = expanded ? "Ver menos" : "Ver m√°s";
        card.dataset.expanded = expanded ? "1" : "0";
      }
      function apply(){
        if(mq.matches){
          btn.hidden = false;
          const expanded = (card.dataset.expanded === "1");
          setExpanded(expanded);
        }else{
          btn.hidden = true;
          card.classList.remove("about-collapsed");
        }
      }
      btn.addEventListener("click", ()=>{
        const expandedNow = (card.dataset.expanded === "1");
        setExpanded(!expandedNow);
      });
      if(typeof mq.addEventListener === "function"){
        mq.addEventListener("change", apply);
      }else if(typeof mq.addListener === "function"){
        mq.addListener(apply);
      }
      if(!card.dataset.expanded) card.dataset.expanded = "0";
      apply();
    })();

    const imgModal = document.getElementById("imgModal");
    const imgModalImg = document.getElementById("imgModalImg");
    const imgModalClose = document.getElementById("imgModalClose");
    const imgModalBackdrop = document.getElementById("imgModalBackdrop");

    let _modalLockCount = 0;
    function lockBodyScroll(){
      _modalLockCount++;
      document.body.style.overflow = "hidden";
    }
    function unlockBodyScroll(){
      _modalLockCount = Math.max(0, _modalLockCount - 1);
      if(_modalLockCount === 0) document.body.style.overflow = "";
    }

    function openImgModal(src, alt){
      if(!imgModal || !imgModalImg || !src) return;
      if(imgModal.classList.contains("open")) return;
      imgModalImg.src = src;
      imgModalImg.alt = alt || "Imagen ampliada del producto";
      imgModal.classList.add("open");
      imgModal.setAttribute("aria-hidden","false");
      lockBodyScroll();
    }
    function closeImgModal(){
      if(!imgModal || !imgModalImg) return;
      if(!imgModal.classList.contains("open")) return;
      imgModal.classList.remove("open");
      imgModal.setAttribute("aria-hidden","true");
      imgModalImg.src = "";
      unlockBodyScroll();
    }
    if(imgModalClose) imgModalClose.addEventListener("click", closeImgModal);
    if(imgModalBackdrop) imgModalBackdrop.addEventListener("click", closeImgModal);

    function makeImgFromFilename(filename, name){
      const img = document.createElement("img");
      img.alt = name ? ("Foto " + name) : "Foto del producto";
      img.loading = "lazy";
      img.decoding = "async";

      let zoomable = false;
      function setNonZoom(){
        zoomable = false;
        img.style.cursor = "default";
      }

      const allowReal = shouldShowProductImages() && Boolean(filename);

      if(!allowReal){
        img.src = productPlaceholderAbsoluteUrl();
        setNonZoom();
      }else{
        zoomable = true;
        img.src = productImageAbsoluteUrlFromFilename(filename);
      }

      img.onerror = ()=>{
        if(img.dataset.fallbackTried === "1"){
          img.onerror = null;
          img.src = COMPANY_LOGO;
          setNonZoom();
          return;
        }
        img.dataset.fallbackTried = "1";
        img.src = productPlaceholderAbsoluteUrl();
        setNonZoom();
      };

      img.addEventListener("click", ()=>{
        if(!zoomable) return;
        const src = img.currentSrc || img.src;
        if(src) openImgModal(src, img.alt);
      });

      return img;
    }

    function makeCartThumbFromFilename(filename, name){
      const img = document.createElement("img");
      img.className = "cart-thumb";
      img.alt = name ? ("Foto " + name) : "Foto del producto";
      img.loading = "lazy";
      img.decoding = "async";

      let zoomable = false;
      function setNonZoom(){
        zoomable = false;
        img.style.cursor = "default";
      }

      const allowReal = shouldShowProductImages() && Boolean(filename);

      if(!allowReal){
        img.src = productPlaceholderAbsoluteUrl();
        setNonZoom();
      }else{
        zoomable = true;
        img.src = productImageAbsoluteUrlFromFilename(filename);
      }

      img.onerror = ()=>{
        if(img.dataset.fallbackTried === "1"){
          img.onerror = null;
          img.src = COMPANY_LOGO;
          setNonZoom();
          return;
        }
        img.dataset.fallbackTried = "1";
        img.src = productPlaceholderAbsoluteUrl();
        setNonZoom();
      };

      img.addEventListener("click", ()=>{
        if(!zoomable) return;
        const src = img.currentSrc || img.src;
        if(src) openImgModal(src, img.alt);
      });

      return img;
    }

    let all = [];
    let productById = new Map();

    const cart = (() => {
      try{
        const rawCart = localStorage.getItem("cart");
        const parsed = JSON.parse(rawCart || "{}");
        return (parsed && typeof parsed === "object") ? parsed : {};
      }catch(_){
        localStorage.removeItem("cart");
        return {};
      }
    })();

    const cartCountEl = document.getElementById("cartCount");

    function cartItemsArray(){
      return Object.values(cart)
        .filter(it => it && it.qty > 0 && it.id && productById.has(String(it.id)));
    }
    function cartTotalValue(){
      return cartItemsArray().reduce((s,it)=> s + ((Number(it.price)||0) * (Number(it.qty)||0)), 0);
    }
    function cartTotalQty(){
      return cartItemsArray().reduce((s,it)=> s + (Number(it.qty)||0), 0);
    }
    function refreshCartCount(){
      if(!cartCountEl) return;
      const qty = cartTotalQty();
      cartCountEl.textContent = String(qty);
      cartCountEl.classList.toggle("has-items", qty > 0);
    }
    function saveCart(){
      localStorage.setItem("cart", JSON.stringify(cart));
      refreshCartCount();
    }

    function sanitizeCartWithStock(){
      const enforce = shouldEnforceStockLimits();
      let changed = false;

      for(const key of Object.keys(cart)){
        const it = cart[key];
        if(!it || !it.id){
          delete cart[key];
          changed = true;
          continue;
        }
        const id = String(it.id);
        const p = productById.get(id);
        if(!p){
          delete cart[key];
          changed = true;
          continue;
        }

        const maxStock = Number.isFinite(p.stock) ? p.stock : 0;
        const qty = Math.max(0, safeInt(it.qty, 0));

        const newQty = enforce
          ? ((maxStock > 0) ? Math.min(qty, maxStock) : 0)
          : qty;

        const newObj = {
          id: p.id,
          name: p.name,
          price: p.price,
          qty: newQty,
          stock: p.stock,
          imgFilename: p.imgFilename || null
        };

        cart[id] = newObj;
        if(id !== key) delete cart[key];

        if(newQty !== qty) changed = true;
      }

      if(changed) saveCart(); else refreshCartCount();
    }

    const shippingCopInp = document.getElementById("shippingCop");
    function getShippingCop(){
      const raw = (shippingCopInp ? shippingCopInp.value : readStringLS(LS_SHIPPING_KEY, "")) || "";
      return toNumberDigits(raw);
    }
	function loadShippingFromLS(){
	  if(!shippingCopInp) return;

	  const MIN_SHIPPING = 6000;

	  const raw = readStringLS(LS_SHIPPING_KEY, "");
	  const v = toNumberDigits(raw);

	  // Si no hay valor guardado, usar 6.000 por defecto (editable).
	  shippingCopInp.value = (v ? String(v) : String(MIN_SHIPPING));
	}
    function saveShippingToLS(){
      if(!shippingCopInp) return;
      const v = toNumberDigits(shippingCopInp.value);
      writeStringLS(LS_SHIPPING_KEY, v ? String(v) : "");
    }

    const STORE_INFO = {
      name: "IRENISMB STOCK NATURA",
      whatsappDisplay: "+57 304 208 8961",
      whatsappDigits: "573042088961",
      celularDisplay: "3114040809",
      direccion: "Calle 10A #20A-06, Santa Marta, Magdalena",
      barrio: "Los Almendros",
      mapa: "https://maps.google.com/?q=11.244833370782679,-74.19066001689564",
      catalogo: "https://irenismb.github.io/stock/natura/catalogo.html",
      referencias: "Entre la tienda Surtifruver y la tienda 5Y6, por la panader√≠a Madepan."
    };

    function buildLineItems(){
      const items = cartItemsArray();
      return items.map(it =>
        `* ${it.name} (Id: ${it.id}) x${it.qty} = ${fmtCOP.format((Number(it.price)||0) * (Number(it.qty)||0))}`
      );
    }

    function oneLineText(s){
      return String(s ?? "")
        .replace(/\r\n/g, "\n")
        .replace(/\n+/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function viaTypeLabel(tipo){
      const t = String(tipo || "").trim();
      const map = { Cl:"Calle", Cra:"Carrera", Av:"Avenida", Dg:"Diagonal", Tv:"Transversal" };
      return map[t] || t;
    }

    function buildViaString(tipo, num, placa){
      const t = viaTypeLabel(tipo);
      const n = String(num || "").trim();
      const p = String(placa || "").trim();
      if(t && n && p) return `${t} ${n} #${p}`;
      return joinParts([t, n, p ? `#${p}` : ""], " ");
    }

    function getClientDataCurrent(){
      const nameInp = document.getElementById("clientName");
      const phoneInp = document.getElementById("clientPhone");
      const obsInp = document.getElementById("clientObs");

      const obj = readJsonLS(LS_CLIENT_KEY, {});
      const name = String((nameInp && nameInp.value) ?? (obj.clientName ?? "")).trim();
      const phone = String((phoneInp && phoneInp.value) ?? (obj.clientPhone ?? "")).trim();
      const obs = String((obsInp && obsInp.value) ?? (obj.clientObs ?? ""));

      return { name, phone, obs };
    }

    function getAddressDataCurrent(){
      const obj = readJsonLS(LS_ADDRESS_KEY, {});

      const cityInp = document.getElementById("addrCity");
      const regionInp = document.getElementById("addrRegion");
      const tipoInp = document.getElementById("addrViaTipo");
      const numInp = document.getElementById("addrViaNum");
      const placaInp = document.getElementById("addrPlaca");
      const barrioInp = document.getElementById("addrBarrio");

      const city = String((cityInp && cityInp.value) ?? (obj.addrCity ?? "")).trim();
      const region = String((regionInp && regionInp.value) ?? (obj.addrRegion ?? "")).trim();
      const tipo = String((tipoInp && tipoInp.value) ?? (obj.addrViaTipo ?? "")).trim();
      const num = String((numInp && numInp.value) ?? (obj.addrViaNum ?? "")).trim();
      const placa = String((placaInp && placaInp.value) ?? (obj.addrPlaca ?? "")).trim();
      const barrio = String((barrioInp && barrioInp.value) ?? (obj.addrBarrio ?? "")).trim();

      const via = buildViaString(tipo, num, placa);
      const addressLine = joinParts([via, city, region], ", ");

      // IMPORTANTE: barrio NO se incluye en el enlace de Google Maps
      const mapLink = addressLine
        ? ("https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(addressLine))
        : "";

      return { addressLine, barrio, mapLink };
    }

    function buildBuyerMessage(){
      const items = cartItemsArray();
      const client = getClientDataCurrent();
      const addr = getAddressDataCurrent();

      const subtotal = cartTotalValue();
      const envio = getShippingCop();
      const total = subtotal + envio;

      const lines = [];

      lines.push("*INFORMACION DEL CLIENTE*");
      lines.push(`*Nombre:* ${client.name || ""}`.trimEnd());
      lines.push(`*Celular:* ${client.phone || ""}`.trimEnd());
      lines.push(`*Direcci√≥n:* ${addr.addressLine || ""}`.trimEnd());
      lines.push(`*Barrio:* ${addr.barrio || ""}`.trimEnd());
      lines.push(`*Mapa:* ${addr.mapLink || ""}`.trimEnd());
      lines.push(`*Observacion:* ${oneLineText(client.obs || "")}`.trimEnd());

      lines.push("");
      lines.push("*PRODUCTOS SOLICITADOS*");

      if(items.length){
        lines.push(...buildLineItems());
      }

      lines.push("");
      lines.push(`*Subtotal:* ${fmtCOP.format(subtotal)}`);
      lines.push(`*Env√≠o:* ${fmtCOP.format(envio)}`);
      lines.push(`*Total:* ${fmtCOP.format(total)}`);

      lines.push("");
      lines.push("*INFORMACION DE LA TIENDA*");
      lines.push(STORE_INFO.name);
      lines.push(`*Celular:* ${STORE_INFO.whatsappDisplay}`);
      lines.push(`*Direcci√≥n:* ${STORE_INFO.direccion}`);
      lines.push(`*Barrio:* ${STORE_INFO.barrio}`);
      lines.push(`*Mapa:* ${STORE_INFO.mapa}`);
      lines.push(`*Cat√°logo:* ${STORE_INFO.catalogo}`);
      lines.push(`*Puntos de referencia:* ${STORE_INFO.referencias}`);

      return lines.join("\n");
    }
    /* ======= FIN PARTE 1/2: contin√∫a en la PARTE 2/2 ======= */
    // Wrapper de compatibilidad (mantiene nombre previo sin barrio en el mapa)
    function getAddressDataFromLS(){
      const addr = getAddressDataCurrent();
      const mapDir = addr.addressLine
        ? ("https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(addr.addressLine))
        : "";
      return { addressLine: addr.addressLine, barrio: addr.barrio, mapDir };
    }

    // (Se deja por compatibilidad, aunque ya no se usa el bot√≥n "Vendedor")
    function buildSellerMessage(){
      const items = cartItemsArray();
      if(!items.length) return `Hola, soy ${STORE_INFO.name}.`;

      const subtotal = cartTotalValue();
      const envio = getShippingCop();
      const total = subtotal + envio;

      const storeMap = STORE_INFO.mapa
        ? STORE_INFO.mapa
        : ("https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(`${STORE_INFO.direccion}, Colombia`));

      const lines = [];
      lines.push(`Hola, soy ${STORE_INFO.name}.`);
      lines.push(`Celular: ${STORE_INFO.whatsappDisplay}`);
      lines.push(`Direcci√≥n: ${STORE_INFO.direccion}`);
      lines.push(`Barrio: ${STORE_INFO.barrio}`);
      lines.push(`Mapa: ${storeMap}`);
      lines.push("");
      lines.push(...buildLineItems());
      lines.push("");
      lines.push(`Subtotal: ${fmtCOP.format(subtotal)}`);
      lines.push(`Env√≠o: ${fmtCOP.format(envio)}`);
      lines.push(`Total: ${fmtCOP.format(total)}`);
      lines.push("");
      lines.push(`Cat√°logo: ${STORE_INFO.catalogo}`);

      return lines.join("\n");
    }

    const cartModal = document.getElementById("cartModal");
    const cartModalClose = document.getElementById("cartModalClose");
    const cartModalBackdrop = document.getElementById("cartModalBackdrop");
    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");
    const cartBuyBtn = document.getElementById("cartBuyBtn");
    const cartClearBtn = document.getElementById("cartClearBtn");
    const cartAddressBtn = document.getElementById("cartAddressBtn");
    const cartClientBtn = document.getElementById("cartClientBtn");

    function openCartModal(){
      if(cartModal.classList.contains("open")) return;
      renderCartModal();
      cartModal.classList.add("open");
      cartModal.setAttribute("aria-hidden", "false");
      lockBodyScroll();
    }
    function closeCartModal(){
      if(!cartModal.classList.contains("open")) return;
      cartModal.classList.remove("open");
      cartModal.setAttribute("aria-hidden", "true");
      unlockBodyScroll();
    }

    function renderCartModal(){
      const enforce = shouldEnforceStockLimits();
      const items = cartItemsArray();
      const total = cartTotalValue() + getShippingCop();
      cartTotalEl.textContent = "Total: " + fmtCOP.format(total);

      if(!items.length){
        cartItemsEl.innerHTML = `<div class="cart-empty">Carrito vac√≠o.</div>`;
        return;
      }

      const frag = document.createDocumentFragment();
      items.forEach(it=>{
        const row = document.createElement("div");
        row.className = "cart-item";
        row.setAttribute("data-id", it.id);

        const left = document.createElement("div");
        left.className = "cart-item-left";

        const p = productById.get(String(it.id));
        const imgFilename = (p && p.imgFilename) ? p.imgFilename : it.imgFilename;

        left.appendChild(makeCartThumbFromFilename(imgFilename, it.name));

        const main = document.createElement("div");
        main.className = "cart-item-main";
        main.innerHTML = `
          <p class="cart-item-name"></p>
          <p class="cart-item-sub"></p>
        `;
        main.querySelector(".cart-item-name").textContent = it.name;
        main.querySelector(".cart-item-sub").textContent = `Id: ${it.id} ¬∑ Precio: ${fmtCOP.format(Number(it.price)||0)}`;
        left.appendChild(main);

        const controls = document.createElement("div");
        controls.className = "cart-controls";
        controls.innerHTML = `
          <button class="cart-qty-btn" type="button" data-act="dec" aria-label="Disminuir">‚àí</button>
          <span class="cart-qty" aria-label="Cantidad">${it.qty}</span>
          <button class="cart-qty-btn" type="button" data-act="inc" aria-label="Aumentar">+</button>
        `;

        const incBtn = controls.querySelector('button[data-act="inc"]');
        const maxStock = Number.isFinite(it.stock) ? it.stock : 0;

        if(incBtn){
          incBtn.disabled = enforce ? (!(maxStock > 0) || (Number(it.qty)||0) >= maxStock) : false;
        }

        const subtotal = document.createElement("div");
        subtotal.className = "cart-subtotal";
        subtotal.textContent = fmtCOP.format((Number(it.price)||0) * (Number(it.qty)||0));

        const remove = document.createElement("button");
        remove.className = "cart-remove";
        remove.type = "button";
        remove.textContent = "Eliminar";
        remove.setAttribute("data-act", "remove");

        row.appendChild(left);
        row.appendChild(controls);
        row.appendChild(subtotal);
        row.appendChild(remove);
        frag.appendChild(row);
      });

      cartItemsEl.innerHTML = "";
      cartItemsEl.appendChild(frag);
    }

    cartItemsEl.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const itemRow = e.target.closest(".cart-item");
      if(!itemRow) return;
      const id = itemRow.getAttribute("data-id");
      if(!id || !cart[id]) return;

      const enforce = shouldEnforceStockLimits();
      const act = btn.getAttribute("data-act");
      const current = cart[id];

      const maxStock = Number.isFinite(current.stock) ? current.stock : 0;
      let newQty = safeInt(current.qty, 0);

      if(act === "inc"){
        if(!enforce){
          newQty += 1;
        }else{
          if(maxStock > 0 && newQty < maxStock) newQty += 1;
        }
      }
      if(act === "dec"){
        newQty = Math.max(0, newQty - 1);
      }
      if(act === "remove"){
        newQty = 0;
      }

      if(!newQty) delete cart[id];
      else cart[id].qty = newQty;

      saveCart();
      renderCartModal();
    });

    function openWhatsAppTo(toDigits, text){
      const msg = String(text || "").trim() || "Hola, quiero informaci√≥n del cat√°logo.";
      window.open(waLinkTo(toDigits, msg), "_blank", "noopener");
    }

    // √öNICO BOT√ìN: Comprar por WhatsApp (se env√≠a al celular escrito por el comprador)
	if(cartBuyBtn){
	  cartBuyBtn.addEventListener("click", ()=>{
		// El mensaje SIEMPRE se env√≠a al celular de la tienda
		openWhatsAppTo(getWhatsAppTo(), buildBuyerMessage());
	  });
	}
    if(cartClearBtn){
      cartClearBtn.addEventListener("click", ()=>{
        for(const k of Object.keys(cart)) delete cart[k];
        saveCart();
        renderCartModal();
        render();
      });
    }

    if(cartModalClose) cartModalClose.addEventListener("click", closeCartModal);
    if(cartModalBackdrop) cartModalBackdrop.addEventListener("click", closeCartModal);

    if(shippingCopInp){
      shippingCopInp.addEventListener("input", ()=>{
        saveShippingToLS();
        if(cartModal.classList.contains("open")) renderCartModal();
      });
    }

    /* ==========================
       Modales Direcci√≥n / Otros datos
       ========================== */
    const addressModal = document.getElementById("addressModal");
    const addressModalClose = document.getElementById("addressModalClose");
    const addressModalBackdrop = document.getElementById("addressModalBackdrop");
    const addrCancelBtn = document.getElementById("addrCancelBtn");
    const addrSaveBtn = document.getElementById("addrSaveBtn");
    const addrMapsLink = document.getElementById("addrMapsLink");

    const addrCity = document.getElementById("addrCity");
    const addrRegion = document.getElementById("addrRegion");
    const addrViaTipo = document.getElementById("addrViaTipo");
    const addrViaNum = document.getElementById("addrViaNum");
    const addrPlaca = document.getElementById("addrPlaca");
    const addrBarrio = document.getElementById("addrBarrio");
    const addrFinal = document.getElementById("addrFinal");

    const DEFAULT_CITY = "Santa Marta";
    const DEFAULT_REGION = "Magdalena";

    function openAddressModal(){
      if(addressModal.classList.contains("open")) return;
      loadAddressFromLS();
      addressModal.classList.add("open");
      addressModal.setAttribute("aria-hidden","false");
      lockBodyScroll();
    }
    function closeAddressModal(){
      if(!addressModal.classList.contains("open")) return;
      addressModal.classList.remove("open");
      addressModal.setAttribute("aria-hidden","true");
      unlockBodyScroll();
    }

    function joinParts(parts, sep=" "){
      return parts.filter(Boolean).join(sep).replace(/\s+/g," ").trim();
    }

    function refreshAddressModalPreview(){
      const city = String(addrCity?.value || "").trim();
      const region = String(addrRegion?.value || "").trim();
      const tipo = String(addrViaTipo?.value || "").trim();
      const num = String(addrViaNum?.value || "").trim();
      const placa = String(addrPlaca?.value || "").trim();

      // Direcci√≥n final SOLO con v√≠a + ciudad + departamento (sin barrio)
      const via = buildViaString(tipo, num, placa);
      const final = joinParts([via || "", city || "", region || ""], ", ");

      if(addrFinal) addrFinal.value = final;

      // El barrio NO se usa para el enlace de Google Maps
      const hasVia = !!(tipo && num && placa);
      if(addrMapsLink){
        if(!hasVia || !final){
          addrMapsLink.setAttribute("aria-disabled","true");
          addrMapsLink.setAttribute("tabindex","-1");
          addrMapsLink.href = "#";
        }else{
          addrMapsLink.removeAttribute("aria-disabled");
          addrMapsLink.setAttribute("tabindex","0");
          addrMapsLink.href = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(final);
        }
      }
    }

    function loadAddressFromLS(){
      const obj = readJsonLS(LS_ADDRESS_KEY, {});

      const hasCity = Object.prototype.hasOwnProperty.call(obj, "addrCity");
      const hasRegion = Object.prototype.hasOwnProperty.call(obj, "addrRegion");

      const cityVal = hasCity ? String(obj.addrCity ?? "") : DEFAULT_CITY;
      const regionVal = hasRegion ? String(obj.addrRegion ?? "") : DEFAULT_REGION;

      if(addrCity) addrCity.value = cityVal;
      if(addrRegion) addrRegion.value = regionVal;
      if(addrViaTipo) addrViaTipo.value = String(obj.addrViaTipo ?? "");
      if(addrViaNum) addrViaNum.value = String(obj.addrViaNum ?? "");
      if(addrPlaca) addrPlaca.value = String(obj.addrPlaca ?? "");
      if(addrBarrio) addrBarrio.value = String(obj.addrBarrio ?? "");
      refreshAddressModalPreview();
    }

    function saveAddressToLS(){
      const obj = readJsonLS(LS_ADDRESS_KEY, {});
      obj.addrCity = String(addrCity?.value ?? "");
      obj.addrRegion = String(addrRegion?.value ?? "");
      obj.addrViaTipo = String(addrViaTipo?.value ?? "");
      obj.addrViaNum = String(addrViaNum?.value ?? "");
      obj.addrPlaca = String(addrPlaca?.value ?? "");
      obj.addrBarrio = String(addrBarrio?.value ?? "");
      obj.addrFinal = String(addrFinal?.value ?? "");
      writeJsonLS(LS_ADDRESS_KEY, obj);
    }

    [addrCity, addrRegion, addrViaTipo, addrViaNum, addrPlaca, addrBarrio].forEach(el=>{
      if(!el) return;
      el.addEventListener("input", refreshAddressModalPreview);
      el.addEventListener("change", refreshAddressModalPreview);
    });

    if(addressModalClose) addressModalClose.addEventListener("click", closeAddressModal);
    if(addressModalBackdrop) addressModalBackdrop.addEventListener("click", closeAddressModal);
    if(addrCancelBtn) addrCancelBtn.addEventListener("click", closeAddressModal);
    if(addrSaveBtn) addrSaveBtn.addEventListener("click", ()=>{
      refreshAddressModalPreview();
      saveAddressToLS();
      closeAddressModal();
    });

    const clientModal = document.getElementById("clientModal");
    const clientModalClose = document.getElementById("clientModalClose");
    const clientModalBackdrop = document.getElementById("clientModalBackdrop");
    const clientCancelBtn = document.getElementById("clientCancelBtn");
    const clientSaveBtn = document.getElementById("clientSaveBtn");

    const clientName = document.getElementById("clientName");
    const clientPhone = document.getElementById("clientPhone");
    const clientObs = document.getElementById("clientObs");

    function openClientModal(){
      if(clientModal.classList.contains("open")) return;
      loadClientFromLS();
      clientModal.classList.add("open");
      clientModal.setAttribute("aria-hidden","false");
      lockBodyScroll();
    }
    function closeClientModal(){
      if(!clientModal.classList.contains("open")) return;
      clientModal.classList.remove("open");
      clientModal.setAttribute("aria-hidden","true");
      unlockBodyScroll();
    }

    function loadClientFromLS(){
      const obj = readJsonLS(LS_CLIENT_KEY, {});
      if(clientName) clientName.value = String(obj.clientName ?? "");
      if(clientPhone) clientPhone.value = String(obj.clientPhone ?? "");
      if(clientObs) clientObs.value = String(obj.clientObs ?? "");
    }

    function saveClientToLS(){
      const obj = readJsonLS(LS_CLIENT_KEY, {});
      obj.clientName = String(clientName?.value ?? "");
      obj.clientPhone = String(clientPhone?.value ?? "");
      obj.clientObs = String(clientObs?.value ?? "");
      writeJsonLS(LS_CLIENT_KEY, obj);
    }

    if(clientModalClose) clientModalClose.addEventListener("click", closeClientModal);
    if(clientModalBackdrop) clientModalBackdrop.addEventListener("click", closeClientModal);
    if(clientCancelBtn) clientCancelBtn.addEventListener("click", closeClientModal);
    if(clientSaveBtn) clientSaveBtn.addEventListener("click", ()=>{
      saveClientToLS();
      closeClientModal();
    });

    if(cartAddressBtn) cartAddressBtn.addEventListener("click", openAddressModal);
    if(cartClientBtn) cartClientBtn.addEventListener("click", openClientModal);

    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        if(imgModal && imgModal.classList.contains("open")){ closeImgModal(); return; }
        if(addressModal && addressModal.classList.contains("open")){ closeAddressModal(); return; }
        if(clientModal && clientModal.classList.contains("open")){ closeClientModal(); return; }
        if(cartModal && cartModal.classList.contains("open")){ closeCartModal(); return; }
      }
    });

    let _ldJob = 0;
    function updateProductsJsonLd(list){
      try{
        const baseUrl = "https://irenismb.github.io/stock/natura/catalogo.html";
        const itemList = {
          "@context":"https://schema.org",
          "@type":"ItemList",
          "name":"Cat√°logo de productos",
          "itemListElement": list.slice(0, 500).map((p, i) => {
            const productUrl = baseUrl + "#p-" + encodeURIComponent(p.id);
            const imgUrl = productImageAbsoluteUrlFromFilename(p.imgFilename);
            const desc = `Producto: ${p.name}. Categor√≠a: ${p.category || "Natura"}. Compra por WhatsApp.`;
            const availability = (Number.isFinite(p.stock) && p.stock > 0)
              ? "https://schema.org/InStock"
              : "https://schema.org/OutOfStock";
            return {
              "@type":"ListItem",
              "position": i + 1,
              "url": productUrl,
              "item": {
                "@type":"Product",
                "name": p.name,
                "description": desc,
                "image": [imgUrl],
                "category": p.category || undefined,
                "brand": p.brand ? { "@type":"Brand", "name": p.brand } : undefined,
                "sku": String(p.id),
                "url": productUrl,
                "offers": {
                  "@type":"Offer",
                  "url": productUrl,
                  "priceCurrency":"COP",
                  "price": p.price || 0,
                  "availability": availability
                }
              }
            };
          })
        };
        const el = document.getElementById("ld-products");
        if(el) el.textContent = JSON.stringify(itemList);
      }catch(_){}
    }

    function scheduleJsonLdUpdate(filtered){
      const job = ++_ldJob;
      runIdle(()=>{
        if(job !== _ldJob) return;
        updateProductsJsonLd(filtered);
      }, 1400);
    }

    const cardTemplate = document.createElement("template");
    cardTemplate.innerHTML = `
      <article class="card">
        <div class="img"></div>
        <div class="pad">
          <h3 class="name"></h3>
          <p class="meta"></p>
          <div class="row">
            <span class="price"></span>
            <span class="pill" data-role="qty"></span>
          </div>
          <div class="actions">
            <button type="button" class="btn-danger" data-act="dec">Quitar</button>
            <button type="button" class="btn-acc" data-act="inc">Agregar</button>
          </div>
        </div>
      </article>
    `;

    function stockMetaText(p){
      const stockVal = Number.isFinite(p.stock) ? p.stock : 0;
      let stockPart = "";
      if (INTERRUPTORES.MOSTRAR_CANTIDAD_STOCK){
        stockPart = ` ¬∑ Stock: ${stockVal}`;
      } else if (INTERRUPTORES.MOSTRAR_TEXTO_ESTADO_STOCK){
        stockPart = ` ¬∑ ${stockVal > 0 ? "Disponible" : "Sin stock"}`;
      } else {
        stockPart = "";
      }
      return `${p.category} ¬∑ ${p.brand} ¬∑ Id: ${p.id}${stockPart}`;
    }

    function refreshCardUI(card, p){
      const enforce = shouldEnforceStockLimits();
      const id = String(p.id);
      const q = (cart[id]?.qty || 0);

      const qtyPill = card.querySelector('[data-role="qty"]');
      const decBtn = card.querySelector('button[data-act="dec"]');
      const incBtn = card.querySelector('button[data-act="inc"]');

      if(qtyPill) qtyPill.textContent = `En carrito: ${q}`;
      if(decBtn) decBtn.disabled = q <= 0;

      const maxStock = Number.isFinite(p.stock) ? p.stock : 0;
      const canAdd = !enforce ? true : ((maxStock > 0) && (q < maxStock));

      if(incBtn){
        incBtn.disabled = !canAdd;
        incBtn.classList.toggle("in-cart", q > 0);
        if(enforce && maxStock <= 0){
          incBtn.textContent = INTERRUPTORES.MOSTRAR_TEXTO_ESTADO_STOCK ? "Sin stock" : "Agregar";
        }else{
          incBtn.textContent = "Agregar";
        }
      }
    }

    function makeCard(p){
      const card = cardTemplate.content.firstElementChild.cloneNode(true);
      card.id = "p-" + p.id;
      card.dataset.id = String(p.id);

      const imgBox = card.querySelector(".img");
      imgBox.appendChild(makeImgFromFilename(p.imgFilename, p.name));

      card.querySelector(".name").textContent = p.name;
      card.querySelector(".meta").textContent = stockMetaText(p);
      card.querySelector(".price").textContent = fmtCOP.format(p.price);

      refreshCardUI(card, p);
      return card;
    }

    const catSel = document.getElementById("cat");
    const brandSel = document.getElementById("brand");
    const sortSel = document.getElementById("sort");
    const qInp = document.getElementById("q");
    const grid = document.getElementById("grid");
    const countEl = document.getElementById("count");

    const searchWrap = document.getElementById("searchWrap");
    const searchTicker = document.getElementById("searchTicker");
    const tickerInner = document.getElementById("tickerInner");

    const countSlot = document.getElementById("countSlot");
    const topline = document.getElementById("topline");
    const mqCountMobile = window.matchMedia("(max-width:560px)");

    function placeCountElement(){
      if(!countEl || !countSlot || !topline) return;

      if(mqCountMobile.matches){
        if(countEl.parentElement !== countSlot){
          countSlot.appendChild(countEl);
        }
        countEl.classList.add("count-mobile");
        topline.classList.add("hidden");
      }else{
        if(countEl.parentElement !== topline){
          topline.appendChild(countEl);
        }
        countEl.classList.remove("count-mobile");
        topline.classList.remove("hidden");
      }
    }

    if(typeof mqCountMobile.addEventListener === "function"){
      mqCountMobile.addEventListener("change", placeCountElement);
    }else if(typeof mqCountMobile.addListener === "function"){
      mqCountMobile.addListener(placeCountElement);
    }
    placeCountElement();

    function updateTickerVisibility(){
      if(!searchWrap || !qInp) return;
      const empty = !String(qInp.value || "").trim();
      const focused = (document.activeElement === qInp);
      searchWrap.classList.toggle("show-ticker", empty && !focused);
    }

    function updateCountAttention(){
      if(!countEl || !qInp) return;
      const hasQuery = !!String(qInp.value || "").trim();
      countEl.classList.toggle("search-active", hasQuery);
    }

    function rebuildSearchTicker(){
      if(!searchWrap || !searchTicker || !tickerInner || !qInp) return;

      const text = String(qInp.getAttribute("placeholder") || "").trim();
      if(!text){
        tickerInner.innerHTML = "";
        searchWrap.style.setProperty("--marquee-distance", "0px");
        return;
      }

      tickerInner.innerHTML = "";

      const seq = document.createElement("div");
      seq.className = "ticker-seq";
      tickerInner.appendChild(seq);

      const available = Math.max(1, searchTicker.clientWidth || searchWrap.clientWidth || 1);
      const target = Math.max(280, Math.floor(available * 1.7));

      let guard = 0;
      while(seq.scrollWidth < target && guard < 60){
        const item = document.createElement("span");
        item.className = "ticker-item";
        item.textContent = text;
        seq.appendChild(item);
        guard++;
      }

      const seqWidth = seq.scrollWidth || 0;
      if(seqWidth <= 0) return;

      const clone = seq.cloneNode(true);
      tickerInner.appendChild(clone);

      const SPEED_PX_PER_SEC = 60;
      const duration = Math.max(8, seqWidth / SPEED_PX_PER_SEC);

      searchWrap.style.setProperty("--marquee-distance", seqWidth + "px");
      searchWrap.style.setProperty("--marquee-duration", duration.toFixed(2) + "s");
    }

    function clearSelectButKeepFirst(sel){
      const first = sel.querySelector("option[value='']");
      sel.innerHTML = "";
      if(first) sel.appendChild(first);
      else{
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = (sel === catSel) ? "Todas las categor√≠as" : "Todas las marcas";
        sel.appendChild(opt);
      }
    }

    function fillSelect(sel, values){
      clearSelectButKeepFirst(sel);
      for(const v of values){
        const opt = document.createElement("option");
        opt.value = v; opt.textContent = v;
        sel.appendChild(opt);
      }
    }

    function readStateFromUrl(){
      const u = new URL(location.href);
      const q = (u.searchParams.get("q") || "").trim();
      const cat = (u.searchParams.get("cat") || "").trim();
      const br = (u.searchParams.get("brand") || "").trim();
      const sort = (u.searchParams.get("sort") || "").trim();
      if (q) qInp.value = q;
      if (cat) catSel.value = cat;
      if (br) brandSel.value = br;
      if (sort && sortSel) sortSel.value = sort;
    }

    let _urlTimer = null;
    function writeStateToUrl(){
      const u = new URL(location.href);
      const q = qInp.value.trim();
      const cat = catSel.value;
      const br = brandSel.value;
      const sort = sortSel ? sortSel.value : "";
      if (q) u.searchParams.set("q", q); else u.searchParams.delete("q");
      if (cat) u.searchParams.set("cat", cat); else u.searchParams.delete("cat");
      if (br) u.searchParams.set("brand", br); else u.searchParams.delete("brand");
      if (sort) u.searchParams.set("sort", sort); else u.searchParams.delete("sort");
      history.replaceState(null, "", u.toString());
    }
    function scheduleWriteStateToUrl(){
      clearTimeout(_urlTimer);
      _urlTimer = setTimeout(writeStateToUrl, 180);
    }

    function buildFilteredList(){
      const cat = catSel.value;
      const br = brandSel.value;
      const sortMode = sortSel ? sortSel.value : "";
      const terms = normalizeText(qInp.value).split(/\s+/).filter(Boolean);

      let filtered = all.filter(p=>{
        if(cat && p.category !== cat) return false;
        if(br && p.brand !== br) return false;
        if(terms.length){
          return terms.every(t => p.searchKey.includes(t));
        }
        return true;
      });

      if(sortMode === "price_asc"){
        filtered.sort((a,b)=> (a.price||0) - (b.price||0) || String(a.id).localeCompare(String(b.id)));
      }else if(sortMode === "price_desc"){
        filtered.sort((a,b)=> (b.price||0) - (a.price||0) || String(a.id).localeCompare(String(b.id)));
      }else if(sortMode === "name_asc"){
        filtered.sort((a,b)=>{
          const cmp = String(a.name||"").localeCompare(String(b.name||""), "es", { sensitivity:"base" });
          if(cmp !== 0) return cmp;
          return String(a.id).localeCompare(String(b.id));
        });
      }
      return filtered;
    }

    let _renderToken = 0;
    function render(){
      const token = ++_renderToken;

      updateTickerVisibility();
      updateCountAttention();
      scheduleWriteStateToUrl();

      const filtered = buildFilteredList();

      const qHas = !!String(qInp.value || "").trim();
      if(countEl){
        countEl.textContent = `${filtered.length} producto(s)`;
        countEl.classList.toggle("search-active", qHas);
      }

      scheduleJsonLdUpdate(filtered);

      if(token !== _renderToken) return;

      const frag = document.createDocumentFragment();
      for(const p of filtered){
        frag.appendChild(makeCard(p));
      }

      grid.innerHTML = "";
      grid.appendChild(frag);

      for(const el of grid.querySelectorAll(".card")){
        const id = el.dataset.id;
        const p = productById.get(String(id));
        if(p) refreshCardUI(el, p);
      }
    }

    function updateCountTextLoading(){
      if(countEl) countEl.textContent = "Cargando productos‚Ä¶";
    }

    function updateCountTextError(msg){
      if(countEl) countEl.textContent = msg || "Error al cargar productos.";
    }

    function bindGridActions(){
      grid.addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-act]");
        if(!btn) return;
        const card = e.target.closest(".card");
        if(!card) return;
        const id = card.dataset.id;
        if(!id) return;

        const p = productById.get(String(id));
        if(!p) return;

        const act = btn.getAttribute("data-act");
        const enforce = shouldEnforceStockLimits();
        const maxStock = Number.isFinite(p.stock) ? p.stock : 0;

        const currentQty = safeInt(cart[id]?.qty, 0);

        let newQty = currentQty;

        if(act === "inc"){
          if(!enforce){
            newQty = currentQty + 1;
          }else{
            if(maxStock > 0 && currentQty < maxStock){
              newQty = currentQty + 1;
            }else{
              newQty = currentQty;
            }
          }
        }else if(act === "dec"){
          newQty = Math.max(0, currentQty - 1);
        }

        if(newQty <= 0){
          delete cart[id];
        }else{
          cart[id] = {
            id: p.id,
            name: p.name,
            price: p.price,
            qty: newQty,
            stock: p.stock,
            imgFilename: p.imgFilename || null
          };
        }

        saveCart();
        refreshCardUI(card, p);

        if(cartModal && cartModal.classList.contains("open")){
          renderCartModal();
        }
      });
    }

    function bindFilters(){
      [catSel, brandSel, sortSel].forEach(sel=>{
        if(!sel) return;
        sel.addEventListener("change", ()=>{
          render();
        });
      });

      qInp.addEventListener("input", ()=>{
        render();
      });

      qInp.addEventListener("focus", ()=>{
        updateTickerVisibility();
      });
      qInp.addEventListener("blur", ()=>{
        updateTickerVisibility();
      });

      window.addEventListener("resize", ()=>{
        rebuildSearchTicker();
        updateTickerVisibility();
      }, { passive:true });
    }

    function buildCategoriesAndBrands(list){
      const cats = new Set();
      const brands = new Set();
      for(const p of list){
        if(p.category) cats.add(p.category);
        if(p.brand) brands.add(p.brand);
      }
      return {
        cats: Array.from(cats).sort((a,b)=> a.localeCompare(b,"es",{sensitivity:"base"})),
        brands: Array.from(brands).sort((a,b)=> a.localeCompare(b,"es",{sensitivity:"base"}))
      };
    }

    async function loadProducts(){
      updateCountTextLoading();

      await warmupPlaceholderOnce();

      const cached = readProductsCache(true);
      if(cached && Array.isArray(cached.products) && cached.products.length){
        all = cached.products;
        productById = new Map(all.map(p => [String(p.id), p]));
        const { cats, brands } = buildCategoriesAndBrands(all);
        fillSelect(catSel, cats);
        fillSelect(brandSel, brands);

        readStateFromUrl();

        sanitizeCartWithStock();

        render();

        if(!cached.isFresh){
          try{
            const fresh = await loadProductsFresh();
            if(Array.isArray(fresh) && fresh.length){
              all = fresh;
              productById = new Map(all.map(p => [String(p.id), p]));
              writeProductsCache(all);

              const { cats: c2, brands: b2 } = buildCategoriesAndBrands(all);
              const prevCat = catSel.value;
              const prevBrand = brandSel.value;

              fillSelect(catSel, c2);
              fillSelect(brandSel, b2);

              if(prevCat && c2.includes(prevCat)) catSel.value = prevCat;
              if(prevBrand && b2.includes(prevBrand)) brandSel.value = prevBrand;

              sanitizeCartWithStock();
              render();
            }
          }catch(_){}
        }
        return;
      }

      try{
        const products = await loadProductsFresh();
        all = products || [];
        productById = new Map(all.map(p => [String(p.id), p]));
        writeProductsCache(all);

        const { cats, brands } = buildCategoriesAndBrands(all);
        fillSelect(catSel, cats);
        fillSelect(brandSel, brands);

        readStateFromUrl();
        sanitizeCartWithStock();

        render();
      }catch(err){
        console.error(err);
        updateCountTextError("No se pudieron cargar los productos. Reintenta m√°s tarde.");
      }
    }

    function initCartButton(){
      const btnCart = document.getElementById("btn-cart");
      if(!btnCart) return;
      btnCart.addEventListener("click", ()=>{
        openCartModal();
      });
    }

    function initShipping(){
      loadShippingFromLS();
    }

    function initWhatsAppDestinationFromClient(){
      // Se mantiene por compatibilidad con el sitio (destinos anteriores),
      // pero la compra se env√≠a al celular del cliente seg√∫n lo solicitado.
    }

    function initKeyboardAccessibility(){
      // Cierre de modales ya est√° en Escape
    }

    function init(){
      refreshCartCount();
      initCartButton();
      initShipping();
      initWhatsAppDestinationFromClient();

      bindFilters();
      bindGridActions();
      initKeyboardAccessibility();

      rebuildSearchTicker();
      updateTickerVisibility();
      updateCountAttention();

      loadClientFromLS();     // precarga datos
      loadAddressFromLS();    // precarga datos (Santa Marta / Magdalena por defecto)

      loadProducts();
    }

    // Arranque
    init();
  </script>
</body>
</html>
